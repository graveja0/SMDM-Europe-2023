---
title: "Incorporating New Evidence and Uncertainty"
subtitle: "Solving for PSA Parameters and Copula-Based PSA Sampling"
format:
  revealjs:
    transition: fade
    background-transition: fade
    incremental: true 
    footer: |
      [Back to Website](../index.html)
editor_options: 
  chunk_output_type: console
self-contained: true
bibliography: references.bib
---

```{r setup}
source("./manifest.r")
```

# Basic PSA Formulas

- Taking 95% CI and turning them into distribution parameters for PSA draws is a common task.
- Analytic formulas: https://www.johndcook.com/quantiles_parameters.pdf
- ParameterSolver implements in Windows, http://biostatistics.mdanderson.org/SoftwareDownload/

## Normal Distribution Analytic

Let $x_1$ and $x_2$ represent desired end points at some confidence interval $p_1$ and $p_2$. For 95% CI, $p_1=0.025$ and $p_2=0.975$

$$ \sigma = \frac{x_2 - x_1}{\Phi^{-1}(p_2)-\Phi^{-1}(p_1)}$$

$$\mu = \frac{x_1\Phi^{-1}(p_2)-x_2\Phi^{-1}(p_1)}{\Phi^{-1}(p_2)-\Phi^{-1}(p_1)}$$

## Normal Distribution Example

```{r}
#| echo: true
param_normal <- function(x1,x2,p1,p2) {
  sigma <- (x2 - x1) / (qnorm(p2)-qnorm(p1))
  mu <- (x1*qnorm(p2)-x2*qnorm(p1))/(qnorm(p2)-qnorm(p1));
  c("mu" = mu, "sigma" = sigma)
}
param_normal(x1 = 0.91, p1 = 0.025, x2 = 1.69, p = 0.975)
```

```{r}
curve(dnorm(x, 1.3, 0.199), from=0.8, to=1.8, ylab="")
abline(v=0.91, col='red')
abline(v=1.69, col='red')
```

## Gamma Example

```{r}
#| echo: true
gamma_fn <- function(x1, p1, x2, p2, alpha)
  x1*qgamma(p2,shape = alpha) - x2*qgamma(p1, shape = alpha)

param_gamma <- function(x1,x2,p1,p2,range) {
    alpha <- uniroot(function(a) gamma_fn(x1,p1,x2,p2,a),range)$root
    beta  <- x1 / qgamma(p1,alpha)
    c("alpha" = alpha, "beta" = beta)
}

param_gamma(x1=0.91, p1=0.025, x2=1.69, p2=0.975, range = c(1,100))
```

```{r}
curve(dgamma(x, shape=40.59, scale=0.0313), from = 0.5, to=2)
abline(v=0.91, col='red')
abline(v=1.69, col='red')
```

## General Optimization Technique

::: nonincremental
-  General solution, requires CDF, $F$.
-  https://hwborchers.lima-city.de/Presents/ROptimSlides4.pdf for optimization tutorial in R 
:::
 
$$\min_{x_1, x_2 \in \mathcal{R}}\,\, (F(x_1)-p_1)^2+(F(x_2)-p_2)^2$$

# Normal Example via Optim

```{r}
#| echo: true
library(pracma)
norm <- function(x1, p1, x2, p2, mu, sigma)
 (pnorm(x1, mu, sigma)-p1)^2 +
 (pnorm(x2, mu, sigma)-p2)^2

fn <- function(x) norm(0.91, 0.025, 1.69, 0.975, x[1], x[2])

optim(c(1, 0.4),
      fn,
      gr = function(x) pracma::grad(fn, x),
      lower=c(-Inf, 1e-3),
      method = "L-BFGS-B",
      control=list(factr=1e-10, maxit=100))$par

```

# Copulas

## What is a Copula?

-   The binding "glue" between correlated variables.
-   

## Copulas and PSA Sampling {auto-animate="true"}

We typically draw PSA samples from the *marginal* distribution of each variable:

$$
F_1(x_1),  ..., F_d(x_d)
$$

## Copulas and PSA Sampling {auto-animate="true"}

Copulas allow us to sample from the *joint* distribution:

$$
F(x_1,...,x_d) = C \big ( F_1(x_1), ..., F_d(x_d) \big )
$$

(This is a result of Sklar \[1959\].)

## Copulas and PSA Sampling {auto-animate="true"}

-   Copula: a multivariate cumulative distribution function with uniform marginals.
