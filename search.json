[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "What They Didn’t Teach You About Decision Modeling",
    "section": "",
    "text": "To Do\n\nWork on Lec 0\n\nmake sure to include a web survey for email addressses to add to posit cloud\n\nLec 3 already is jam packed; lets punt on tunnel states\nNeed learning objectives at top of every lecture and case study\nSolve for PSA parameters given mean and SD\nLook over 1st, 2nd and 3rd case study\n\nAdd in msm based method if possible?\n\nCreate brief Learnr for PSA solver and copula-based sampling\nadd in useful links to website\nget rid of blog\nAdd cycle adjustment (with alt_simp+1) to life expectancy calculations. See the case study for example.\nChange the discount rate in the monthly time step too!\n\n\nWorkshop Schedule\n\n\nStart\n9:00am\nEnd\n9:20am\nTopic\nIntroductions and Welcome\nApplied Case Study\n\n\n\n\n\n\n\n\n\n\n\n\n9:20am\n10:30 am\nCause-Specific and Cause-Deleted Mortality\n\nMortality modeling in R\n\n\n\n\n\n10:30am\n11:00am\nBREAK\n\n\n\n\n\n11:00am\n12:30pm\nEmbedding and Competing Events\n\nNatural History Cardiovascular Disease Model\n\n\n\n\n\n12:30pm\n2:00pm\nLUNCH BREAK\n\n\n\n\n\n2:00pm\n3:30pm\nAdvanced Bookkeeping: Incorporating Non-Markovian Accumulators and Transition States\n\nProgressive Disease Model (Green et al. 2023) model.\n\n\n\n\n\n3:30pm\n4:00pm\nBREAK\n\n\n\n\n\n4:00pm\n5:30pm\nIncorporating New Evidence"
  },
  {
    "objectID": "blog/posts/green-et-al-replication/green-et-al-replication.html",
    "href": "blog/posts/green-et-al-replication/green-et-al-replication.html",
    "title": "Basic Markov Modeling in R",
    "section": "",
    "text": "The objective of this posting is to provide R code that replicates the model and results in Green et al. (2023).\nGreen et al. (2023) provide a link to the Excel file as well as code to execute the same model in R. The R code is written in base R, meaning that it does not require any loaded packages to execute. However, the model structure is somewhat complicated–requiring, for example, both state occupancy and transitions out of certain states to be tracked.More specifically, in the Green et al. (2023) model there is an additional cost from transitioning from Progressive disease to death, but this cost does not apply if the cause of death was background mortality. This is straighforward to track when the calculations are done cycle-by-cycle, as in the original Excel file and R code. However, this type of dynamic is not easily captured in a generalized approach to modeling—as we aim to build here—unless the specific health states are separately defined in the model. Our adaptation to the code generalizes the modeling process but does not change the results.\nThe code provided below replicates the original model, but draws on various capabilities within the (now ubiquitous) tidyverse universe to both simplify and generalize the execution process; this will become useful in the workshop when we augment the model with additional health states, new evidence, etc.\nThe original model is structured as follows:\n\nCreated on Sketchviz\n\nIn this model, individuals can cycle into the death state in one of two ways:\n\nFrom the Asymptomatic state, in which case the probability of death is goverened by age-dependent mortality probabilities.\nFrom the Progressive Disease state, in which case the probability of death is govered both by age-dependent mortality, as well as a heightened probability of death from the disease.\n\nTo simplify and generalize the code required to execute the model we will make a slight adaptation to the model structure and seaprate out death from Progressive disease and death from background causes. The adapted model diagram is provided below.\n\nHosted on Sketchviz\n\nThe only other adaptation to the model we will make is to set the discount rates to 0."
  },
  {
    "objectID": "blog/posts/green-et-al-replication/green-et-al-replication.html#define-payoffs",
    "href": "blog/posts/green-et-al-replication/green-et-al-replication.html#define-payoffs",
    "title": "Basic Markov Modeling in R",
    "section": "Define Payoffs",
    "text": "Define Payoffs\n\nu_payoff &lt;- with(params,{\n    array(c(\"Asymptomatic_disease\" = uAsymp, \"Progressive_disease\" = uProg, \"DeadCause\" = 0, \"Dead\" = 0, \n            \"Asymptomatic_disease\" = uAsymp, \"Progressive_disease\" = uProg,  \"DeadCause\" = 0, \"Dead\" = 0 ),\n          dim = c(1, n_states, n_treatments),\n          dimnames = list(from = \"qaly\",\n                          to = c(s_names),\n                          t_names))\n    }) %&gt;% \n         apply(.,3,function(x) t(x), simplify = FALSE)\nu_payoff\n\n$without_drug\n             from\nto            qaly\n  Asympt      0.95\n  Progressive 0.75\n  DeadCause   0.00\n  Dead        0.00\n\n$with_drug\n             from\nto            qaly\n  Asympt      0.95\n  Progressive 0.75\n  DeadCause   0.00\n  Dead        0.00\n\nc_state_payoff &lt;- with(params,{\n    array(c(\"Asymptomatic_disease\" = cAsymp, \"Progressive_disease\" = cProg, \"DeadCause\" = 0 , \"Dead\" = 0, \n            \"Asymptomatic_disease\" = cAsymp+cDrug, \"Progressive_disease\" = cProg, \"DeadCause\" = 0 , \"Dead\" = 0 ),\n          dim = c(1, n_states, n_treatments),\n          dimnames = list(from = \"cost\",\n                          to = c(s_names),\n                          t_names))\n    }) %&gt;% \n        apply(.,3,function(x) t(x), simplify = FALSE)\nc_state_payoff\n\n$without_drug\n             from\nto            cost\n  Asympt       500\n  Progressive 3000\n  DeadCause      0\n  Dead           0\n\n$with_drug\n             from\nto            cost\n  Asympt      1500\n  Progressive 3000\n  DeadCause      0\n  Dead           0\n\nc_transition_payoff &lt;- with(params,{\n    array(c(\"Asymptomatic_disease\" = 0, \"Progressive_disease\" = 0, \"DeadCause\" = cDeath , \"Dead\" = 0, \n            \"Asymptomatic_disease\" = 0, \"Progressive_disease\" = 0, \"DeadCause\" = cDeath , \"Dead\" = 0 ),\n          dim = c(1, n_states, n_treatments),\n          dimnames = list(from = \"transition_cost\",\n                          to = c(s_names),\n                          t_names))\n    }) %&gt;% \n        apply(.,3,function(x) t(x), simplify = FALSE)\nc_transition_payoff\n\n$without_drug\n             from\nto            transition_cost\n  Asympt                    0\n  Progressive               0\n  DeadCause              1000\n  Dead                      0\n\n$with_drug\n             from\nto            transition_cost\n  Asympt                    0\n  Progressive               0\n  DeadCause              1000\n  Dead                      0\n\n\n\nqaly_unadj &lt;- # .x[-1,] because we don't count the cycle with the full cohort in asymptomatic\n    map2(markov_result$trace, u_payoff,  ~ ({\n        .x[-1,] %*% .y\n    })) %&gt;% \n    set_names(params$t_names)\n\ncost_state_unadj &lt;- \n    map2(markov_result$trace, c_state_payoff, ~({\n        .x[-1,] %*% .y\n    })) %&gt;% \n    set_names(params$t_names)\n\ncost_transition_unadj &lt;- \n    map2(markov_result$trace, c_state_payoff, ~({\n         matrix(c(0,diff(.x[-1,\"DeadCause\"]))) * params$cDeath\n    })) %&gt;% \n    set_names(params$t_names)\n    \ncost_unadj &lt;- map2(cost_state_unadj, cost_transition_unadj, ~(.x + .y))"
  },
  {
    "objectID": "blog/posts/green-et-al-replication/green-et-al-replication.html#discounting",
    "href": "blog/posts/green-et-al-replication/green-et-al-replication.html#discounting",
    "title": "Basic Markov Modeling in R",
    "section": "Discounting",
    "text": "Discounting\n\ndiscounting_cost &lt;- \n    1/(1+params$cDr)^(0:(params$n_cycles-2))\ndiscounting_outcome &lt;- \n    1/(1+params$oDr)^(0:(params$n_cycles-2))"
  },
  {
    "objectID": "blog/posts/green-et-al-replication/green-et-al-replication.html#total-cost-and-qaly-calculation-no-cycle-adjustment",
    "href": "blog/posts/green-et-al-replication/green-et-al-replication.html#total-cost-and-qaly-calculation-no-cycle-adjustment",
    "title": "Basic Markov Modeling in R",
    "section": "Total Cost and QALY Calculation (No Cycle Adjustment)",
    "text": "Total Cost and QALY Calculation (No Cycle Adjustment)\n\ntot_cost &lt;- \n    map(cost_unadj, ~(sum(.x * discounting_cost )/params$n_cohort))  %&gt;% \n    set_names(params$t_names)\ntot_qaly &lt;- \n    map(qaly_unadj, ~(sum(.x * discounting_outcome )/params$n_cohort)) %&gt;% \n    set_names(params$t_names)\n\ndiff_cost &lt;- \n    tot_cost$with_drug - tot_cost$without_drug\ndiff_qaly &lt;- \n    tot_qaly$with_drug - tot_qaly$without_drug\n\ncbind.data.frame(cbind(tot_qaly),cbind(tot_cost))  %&gt;% \n    set_names(c(\"Eff\",\"Cost\")) %&gt;% \n    data.frame() %&gt;% \n    rbind.data.frame(\"difference\" = data.frame(Eff = round(diff_qaly,2), Cost = round(diff_cost,0))) %&gt;% \n    mutate(ICER = c(\"\",\"\",paste0(round(diff_cost / diff_qaly,0)))) %&gt;% \n    kable(digits = c(0,0,0)) %&gt;% \n    kable_styling()\n\n\nR Model Results \n\n\n\nEff\nCost\nICER\n\n\n\n\nwithout_drug\n12.203\n17526\n\n\n\nwith_drug\n14.446\n28912\n\n\n\ndifference\n2.24\n11386\n5074\n\n\n\n\n\n\n\n\n\n\nExcel Model Results"
  },
  {
    "objectID": "blog/posts/green-et-al-replication/green-et-al-replication.html#total-cost-and-qaly-calculation-with-cycle-adjustment",
    "href": "blog/posts/green-et-al-replication/green-et-al-replication.html#total-cost-and-qaly-calculation-with-cycle-adjustment",
    "title": "Basic Markov Modeling in R",
    "section": "Total Cost and QALY Calculation (With Cycle Adjustment)",
    "text": "Total Cost and QALY Calculation (With Cycle Adjustment)\n\n1alt_simp_coef &lt;- function(i) c(17, 59, 43, 49, rep(48, i-8), 49, 43, 59, 17) / 48\ncycle_adj &lt;- alt_simp_coef(params$n_cycles-1)\n\n\n1\n\nAlternative Simpson’s method coefficients\n\n\n\n\n\ntot_cost_cadj &lt;- \n    map(cost_unadj, ~(sum(.x * discounting_cost * cycle_adj )/params$n_cohort))  %&gt;% \n    set_names(params$t_names)\ntot_qaly_cadj &lt;- \n    map(qaly_unadj, ~(sum(.x * discounting_outcome * cycle_adj )/params$n_cohort)) %&gt;% \n    set_names(params$t_names)\n\ndiff_cost_cadj &lt;- \n    tot_cost_cadj$with_drug - tot_cost_cadj$without_drug\ndiff_qaly_cadj &lt;- \n    tot_qaly_cadj$with_drug - tot_qaly_cadj$without_drug\n\ncbind.data.frame(cbind(tot_qaly_cadj),cbind(tot_cost_cadj))  %&gt;% \n    set_names(c(\"Eff\",\"Cost\")) %&gt;% \n    data.frame() %&gt;% \n    rbind.data.frame(\"difference\" = data.frame(Eff = round(diff_qaly_cadj,2), Cost = round(diff_cost_cadj,0))) %&gt;% \n    mutate(ICER = c(\"\",\"\",paste0(round(diff_cost / diff_qaly,0)))) %&gt;% \n    kable(digits = c(0,0,0)) %&gt;% \n    kable_styling()\n\n\nR Model Results \n\n\n\nEff\nCost\nICER\n\n\n\n\nwithout_drug\n11.734\n17269\n\n\n\nwith_drug\n13.977\n28167\n\n\n\ndifference\n2.24\n10898\n5074"
  },
  {
    "objectID": "blog/posts/backwards-conversion/backwards-conversion.html",
    "href": "blog/posts/backwards-conversion/backwards-conversion.html",
    "title": "Backwards Conversion",
    "section": "",
    "text": "library(tidyverse)\nlibrary(knitr)\nlibrary(kableExtra)\nlibrary(survival)\nlibrary(flexsurv)\nlibrary(haven)\nlibrary(dampack)\nlibrary(Matrix)\nlibrary(here)\nlibrary(glue)\nlibrary(demography)\nlibrary(glue)\nlibrary(MortalityLaws)\nlibrary(demography)\nlibrary(MASS)\nlibrary(directlabels)\nlibrary(markovchain)\nlibrary(expm)\n\noptions(\"scipen\" = 100, \"digits\" = 5)\n\nselect &lt;- dplyr::select\ntheme_set(hrbrthemes::theme_ipsum(base_family = \"Arial\"))\nWhat if a given source of data provides observed transition probabilities and these are exclusionary states, i.e., competing? How could one reverse these probabilities and embed other competing events into the model?\nTo do this, one must solve for the generator matrix of the transition probability matrix using eigenvalue decomposition. Note that this is not always possible, as it is trivial to construct a transition probability matrix that has no generator.\nConsider the following, which builds on the example provided in the main text. We wish to approximate a continuous time process using a discrete-time Markov model with three distinct states: A (healthy), B (sick/intervention), and C (complication from intervention). Moreover, in continuous time, this process proceeds sequentially, i.e., A-&gt;B-&gt;C.\nA (naively) specified model has transitions from A-&gt;B and from B-&gt;C specified as probabilities within the selected time step. As noted in the main text, this model cannot truly approximate continuous time process, as within a given time step there is a non-zero probability of transitioning from healthy to complication (i.e., A-&gt;C, with an implied sojourn through B). That is, during a timestep it is possible to transition from A-&gt;C.\nBy incorrectly specifying all transitions, it makes it impossible to find a proper generator—though eigenvalue decomposition can be used to get as close as possible. If negative rates of transition are found using eigenvalue decomposition, then probabilities inconsistent with continuous rates have been specified.\nIn mathematical terms, the generator matrix is the matrix logarithm of the transition probability matrix. A matrix has a logarithm if and only if if it is invertible.\n\\[ A = \\log T_{prob} \\]\nThe \\(\\log\\) can be found using spectral or eigenvalue decomposition. If \\(V\\) is a matrix where equal column is an eigenvector of \\(T_{prob}\\), then,\n\\[A' = V^{-1} A V\\] \\[\\log T_{prob} = V (\\log A') V^{-1}\\]"
  },
  {
    "objectID": "blog/posts/backwards-conversion/backwards-conversion.html#alternative-approach",
    "href": "blog/posts/backwards-conversion/backwards-conversion.html#alternative-approach",
    "title": "Backwards Conversion",
    "section": "Alternative Approach",
    "text": "Alternative Approach\nThe theoretical approach requires computation of the eigenvalues of the matrix, and then correction along the way for various numerical errors to derive the generator matrix of rates. The observed statistical error from a stochastic process in general create a situation in which the Q-matrix is not derivable theoretically resulting in negative probabilities. Finding the closest generator matrix can be done using Higham’s 2008 method from `Functions of Matrices: Theory and Computation’ with extra balancing options from Stadelmann’s thesis.\n\nR &lt;- transition2Generator(mP)\nrownames(R) &lt;- c(\"A\", \"B\", \"C\", \"D\")\ncolnames(R) &lt;- c(\"A\", \"B\", \"C\", \"D\")\nR\n\n         A       B          C         D\nA -0.32712  0.3115  0.0024395  0.013181\nB  0.00000 -0.5430  0.6148890 -0.071884\nC  0.00000  0.0000 -0.2876821  0.287682\nD  0.00000  0.0000  0.0000000  0.000000\n\n\nNote: this is the closest Markov model allowing any transition. There are still transitions from A-&gt;C and A-&gt;D. Notably B-&gt;D occurs at a negative rate. If D were representing an absorbing state, e.g. Death, then this would represent a physical impossibility, as this negative rate represents D -&gt; B."
  },
  {
    "objectID": "blog/posts/backwards-conversion/backwards-conversion.html#demonstrate-that-the-embedded-new-transition-probability-matrix-successfully-recreates-the-original-transition-probability-matrix-and-results.",
    "href": "blog/posts/backwards-conversion/backwards-conversion.html#demonstrate-that-the-embedded-new-transition-probability-matrix-successfully-recreates-the-original-transition-probability-matrix-and-results.",
    "title": "Backwards Conversion",
    "section": "Demonstrate that the embedded (new) transition probability matrix successfully recreates the original transition probability matrix and results.",
    "text": "Demonstrate that the embedded (new) transition probability matrix successfully recreates the original transition probability matrix and results.\nLet’s double check it recapitulates the original rates.\n\nround(expm(R),3)\n\n      A     B     C     D\nA 0.721 0.202 0.067 0.010\nB 0.000 0.581 0.407 0.012\nC 0.000 0.000 0.750 0.250\nD 0.000 0.000 0.000 1.000"
  },
  {
    "objectID": "blog/posts/backwards-conversion/backwards-conversion.html#an-assumed-model",
    "href": "blog/posts/backwards-conversion/backwards-conversion.html#an-assumed-model",
    "title": "Backwards Conversion",
    "section": "An assumed model",
    "text": "An assumed model\nIf one were to assume that all transitions were forward , i.e. A-&gt;B-&gt;C-&gt;D the best approach would be to fit the generator matrix directly from raw data (there are many statistical Markov and ordinal data fitting models). Without the raw data available, an ad-hoc method to minimize squared error against the original under the 3 rate constraint does a decent job of recapitulating the original transition probabilities.\n\ninit  &lt;- c(1/3, 1/3, 1/3, 0)\nstep1 &lt;- init %*% mP\nm_3r &lt;- function(r)\n    matrix(c(-(r[1]+r[4]+r[5]),  r[1],      r[4],    r[5],\n                 0, -(r[2]+r[6]),   r[2],    r[6],\n                 0,     0,  -r[3], r[3],\n                 0,     0,      0,   0), nrow=4, byrow=TRUE)\nr.est &lt;- optim((-diag(R))[1:3],\n      lower=c(0.1, 0.1, 0.1),\n      method=\"L-BFGS-B\",\n      function(r) {\n      sum( ((init %*% expm(m_3r(r))) - step1)^2 )\n})$par\nm_3r(r.est)\nround(expm(m_3r(r.est)),3)\n\n\nmP_ &lt;- mP\ndiag(mP_) = 0\nmR_ &lt;- apply(mP_,c(1,2),function(x)-log(1-x))\ndiag(mR_) &lt;- -rowSums(mR_)\nexpm(mR_)\n\nlist(\"eigen\" = R,\n     \"m_3r\" = m_3r(r.est),\n     \"form\" = mR_)"
  },
  {
    "objectID": "blog/posts/extending-the-matrix/extending-the-transition-matrix.html",
    "href": "blog/posts/extending-the-matrix/extending-the-transition-matrix.html",
    "title": "Extending the Transition Matrix",
    "section": "",
    "text": "Hosted on Sketchviz"
  },
  {
    "objectID": "blog/posts/extending-the-matrix/extending-the-transition-matrix.html#define-payoffs",
    "href": "blog/posts/extending-the-matrix/extending-the-transition-matrix.html#define-payoffs",
    "title": "Extending the Transition Matrix",
    "section": "Define Payoffs",
    "text": "Define Payoffs\n\nu_payoff &lt;- with(params,{\n    array(c(\"Asympt\" = uAsymp, \"Progressive\" = uProg, \"DeadCause\" = 0 , \"Dead\" = 0, \"accProgressive\" = 0,\"trProgressive\" = 0, \"trDeadCause\" = 0,\n            \"Asympt\" = uAsymp, \"Progressive\" = uProg, \"DeadCause\" = 0 , \"Dead\" = 0, \"accProgressive\" = 0,\"trProgressive\" = 0,\"trDeadCause\" = 0),\n          dim = c(1, n_states+length(a_names)+length(tunnel_names), n_treatments),\n          dimnames = list(from = \"cost\",\n                          to = c(s_names,a_names,tunnel_names),\n                          t_names))\n    \n}) %&gt;% \n   apply(.,3,function(x) t(x), simplify = FALSE)\nu_payoff\n\n$without_drug\n                from\nto               cost\n  Asympt         0.95\n  Progressive    0.75\n  DeadCause      0.00\n  Dead           0.00\n  accProgressive 0.00\n  trProgressive  0.00\n  trDeadCause    0.00\n\n$with_drug\n                from\nto               cost\n  Asympt         0.95\n  Progressive    0.75\n  DeadCause      0.00\n  Dead           0.00\n  accProgressive 0.00\n  trProgressive  0.00\n  trDeadCause    0.00\n\nc_payoff &lt;- with(params,{\n    array(c(\"Asympt\" = cAsymp, \"Progressive\" = cProg, \"DeadCause\" = 0 , \"Dead\" = 0, \"accProgressive\" = 0,\"trProgressive\" = 0, \"trDeadCause\" = cDeath,\n            \"Asympt\" = cAsymp+cDrug, \"Progressive\" = cProg, \"DeadCause\" = 0 , \"Dead\" = 0, \"accProgressive\" = 0,\"trProgressive\" = 0, \"trDeadCause\" = cDeath),\n          dim = c(1, n_states+length(a_names)+length(tunnel_names), n_treatments),\n          dimnames = list(from = \"cost\",\n                          to = c(s_names,a_names,tunnel_names),\n                          t_names))\n    \n    }) %&gt;% \n        apply(.,3,function(x) t(x), simplify = FALSE)\nc_payoff\n\n$without_drug\n                from\nto               cost\n  Asympt          500\n  Progressive    3000\n  DeadCause         0\n  Dead              0\n  accProgressive    0\n  trProgressive     0\n  trDeadCause    1000\n\n$with_drug\n                from\nto               cost\n  Asympt         1500\n  Progressive    3000\n  DeadCause         0\n  Dead              0\n  accProgressive    0\n  trProgressive     0\n  trDeadCause    1000\n\n\n\nqaly_unadj &lt;- # .x[-1,] because we don't count the cycle with the full cohort in asymptomatic\n    map2(markov_result$trace, u_payoff,  ~ ({\n        .x[-1,] %*% .y\n    })) %&gt;% \n    set_names(params$t_names)\n\ncost_unadj &lt;- \n    map2(markov_result$trace, c_payoff, ~({\n        .x[-1,] %*% .y\n    })) %&gt;% \n    set_names(params$t_names)"
  },
  {
    "objectID": "blog/posts/extending-the-matrix/extending-the-transition-matrix.html#discounting",
    "href": "blog/posts/extending-the-matrix/extending-the-transition-matrix.html#discounting",
    "title": "Extending the Transition Matrix",
    "section": "Discounting",
    "text": "Discounting\n\ndiscounting_cost &lt;- \n    1/(1+params$cDr)^(0:(params$n_cycles-2))\ndiscounting_outcome &lt;- \n    1/(1+params$oDr)^(0:(params$n_cycles-2))"
  },
  {
    "objectID": "blog/posts/extending-the-matrix/extending-the-transition-matrix.html#total-cost-and-qaly-calculation-with-cycle-adjustment",
    "href": "blog/posts/extending-the-matrix/extending-the-transition-matrix.html#total-cost-and-qaly-calculation-with-cycle-adjustment",
    "title": "Extending the Transition Matrix",
    "section": "Total Cost and QALY Calculation (With Cycle Adjustment)",
    "text": "Total Cost and QALY Calculation (With Cycle Adjustment)\n\n1alt_simp_coef &lt;- function(i) c(17, 59, 43, 49, rep(48, i-8), 49, 43, 59, 17) / 48\ncycle_adj &lt;- alt_simp_coef(params$n_cycles-1)\n\n\n1\n\nAlternative Simpson’s method coefficients\n\n\n\n\n\ntot_cost &lt;- \n    map(cost_unadj, ~(sum(.x * discounting_cost * cycle_adj )/params$n_cohort))  %&gt;% \n    set_names(params$t_names)\ntot_qaly &lt;- \n    map(qaly_unadj, ~(sum(.x * discounting_outcome * cycle_adj )/params$n_cohort)) %&gt;% \n    set_names(params$t_names)\n\ndiff_cost &lt;- \n    tot_cost$with_drug - tot_cost$without_drug\ndiff_qaly &lt;- \n    tot_qaly$with_drug - tot_qaly$without_drug\n\ncbind.data.frame(cbind(tot_qaly),cbind(tot_cost))  %&gt;% \n    set_names(c(\"Eff\",\"Cost\")) %&gt;% \n    data.frame() %&gt;% \n    rbind.data.frame(\"difference\" = data.frame(Eff = round(diff_qaly,2), Cost = round(diff_cost,0))) %&gt;% \n    mutate(ICER = c(\"\",\"\",paste0(round(diff_cost / diff_qaly,0)))) %&gt;% \n    kable(digits = c(0,0,0)) %&gt;% \n    kable_styling()\n\n\nR Model Results \n\n\n\nEff\nCost\nICER\n\n\n\n\nwithout_drug\n11.659\n16629\n\n\n\nwith_drug\n13.971\n27813\n\n\n\ndifference\n2.31\n11184\n4838"
  },
  {
    "objectID": "blog/posts/embedding/embedding-a-transition-probability-matrix.html",
    "href": "blog/posts/embedding/embedding-a-transition-probability-matrix.html",
    "title": "Embedding A Transition Probability Matrix for a Discrete Time Markov Model",
    "section": "",
    "text": "Define \\(r_{HS}\\) and \\(r_{HD}\\) as the hazard rate of two independent competing risks from a given (Healthy) health state (to Sick and Dead, respectively), and \\(\\Delta t\\) the cycle length (e.g., \\(1\\)=1 year, \\(1/12\\)=1 month, etc.). We can also define a third rate \\(r_{SD} = hr_{S}*r_{HD}\\) for transitioning from sick to dead, i.e., the standard (healthy-to-dead) rate multiplied by the hazard ratio \\(hr_{S}\\).\nThe underlying Markov model takes the following form:\n\n\n\n\n\n\n\n\n\nG\n\n  \n\nHealthy\n\n Healthy   \n\nHealthy-&gt;Healthy\n\n    \n\nSick\n\n Sick   \n\nHealthy-&gt;Sick\n\n  r_HS   \n\nDead\n\n Dead   \n\nHealthy-&gt;Dead\n\n  r_HD   \n\nSick-&gt;Sick\n\n    \n\nSick-&gt;Dead\n\n  hr_S * r_HD   \n\nDead-&gt;Dead\n\n   \n\n\nFigure 1: Model Diagram\n\n\n\n\n\n\n\nCode\nlibrary(Matrix)\nlibrary(tidyverse)\nlibrary(expm)\nlibrary(knitr)\nlibrary(gt)\nlibrary(directlabels)\nlibrary(glue)\nlibrary(ggsci)\nlibrary(ggthemes)\n\n# Better accuracy that \"life-table\" aka trapezoidal method\nalt_simp_coef &lt;- function(i) c(17, 59, 43, 49, rep(48, i-8), 49, 43, 59, 17) / 48\nalt_simp      &lt;- function(x,h) h*sum(alt_simp_coef(length(x)) * x)\n\nr_HS &lt;- 0.15\nr_HD &lt;- .006\nhr_S &lt;- 10\nr_SD &lt;- hr_S*r_HD\ncycle &lt;- 1\n\n# 1-exp(-r_HS*cycle)\n# 1-exp(-r_HD*cycle)\n\nget_P &lt;- function(r_HS,r_HD,r_SD,cycle) {\n  P_st &lt;- \n  matrix(\n  c(exp(-r_HS*cycle) + exp(-r_HD*cycle) -1 ,  (1-exp(-r_HS*cycle)) ,  1-exp(-r_HD*cycle), \n  0, exp(-r_SD*cycle), 1-exp(-r_SD*cycle),\n  0,0,1),\n  nrow = 3, \n  ncol = 3,\n  byrow=TRUE,\n  dimnames = list(c(\"Healthy\",\"Sick\",\"Dead\"), c(\"Healthy\",\"Sick\",\"Dead\"))\n  ) %&gt;% \n    data.frame() %&gt;% \n    rownames_to_column(var = \"from\") %&gt;% \n    mutate(name = \"P_st\")\n\n  P_eQ &lt;- matrix(\n    c(-(r_HS*cycle+r_HD*cycle),r_HS*cycle,r_HD*cycle,\n      0,-r_SD*cycle,r_SD*cycle,\n      0,0,0),\n      nrow=3,\n      ncol=3,\n      byrow=TRUE,\n    dimnames = list(c(\"Healthy\",\"Sick\",\"Dead\"), c(\"Healthy\",\"Sick\",\"Dead\"))\n  ) %&gt;% expm() %&gt;% as.matrix() %&gt;% \n    data.frame() %&gt;% \n    rownames_to_column(var = \"from\") %&gt;% \n    mutate(name = \"P_eQ\")\n\n\n  P_cr &lt;- \n    matrix(\n    c(exp(-(r_HS+r_HD)*cycle) , (r_HS/(r_HS+r_HD)) * (1-exp(-(r_HS+r_HD)*cycle))   ,(r_HD/(r_HS+r_HD)) * (1-exp(-(r_HS+r_HD)*cycle))   , \n    0, exp(-r_SD*cycle), 1-exp(-r_SD*cycle),\n    0,0,1),\n    nrow = 3, \n    ncol = 3,\n    byrow=TRUE,\n    dimnames = list(c(\"Healthy\",\"Sick\",\"Dead\"), c(\"Healthy\",\"Sick\",\"Dead\"))\n  ) %&gt;% \n    data.frame() %&gt;% \n    rownames_to_column(var = \"from\") %&gt;% mutate(name = \"P_cr\")\n  \n  \n  \n  out &lt;- bind_rows( P_st, P_cr , P_eQ)\n  return(out)\n}\n\n\n\n\nCode\ncheck_sens &lt;- function(r_HD,r_HS,r_SD,cycle) {\n  \nQ &lt;- matrix(\n    c(-(r_HS*cycle+r_HD*cycle),r_HS*cycle,r_HD*cycle,\n      0,-r_SD*cycle,r_SD*cycle,\n      0,0,0),\n      nrow=3,\n      ncol=3,\n      byrow=TRUE,\n    dimnames = list(c(\"Healthy\",\"Sick\",\"Dead\"), c(\"Healthy\",\"Sick\",\"Dead\"))\n  ) \n\n# Q_ &lt;- rbind(cbind(Q,c(r_HS*cycle,0,0)),c(0,0,0,0)) \n# Q_ &lt;- rbind(cbind(Q_,c(r_HD*cycle,0,0,0)),c(0,0,0,0,0))\n# dimnames(Q_) = list(c(\"Healthy\",\"Sick\",\"Dead\",\"accS\",\"accHD\"),\n#                    c(\"Healthy\",\"Sick\",\"Dead\",\"accS\",\"accHD\"))\n\nQ_ &lt;- Q\n\nP &lt;- Q_ %&gt;% expm() %&gt;% as.matrix() \nres &lt;- get_P(r_HS=r_HS,r_HD=r_HD,r_SD=r_SD,cycle=cycle)\n\nP_cr &lt;- res %&gt;% filter(name==\"P_cr\") %&gt;% select(from,Healthy,Sick,Dead) %&gt;% \n  data.frame() %&gt;% \n  column_to_rownames(var = \"from\") %&gt;% \n  as.matrix()\n\nP_st &lt;- res %&gt;% filter(name==\"P_st\") %&gt;% select(from,Healthy,Sick,Dead) %&gt;% \n  data.frame() %&gt;% \n  column_to_rownames(var = \"from\") %&gt;% \n  as.matrix()\n\nle1 &lt;- \n  0:(60/cycle) %&gt;% map(~(c(1000,0,0) %*% (P[1:3,1:3] %^% (.x)))) %&gt;% \n  map(~(.x %&gt;% data.frame)) %&gt;% \n  bind_rows() %&gt;% \n  as.matrix() %&gt;%  \n  {.[,-3]} %&gt;% \n  alt_simp(.,1) %&gt;% \n  {. * cycle} %&gt;% {./1000} %&gt;% \n  data.frame() %&gt;% \n  set_names(\"life_exp\")\n\nres1 &lt;- 0:(60/cycle) %&gt;% map_df(~(c(1000,0,0) %*% (P %^%.x) %&gt;% data.frame())) %&gt;% \n  mutate(cycle = 0:(60/cycle)) %&gt;% \n  select(cycle, everything()) %&gt;% \n  tibble() %&gt;% \n  tail(n=1) %&gt;% \n  bind_cols(le1) %&gt;% \n  mutate(method = \"P_eQ\") \n\nle2 &lt;- \n  0:(60/cycle) %&gt;% map(~(c(1000,0,0) %*% (P_cr[1:3,1:3] %^% (.x)))) %&gt;% \n  map(~(.x %&gt;% data.frame)) %&gt;% \n  bind_rows() %&gt;% \n   as.matrix() %&gt;%  \n  {.[,-3]} %&gt;% \n  alt_simp(.,1) %&gt;% \n  {. * cycle} %&gt;% {./1000} %&gt;% \n  data.frame() %&gt;% \n  set_names(\"life_exp\")\n  \nres2 &lt;- 0:(60/cycle) %&gt;% map_df(~(c(1000,0,0) %*% (P_cr %^%.x) %&gt;% data.frame())) %&gt;% \n  mutate(cycle = 0:(60/cycle)) %&gt;% \n  select(cycle, everything()) %&gt;% \n  tibble() %&gt;% \n  tail(n=1) %&gt;% \n  bind_cols(le2) %&gt;% \n  mutate(method = \"P_cr\")\n\n\nle3 &lt;- \n 0:(60/cycle) %&gt;% map(~(c(1000,0,0) %*% (P_st[1:3,1:3] %^% (.x)))) %&gt;% \n  map(~(.x %&gt;% data.frame)) %&gt;% \n  bind_rows() %&gt;% \n   as.matrix() %&gt;%  \n  {.[,-3]} %&gt;% \n  alt_simp(.,1) %&gt;% \n  {. * cycle} %&gt;% {./1000} %&gt;% \n  data.frame() %&gt;% \n  set_names(\"life_exp\")\n\nres3 &lt;- 0:(60/cycle) %&gt;% map_df(~(c(1000,0,0) %*% (P_st %^%.x) %&gt;% data.frame())) %&gt;% \n  mutate(cycle = 0:(60/cycle)) %&gt;% \n  select(cycle, everything()) %&gt;% \n  tibble() %&gt;% \n  tail(n=1) %&gt;% \n  bind_cols(le3) %&gt;% \n  mutate(method = \"P_st\")\n  \n  out &lt;- res1 %&gt;% bind_rows(res2) %&gt;% bind_rows(res3)\n  return(out)\n\n}"
  },
  {
    "objectID": "blog/posts/embedding/embedding-a-transition-probability-matrix.html#standard-rate-to-transition-conversion",
    "href": "blog/posts/embedding/embedding-a-transition-probability-matrix.html#standard-rate-to-transition-conversion",
    "title": "Embedding A Transition Probability Matrix for a Discrete Time Markov Model",
    "section": "Standard Rate-to-Transition Conversion",
    "text": "Standard Rate-to-Transition Conversion\nLet’s first convert the supplied rates to probabilities using the same standard formulas, as above:\n\\[\np_{HS}= 1 - e^{-r_{HS}\\cdot \\Delta t}\n\\]\n\\[\np_{HD} = 1 - e^{-r_{HD}\\cdot \\Delta t}\n\\]\nWe can also define the probability of remaining healthy (i.e., transitioning to neither the sick or dead state) as:\n\\[\np_{HH} = 1 - p_{HS} - p_{HD}= e^{-r_{HS}\\Delta t}  + e^{-r_{HD}\\Delta t} - 1\n\\]\nAnd finally the probability of dying among sick people is defined as\n\\[\np_{SD} = 1 - e^{-hr_{HD}\\cdot r_{HD}\\cdot \\Delta t}\n\\]\nFigure 6 shows the corresponding transition probability matrix:\n\n\nCode\nr_HD &lt;- 0.006\nr_SD &lt;- 10*0.006\n\nget_P(r_HS=r_HS,r_HD=r_HD,r_SD=r_SD,cycle=cycle) %&gt;% \nfilter(name==\"P_st\") %&gt;% \nselect(-name) %&gt;% \n#column_to_rownames(\"from\") %&gt;% \nmutate_at(vars(-from), ~round(.,4)) %&gt;% \ngt() %&gt;% \n  cols_label(\"from\"=\"\")\n\n\n\n\n\n\n\n\n\n\n\nHealthy\nSick\nDead\n\n\n\n\nHealthy\n0.8547\n0.1393\n0.0060\n\n\nSick\n0.0000\n0.9418\n0.0582\n\n\nDead\n0.0000\n0.0000\n1.0000\n\n\n\n\n\nFigure 6: Transition Probability Matrix Using Standard Rate-to-Probability Conversion Formulas\n\n\n\nGiven this transition probability matrix, how many healthy, sick and dead individuals do we have in our cohort after a 60-year time horizon? Figure 7 summarizes state occupancy at the end of 60 years:\n\n\nCode\nres_60yst &lt;- \n  check_sens(r_HD= r_HD, r_HS = r_HS, r_SD = r_SD, cycle=1) %&gt;% \n  filter(method==\"P_st\") \nres_60yst %&gt;% \n  select(cycle,Healthy,Sick,Dead,life_exp) %&gt;% \n  gt::gt() %&gt;% \n  sub_missing(missing_text=\"-\") %&gt;% \n  fmt_number(columns = c(Healthy,Sick,Dead,life_exp),decimals=1) %&gt;% \n  cols_label(\"life_exp\" = \"Life Expectancy\")\n\n\n\n\n\n\n\n\n\n\ncycle\nHealthy\nSick\nDead\nLife Expectancy\n\n\n\n\n60\n0.1\n43.6\n956.3\n22.1\n\n\n\n\n\nFigure 7: 1-Year Cycle\n\n\n\nAs Figure 7 shows, after 60 years, 43.6 are recorded as being in the sick state and life expectancy has reduced to 22.1 years.\nAs above, let’s now repeat the same exercise using a daily cycle length:\n\n\nCode\nres_60yst_daily &lt;- \n  check_sens(r_HD= r_HD, r_HS = r_HS, r_SD = r_SD,cycle=1/365) %&gt;% \n  filter(method==\"P_st\") \n\nres_60yst_daily %&gt;% \n  select(cycle,Healthy,Sick,Dead,life_exp) %&gt;% \n  gt::gt() %&gt;% \n  sub_missing(missing_text=\"-\") %&gt;% \n  fmt_number(columns = c(Healthy,Sick,Dead,life_exp),decimals=1) %&gt;% \n  cols_label(\"life_exp\" = \"Life Expectancy\")\n\n\n\n\n\n\n\n\n\n\ncycle\nHealthy\nSick\nDead\nLife Expectancy\n\n\n\n\n21900\n0.1\n42.6\n957.4\n21.7\n\n\n\n\n\nFigure 8: Daily Cycle\n\n\n\nBy switching to a daily cycle we now have 42.6 recorded as being in the sick state after 60 years (=21,900 days) and life expectancy is 21.7 years.\n\nSigns of Trouble\nLet’s recap what we have found after introducing background mortality as a competing risk:\n\nUsing a 1-year cycle length, life expectancy is 22.11 years.\nUsing a daily cycle length, life expectancy is 21.73 years.\n\nThe only difference above is the cycle length used, yet we obtain a 0.38 year difference in life expectancy. What causes this difference?\n\n\nDiscretizing a Continuous Time Process\nThe answer boils down to the fact that with longer cycle lengths we “hide” some deaths that occur because a full healthy  sick  dead transition occurs within a single cycle.\nWhen we use the standard rate-to-probability conversion formula (i.e., \\(p_{HS}= 1 - e^{-r_{HS}\\Delta t}\\)) we obtain the marginal probability of transition. This marginal probability reflects the union of all possible transitions that start Healthy and then transition to and from the sick state in the cycle.\nThat is, \\(p_{HS}= 1 - e^{-r_{HS}\\Delta t}\\) captures the probability of following scenarios occurring in a cycle:\n\nIndividual transitions from healthy to sick.\nIndividual transitions from healthy to sick to dead.\n\nBy including case 2 in the healthy  sick transition probability, we effectively rule out the possibility of becoming sick and dying within the same cycle. This implicit assumption means that we are no longer modeling a continuous time process, since we effectively “hide” some (quick) deaths that occur within a cycle due to the disease:\n\n\n\n\n\n\n\n\nG\n\n  \n\nHealthy\n\n Healthy   \n\nHealthy-&gt;Healthy\n\n    \n\nSick\n\n Sick   \n\nHealthy-&gt;Sick\n\n    \n\nDead\n\n Dead   \n\nHealthy-&gt;Dead\n\n    \n\nSick-&gt;Sick\n\n    \n\nSick-&gt;Dead\n\n    \n\nDead-&gt;Dead\n\n   \n\n\nFigure 9: compound Transition Patterns Using Standard Rate to Probability Conversion Formulas\n\n\n\n\nIn Figure 9, and using standard rate-to-probability conversion formulas, the recorded states of a healthy  sick  dead transition are recorded in blue; the “hidden” transition is shown in red.\n\nAlternative Rate-to-Probability Conversion\nAnother set of formulas often used to account for competing risks are as follows:\n\\[\np_{HS}= \\frac{r_{HS}}{r_{HS}+r_{HD}}\\big ( 1 - e^{-(r_{HS}+r_{HD})\\Delta t}\\big )\n\\]\n\\[\np_{HD}= \\frac{r_{HD}}{r_{HS}+r_{HD}}\\big ( 1 - e^{-(r_{HS}+r_{HD})\\Delta t}\\big )\n\\]\n\\[\np_{HH} = e^{-(r_{HS}+r_{HD})\\Delta t}\n\\]\nLet’s now use these formulas instead.\nFigure 10 shows the corresponding transition probability matrix:\n\n\nCode\nr_HD &lt;- 0.006\nr_SD &lt;- 10*0.006\n\nget_P(r_HS=r_HS,r_HD=r_HD,r_SD=r_SD,cycle=cycle) %&gt;% \nfilter(name==\"P_cr\") %&gt;% \nselect(-name) %&gt;% \n#column_to_rownames(\"from\") %&gt;% \nmutate_at(vars(-from), ~round(.,4)) %&gt;% \ngt() %&gt;% \n  cols_label(\"from\"=\"\")\n\n\n\n\n\n\n\n\n\n\n\nHealthy\nSick\nDead\n\n\n\n\nHealthy\n0.8556\n0.1389\n0.0056\n\n\nSick\n0.0000\n0.9418\n0.0582\n\n\nDead\n0.0000\n0.0000\n1.0000\n\n\n\n\n\nFigure 10: Transition Probability Matrix Using Alternative Rate-to-Probability Conversion Formulas\n\n\n\nComparing Figure 6 and Figure 10, notice that a few things have changed. First, the probability of Healthy  Sick transition declined. This would seem to be consistent with a world in which there are fewer alive sick individuals observed at the end of the cycle–which we would expect if acute illness results in a nontrivial number of quick deaths after illness onset in a cycle.\nHowever, look at the Healthy  Dead transition probability change; it went down, too. If we were recording more acute deaths from the disease, we should see more Healthy  Dead transitions from individuals sojourning through the Sick state on their way to death in a single cycle.\nWhat about state occupancy and life expectancy under different cycle lengths?\n\n\nCode\nres_60yst_cr &lt;- \n  check_sens(r_HD= r_HD, r_HS = r_HS, r_SD = r_SD, cycle=1) %&gt;% \n  filter(method==\"P_cr\") %&gt;% \n  mutate(cycle = \"1y\") %&gt;% \n  mutate(cycle_t = 60)\n\nres_60yst_daily_cr &lt;- \n  check_sens(r_HD= r_HD, r_HS = r_HS, r_SD = r_SD,cycle=1/365) %&gt;% \n  filter(method==\"P_cr\") %&gt;% \n  mutate(cycle_t = cycle) %&gt;% \n  mutate(cycle = \"Daily\")\n\nres_60yst_cr %&gt;% \n  bind_rows(res_60yst_daily_cr) %&gt;% \n  select(cycle,cycle_t,Healthy,Sick,Dead,life_exp) %&gt;% \n  gt::gt() %&gt;% \n  sub_missing(missing_text=\"-\") %&gt;% \n  fmt_number(columns = c(Healthy,Sick,Dead,life_exp),decimals=1) %&gt;% \n  cols_label(\"life_exp\" = \"Life Expectancy\")\n\n\n\n\n\n\n\n\n\n\ncycle\ncycle_t\nHealthy\nSick\nDead\nLife Expectancy\n\n\n\n\n1y\n60\n0.1\n43.9\n956.0\n22.2\n\n\nDaily\n21900\n0.1\n42.6\n957.4\n21.7\n\n\n\n\n\nFigure 11: 1-Year vs. Daily Cycle\n\n\n\nCode\ndiff_st_cr &lt;- \n  res_60yst_cr %&gt;% \n    bind_rows(res_60yst_daily_cr) %&gt;% mutate(life_exp = life_exp-lead(life_exp)) %&gt;% pull(life_exp) %&gt;% na.omit() %&gt;% as.vector()\n\n\nAgain, we have a difference in life expectancy of 0.462 years. So switching to the alternative formulas has not fundamentally solved our problem.\n\n\nHow do transition probabilities change as the Likelihood of Disease-related death varies?\nAnother way to see the issue is to plot how the transition probabilities change (or not) at different levels of disease acuity. Figure 12 plots the relevant transition probabilities under a yearly time cycle, and while allowing the underlying hazard rate of death from the disease (hr_S) to vary.\nAs the hazard rate increases, the likelihood of ending up dead within a given cycle increases. Indeed, in the most extreme case, imagine the disease has a near instantaneous death rate. In that case we should see almost no Healthy  Sick transitions within a yearly cycle, because nearly everyone who became sick within the cycle died within 1 day.\nWe see in Figure 12 that the Healthy  Sick probabilities remain flat for transitions under which background mortality is a competing event. However, the Sick  Dead transition probabilities rise as the likelihood of fatal disease increases.\n\n\nCode\n1:10 %&gt;% map(~get_P(r_HS=.15,r_HD=.006,r_SD=.006*.x,cycle=1) %&gt;% mutate(hr_S=.x)) %&gt;% \n  bind_rows() %&gt;% \n  gather(transition,value,-from,-name,-hr_S) %&gt;% \n  spread(name,value) %&gt;% \n  filter(P_cr!=1 & P_cr!=0) %&gt;% \n  gather(method,value,-from,-hr_S,-transition) %&gt;% \n    filter(method!=\"P_eQ\") %&gt;% \n  tibble() %&gt;% \n  mutate_at(vars(transition), function(x) factor(x,levels=c(\"Healthy\",\"Sick\",\"Dead\"))) %&gt;% \n  mutate_at(vars(from), function(x) factor(x,levels=c(\"Healthy\",\"Sick\",\"Dead\"),\n                                           labels=c(\"Healthy\",\"Sick\",\"Dead\"))) %&gt;% \n  filter(from!=transition) %&gt;% \n  ggplot(aes(x = hr_S, y = value)) + \n  geom_point(aes(colour=method, shape=method),size=3) + \n  scale_shape_manual(values = c(19,17)) +\n  scale_color_manual(values= c(\"blue\",\"red\")) +\n  facet_wrap(from~transition, scales=\"free\") + \n  ggthemes::theme_base() + \n  scale_x_continuous(expand = expansion(mult=.5))+\n  scale_y_continuous(expand = expansion(mult=.5))+\n  theme(legend.position = \"bottom\") +\n  directlabels::geom_dl(aes(label = glue::glue(\"  {method}\")), method=\"last.bumpup\",hjust=1) + \n  labs(x = \"hr_S (Hazard Ratio for Sick-to-Dead)\",y = \"Value\")\n\n\n\n\n\nFigure 12: Yearly Cycle - Transition Probabilities by Sick-to-Dead Hazard Rate (P_st uses standard conversion formula; P_cr uses the formula that accounts for competing risks.)\n\n\n\n\nIt is common practice to address these issues using the following guidelines:\n\nSelect a cycle length where the probability of remaining in a given state is at least 95%.\nPick a cycle length that aligns with the clinical/disease timelines of the decision problem.\n\nTreatment schedules.\nAcute vs. chronic condition.\n\n\nBut do these actually solve the issue? No. Figure 13 shows how the transition probabilities change when we switch to a daily cycle length. Again, we see the problem: as disease acuity increases, the probability of a Healthy  Dead transition does not change; even though we shortened the cycle length, we have not fundamentally addressed the issue.\n\n\nCode\n1:10 %&gt;% map(~get_P(r_HS=.15,r_HD=.006,r_SD=.006*.x,cycle=1/365) %&gt;% mutate(hr_S=.x)) %&gt;% \n  bind_rows() %&gt;% \n  gather(transition,value,-from,-name,-hr_S) %&gt;% \n  spread(name,value) %&gt;% \n  filter(P_cr!=1 & P_cr!=0) %&gt;% \n  gather(method,value,-from,-hr_S,-transition) %&gt;% \n  filter(method!=\"P_eQ\") %&gt;% \n  tibble() %&gt;% \n  mutate_at(vars(transition), function(x) factor(x,levels=c(\"Healthy\",\"Sick\",\"Dead\"))) %&gt;% \n  mutate_at(vars(from), function(x) factor(x,levels=c(\"Healthy\",\"Sick\",\"Dead\"),\n                                           labels=c(\"Healthy\",\"Sick\",\"Dead\"))) %&gt;% \n  filter(from!=transition) %&gt;% \n  ggplot(aes(x = hr_S, y = value)) + \n  geom_point(aes(colour=method, shape=method),size=3) + \n    scale_shape_manual(values = c(19,17)) +\n  scale_color_manual(values= c(\"blue\",\"red\")) +\n  facet_wrap(from~transition, scales=\"free\") + \n  ggthemes::theme_base() + \n  scale_x_continuous(expand = expansion(mult=.5))+\n  scale_y_continuous(expand = expansion(mult=.5))+\n  theme(legend.position = \"bottom\") +\n  directlabels::geom_dl(aes(label = glue::glue(\"  {method}\")), method=\"last.bumpup\",hjust=1) + \n  labs(x = \"hr_S (Hazard Ratio for Sick-to-Dead)\",y = \"Value\")\n\n\n\n\n\nFigure 13: Daily Cycle - Transition Probabilities by Sick-to-Dead Hazard Rate (P_st uses standard conversion formula; P_cr uses the formula that accounts for competing risks.)\n\n\n\n\nHow does this all translate into model outputs, such as life expectancy? Figure 14 plots life-expectancy (y-axis) against the underlying disease hazard rate for death. Each line provides the life-expectancy curve under a different cycle length, with everything else in the model held fixed.\nNot surprisingly, we see that as the likelihood of fatal disease increases, life expectancy declines.\nBut the most important takeaway is that the modeled life expectancy differs depending on the cycle length used. For a given hazard rate the underlying disease process is exactly the same – but we get different answers depending on our cycle length.\nThe pattern of results is instructive, too. Essentially, with longer cycle lengths and incorrect transition probabilities, we will “miss” more compound within-cycle Healthy  Sick  Dead transitions and instead record them as Healthy  Sick transitions. This has a net effect of “hiding” more disease-related death in our model – and life-expectancy is inflated as a result.\n\n\n\n\n\nFigure 14: Life Expectancy by Sick-to-Dead Hazard Rate and Cycle Length. The left panel uses the formula that accounts for competing risks. The right panel uses standard conversion formula."
  },
  {
    "objectID": "blog/posts/embedding/embedding-a-transition-probability-matrix.html#embed-the-transition-probability-matrix",
    "href": "blog/posts/embedding/embedding-a-transition-probability-matrix.html#embed-the-transition-probability-matrix",
    "title": "Embedding A Transition Probability Matrix for a Discrete Time Markov Model",
    "section": "1. Embed the Transition Probability Matrix",
    "text": "1. Embed the Transition Probability Matrix\nOur rate matrix Q is constructed by including the relevant transition rates in the off-diagonal cells. The diagonal of Q is the negative sum of off-diagonal elements in the same row:\n\n\n\n\n\n\n\n\n\n\nHealthy\nSick\nDead\n\n\n\n\nHealthy\n-(\\(r_{HS}\\) + \\(r_{HD}\\))\n\\(r_{HS}\\)\n\\(r_{HD}\\)\n\n\nSick\n0\n-(\\(hr_{S} \\cdot r_{HD}\\))\n\\(hr_{S} \\cdot r_{HD}\\)\n\n\nDead\n0\n0\n0\n\n\n\nHere is the rate matrix for the Healthy-Sick-Dead model:\n\n\nCode\nparams &lt;- \n  list(r_HS = 0.15,\n       r_HD = 0.006,\n       hr_S = 10,\n       cycle = 1)\n\nQ &lt;- \n  with(params,{\n    matrix(\n    c(-(r_HS*cycle+r_HD*cycle),r_HS*cycle,r_HD*cycle,\n      0,-r_SD*cycle,r_SD*cycle,\n      0,0,0),\n      nrow=3,\n      ncol=3,\n      byrow=TRUE,\n    dimnames = list(c(\"Healthy\",\"Sick\",\"Dead\"), c(\"Healthy\",\"Sick\",\"Dead\"))\n  ) \n  })\nQ\n\n\n        Healthy  Sick  Dead\nHealthy  -0.156  0.15 0.006\nSick      0.000 -0.06 0.060\nDead      0.000  0.00 0.000\n\n\nWe next embed the transition probability matrix P by taking the matrix exponential of Q:\n\nlibrary(expm)\nP &lt;- expm(Q)\nP\n\n          Healthy      Sick        Dead\nHealthy 0.8555592 0.1346958 0.009744961\nSick    0.0000000 0.9417645 0.058235466\nDead    0.0000000 0.0000000 1.000000000\n\n\nAn alternative way of exponentiating a matrix is to perform a Taylor series expansion:\n\n# Identity matrix with same dimensions and names as Q \nQ_I &lt;- diag(3)\ndimnames(Q_I) = dimnames(Q)\n\n# Note the %^% operator is in the expm package. \n\nQ2 = Q %^% 2   # Q-squared\nQ3 = Q %^% 3   # Q-cubed\nQ4 = Q %^% 4   # etc.\n\nQ_I + Q + (1/factorial(2))*Q2 + (1/factorial(3))*Q3 + (1/factorial(4))*Q4 \n\n          Healthy      Sick        Dead\nHealthy 0.8555599 0.1346947 0.009745373\nSick    0.0000000 0.9417645 0.058235460\nDead    0.0000000 0.0000000 1.000000000\n\n\nHow does this approach (P_eQ) perform relative to the other transition probability matrices (P_st and P_cr)? Figure 15 shows how the transition probabilities vary by hazard rate.\nWe can now see we’ve achieved what we need: Healthy  Dead transition probabilities that rise as the hazard rate of death from disease increases. Again, this occurs because as the likelihood of death after becoming ill increases, we increase the likelihood of a compound Healthy  Sick  Dead transition within a cycle. We need these to be recorded (accurately) as Healthy  Dead transitions, rather than Healthy  Sick transitions. Correspondingly, as the probability of a compound transition increases with an increasing hazard rate, the probability of a single Healthy  Sick transition declines; we see this in Figure 15 as well.\n\n\nCode\n1:10 %&gt;% map(~get_P(r_HS=.15,r_HD=.006,r_SD=.006*.x,cycle=1) %&gt;% mutate(hr_S=.x)) %&gt;% \n  bind_rows() %&gt;% \n  gather(transition,value,-from,-name,-hr_S) %&gt;% \n  spread(name,value) %&gt;% \n  filter(P_cr!=1 & P_cr!=0) %&gt;% \n  gather(method,value,-from,-hr_S,-transition) %&gt;% \n  #filter(method!=\"P_eQ\") %&gt;% \n  tibble() %&gt;% \n  mutate_at(vars(transition), function(x) factor(x,levels=c(\"Healthy\",\"Sick\",\"Dead\"))) %&gt;% \n  mutate_at(vars(from), function(x) factor(x,levels=c(\"Healthy\",\"Sick\",\"Dead\"),\n                                           labels=c(\"Healthy\",\"Sick\",\"Dead\"))) %&gt;% \n  filter(from!=transition) %&gt;% \n  ggplot(aes(x = hr_S, y = value)) + \n  geom_point(aes(colour=method, shape=method),size=3) + \n  scale_shape_manual(values = c(19,17,3)) +\n  facet_wrap(from~transition, scales=\"free\") + \n  ggthemes::theme_base() + \n  scale_x_continuous(expand = expansion(mult=.5))+\n  scale_y_continuous(expand = expansion(mult=.5))+\n  theme(legend.position = \"bottom\") +\n  scale_color_manual(values= c(\"blue\",\"darkgreen\",\"red\")) +\n  directlabels::geom_dl(aes(label = glue::glue(\"  {method}\")), method=\"last.bumpup\",hjust=1) + \n  labs(x = \"hr_S (Hazard Ratio for Sick-to-Dead)\",y = \"Value\")\n\n\n\n\n\nFigure 15: 1-Year Cycle - Transition Probabilities by Sick-to-Dead Hazard Rate (P_st uses standard conversion formula; P_cr uses the formula that accounts for competing risks, and P_eQ is embedded using the transition rate matrix Q.)\n\n\n\n\nWe also see that regardless of the cycle length used, we always end up with the same calculated life expectancy:\n\n\n\n\n\nFigure 16: Life Expectancy by Sick-to-Dead Hazard Rate and Cycle Length\n\n\n\n\nWe have thus “fixed” our problem of hidden disease-related deaths!\n\nWhy is this important?\nThe use of an embedded transition probability matrix is important for a number of reasons:\n\nThe Markov model accurately reflects the underlying continuous time process.\nWe get an accurate accounting of disease-related deaths.\nWe can use whatever cycle length we need – this facilitates computationally intensive processes such as probabilistic sensitivity analyses, which may not be feasible with a short (e.g., daily) cycle length.\nWe also avoid “state explosion” in the event our model has tunnel states. For example, if there is a one-year tunnel state for costs or utilities following disease onset, if we switched to a monthly or daily cycle we’d have to build in dozens or more health states into our Markov model. Beacuse we can stick with a one-year cycle, this makes use of tunnel states much more feasible.\n\nThe primary “cost” of using this approach over standard rate-to-probability conversion formulas is that we must be a bit more careful in structuring our transition probability matrix to include accumulators used to aggregate model outputs. We will cover this process in the section directly below."
  },
  {
    "objectID": "blog/posts/embedding/embedding-a-transition-probability-matrix.html#include-non-markovian-accumulators-to-record-event-transitions",
    "href": "blog/posts/embedding/embedding-a-transition-probability-matrix.html#include-non-markovian-accumulators-to-record-event-transitions",
    "title": "Embedding A Transition Probability Matrix for a Discrete Time Markov Model",
    "section": "2. Include Non-Markovian Accumulators to Record Event Transitions",
    "text": "2. Include Non-Markovian Accumulators to Record Event Transitions\nWe now have the correct transition probabilities to model the underlying continuous-time process, but how do we account for these compound transitions in our aggregation of model outputs?\nFundamentally, what we have now is a model that will correctly records the “true” number of deaths at the end of the cycle, because all the compound Healthy  Sick  Dead transitions are included in the Healthy  Dead transition probability.\nTo track the total number of transitions to Sick, we must augment our transition probability matrix with non-Markovian accumulators. This accumulator shows up as a purple edge in our model diagram below:\n\n\n\n\n\n\n\nG\n\n  \n\nHealthy\n\n Healthy   \n\nHealthy-&gt;Healthy\n\n    \n\nSick\n\n Sick   \n\nHealthy-&gt;Sick\n\n    \n\nDead\n\n Dead   \n\nHealthy-&gt;Dead\n\n    \n\nSick-&gt;Sick\n\n    \n\nSick-&gt;Dead\n\n    \n\nDead-&gt;Dead\n\n   \n\n\n\n\n\nFortunately, accumulators are easy to build in. We simply add the relevant transition rate in a new column in the transition rate matrix Q, while leaving everything else the same.\nSuppose we want to count up all the Healthy  Sick transitions in the model. To do this we simply add the appropriate transition rate (\\(r_{HS}\\)) in as an accumulator column:\n\n\n\n\n\n\n\n\n\n\n\nHealthy\nSick\nDead\naccHS\n\n\n\n\nHealthy\n-(\\(r_{HS}\\) + \\(r_{HD}\\))\n\\(r_{HS}\\)\n\\(r_{HD}\\)\n\\(r_{HS}\\)\n\n\nSick\n0\n-(\\(hr_{S} \\cdot r_{HD}\\))\n\\(hr_{S} \\cdot r_{HD}\\)\n0\n\n\nDead\n0\n0\n0\n0\n\n\naccHS\n0\n0\n0\n0\n\n\n\nNote the following:\n\nAn extra row of 0’s was added so that we balance the matrix, and ensure that we do not lose (or create!) anyone who becomes Sick.\nWe did not update the diagonal elements (i.e., the negative sum of transition rates); these stay the same as before.\nIf we wanted to add additional accumulators, we can just expand the matrix with more columns and rows as needed.\n\nHere is the augmented transition rate matrix for our example:\n\n\nCode\nQ_ &lt;- data.frame(Q)\nQ_[\"Healthy\",\"accHS\"] &lt;- params$r_HS\nQ_[\"accHS\",\"accHS\"] &lt;- 0\nQ_[is.na(Q_)] &lt;- 0\nQ_ &lt;- as.matrix(Q_)\nQ_ \n\n\n        Healthy  Sick  Dead accHS\nHealthy  -0.156  0.15 0.006  0.15\nSick      0.000 -0.06 0.060  0.00\nDead      0.000  0.00 0.000  0.00\naccHS     0.000  0.00 0.000  0.00\n\n\nWe next embed the transition probability matrix, as before:Notice that the accumulator (accHS) value is identical to the Healthy  Sick transition probability we obtained using the alternative rate-to-probability conversion formula that accounted for competing risks (e.g., see Figure 10).\n\nP_ &lt;- expm(Q_)\nP_\n\n          Healthy      Sick        Dead     accHS\nHealthy 0.8555592 0.1346958 0.009744961 0.1388854\nSick    0.0000000 0.9417645 0.058235466 0.0000000\nDead    0.0000000 0.0000000 1.000000000 0.0000000\naccHS   0.0000000 0.0000000 0.000000000 1.0000000\n\n\nUsing the accumulator we can accurately count up how many individuals transition to the Sick state over our time horizon:\n\nm_trace &lt;- \n  0:(horizon/cycle) %&gt;% \n  map_df(~(c(1000,0,0,0) %*% (P_%^%.x) %&gt;% data.frame()))\n\n\n\nCode\nm_trace[3,] %&gt;% \n  round(.,2) %&gt;% \n  rownames_to_column(var=\"cycle\") %&gt;% \n  select(-cycle) %&gt;% \n  kable() %&gt;% \n  kableExtra::kable_styling()\n\n\n\n\n\n\n\n\nHealthy\n\n\nSick\n\n\nDead\n\n\naccHS\n\n\n\n\n\n\n731.98\n\n\n242.09\n\n\n25.93\n\n\n257.71\n\n\n\n\n\nFigure 17: State Occupancy after Two Years\n\n\n\nWe see in Figure 17 that after 2 years, 257.7 people (out of 1,000) have become sick, which is slightly less than the 259 who became sick after 2 years in our world without death as a competing risk. Moreover, we see that state occupancy in the Sick category is lower, at 242.1. This lower value reflects the fact some people had a compound transition through Sick and ended up dead in the same cycle. The difference (15.6) amounts to the total number of individual deaths we “hid” in the model when we used the incorrect rate-to-probability conversion formulas.This, of course, makes sense, since there are a small number of people who die before they could become ill once we add background mortality to the model"
  },
  {
    "objectID": "blog/posts/signs-of-trouble/signs-of-trouble.html",
    "href": "blog/posts/signs-of-trouble/signs-of-trouble.html",
    "title": "Signs of Trouble",
    "section": "",
    "text": "The objective of this blog post is to demonstrate how state occupancy will differ over different cycle lengths when using standard conversion formulas in the presence of competing risks. In the embedded version, however, changing the cycle length does not affect state occupancy estimates."
  },
  {
    "objectID": "blog/posts/signs-of-trouble/signs-of-trouble.html#using-conversion-formulas",
    "href": "blog/posts/signs-of-trouble/signs-of-trouble.html#using-conversion-formulas",
    "title": "Signs of Trouble",
    "section": "1. Using Conversion Formulas",
    "text": "1. Using Conversion Formulas\n\nConvert each annual transition probability to a rate using \\(r = -ln(1 - p)\\).\nConvert the rate to the model timestep using \\(1 - exp(-rt)\\), where \\(t\\) is the timestep (e.g., \\(t = \\frac{1}{12}\\) for a monthly cycle)\nConstruct the transition probability matrix using the converted probabilities.\n\n\n\nCode\nmPt &lt;- function(t, params) {\n    lapply(t, function(tt){\n        \n        current_age &lt;- params$Initial_age  +  (tt)*params$cycle - 1 \n\n        tpDn_lookup &lt;-\n            c(\"(34,44]\" = 0.0017,\n              \"(44,54]\" = 0.0044,\n              \"(54,64]\" = 0.0138,\n              \"(64,74]\" = 0.0379,\n              \"(74,84]\" = 0.0912,\n              \"(84,100]\" = 0.1958)\n        \n        age_grp &lt;- cut(current_age, \n                       breaks = c(34,44,54,64,74,84,100))\n        \n        tpDn &lt;- tpDn_lookup[age_grp]\n        tpProg_ &lt;- params$tpProg * (tt * params$cycle )\n        tpDcm_ &lt;- params$tpDcm \n        \n        rDn &lt;- -log(1 - tpDn)\n        rProg_ &lt;- -log(1 - tpProg_)\n        rDcm_ &lt;- -log(1 - tpDcm_)\n        \n        tpDn &lt;- 1 - exp(-rDn * params$cycle)\n        tpProg_ &lt;- 1 - exp(-rProg_ * params$cycle)\n        tpDcm_ &lt;- 1 - exp(-rDcm_ * params$cycle)\n        \n        effect_ &lt;- params$effect\n        n_states_ &lt;- params$n_states\n        s_names_ &lt;- params$s_names\n        t_names_ &lt;- params$t_names\n        n_treatments_ &lt;- params$n_treatments\n        \n        mP_ &lt;- \n            array(data = c(0, 0, 0,0,\n                           tpProg_, 0, 0,0,\n                           0,tpDcm_,0,0,\n                           tpDn , tpDn, 0,0,\n                           \n                           0, 0, 0,0,\n                           tpProg_*(1-effect_), 0, 0,0,\n                           0,tpDcm_,0,0,\n                           tpDn, tpDn,0, 0),\n                  dim = c(n_states_, n_states_, n_treatments_),\n                  dimnames = list(from = s_names_,\n                                  to = s_names_,\n                                  t_names_))\n        diag(mP_[,,1]) &lt;-  # Diagonal of transition probability matrix is 1 minus off-diagonal sum\n            1 - rowSums(mP_[,,1])\n        diag(mP_[,,2]) &lt;- \n            1 - rowSums(mP_[,,2])\n        \n        mP &lt;- # This turns the named array into a simpler list object\n            apply(mP_,3,function(x) x, simplify = FALSE)\n\n        return(mP)\n    })\n}"
  },
  {
    "objectID": "blog/posts/signs-of-trouble/signs-of-trouble.html#using-transition-rate-matrix-embedding",
    "href": "blog/posts/signs-of-trouble/signs-of-trouble.html#using-transition-rate-matrix-embedding",
    "title": "Signs of Trouble",
    "section": "2. Using Transition Rate Matrix Embedding",
    "text": "2. Using Transition Rate Matrix Embedding\n\nConvert each annual transition probability to a rate using \\(r = -ln(1 - p)\\).\nUse these rates to fill out the Markovian transition rate matrix mR\n\nDiagonal of mR is the negative row sum of off-diagonal elements.\n\nAugment the transition rate matrix with non-Markovian accumulators and transition/tunnel states.\nEmbed the transition rate matrix into the time step using \\(mP = exp(mR*t)\\), where \\(t\\) is the timestep (e.g., \\(t = \\frac{1}{12}\\) for a monthly cycle).\n\n\n\nCode\nmPt_embedded &lt;- function(t,params) {\n    lapply(t, function(tt){\n        \n        current_age &lt;- params$Initial_age  + (tt)*params$cycle - 1\n        cycle = tt\n        cycle_years &lt;- ceiling(tt * params$cycle)\n            \n        tpDn_lookup &lt;-\n            c(\"(34,44]\" = 0.0017,\n              \"(44,54]\" = 0.0044,\n              \"(54,64]\" = 0.0138,\n              \"(64,74]\" = 0.0379,\n              \"(74,84]\" = 0.0912,\n              \"(84,100]\" = 0.1958)\n        \n        age_grp &lt;- cut(current_age, \n                       breaks = c(34,44,54,64,74,84,100))\n        tpDn &lt;- tpDn_lookup[age_grp]\n        \n        tpProg_ &lt;- params$tpProg * (cycle_years)\n        tpDcm_ &lt;- params$tpDcm \n        effect_ &lt;- params$effect\n        n_states_ &lt;- params$n_states\n        s_names_ &lt;- params$s_names\n        t_names_ &lt;- params$t_names\n        n_treatments_ &lt;- params$n_treatments\n        \n        mR_ &lt;- \n            array(data = c(0, 0, 0,0,\n                                   -log(1-tpProg_), 0, 0,0,\n                                   0,-log(1-tpDcm_),0,0,\n                           -log(1 - tpDn),  -log(1 - tpDn), 0,0,\n                           \n                                   0, 0, 0,0,\n                                   -log(1-(tpProg_*(1-effect_))), 0, 0,0,\n                                   0,-log(1-tpDcm_),0,0,\n                           -log(1 - tpDn),  -log(1 - tpDn),0, 0),\n                          dim = c(n_states_, n_states_, n_treatments_),\n                          dimnames = list(from = s_names_,\n                                          to = s_names_,\n                                          t_names_))\n\n        mR_ &lt;- apply(mR_,3,function(x){\n            diag(x) &lt;- -rowSums(x)\n            x\n        },simplify=FALSE)\n        \n        ###############################\n        # Add Non-Markovian Components\n        ###############################\n        \n        mR &lt;- lapply(mR_,function(x){\n            r_ &lt;- nrow(x)\n            add_ &lt;- length(params$a_names)   + length(params$tunnel_names) + 1\n            \n            new_row_names &lt;- c(rownames(x), params$a_names,params$tunnel_names,\"XX\")\n            new_col_names &lt;- c(colnames(x), params$a_names,params$tunnel_names,\"XX\")\n            # Expand matrix\n            x &lt;- cbind(x,  matrix(rep(0, r_ * add_), nrow=r_))\n            x  &lt;- rbind(x, matrix(rep(0, add_ * (r_+add_)), nrow=add_))\n            \n            rownames(x) &lt;- new_row_names\n            colnames(x) &lt;- new_col_names\n            \n            x[\"Asympt\",\"accProgressive\"] = x[\"Asympt\",\"Progressive\"]\n            x[\"Asympt\",\"trProgressive\"] = x[\"Asympt\",\"Progressive\"]\n            x[\"Progressive\",\"trDeadCause\"] = x[\"Progressive\",\"DeadCause\"] \n            x\n        })\n        \n        mP_ &lt;- # Embed the transition probability matrix\n            lapply(mR,function(x) expm(x * params$cycle))\n                \n        mP &lt;- lapply(mP_,function(x){\n            # Don't allow the transition columns to remain...\n            x[\"trDeadCause\",\"trDeadCause\"] = 0\n            x[\"trProgressive\",\"trProgressive\"] = 0\n            # The receiving bucket was required for embedding, but is no longer needed\n            x[-which(rownames(x)==\"XX\"),-which(colnames(x)==\"XX\")]    \n        }) \n        \n        \n    })\n}"
  },
  {
    "objectID": "blog/posts/signs-of-trouble/signs-of-trouble.html#using-conversion-formulas-1",
    "href": "blog/posts/signs-of-trouble/signs-of-trouble.html#using-conversion-formulas-1",
    "title": "Signs of Trouble",
    "section": "1. Using Conversion Formulas",
    "text": "1. Using Conversion Formulas\n\n\nCode\nsim_cohort &lt;- function(params) {\n    \n    mP &lt;- mPt(1:(params$n_cycles-1),params)\n    \n    tr &lt;-\n        mP %&gt;% transpose() %&gt;% \n        map(~({\n            tr_ &lt;- t(c(\"Asympt\" = params$n_cohort, \"Progressive\" = 0, \"DeadCause\" = 0, \"Dead\" = 0))\n            do.call(rbind,lapply(.x, function(tp) {\n                tr_ &lt;&lt;- tr_ %*% tp\n            }))\n        }))\n    tr &lt;-  \n        tr %&gt;% \n        map(~({\n            .x &lt;- rbind(t(c(params$n_cohort,0,0,0)),.x)\n        }))\n    \n    arr &lt;-\n        mP %&gt;% transpose() %&gt;% \n        map(~({\n            tr_ &lt;- t(c(\"Asymptomatic_disease\" = params$n_cohort, \"Progressive_disease\" = 0, \"DeadCause\" = 0, \"Dead\" = 0))\n            arr_ &lt;- diag(as.vector(tr_))\n            do.call(rbind,lapply(.x, function(tp) {\n                tr_ &lt;&lt;- tr_ %*% tp\n                arr_ &lt;&lt;- diag(as.vector(tr_)) %*% tp\n                arr_\n            }))\n        }))\n    arr &lt;- \n        arr %&gt;% \n        map(~({\n            .x &lt;- rbind(diag(c(params$n_cohort,0,0,0)),.x)\n        }))\n    \n    arr &lt;- arr %&gt;% map(~({\n        .x %&gt;% data.frame() %&gt;% \n            mutate(cycle = sort(rep(1:params$n_cycles,params$n_states))) %&gt;% \n            group_by(cycle) %&gt;% \n            nest()\n    }))\n    \n    return(list(trace = tr, array = arr))\n}\n\nmarkov_result &lt;-\n    sim_cohort(params)\nmarkov_result12 &lt;- \n    sim_cohort(params12)\nmarkov_result365 &lt;- \n    sim_cohort(params365)\n\nmarkov_result$trace %&gt;% \n    map(~(.x %&gt;% data.frame() %&gt;% \n              mutate(cycle = (row_number()-1)))) %&gt;% \n    bind_rows(.id = \"strategy\") %&gt;% \n    mutate(cycle = cycle * params$cycle) %&gt;% \n    mutate(cycle_length = paste0(params$cycle))  %&gt;% \n    bind_rows(\n        markov_result12$trace %&gt;% \n        map(~(.x %&gt;% data.frame() %&gt;% \n                  mutate(cycle = (row_number()-1)))) %&gt;% \n        bind_rows(.id = \"strategy\") %&gt;% \n        mutate(cycle = cycle * params12$cycle) %&gt;% \n        mutate(cycle_length = paste0(params12$cycle))\n    ) %&gt;% \n     bind_rows(\n        markov_result365$trace %&gt;% \n        map(~(.x %&gt;% data.frame() %&gt;% \n                  mutate(cycle = (row_number()-1)))) %&gt;% \n        bind_rows(.id = \"strategy\") %&gt;% \n        mutate(cycle = cycle * params365$cycle) %&gt;% \n        mutate(cycle_length = paste0(params365$cycle))\n    ) %&gt;%\n    mutate(cycle_length = factor(round(as.numeric(paste0(cycle_length)),2), labels = c(\"Day\",\"Month\",\"Year\"))) %&gt;% \n    gather(state,value,-strategy,-cycle,-cycle_length) %&gt;% \n    ggplot(aes(x = cycle, y = value, colour = state ,lty=cycle_length)) + \n    geom_line() +\n    facet_grid(~strategy) +\n    hrbrthemes::theme_ipsum(base_family = \"Arial\") + \n    ggsci::scale_color_aaas(name=\"\") + \n    theme(legend.position = \"top\") +\n    geom_dl(method = list(\"last.bumpup\",hjust=1,vjust=-1),aes(label = state)) +\n    geom_dl(method = list(\"first.bumpup\",hjust=0,vjust=-1),aes(label = state))\n\n\n\n\n\n\n\n\n\nAs the figure shows, state occupancy differs across the various cycle lengths."
  },
  {
    "objectID": "blog/posts/signs-of-trouble/signs-of-trouble.html#using-embedding",
    "href": "blog/posts/signs-of-trouble/signs-of-trouble.html#using-embedding",
    "title": "Signs of Trouble",
    "section": "2. Using Embedding",
    "text": "2. Using Embedding\n\n\nCode\nsim_cohort_emb &lt;- function(params) {\n    \n    mP &lt;- mPt_embedded(1:(params$n_cycles-1),params)\n    \n    tr &lt;-\n        mP %&gt;% transpose() %&gt;% \n        map(~({\n            tr_ &lt;- t(c(\"Asymptomatic_disease\" = params$n_cohort, \"Progressive_disease\" = 0, \"DeadCause\" = 0, \"Dead\" = 0,\n                       \"accProgressive\" = 0, \"trProgressive\" = 0, \"trDeadCause\" = 0))\n            do.call(rbind,lapply(.x, function(tp) {\n                tr_ &lt;&lt;- tr_ %*% tp\n            }))\n        }))\n    tr &lt;-  \n        tr %&gt;% \n        map(~({\n            .x &lt;- rbind(t(c(params$n_cohort,0,0,0,rep(0,length(c(params$a_names,params$t_names))))),.x)\n        }))\n    \n    arr &lt;-\n        mP %&gt;% transpose() %&gt;% \n        map(~({\n            tr_ &lt;- t(c(\"Asymptomatic_disease\" = params$n_cohort, \"Progressive_disease\" = 0, \"DeadCause\" = 0, \"Dead\" = 0, \n                       \"accProgressive\" = 0, \"trProgressive\" = 0, \"trDeadCause\" = 0))\n            arr_ &lt;- diag(as.vector(tr_))\n            do.call(rbind,lapply(.x, function(tp) {\n                tr_ &lt;&lt;- tr_ %*% tp\n                arr_ &lt;&lt;- diag(as.vector(tr_)) %*% tp\n                arr_\n            }))\n        }))\n    arr &lt;- \n        arr %&gt;% \n        map(~({\n            .x &lt;- rbind(diag(c(params$n_cohort,0,0,0,rep(0,length(c(params$a_names,params$t_names))))),.x)\n        }))\n    \n   \n    arr &lt;- arr %&gt;% map(~({\n        .x %&gt;% data.frame() %&gt;% \n            mutate(cycle = sort(rep(1:params$n_cycles,params$n_states+length(c(params$a_names,params$t_names))))) %&gt;% \n            group_by(cycle) %&gt;% \n            nest()\n    }))\n    \n    return(list(trace = tr, array = arr))\n}\n\nmarkov_result_emb &lt;-\n    sim_cohort_emb(params)\nmarkov_result_emb12 &lt;-\n    sim_cohort_emb(params12)\nmarkov_result_emb365 &lt;-\n    sim_cohort_emb(params365)\n\nmarkov_result_emb$trace %&gt;% \n    map(~(.x %&gt;% data.frame() %&gt;% \n              mutate(cycle = (row_number()-1)))) %&gt;% \n    bind_rows(.id = \"strategy\") %&gt;% \n    mutate(cycle = cycle * params$cycle) %&gt;% \n    mutate(cycle_length = paste0(params$cycle))  %&gt;% \n    bind_rows(\n        markov_result_emb12$trace %&gt;% \n        map(~(.x %&gt;% data.frame() %&gt;% \n                  mutate(cycle = (row_number()-1)))) %&gt;% \n        bind_rows(.id = \"strategy\") %&gt;% \n        mutate(cycle = cycle * params12$cycle) %&gt;% \n        mutate(cycle_length = paste0(params12$cycle))\n    ) %&gt;% \n    bind_rows(\n        markov_result_emb365$trace %&gt;% \n        map(~(.x %&gt;% data.frame() %&gt;% \n                  mutate(cycle = (row_number()-1)))) %&gt;% \n        bind_rows(.id = \"strategy\") %&gt;% \n        mutate(cycle = cycle * params365$cycle) %&gt;% \n        mutate(cycle_length = paste0(params365$cycle))\n    ) %&gt;%   \n    select(-starts_with(\"tr\"),-starts_with(\"acc\")) %&gt;% \n    mutate(cycle_length = factor(round(as.numeric(paste0(cycle_length)),2), labels = c(\"Day\",\"Month\",\"Year\"))) %&gt;% \n    gather(state,value,-strategy,-cycle,-cycle_length) %&gt;% \n    ggplot(aes(x = cycle, y = value, colour = state ,lty=cycle_length)) + \n    geom_line() +\n    facet_grid(~strategy) +\n    hrbrthemes::theme_ipsum(base_family = \"Arial\") + \n    ggsci::scale_color_aaas(name=\"\") + \n    theme(legend.position = \"top\") +\n    geom_dl(method = list(\"last.bumpup\",hjust=1,vjust=-1),aes(label = state)) +\n    geom_dl(method = list(\"first.bumpup\",hjust=0,vjust=-1),aes(label = state))\n\n\n\n\n\n\n\n\n\nThe figure clearly shows that changing the cycle length does not affect the state occupancy estimates."
  },
  {
    "objectID": "blog/index.html",
    "href": "blog/index.html",
    "title": "Health Economics Workshop Blog",
    "section": "",
    "text": "Basic Markov Modeling in R\n\n\nReplication of Green et al (2023) Results\n\n\n\n\n\n\n\n \n\n\n\n\n  \n\n\n\n\nBackwards Conversion\n\n\n\n\n\n\n\n\n\n\n \n\n\n\n\n  \n\n\n\n\nExtending the Transition Matrix\n\n\nIncluding Non-Markovian Accumulators and Transition States\n\n\n\n\n\n\n\n \n\n\n\n\n  \n\n\n\n\nEmbedding A Transition Probability Matrix for a Discrete Time Markov Model\n\n\n\n\n\n\n\n\n\n\n \n\n\n\n\n  \n\n\n\n\nSigns of Trouble\n\n\nChanging Cycle Lengths\n\n\n\n\n\n\n\n \n\n\n\n\nNo matching items"
  },
  {
    "objectID": "slides/00_welcome-and-intros.html#welcome-to-berlin",
    "href": "slides/00_welcome-and-intros.html#welcome-to-berlin",
    "title": "Welcome and Introductions",
    "section": "Welcome to Berlin!",
    "text": "Welcome to Berlin!"
  },
  {
    "objectID": "slides/00_welcome-and-intros.html#learning-objectives",
    "href": "slides/00_welcome-and-intros.html#learning-objectives",
    "title": "Welcome and Introductions",
    "section": "Learning Objectives",
    "text": "Learning Objectives\n\nUnderlying robust property of decision modeling.\nUnderstand options for modeling background mortality based on life tables and parametric mortality models.\nConstruct a cause-deleted life table to model cause-specific and non-cause-specific death."
  },
  {
    "objectID": "slides/00_welcome-and-intros.html#the-big-picture",
    "href": "slides/00_welcome-and-intros.html#the-big-picture",
    "title": "Welcome and Introductions",
    "section": "The Big Picture",
    "text": "The Big Picture\n\nDecision thresholds methods, e.g. ICER, NMB, NHB all involve comparing a model run versus a reference run of the same model.\nFor example, a model of \\(f_{cost}\\) and \\(f_{qaly}\\) are run versus \\(\\theta_{ref}\\) and \\(\\theta_{target}\\).\nThese runs will have error due to misspecification, and in differencing the error can mostly cancel. Let \\(g\\) represent the truth, thus \\(f(\\theta) = g(\\theta)+\\epsilon_{\\theta}\\)."
  },
  {
    "objectID": "slides/00_welcome-and-intros.html#the-hopeful-big-picture",
    "href": "slides/00_welcome-and-intros.html#the-hopeful-big-picture",
    "title": "Welcome and Introductions",
    "section": "The Hopeful Big Picture",
    "text": "The Hopeful Big Picture\n\\[\\text{ICER} = \\frac{f_{cost}(\\theta_{target}) - \\epsilon_{ct} - f_{cost}(\\theta_{ref}) + \\epsilon_{cr}}{f_{qaly}(\\theta_{target}) - \\epsilon_{qt} - f_{qaly}(\\theta_{ref}) + \\epsilon_{qr}}\\]\n\nIf \\(\\epsilon_{ct} \\sim \\epsilon_{cr}\\) and \\(\\epsilon_{qt} \\sim \\epsilon_{qr}\\) then the model errors cancel and this approaches the true model.\nThe decision threshold is robust in this case even when model run results are biased!\nWe will explore this periodically today.\n\n\n\nBack to Website"
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#scenario",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#scenario",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "Scenario",
    "text": "Scenario\n\nYour model has a rate rH_CVD and you want to define a probabilistic sensitivity analysis (PSA) distribution around it."
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#common-psa-distributions",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#common-psa-distributions",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "Common PSA Distributions",
    "text": "Common PSA Distributions\n\n\n\nParameter Type\nDistribution\n\n\n\n\nProbability\nbeta\n\n\nRate\ngamma\n\n\nUtility weight\nbeta\n\n\nRight skew (e.g., cost)\ngamma, lognormal\n\n\nRelative risks or hazard ratios\nlognormal\n\n\nOdds Ratio\nlogistic"
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#normal-distribution-analytic",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#normal-distribution-analytic",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "Normal Distribution Analytic",
    "text": "Normal Distribution Analytic\nLet \\(x_1\\) and \\(x_2\\) represent desired end points at some confidence interval \\(p_1\\) and \\(p_2\\). For 95% CI, \\(p_1=0.025\\) and \\(p_2=0.975\\)\n\\[ \\sigma = \\frac{x_2 - x_1}{\\Phi^{-1}(p_2)-\\Phi^{-1}(p_1)}\\]\n\\[\\mu = \\frac{x_1\\Phi^{-1}(p_2)-x_2\\Phi^{-1}(p_1)}{\\Phi^{-1}(p_2)-\\Phi^{-1}(p_1)}\\]"
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#normal-distribution-example",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#normal-distribution-example",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "Normal Distribution Example",
    "text": "Normal Distribution Example\n\nparam_normal &lt;- function(x1,x2,p1,p2) {\n  sigma &lt;- (x2 - x1) / (qnorm(p2)-qnorm(p1))\n  mu &lt;- (x1*qnorm(p2)-x2*qnorm(p1))/(qnorm(p2)-qnorm(p1));\n  c(\"mu\" = mu, \"sigma\" = sigma)\n}\nparam_normal(x1 = 0.91, p1 = 0.025, x2 = 1.69, p = 0.975)\n\n     mu   sigma \n1.30000 0.19898"
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#gamma-example",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#gamma-example",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "Gamma Example",
    "text": "Gamma Example\n\ngamma_fn &lt;- function(x1, p1, x2, p2, alpha)\n  x1*qgamma(p2,shape = alpha) - x2*qgamma(p1, shape = alpha)\n\nparam_gamma &lt;- function(x1,x2,p1,p2,range) {\n    alpha &lt;- uniroot(function(a) gamma_fn(x1,p1,x2,p2,a),range)$root\n    beta  &lt;- x1 / qgamma(p1,alpha)\n    c(\"alpha\" = alpha, \"beta\" = beta)\n}\n\nparam_gamma(x1=0.91, p1=0.025, x2=1.69, p2=0.975, range = c(1,100))\n\n    alpha      beta \n40.586498  0.031301"
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#general-optimization-technique",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#general-optimization-technique",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "General Optimization Technique",
    "text": "General Optimization Technique\n\n\nGeneral solution, requires cumulative distribution function (CDF), \\(F\\).\nhttps://hwborchers.lima-city.de/Presents/ROptimSlides4.pdf for optimization tutorial in R\n\n\n\\[\\min_{\\vec{\\theta} \\in \\mathcal{R}}\\,\\, (F(x_1|\\vec{\\theta})-p_1)^2+(F(x_2|\\vec{\\theta})-p_2)^2\\]"
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#normal-via-optim",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#normal-via-optim",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "Normal via Optim",
    "text": "Normal via Optim\n\nExpected 1.30000 0.19898\nNot the right answer!\n\n\nlibrary(pracma)\nnorm &lt;- function(x1, p1, x2, p2, mu, sigma)\n (pnorm(x1, mu, sigma)-p1)^2 +\n (pnorm(x2, mu, sigma)-p2)^2\n\nfn &lt;- function(x) norm(0.91, 0.025, 1.69, 0.975, x[1], x[2])\n\noptim(c(0.5, 0.1),\n      fn,\n      gr = function(x) pracma::grad(fn, x),\n      lower=c(-Inf, 1e-4),\n      method = \"L-BFGS-B\",\n      control=list(factr=1e-10, maxit=100))$par\n\n[1] 1.0721 0.0001"
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#normal-via-optim-1",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#normal-via-optim-1",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "Normal via Optim",
    "text": "Normal via Optim\n\n\nNote that the function is on the probability scale.\nWe have seen issues with probability before.\nNote the gradient of the tails."
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#stable-optimization",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#stable-optimization",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "Stable Optimization",
    "text": "Stable Optimization\n\n\nAnalytically correct formula is not numerically stable.\nTransfinite scaling stabilizes optimization.\nFor probabilities, this is the \\(\\text{logit}(p)=\\log \\frac{p}{1-p}=\\log p - \\log (1-p)\\).\nTweaking parameters to converge can still happen.\nExample of theory versus practice.\n\n\n\\[\\min_{\\vec{\\theta} \\in \\mathcal{R}} \\sum_{i \\in 1,2}\\,\\, (\\text{logit} (F(x_i|\\vec{\\theta}))-\\text{logit} (p_i))^2\\]"
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#transfinite-example",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#transfinite-example",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "Transfinite Example",
    "text": "Transfinite Example\n\nTf &lt;- function(x, mu, sigma) # Stable Logit for *any* distribution\n    pnorm(x, mu, sigma, log=TRUE) -\n    pnorm(x, mu, sigma, log=TRUE, lower.tail=FALSE)\n\nnorm &lt;- function(x1, p1, x2, p2, mu, sigma)\n (Tf(x1, mu, sigma)-(log(p1)-log(1-p1)) )^2 +\n (Tf(x2, mu, sigma)-(log(p2)-log(1-p2)) )^2\n\nfn &lt;- function(x) norm(0.91, 0.025, 1.69, 0.975, x[1], x[2])\n\noptim(c(0.5, 0.1),\n      fn,\n      gr = function(x) pracma::grad(fn, x),\n      lower=c(-Inf, 1e-5),\n      method = \"L-BFGS-B\",\n      control=list(factr=1e-10, maxit=100))$par\n\n[1] 1.30000 0.19898"
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#summary-on-distribution-fitting",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#summary-on-distribution-fitting",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "Summary on Distribution Fitting",
    "text": "Summary on Distribution Fitting\n\nUse analytical formulas if they exist.\nOptimize on \\(\\text{logit}\\) scale.\nAgain, avoid \\(\\log\\) on probabilities, use log=TRUE.\nPlot results for visual check."
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#what-is-a-copula",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#what-is-a-copula",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "What is a Copula?",
    "text": "What is a Copula?\n\nThe binding “glue” between correlated variables."
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#copulas-and-psa-sampling",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#copulas-and-psa-sampling",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "Copulas and PSA Sampling",
    "text": "Copulas and PSA Sampling\nWe typically draw PSA samples from the marginal distribution of each variable:\n\\[\nF_1(x_1),  ..., F_d(x_d)\n\\]"
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#copulas-and-psa-sampling-1",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#copulas-and-psa-sampling-1",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "Copulas and PSA Sampling",
    "text": "Copulas and PSA Sampling\nCopulas allow us to sample from the joint distribution:\n\\[\nF(x_1,...,x_d) = C \\big ( F_1(x_1), ..., F_d(x_d) \\big )\n\\]\n(This is a result of Sklar [1959].)"
  },
  {
    "objectID": "slides/04_incorporating-new-evidence-and-uncertainty.html#copulas-and-psa-sampling-2",
    "href": "slides/04_incorporating-new-evidence-and-uncertainty.html#copulas-and-psa-sampling-2",
    "title": "Incorporating New Evidence and Uncertainty",
    "section": "Copulas and PSA Sampling",
    "text": "Copulas and PSA Sampling\n\nCopula: a multivariate cumulative distribution function with uniform marginals.\n\n\n\nBack to Website"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#learning-objectives",
    "href": "slides/03_advanced-bookkeeping.html#learning-objectives",
    "title": "Advanced Bookkeeping",
    "section": "Learning Objectives",
    "text": "Learning Objectives\n\nEstablish the transition rate matrix as the central “hub” of the modeling process.\nInclude transition states and accumulators to accurately track and count events, costs, and QALYs.\nBackwards convert an existing Markov model to facilitate new health states, new strategies, or new settings."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-rate-matrix",
    "href": "slides/03_advanced-bookkeeping.html#transition-rate-matrix",
    "title": "Advanced Bookkeeping",
    "section": "Transition Rate Matrix",
    "text": "Transition Rate Matrix\n\n\nThe central “hub” of a Markov model.\nStraightforward to convert rate matrix into a transition probability matrix.\nFacilitates modeling using alternative techniques:\n\nContinuous time Markov\nDiscrete event simulation"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-rate-matrix-1",
    "href": "slides/03_advanced-bookkeeping.html#transition-rate-matrix-1",
    "title": "Advanced Bookkeeping",
    "section": "Transition Rate Matrix",
    "text": "Transition Rate Matrix\n\nThe “workshop” where you can include additional health states, new evidence, change cycle lengths, etc.\nEnsures that results obtained via discrete time Markov model will match those under an identical model but different method (e.g., DES)."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#what-they-didnt-teach-you",
    "href": "slides/03_advanced-bookkeeping.html#what-they-didnt-teach-you",
    "title": "Advanced Bookkeeping",
    "section": "What they didn’t teach you",
    "text": "What they didn’t teach you\n\nThe transition rate matrix is also essential for accurate and transparent accounting of costs and QALYs."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#what-well-teach-you",
    "href": "slides/03_advanced-bookkeeping.html#what-well-teach-you",
    "title": "Advanced Bookkeeping",
    "section": "What we’ll teach you",
    "text": "What we’ll teach you\n\nWe’ll demonstrate how to augment the matrix with non-Markovian elements using the basic CVD model from the last session.\nWe’ll show you how to backwards convert an existing transition probability matrix into a continuous generator (rate) matrix.\nWe’ll then replicate and extend a recent didactic model (Green et al. 2023) in an applied case study using these methods."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#cvd-model-1",
    "href": "slides/03_advanced-bookkeeping.html#cvd-model-1",
    "title": "Advanced Bookkeeping",
    "section": "CVD Model",
    "text": "CVD Model\n\n\nLet’s quickly build up the basic CVD model again."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#cvd-model-2",
    "href": "slides/03_advanced-bookkeeping.html#cvd-model-2",
    "title": "Advanced Bookkeeping",
    "section": "CVD Model",
    "text": "CVD Model\n\n\n\n\n\n\n\nG\n\n  \n\nHealthy\n\n Healthy   \n\nHealthy-&gt;Healthy\n\n    \n\nCVD\n\n CVD   \n\nHealthy-&gt;CVD\n\n  r_H_CVD = 0.15   \n\nDead\n\n Dead   \n\nHealthy-&gt;Dead\n\n  r_HD=0.01   \n\nCVD-&gt;CVD\n\n    \n\nCVD-&gt;Dead\n\n   hr_CVD * r_HD hr_CVD=10   \n\nDead-&gt;Dead"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#parameterize",
    "href": "slides/03_advanced-bookkeeping.html#parameterize",
    "title": "Advanced Bookkeeping",
    "section": "Parameterize",
    "text": "Parameterize\n\nparams = \n  list(\n    t_names = c(\"natural_history\"),           # Strategy names. \n    n_treatments = 1,                         # Number of treatments\n    s_names  = c(\"Healthy\", \"CVD\", \"Dead\"),   # State names\n    n_states = 3,                             # Number of states\n    n_cohort = 1,                             # Cohort size\n    n_cycles = 100,                           # Number of cycles in model.  \n    cycle = 1,                                # Cycle length\n    initial_age = 55,                         # Cohort starting age\n    r_H_CVD = 0.15,                           # Rate of healthy -&gt; CVD\n    hr_CVD = 10,                              # Hazard Ratio: CVD Death\n    r_H_D = 0.01                              # Rate of healthy -&gt; dead\n  )"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-rate-matrix-2",
    "href": "slides/03_advanced-bookkeeping.html#transition-rate-matrix-2",
    "title": "Advanced Bookkeeping",
    "section": "Transition Rate Matrix",
    "text": "Transition Rate Matrix\n\nparams$mR &lt;- \n  with(params,{\n    r_CVD_D &lt;- hr_CVD * r_H_D\n    R_ &lt;- \n      array(data = c(0, 0, 0,  \n                 r_H_CVD,0, 0,\n                 r_H_D,r_H_D + r_CVD_D,0,\n                 r_H_D, 0,0),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n    R &lt;- apply(R_,3, simplify=FALSE,function(x) {\n      diag(x) = -rowSums(x)\n      x * cycle\n    })\n  R    \n  })"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-rate-matrix-3",
    "href": "slides/03_advanced-bookkeeping.html#transition-rate-matrix-3",
    "title": "Advanced Bookkeeping",
    "section": "Transition Rate Matrix",
    "text": "Transition Rate Matrix\n\nparams$mR\n\n$natural_history\n         to\nfrom      Healthy   CVD Dead\n  Healthy   -0.16  0.15 0.01\n  CVD        0.00 -0.11 0.11\n  Dead       0.00  0.00 0.00"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-probability-matrix",
    "href": "slides/03_advanced-bookkeeping.html#transition-probability-matrix",
    "title": "Advanced Bookkeeping",
    "section": "Transition Probability Matrix",
    "text": "Transition Probability Matrix\n\nexpm(params$mR[[\"natural_history\"]])\n\n        Healthy     CVD     Dead\nHealthy 0.85214 0.13107 0.016785\nCVD     0.00000 0.89583 0.104166\nDead    0.00000 0.00000 1.000000"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#advanced-bookkeeping",
    "href": "slides/03_advanced-bookkeeping.html#advanced-bookkeeping",
    "title": "Advanced Bookkeeping",
    "section": "Advanced Bookkeeping",
    "text": "Advanced Bookkeeping\n\nGiven compound transitions, how can we track the total number of people who develop CVD?\nWhat if there is a cost associated with a single transition type (e.g., CVD  CVD death)?\nWhat if we want to include a tunnel state to capture transient utility changes after contracting CVD or experiencing an acute event?"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#advanced-bookkeeping-1",
    "href": "slides/03_advanced-bookkeeping.html#advanced-bookkeeping-1",
    "title": "Advanced Bookkeeping",
    "section": "Advanced Bookkeeping",
    "text": "Advanced Bookkeeping\nAugmenting the transition matrix with non-markovian elements can address each question:\n\nAccumulator states to count total number of people who enter a health state.\nTransition states to count the number of people who transition into a state in a given cycle.\nTunnel states to capture transient events (e.g., 2 cycle utility decrement, etc.)"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#markovian-transition-matrices",
    "href": "slides/03_advanced-bookkeeping.html#markovian-transition-matrices",
    "title": "Advanced Bookkeeping",
    "section": "Markovian Transition Matrices",
    "text": "Markovian Transition Matrices\n\nTraditional Markov modeling approaches restrict to a transition probability matrix.\nRow sums all equal 1.0."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#markovian-transition-matrices-1",
    "href": "slides/03_advanced-bookkeeping.html#markovian-transition-matrices-1",
    "title": "Advanced Bookkeeping",
    "section": "Markovian Transition Matrices",
    "text": "Markovian Transition Matrices\n\n\nTraditional Markov modeling approaches restrict to a transition probability matrix.\nRow sums all equal 1.0.\n\n\n\n\n\n\n\n\nHealthy\nCVD\nDead\n\n\n\n\nHealthy\n0.852\n0.131\n0.017\n\n\nCVD\n0.000\n0.896\n0.104\n\n\nDead\n0.000\n0.000\n1.000"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#non-markovian-elements",
    "href": "slides/03_advanced-bookkeeping.html#non-markovian-elements",
    "title": "Advanced Bookkeeping",
    "section": "Non-Markovian Elements",
    "text": "Non-Markovian Elements\n\nAugmenting the transition matrix with non-markovian rows and columns can facilitate accurate counting and bookkeeping.\nDepending on the objective, can include non-markovian accumulators and/or transition states."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#non-markovian-elements-1",
    "href": "slides/03_advanced-bookkeeping.html#non-markovian-elements-1",
    "title": "Advanced Bookkeeping",
    "section": "Non-Markovian Elements",
    "text": "Non-Markovian Elements\n\nAccumulator: tracks the total number of individuals who have entered a given state up until a given cycle (even if they moved out of the state later)."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#non-markovian-elements-2",
    "href": "slides/03_advanced-bookkeeping.html#non-markovian-elements-2",
    "title": "Advanced Bookkeeping",
    "section": "Non-Markovian Elements",
    "text": "Non-Markovian Elements\n\nTransition state: tracks the total number of individuals who enter a given state in a given cycle.\n\nCan construct as a tunnel state if you move them through to the next state (or exit for some other reason like background mortality).\nBut you don’t have to do this. Depending on objective, you could just count the total number who enter the state to count up transitory costs, etc."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#where-were-headed",
    "href": "slides/03_advanced-bookkeeping.html#where-were-headed",
    "title": "Advanced Bookkeeping",
    "section": "Where we’re headed",
    "text": "Where we’re headed\n\n\n\n\n\n\nHealthy\nCVD\nDead\ntrCVD\naccCVD\n\n\n\n\nHealthy\n0.852\n0.131\n0.017\n.\n.\n\n\nCVD\n0\n0.896\n0.104\n.\n.\n\n\nDead\n0\n0\n1\n.\n.\n\n\ntrCVD\n.\n.\n.\n.\n.\n\n\naccCVD\n.\n.\n.\n.\n."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#augmenting-the-transition-matrix-1",
    "href": "slides/03_advanced-bookkeeping.html#augmenting-the-transition-matrix-1",
    "title": "Advanced Bookkeeping",
    "section": "Augmenting the Transition Matrix",
    "text": "Augmenting the Transition Matrix\n\nAs noted earlier, all roads begin from the transition rate matrix.\nThe way in which we construct the Markovian components is the same.\n\nPlace rates as appropriate.\nDiagonal of Markovian elements is the negative sum of the other row elements."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#augmenting-the-transition-matrix-2",
    "href": "slides/03_advanced-bookkeeping.html#augmenting-the-transition-matrix-2",
    "title": "Advanced Bookkeeping",
    "section": "Augmenting the Transition Matrix",
    "text": "Augmenting the Transition Matrix\n\n\nRate matrix for basic CVD model\n\n\n\n\n\n\n\n\nHealthy\nCVD\nDead\n\n\n\n\nHealthy\n-0.16\n0.15\n0.01\n\n\nCVD\n0.00\n-0.11\n0.11\n\n\nDead\n0.00\n0.00\n0.00"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#total-cvd-cases",
    "href": "slides/03_advanced-bookkeeping.html#total-cvd-cases",
    "title": "Advanced Bookkeeping",
    "section": "Total CVD Cases",
    "text": "Total CVD Cases\n\nSuppose we wanted to track the total number of people who develop CVD over the simulated time horizon.\nWe can’t do this accurately using CVD state occupancy in the Markov trace due to compound transitions."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#total-cvd-cases-1",
    "href": "slides/03_advanced-bookkeeping.html#total-cvd-cases-1",
    "title": "Advanced Bookkeeping",
    "section": "Total CVD Cases",
    "text": "Total CVD Cases\n\nWe need some way to track everyone who moves into the CVD state.\nWe can do this by adding a non-markovian accumulator to the rate matrix."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#non-markovian-accumulators",
    "href": "slides/03_advanced-bookkeeping.html#non-markovian-accumulators",
    "title": "Advanced Bookkeeping",
    "section": "Non-Markovian Accumulators",
    "text": "Non-Markovian Accumulators\nWe’ll start with the original transition rate matrix:\n\nR_ &lt;- params$mR[[\"natural_history\"]]\nR_\n\n         to\nfrom      Healthy   CVD Dead\n  Healthy   -0.16  0.15 0.01\n  CVD        0.00 -0.11 0.11\n  Dead       0.00  0.00 0.00"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#non-markovian-accumulators-1",
    "href": "slides/03_advanced-bookkeeping.html#non-markovian-accumulators-1",
    "title": "Advanced Bookkeeping",
    "section": "Non-Markovian Accumulators",
    "text": "Non-Markovian Accumulators\n\n\nNext, we will add both a column and a row for the accumulator that tracks movement into the CVD health state.\n\n\n\nFor now, just include zeros."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#non-markovian-accumulators-2",
    "href": "slides/03_advanced-bookkeeping.html#non-markovian-accumulators-2",
    "title": "Advanced Bookkeeping",
    "section": "Non-Markovian Accumulators",
    "text": "Non-Markovian Accumulators\n\n\nNext, we will add both a column and a row for the accumulator that tracks movement into the CVD health state.\nFor now, just include zeros.\n\n\n\nR &lt;- \n  cbind(R_,\"accCVD\" = c(0,0,0)) %&gt;% \n  rbind(.,\"accCVD\" = c(0,0,0,0))  \nR\n\n        Healthy   CVD Dead accCVD\nHealthy   -0.16  0.15 0.01      0\nCVD        0.00 -0.11 0.11      0\nDead       0.00  0.00 0.00      0\naccCVD     0.00  0.00 0.00      0"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#non-markovian-accumulators-3",
    "href": "slides/03_advanced-bookkeeping.html#non-markovian-accumulators-3",
    "title": "Advanced Bookkeeping",
    "section": "Non-Markovian Accumulators",
    "text": "Non-Markovian Accumulators\n\n\nNext fill in the appropriate transition rate.\n\n\n\nR[\"Healthy\",\"accCVD\"] = params$r_H_CVD\nR\n\n        Healthy   CVD Dead accCVD\nHealthy   -0.16  0.15 0.01   0.15\nCVD        0.00 -0.11 0.11   0.00\nDead       0.00  0.00 0.00   0.00\naccCVD     0.00  0.00 0.00   0.00"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#non-markovian-accumulators-4",
    "href": "slides/03_advanced-bookkeeping.html#non-markovian-accumulators-4",
    "title": "Advanced Bookkeeping",
    "section": "Non-Markovian Accumulators",
    "text": "Non-Markovian Accumulators\n\n\nEmbed using matrix exponentiation to obtain the transition probability matrix.\n\n\n\nThe transition matrix now includes a Markovian submatrix (green) and a non-markovian accumulator component (purple).\n\n\nexpm(R)  \n\n\n\n\n\n\n\nHealthy\nCVD\nDead\naccCVD\n\n\n\n\nHealthy\n0.852\n0.131\n0.017\n0.139\n\n\nCVD\n0\n0.896\n0.104\n0\n\n\nDead\n0\n0\n1\n0\n\n\naccCVD\n0\n0\n0\n1"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#non-markovian-accumulators-5",
    "href": "slides/03_advanced-bookkeeping.html#non-markovian-accumulators-5",
    "title": "Advanced Bookkeeping",
    "section": "Non-Markovian Accumulators",
    "text": "Non-Markovian Accumulators\n\nNote that the Markovian submatrix still has rows that sum to one.\nAlso note that the accumulator captures the same transition probability that was (incorrectly) placed in the Healthy  CVD cell in lecture 2!\n\nRecall that this probability is the marginal probability of transition (i.e., all transitions into CVD state). So it’s exactly what we want to accumulate!"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#how-many-with-cvd-after-1-years",
    "href": "slides/03_advanced-bookkeeping.html#how-many-with-cvd-after-1-years",
    "title": "Advanced Bookkeeping",
    "section": "How Many with CVD After 1 Years?",
    "text": "How Many with CVD After 1 Years?\n\nIf we simply went based on state occupancy after one cycle, we’d understate the number of people who develop CVD.\n\nThis is the number who remain in the CVD health state.\nSome had a compound transition and died within the cycle after they developed CVD!\n\n\n\n\n\n\n\ncycle\nHealthy\nCVD\nDead\naccCVD\n\n\n\n\n0\n100000\n0\n0.0\n0\n\n\n1\n85214\n13107\n1678.5\n13862"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#how-many-with-cvd-after-1-years-1",
    "href": "slides/03_advanced-bookkeeping.html#how-many-with-cvd-after-1-years-1",
    "title": "Advanced Bookkeeping",
    "section": "How Many with CVD After 1 Years?",
    "text": "How Many with CVD After 1 Years?\n\n\nThe accumulator column tells us how many total people developed CVD.\n\n\n\n\n\n\n\ncycle\nHealthy\nCVD\nDead\naccCVD\n\n\n\n\n0\n100000\n0\n0.0\n0\n\n\n1\n85214\n13107\n1678.5\n13862"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-states-1",
    "href": "slides/03_advanced-bookkeeping.html#transition-states-1",
    "title": "Advanced Bookkeeping",
    "section": "Transition States",
    "text": "Transition States\n\nWhat if we need to count how many people transition to a given state in a cycle?\nFor example, we may want to apply a one-time cost to a transition such as CVD  CVD death.\nThis type of transition is not immediately captured in the Markov trace.\n\nObserved cycle-to-cycle change in death counts capture CVD  CVD Death as well as death from background causes."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-states-2",
    "href": "slides/03_advanced-bookkeeping.html#transition-states-2",
    "title": "Advanced Bookkeeping",
    "section": "Transition States",
    "text": "Transition States\n\nTransition states are straightforward to capture as another element in the transition matrix.\nSimilar to an accumulator state, but we require state exit after one cycle.\nAmounts so simply zeroing out the accCVD  accCVD transition probability."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-states-3",
    "href": "slides/03_advanced-bookkeeping.html#transition-states-3",
    "title": "Advanced Bookkeeping",
    "section": "Transition States",
    "text": "Transition States\nWe’ll start with the original transition rate matrix:\n\nR_ &lt;- params$mR[[\"natural_history\"]]\nR_\n\n         to\nfrom      Healthy   CVD Dead\n  Healthy   -0.16  0.15 0.01\n  CVD        0.00 -0.11 0.11\n  Dead       0.00  0.00 0.00"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-states-4",
    "href": "slides/03_advanced-bookkeeping.html#transition-states-4",
    "title": "Advanced Bookkeeping",
    "section": "Transition States",
    "text": "Transition States\n\n\nNext, we will add both a column and a row for the transition state that tracks movement into the CVD Death state."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-states-5",
    "href": "slides/03_advanced-bookkeeping.html#transition-states-5",
    "title": "Advanced Bookkeeping",
    "section": "Transition States",
    "text": "Transition States\n\n\nNext, we will add both a column and a row for the transition state that tracks movement into the CVD Death state.\nFor now, just include zeros.\n\n\n\n\nR &lt;- \n  cbind(R_,\"trCVDDeath\" = c(0,0,0)) %&gt;% \n  rbind(.,\"trCVDDeath\" = c(0,0,0,0))  \nR\n\n           Healthy   CVD Dead trCVDDeath\nHealthy      -0.16  0.15 0.01          0\nCVD           0.00 -0.11 0.11          0\nDead          0.00  0.00 0.00          0\ntrCVDDeath    0.00  0.00 0.00          0"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-states-6",
    "href": "slides/03_advanced-bookkeeping.html#transition-states-6",
    "title": "Advanced Bookkeeping",
    "section": "Transition States",
    "text": "Transition States\n\n\nWe then fill in the appropriate transition rate.\n\n\n\nR[\"CVD\",\"trCVDDeath\"] = params$hr_CVD * params$r_H_D\nR\n\n           Healthy   CVD Dead trCVDDeath\nHealthy      -0.16  0.15 0.01        0.0\nCVD           0.00 -0.11 0.11        0.1\nDead          0.00  0.00 0.00        0.0\ntrCVDDeath    0.00  0.00 0.00        0.0"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-states-7",
    "href": "slides/03_advanced-bookkeeping.html#transition-states-7",
    "title": "Advanced Bookkeeping",
    "section": "Transition States",
    "text": "Transition States\n\n\nEmbed using matrix exponentiation to obtain the transition probability matrix.\nNote that we need to manually zero out the transition probability that keeps people in the transition state.\n\n\n\nP = expm(R)  \nP[\"trCVDDeath\",\"trCVDDeath\"] = 0\nP\n\n           Healthy     CVD     Dead trCVDDeath\nHealthy    0.85214 0.13107 0.016785  0.0068583\nCVD        0.00000 0.89583 0.104166  0.0946962\nDead       0.00000 0.00000 1.000000  0.0000000\ntrCVDDeath 0.00000 0.00000 0.000000  0.0000000"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-states-8",
    "href": "slides/03_advanced-bookkeeping.html#transition-states-8",
    "title": "Advanced Bookkeeping",
    "section": "Transition States",
    "text": "Transition States\n\n\n\n\n\n\nHealthy\nCVD\nDead\ntrCVDDeath\n\n\n\n\nHealthy\n0.852\n0.131\n0.017\n0.007\n\n\nCVD\n0.000\n0.896\n0.104\n0.095\n\n\nDead\n0.000\n0.000\n1.000\n0.000\n\n\ntrCVDDeath\n0.000\n0.000\n0.000\n0.000\n\n\n\n\n\n\n\n\nNote that the Markovian submatrix still has rows that sum to one.\nAlso note that the transition state column captures transitions to death that occur from both the Healthy state (compound transitions) and the CVD state!"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#how-many-cvd-death-transitions-are-there",
    "href": "slides/03_advanced-bookkeeping.html#how-many-cvd-death-transitions-are-there",
    "title": "Advanced Bookkeeping",
    "section": "How Many CVD Death Transitions Are There?",
    "text": "How Many CVD Death Transitions Are There?\n\n\nHypothetical cohort of 100,000.\n\n\n\nNote how there are some deaths in the first cycle, despite everyone starting from healthy!\n\n\n\n\n\n\ncycle\nHealthy\nCVD\nDead\ntrCVDDeath\n\n\n\n\n0\n100000\n0\n0.0\n0.00\n\n\n1\n85214\n13107\n1678.5\n685.83"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#incorporating-a-one-time-cost",
    "href": "slides/03_advanced-bookkeeping.html#incorporating-a-one-time-cost",
    "title": "Advanced Bookkeeping",
    "section": "Incorporating a one-time cost",
    "text": "Incorporating a one-time cost\n\n\nCan define a cost “payoff” for trCVDDeath and apply as usual to calculate accumulated costs from a one-time CVD death cost.\n\n\n\n# Define the cost vector\ncost_payoff = c(\"Healthy\" = 0, \"CVD\" = 500, \"Dead\" = 0, \"trCVDDeath\" = 2000) \n\n# Sum up total costs in each cycle\ncosts_cycle = trace[[\"natural_history\"]][-1,] %*% cost_payoff\n\n# Function for cycle correction (alternative Simpson's method)\nalt_simp_coef &lt;- function(i) c(17, 59, 43, 49, rep(48, i-8), 49, 43, 59, 17) / 48\ncycle_adj      &lt;- function(x) sum(alt_simp_coef(length(x)) * x)\n\ntotal_costs = cycle_adj(costs_cycle) \ntotal_costs\n\n[1] 5926.6"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#tunnel-states-1",
    "href": "slides/03_advanced-bookkeeping.html#tunnel-states-1",
    "title": "Advanced Bookkeeping",
    "section": "Tunnel States",
    "text": "Tunnel States\n\nTunnel states are structured similarly to accumulators and transition states.\nOne additional complication: need to allow for tunnel state exit to background mortality (or other exit states)."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#accumulators-and-transition-states",
    "href": "slides/03_advanced-bookkeeping.html#accumulators-and-transition-states",
    "title": "Advanced Bookkeeping",
    "section": "Accumulators and Transition States",
    "text": "Accumulators and Transition States\n\nOccupy both ends of a spectrum.\nAccumulators: probability of remaining in accumulator state = 1.0.\nTransition States: probability of remaining in transition state = 0.0."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#tunnel-states-2",
    "href": "slides/03_advanced-bookkeeping.html#tunnel-states-2",
    "title": "Advanced Bookkeeping",
    "section": "Tunnel States",
    "text": "Tunnel States\n\nProbability of remaining in tunnel: 0 &lt; p &lt; 1.\nReflects the idea that most will remain in the tunnel for the cycle, but some might leave due to secular death, transition back to a less severe disease state (e.g., remission), etc."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#tunnel-states-3",
    "href": "slides/03_advanced-bookkeeping.html#tunnel-states-3",
    "title": "Advanced Bookkeeping",
    "section": "Tunnel States",
    "text": "Tunnel States\n\nProcess for constructing is similar, with a “catch.”\nWe are already accounting for transitions to death in the primary Markovian submatrix.\nBut for accurate bookkeeping purposes (e.g., QALYs and costs) we still need to net them out."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#tunnel-states-4",
    "href": "slides/03_advanced-bookkeeping.html#tunnel-states-4",
    "title": "Advanced Bookkeeping",
    "section": "Tunnel States",
    "text": "Tunnel States\n\nWe’ll do this by including a temporary “receiving bucket” in the rate matrix.\nThe receiving bucket is used for embedding, but can be discarded for the final transition probability matrix."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#tunnel-states-5",
    "href": "slides/03_advanced-bookkeeping.html#tunnel-states-5",
    "title": "Advanced Bookkeeping",
    "section": "Tunnel States",
    "text": "Tunnel States\n\nSuppose we want to record a temporary 2 year (cycle) initial treatment cost once someone develops CVD.\nWe can set up a tunnel state to capture this."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#tunnel-state",
    "href": "slides/03_advanced-bookkeeping.html#tunnel-state",
    "title": "Advanced Bookkeeping",
    "section": "Tunnel State",
    "text": "Tunnel State\nWe’ll start with the original transition rate matrix:\n\n\n$natural_history\n         to\nfrom      Healthy   CVD Dead\n  Healthy   -0.16  0.15 0.01\n  CVD        0.00 -0.11 0.11\n  Dead       0.00  0.00 0.00\n\n\n\nR_ &lt;- params$mR[[\"natural_history\"]]\nR_\n\n         to\nfrom      Healthy   CVD Dead\n  Healthy   -0.16  0.15 0.01\n  CVD        0.00 -0.11 0.11\n  Dead       0.00  0.00 0.00"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#tunnel-state-1",
    "href": "slides/03_advanced-bookkeeping.html#tunnel-state-1",
    "title": "Advanced Bookkeeping",
    "section": "Tunnel State",
    "text": "Tunnel State\n\nNext, we will add columns and rows for the tunnel states.\nGiven that our model has an annual cycle, and the tunnel lasts two years, we need to add two columns and two rows PLUS a receiving bucket. So three new rows and columns.\nIf we had a monthly time cycle, we’d need to add 25 …"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#tunnel-states-6",
    "href": "slides/03_advanced-bookkeeping.html#tunnel-states-6",
    "title": "Advanced Bookkeeping",
    "section": "Tunnel States",
    "text": "Tunnel States\n\n\nFor now, just include zeros.\n\n\n\n\nR &lt;- \n  cbind(R_,\"tunCVDy1\" = c(0,0,0), \"tunCVDy2\" = c(0,0,0),\"NULL\" = c(0,0,0)) %&gt;% \n  rbind(.,\"tunCVDy1\" = c(0,0,0,0,0,0), \"tunCVDy2\" = c(0,0,0,0,0,0), \"NULL\" = c(0,0,0,0,0,0))  \nR\n\n         Healthy   CVD Dead tunCVDy1 tunCVDy2 NULL\nHealthy    -0.16  0.15 0.01        0        0    0\nCVD         0.00 -0.11 0.11        0        0    0\nDead        0.00  0.00 0.00        0        0    0\ntunCVDy1    0.00  0.00 0.00        0        0    0\ntunCVDy2    0.00  0.00 0.00        0        0    0\nNULL        0.00  0.00 0.00        0        0    0"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#tunnel-state-2",
    "href": "slides/03_advanced-bookkeeping.html#tunnel-state-2",
    "title": "Advanced Bookkeeping",
    "section": "Tunnel State",
    "text": "Tunnel State\n\n\nWe then fill in the appropriate transition rate for entry into the tunnel.\n\n\n\nR[\"Healthy\",\"tunCVDy1\"] = R[\"Healthy\",\"CVD\"]\nR\n\n         Healthy   CVD Dead tunCVDy1 tunCVDy2 NULL\nHealthy    -0.16  0.15 0.01     0.15        0    0\nCVD         0.00 -0.11 0.11     0.00        0    0\nDead        0.00  0.00 0.00     0.00        0    0\ntunCVDy1    0.00  0.00 0.00     0.00        0    0\ntunCVDy2    0.00  0.00 0.00     0.00        0    0\nNULL        0.00  0.00 0.00     0.00        0    0"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#tunnel-state-3",
    "href": "slides/03_advanced-bookkeeping.html#tunnel-state-3",
    "title": "Advanced Bookkeeping",
    "section": "Tunnel State",
    "text": "Tunnel State\n\n\nEmbed using matrix exponentiation to obtain the initial transition probability matrix.\nNote that we need to TK\n\n\n\nP_ = expm(R)  \nP_[\"tunCVDy1\",\"NULL\"] = P_[\"CVD\",\"Dead\"]\nP_[\"tunCVDy1\",\"tunCVDy1\"] = 0\nP_[\"tunCVDy1\",\"tunCVDy2\"] = 1 - P_[\"tunCVDy1\",\"NULL\"]\nP_[\"tunCVDy2\",\"tunCVDy2\"] = 0\nP_[\"tunCVDy2\",\"NULL\"] = 1\nP = P_[-which(rownames(P_)==\"NULL\"),-which(colnames(P_)==\"NULL\")]\nP\n\n         Healthy     CVD     Dead tunCVDy1 tunCVDy2\nHealthy  0.85214 0.13107 0.016785  0.13862  0.00000\nCVD      0.00000 0.89583 0.104166  0.00000  0.00000\nDead     0.00000 0.00000 1.000000  0.00000  0.00000\ntunCVDy1 0.00000 0.00000 0.000000  0.00000  0.89583\ntunCVDy2 0.00000 0.00000 0.000000  0.00000  0.00000"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#transition-states-9",
    "href": "slides/03_advanced-bookkeeping.html#transition-states-9",
    "title": "Advanced Bookkeeping",
    "section": "Transition States",
    "text": "Transition States\n\n\n\n\n\n\nHealthy\nCVD\nDead\ntunCVDy1\ntunCVDy2\n\n\n\n\nHealthy\n0.852\n0.131\n0.017\n0.139\n0.000\n\n\nCVD\n0.000\n0.896\n0.104\n0.000\n0.000\n\n\nDead\n0.000\n0.000\n1.000\n0.000\n0.000\n\n\ntunCVDy1\n0.000\n0.000\n0.000\n0.000\n0.896\n\n\ntunCVDy2\n0.000\n0.000\n0.000\n0.000\n0.000\n\n\n\n\n\n\n\n\nNote that the Markovian submatrix still has rows that sum to one."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#hiv-model",
    "href": "slides/03_advanced-bookkeeping.html#hiv-model",
    "title": "Advanced Bookkeeping",
    "section": "HIV Model",
    "text": "HIV Model\n\n\n      A     B     C     D\nA 0.721 0.202 0.067 0.010\nB 0.000 0.581 0.407 0.012\nC 0.000 0.000 0.750 0.250\nD 0.000 0.000 0.000 1.000\n\n\n\n\nOriginal paper specified probabilities observed.\nA (Healthly) -&gt; B (cd4 &lt; 200) -&gt; C (AIDS) -&gt; D (Death)\nNote there are “jumpover” transitions.\nFrom ‘Decision Modelling for Health Economic Evaluation’ by Briggs, Claxton, Sculpher."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#eigenvalue-method",
    "href": "slides/03_advanced-bookkeeping.html#eigenvalue-method",
    "title": "Advanced Bookkeeping",
    "section": "Eigenvalue Method",
    "text": "Eigenvalue Method\n\nV  &lt;- eigen(m_P)$vectors\niV &lt;- solve(V)\nAp &lt;- iV %*% m_P %*% V\nlAp &lt;- diag(log(diag(Ap)), nrow(Ap), ncol(Ap))\nR  &lt;- V %*% lAp %*% iV\nR[abs(R) &lt; 1e-6 ] &lt;- 0\nrownames(R) &lt;- c(\"A\", \"B\", \"C\", \"D\")\ncolnames(R) &lt;- c(\"A\", \"B\", \"C\", \"D\")\nround(R,3)\n\n       A      B      C      D\nA -0.327  0.311  0.002  0.013\nB  0.000 -0.543  0.615 -0.072\nC  0.000  0.000 -0.288  0.288\nD  0.000  0.000  0.000  0.000\n\n\n\nNote there is a negative rate from B -&gt; D.\nThis is a transition from D -&gt; B and should be moved to the other side of the matrix."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#eigenvalue-method-cont.",
    "href": "slides/03_advanced-bookkeeping.html#eigenvalue-method-cont.",
    "title": "Advanced Bookkeeping",
    "section": "Eigenvalue Method (cont.)",
    "text": "Eigenvalue Method (cont.)\n\n\n       A      B      C      D\nA -0.327  0.311  0.002  0.013\nB  0.000 -0.543  0.615 -0.072\nC  0.000  0.000 -0.288  0.288\nD  0.000  0.000  0.000  0.000\n\n\n\nThe negative rate implies an identifiable issue.\nNote rates from A-&gt;C, A-&gt;D are relatively small, implying these are from statistical noise in observation.\nexpm::logm Higham method returns same as Eigenvalue method.\nTweaking rates to get a proper model is ad-hoc and difficult."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#reestimating-rates",
    "href": "slides/03_advanced-bookkeeping.html#reestimating-rates",
    "title": "Advanced Bookkeeping",
    "section": "Reestimating Rates",
    "text": "Reestimating Rates\n\nImposition of structural assumptions and fitting to raw data would likely result in better rate estimates.\nWe could assume that a patient with HIV at this point in time only gets sicker and external causes of death are negligible. A-&gt;B-&gt;C-&gt;D constrains model.\nWe use the reported data from the paper at year 1\nMSM Method: https://chjackson.github.io/msm/msmcourse/"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#reestimating-rates-msm-method",
    "href": "slides/03_advanced-bookkeeping.html#reestimating-rates-msm-method",
    "title": "Advanced Bookkeeping",
    "section": "Reestimating Rates (MSM Method)",
    "text": "Reestimating Rates (MSM Method)\n\nlibrary(msm)\nx &lt;- rbind(\n  # Start in state 1 at time 0.\n  data.frame(\n    ptnum=1:1000, years=rep(0, 1000), state=rep(1, 1000)\n  ),\n  # Observed at year 1 new state.\n  data.frame(\n    ptnum=1:1000, years=rep(1, 1000),\n    state=c(rep(1, 721), rep(2, 202),\n            rep(3, 67),  rep(4, 10))\n  )\n)\nx &lt;- x[order(x$ptnum, x$years),]"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#reestimating-rates-structural-assumption",
    "href": "slides/03_advanced-bookkeeping.html#reestimating-rates-structural-assumption",
    "title": "Advanced Bookkeeping",
    "section": "Reestimating Rates (Structural Assumption)",
    "text": "Reestimating Rates (Structural Assumption)\n\nstatetable.msm(state, ptnum, data=x)\n\n    to\nfrom   1   2   3   4\n   1 721 202  67  10\n\nQ.init &lt;- rbind(rbind(c(0, 0.3, 0,   0),    # A -&gt; B only\n                      c(0, 0,   0.6, 0),    # B -&gt; C only\n                      c(0, 0,   0,   0.3),  # C -&gt; D only\n                      c(0, 0,   0,   0)))\n\n\n\nQ represents structural assumptions and estimate\nEstimates were taken from Eigenvalue method\nRelaxing structural assumptions does not converge"
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#reestimating-rates-likelihood-fit",
    "href": "slides/03_advanced-bookkeeping.html#reestimating-rates-likelihood-fit",
    "title": "Advanced Bookkeeping",
    "section": "Reestimating Rates (Likelihood Fit)",
    "text": "Reestimating Rates (Likelihood Fit)\n\nhiv.msm &lt;- msm(state ~ years, subject = ptnum, data = x, qmatrix = Q.init)\nhiv.msm\n\n\nCall:\nmsm(formula = state ~ years, subject = ptnum, data = x, qmatrix = Q.init)\n\nMaximum likelihood estimates\n\nTransition intensities\n                  Baseline                 \nState 1 - State 1 -0.3271 (-0.3680,-0.2907)\nState 1 - State 2  0.3271 ( 0.2907, 0.3680)\nState 2 - State 2 -0.6454 (-0.8181,-0.5092)\nState 2 - State 3  0.6454 ( 0.5092, 0.8181)\nState 3 - State 3 -0.3982 (-0.7562,-0.2097)\nState 3 - State 4  0.3982 ( 0.2097, 0.7562)\n\n-2 * log-likelihood:  1572.2 \n\n\n\n\nAll positive.\nProvides 95% confidence intervals for a PSA."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#reestimating-rates-transition-probabilities",
    "href": "slides/03_advanced-bookkeeping.html#reestimating-rates-transition-probabilities",
    "title": "Advanced Bookkeeping",
    "section": "Reestimating Rates (Transition Probabilities)",
    "text": "Reestimating Rates (Transition Probabilities)\n\nm_P\n\n      A     B     C     D\nA 0.721 0.202 0.067 0.010\nB 0.000 0.581 0.407 0.012\nC 0.000 0.000 0.750 0.250\nD 0.000 0.000 0.000 1.000\n\nround(pmatrix.msm(hiv.msm, t=1), 3)\n\n        State 1 State 2 State 3 State 4\nState 1   0.721   0.202   0.067   0.010\nState 2   0.000   0.524   0.384   0.092\nState 3   0.000   0.000   0.672   0.328\nState 4   0.000   0.000   0.000   1.000\n\n\n\n\nQuite close.\nProblematic transition from B -&gt; D probability is higher."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#reestimating-rates-transition-probabilities-1",
    "href": "slides/03_advanced-bookkeeping.html#reestimating-rates-transition-probabilities-1",
    "title": "Advanced Bookkeeping",
    "section": "Reestimating Rates (Transition Probabilities)",
    "text": "Reestimating Rates (Transition Probabilities)\n\nc(1000, 0, 0, 0) %*% m_P\n\n       A   B  C  D\n[1,] 721 202 67 10\n\nc(1000, 0, 0, 0) %*% pmatrix.msm(hiv.msm, t=1)\n\n     State 1 State 2 State 3 State 4\n[1,]     721     202      67      10\n\n\n\n\nResulting expectation after 1 cycle is nearly identical.\nThe msm method has bits down at 4th decimal. Round off made them identical.\nOnly a tiny bit of error (721 vs. 721.0002) makes log numerically unstable converting from probability to rate."
  },
  {
    "objectID": "slides/03_advanced-bookkeeping.html#conclusions",
    "href": "slides/03_advanced-bookkeeping.html#conclusions",
    "title": "Advanced Bookkeeping",
    "section": "Conclusions",
    "text": "Conclusions\n\nIdentifying rate matrix from transition probability matrix in presence of error/jump over is in general not possible.\nThe matrix log methods (eigen/Higham) usually results in impossible models.\nUsing observed data one can fit rate data using likelihood, e.g. msm.\nStructural assumptions can be imposed and may be necessary.\n95% confidence intervals result.\n\n\n\nBack to Website"
  },
  {
    "objectID": "slides/01_mortality.html#learning-objectives",
    "href": "slides/01_mortality.html#learning-objectives",
    "title": "1. Coping with Mortality",
    "section": "Learning Objectives",
    "text": "Learning Objectives\n\nUnderstand options for modeling background mortality based on life tables and parametric mortality models.\nConstruct a cause-deleted life table to model cause-specific and non-cause-specific death."
  },
  {
    "objectID": "slides/01_mortality.html#approaches-to-modeling-mortality",
    "href": "slides/01_mortality.html#approaches-to-modeling-mortality",
    "title": "1. Coping with Mortality",
    "section": "Approaches to Modeling Mortality",
    "text": "Approaches to Modeling Mortality\n\n\nStandard approach is to draw from life table data:\n\n\n\n\n\n\n\nage\nlx\ndx\nmx\nqx\n\n\n\n\n0\n100000\n553.22\n0.00556\n0.00553\n\n\n1\n99447\n38.18\n0.00038\n0.00038\n\n\n2\n99409\n23.16\n0.00023\n0.00023\n\n\n\n\n\n\n\n\nlx is the total number living in a hypothetical cohort (of 100,000).\ndx is the number of deaths in the age interval."
  },
  {
    "objectID": "slides/01_mortality.html#approaches-to-modeling-mortality-1",
    "href": "slides/01_mortality.html#approaches-to-modeling-mortality-1",
    "title": "1. Coping with Mortality",
    "section": "Approaches to Modeling Mortality",
    "text": "Approaches to Modeling Mortality\n\n\nStandard approach is to draw from life table data:\n\n\n\n\n\n\n\nage\nlx\ndx\nmx\nqx\n\n\n\n\n0\n100000\n553.22\n0.00556\n0.00553\n\n\n1\n99447\n38.18\n0.00038\n0.00038\n\n\n2\n99409\n23.16\n0.00023\n0.00023\n\n\n\n\n\n\n\n\nmx is the death rate within the interval.\nqx is the probability of death within an interval."
  },
  {
    "objectID": "slides/01_mortality.html#life-table-data",
    "href": "slides/01_mortality.html#life-table-data",
    "title": "1. Coping with Mortality",
    "section": "Life Table Data",
    "text": "Life Table Data\n\n\nDeath probabilities are useful for discrete time Markov models.\n\n\n\n\n\n\n\nage\nlx\ndx\nmx\nqx\n\n\n\n\n0\n100000\n553.22\n0.00556\n0.00553\n\n\n1\n99447\n38.18\n0.00038\n0.00038\n\n\n2\n99409\n23.16\n0.00023\n0.00023"
  },
  {
    "objectID": "slides/01_mortality.html#life-table-data-1",
    "href": "slides/01_mortality.html#life-table-data-1",
    "title": "1. Coping with Mortality",
    "section": "Life Table Data",
    "text": "Life Table Data\n\n\nDeath rates are useful for discrete event simulation (DES) models.\n\n\n\n\n\n\n\nage\nlx\ndx\nmx\nqx\n\n\n\n\n0\n100000\n553.22\n0.00556\n0.00553\n\n\n1\n99447\n38.18\n0.00038\n0.00038\n\n\n2\n99409\n23.16\n0.00023\n0.00023"
  },
  {
    "objectID": "slides/01_mortality.html#life-table-based-mortality",
    "href": "slides/01_mortality.html#life-table-based-mortality",
    "title": "1. Coping with Mortality",
    "section": "Life Table-Based Mortality",
    "text": "Life Table-Based Mortality\n\n\nA common approach is to use a life table-based lookup table in the model:\n\n\n\ntpDn_lookup &lt;-\n    c(\"(34,44]\" = 0.0017,  \n      \"(44,54]\" = 0.0044,\n      \"(54,64]\" = 0.0138,\n      \"(64,74]\" = 0.0379,\n      \"(74,84]\" = 0.0912,\n      \"(84,100]\" = 0.1958)\n\n\nHighlighted row: annual probability of death for 35-44 year old."
  },
  {
    "objectID": "slides/01_mortality.html#life-table-based-mortality-1",
    "href": "slides/01_mortality.html#life-table-based-mortality-1",
    "title": "1. Coping with Mortality",
    "section": "Life Table-Based Mortality",
    "text": "Life Table-Based Mortality\n\nWhat if age bins are coarse (e.g., 0, 5, 10,… vs. 0,1,2,3,…)?\n\nAssume death probability/rate is constant within age bins (and cycles)?\nIn a DES model, we need to sample a time to death.\n\nCan sample from survival function in underlying life table.\nAges in life table often topcoded (e.g., 85, 100, etc.)"
  },
  {
    "objectID": "slides/01_mortality.html#alternative-parametric-mortality-model",
    "href": "slides/01_mortality.html#alternative-parametric-mortality-model",
    "title": "1. Coping with Mortality",
    "section": "Alternative: Parametric Mortality Model",
    "text": "Alternative: Parametric Mortality Model\n\nFit a parametric mortality model to the life table data.\nReduces dimensionality to a few parameters.\nUse these parameters to sample time of death, obtain mortality rate/probability at any arbitrary time, etc."
  },
  {
    "objectID": "slides/01_mortality.html#obtaining-life-table-data",
    "href": "slides/01_mortality.html#obtaining-life-table-data",
    "title": "1. Coping with Mortality",
    "section": "Obtaining Life Table Data",
    "text": "Obtaining Life Table Data\n\n\n\n\n\n\nThe R packages MortalityLaws and demography facilitate life table data aquisition and modeling.\n\n\n\nCommon sources:\n\nHuman Mortality Database\nGlobal Burden of Disease\nHuman Cause of Death Database\nHuman Life Table Database"
  },
  {
    "objectID": "slides/01_mortality.html#processing-life-table-data",
    "href": "slides/01_mortality.html#processing-life-table-data",
    "title": "1. Coping with Mortality",
    "section": "Processing Life Table Data",
    "text": "Processing Life Table Data\n\nCode below extracts U.S. life table data from the human mortality database (HMD)."
  },
  {
    "objectID": "slides/01_mortality.html#processing-life-table-data-1",
    "href": "slides/01_mortality.html#processing-life-table-data-1",
    "title": "1. Coping with Mortality",
    "section": "Processing Life Table Data",
    "text": "Processing Life Table Data\n\n\nCode below extracts U.S. life table data from the human mortality database (HMD).\n\n\n\nhmd_usa &lt;-\n    demography::hmd.mx(\"USA\",\n                       username = \"&lt;&lt;your user name&gt;&gt;\",\n                       password = \"&lt;&lt;your password&gt;&gt;\", \"USA\")"
  },
  {
    "objectID": "slides/01_mortality.html#processing-life-table-data-2",
    "href": "slides/01_mortality.html#processing-life-table-data-2",
    "title": "1. Coping with Mortality",
    "section": "Processing Life Table Data",
    "text": "Processing Life Table Data\n\nCode below processes HMD data and constructs a (2019) life table from it.\nRadix (cohort size) is 100,000 individuals."
  },
  {
    "objectID": "slides/01_mortality.html#processing-life-table-data-3",
    "href": "slides/01_mortality.html#processing-life-table-data-3",
    "title": "1. Coping with Mortality",
    "section": "Processing Life Table Data",
    "text": "Processing Life Table Data\n\n\nCode below processes HMD data and constructs a (2019) life table from it.\nRadix (cohort size) is 100,000 individuals.\n\n\n\nmortality_year = 2019 \nradix = 100000\n\nlt = \n    hmd_usa %&gt;% \n    demography::lifetable(.,series = \"total\", years = mortality_year) %&gt;% \n    as_tibble() %&gt;% \n    rename(age = x) %&gt;% \n    mutate_at(vars(lx,dx), function(x) x * radix)"
  },
  {
    "objectID": "slides/01_mortality.html#us-life-table-2019",
    "href": "slides/01_mortality.html#us-life-table-2019",
    "title": "1. Coping with Mortality",
    "section": "US Life Table (2019)",
    "text": "US Life Table (2019)\nHighlighted column: Remaining life expectancy at exact age x.\n\n\n\n\n\nage\nlx\ndx\nex\nqx\nmx\n\n\n\n\n0\n100000\n553.221\n78.963\n0.00553\n0.00556\n\n\n1\n99447\n38.180\n78.402\n0.00038\n0.00038\n\n\n2\n99409\n23.160\n77.432\n0.00023\n0.00023\n\n\n3\n99385\n17.689\n76.450\n0.00018\n0.00018"
  },
  {
    "objectID": "slides/01_mortality.html#alive-dead-model-1",
    "href": "slides/01_mortality.html#alive-dead-model-1",
    "title": "1. Coping with Mortality",
    "section": "Alive-Dead Model",
    "text": "Alive-Dead Model\n\n\nAs a refresher, let’s construct a very simple alive-dead model using life table death probability (qx) values.\n\n\n\n\n\n\n\n\n\nG\n\n  \n\nAlive\n\n Alive   \n\nAlive-&gt;Alive\n\n  1.0-qx(t)   \n\nDead\n\n Dead   \n\nAlive-&gt;Dead\n\n  qx(t)   \n\nDead-&gt;Dead\n\n  1.0"
  },
  {
    "objectID": "slides/01_mortality.html#parameterize-the-model",
    "href": "slides/01_mortality.html#parameterize-the-model",
    "title": "1. Coping with Mortality",
    "section": "Parameterize the model",
    "text": "Parameterize the model\n\nparams = \n  list(\n    t_names = c(\"lifetable\"),         # Strategy names. \n    n_treatments = 1,                 # Number of treatments\n    s_names  = c(\"Alive\", \"Dead\"),    # State names\n    n_states = 2,                     # Number of states\n    n_cohort = 100000,                # Cohort size\n    initial_age = 0,                  # Cohort starting age    \n    n_cycles = 110,                   # Number of cycles in model.  \n    cycle = 1,                        # Cycle length\n    life_table = lt                   # Processed HMD life table data (2019, USA)\n  )"
  },
  {
    "objectID": "slides/01_mortality.html#parameterize-the-model-1",
    "href": "slides/01_mortality.html#parameterize-the-model-1",
    "title": "1. Coping with Mortality",
    "section": "Parameterize the model",
    "text": "Parameterize the model\n\nparams = \n  list(\n    t_names = c(\"lifetable\"),         # Strategy names. \n    n_treatments = 1,                 # Number of treatments\n    s_names  = c(\"Alive\", \"Dead\"),    # State names\n    n_states = 2,                     # Number of states\n    n_cohort = 100000,                # Cohort size\n    initial_age = 0,                  # Cohort starting age    \n    n_cycles = 110,                   # Number of cycles in model.  \n    cycle = 1,                        # Cycle length\n    life_table = lt                   # Processed HMD life table data (2019, USA)\n  )\n\n\n\nNo specific strategies or policies under consideration; we’re just trying to replicate mortality using life table data for a hypothetical cohort of 100,000 infants."
  },
  {
    "objectID": "slides/01_mortality.html#parameterize-the-model-2",
    "href": "slides/01_mortality.html#parameterize-the-model-2",
    "title": "1. Coping with Mortality",
    "section": "Parameterize the model",
    "text": "Parameterize the model\n\nparams = \n    list(\n        t_names = c(\"lifetable\"),         # Strategy names. \n        n_treatments = 1,                 # Number of treatments\n        s_names  = c(\"Alive\", \"Dead\"),    # State names\n        n_states = 2,                     # Number of states\n        n_cohort = 100000,                # Cohort size\n        initial_age = 0,                  # Cohort starting age    \n        n_cycles = 110,                   # Number of cycles in model.  \n        cycle = 1,                        # Cycle length\n        life_table = lt                   # Processed HMD life table data (2019, USA)\n    )\n\n\n\nDiscrete time will be in annual cycles."
  },
  {
    "objectID": "slides/01_mortality.html#parameterize-the-model-3",
    "href": "slides/01_mortality.html#parameterize-the-model-3",
    "title": "1. Coping with Mortality",
    "section": "Parameterize the model",
    "text": "Parameterize the model\n\nparams = \n    list(\n        t_names = c(\"lifetable\"),         # Strategy names. \n        n_treatments = 1,                 # Number of treatments\n        s_names  = c(\"Alive\", \"Dead\"),    # State names\n        n_states = 2,                     # Number of states\n        n_cohort = 100000,                # Cohort size\n        initial_age = 0,                  # Cohort starting age    \n        n_cycles = 110,                   # Number of cycles in model.  \n        cycle = 1,                        # Cycle length\n        life_table = lt                   # Processed HMD life table data (2019, USA)\n    )\n\n\n\nThe lifetable “strategy” will draw on the HMD life table data processed earlier."
  },
  {
    "objectID": "slides/01_mortality.html#age-dependent-transition-matrix",
    "href": "slides/01_mortality.html#age-dependent-transition-matrix",
    "title": "1. Coping with Mortality",
    "section": "Age-Dependent Transition Matrix",
    "text": "Age-Dependent Transition Matrix\n\nWe’ll next construct a transition probability matrix using the age-specific probability of death field (qx) from the life table data.\nTo do so, we need to define a function that, for a given age and cycle length, calculates the probability of death and places this within a transition matrix."
  },
  {
    "objectID": "slides/01_mortality.html#age-dependent-transition-matrix-1",
    "href": "slides/01_mortality.html#age-dependent-transition-matrix-1",
    "title": "1. Coping with Mortality",
    "section": "Age-Dependent Transition Matrix",
    "text": "Age-Dependent Transition Matrix\n\n\nLife Table:\n\nlt[1,c(\"age\",\"qx\")]\n\n# A tibble: 1 × 2\n    age      qx\n  &lt;dbl&gt;   &lt;dbl&gt;\n1     0 0.00553\n\nlt[90,c(\"age\",\"qx\")]\n\n# A tibble: 1 × 2\n    age    qx\n  &lt;dbl&gt; &lt;dbl&gt;\n1    89 0.123\n\n\n\nTransition Matrix:\n\nparams$mP[[1]][,,\"lifetable\"]\n\n       to\nfrom    Alive   Dead     \n  Alive 0.99447 0.0055322\n  Dead  0       1        \n\nparams$mP[[90]][,,\"lifetable\"]\n\n       to\nfrom    Alive   Dead   \n  Alive 0.87677 0.12323\n  Dead  0       1"
  },
  {
    "objectID": "slides/01_mortality.html#construct-the-markov-trace",
    "href": "slides/01_mortality.html#construct-the-markov-trace",
    "title": "1. Coping with Mortality",
    "section": "Construct the Markov Trace",
    "text": "Construct the Markov Trace\n\nsim_cohort &lt;- function(params) {\n params$t_names %&gt;% map(~({ \n    tr_ &lt;- t(c(\"alive\" = params$n_cohort, \"dead\" = 0))\n    \n    res &lt;- do.call(rbind,lapply(params$mP, function(tp) {\n        tr_ &lt;&lt;- tr_ %*% matrix(unlist(tp[,,.x]),nrow=params$n_state)\n    }))\n    res &lt;- rbind(c(params$n_cohort,0),res) \n    dimnames(res) &lt;- list(paste0(c(0:params$n_cycles)), params$s_names)\n    res\n  })) %&gt;% \n    set_names(params$t_names)\n}"
  },
  {
    "objectID": "slides/01_mortality.html#construct-the-markov-trace-1",
    "href": "slides/01_mortality.html#construct-the-markov-trace-1",
    "title": "1. Coping with Mortality",
    "section": "Construct the Markov Trace",
    "text": "Construct the Markov Trace\n\n\nOutput: named list object with full Markov trace for each state."
  },
  {
    "objectID": "slides/01_mortality.html#construct-the-markov-trace-2",
    "href": "slides/01_mortality.html#construct-the-markov-trace-2",
    "title": "1. Coping with Mortality",
    "section": "Construct the Markov Trace",
    "text": "Construct the Markov Trace\n\n\nOutput: named list object with full Markov trace for each strategy.\n\n\n\ntrace &lt;- \n  sim_cohort(params)\ntrace[[\"lifetable\"]][1:10,]\n\n   Alive   Dead\n0 100000   0.00\n1  99447 553.22\n2  99409 591.40\n3  99385 614.56\n4  99368 632.25\n5  99354 646.46\n6  99340 659.67\n7  99328 671.69\n8  99317 682.52\n9  99307 693.14"
  },
  {
    "objectID": "slides/01_mortality.html#life-expectancy",
    "href": "slides/01_mortality.html#life-expectancy",
    "title": "1. Coping with Mortality",
    "section": "Life Expectancy",
    "text": "Life Expectancy\n\nWe have a model with 110 annual cycles for a cohort of 100,000 0 year olds.\nAccording to the underlying life table data, life expectancy at birth is 78.96315 years.\nLet’s verify we can replicate this with our Markov model."
  },
  {
    "objectID": "slides/01_mortality.html#life-expectancy-1",
    "href": "slides/01_mortality.html#life-expectancy-1",
    "title": "1. Coping with Mortality",
    "section": "Life Expectancy",
    "text": "Life Expectancy\n\n\nWe have a model with 110 annual cycles for a cohort of 100,000 0 year olds.\nAccording to the underlying life table data, life expectancy at birth is 78.96315 years.\nLet’s verify we can replicate this with our Markov model.\n\n\n\n\n\n\n\nage\nqx\nex\n\n\n\n\n0\n0.00553\n78.963"
  },
  {
    "objectID": "slides/01_mortality.html#life-expectancy-2",
    "href": "slides/01_mortality.html#life-expectancy-2",
    "title": "1. Coping with Mortality",
    "section": "Life Expectancy",
    "text": "Life Expectancy\n\n\nDefine the payoff for life expectancy (1 if alive, 0 otherwise)\n\n\n\n# Define the payoff for life expectancy\npayoff_life_exp = c(\"Alive\" = 1, \"Dead\" = 0)\n\n# Calculate alive years in each cycle\nlife_exp_cycle = (trace[[1]] * (1 / params$n_cohort)) %*% payoff_life_exp\n\n# Function for cycle correction (alternative Simpson's method)\nalt_simp_coef &lt;- function(i) c(17, 59, 43, 49, rep(48, i-8),\n                               49, 43, 59, 17) / 48\ncycle_adj     &lt;- function(x) sum(alt_simp_coef(length(x)) * x)\n\ntotal_life_exp = cycle_adj(life_exp_cycle)"
  },
  {
    "objectID": "slides/01_mortality.html#life-expectancy-3",
    "href": "slides/01_mortality.html#life-expectancy-3",
    "title": "1. Coping with Mortality",
    "section": "Life Expectancy",
    "text": "Life Expectancy\n\n\nCalculate life years in each cycle.1\n\n\n\n# Define the payoff for life expectancy\npayoff_life_exp = c(\"Alive\" = 1, \"Dead\" = 0)\n\n# Calculate alive years in each cycle\nlife_exp_cycle = (trace[[1]] * (1 / params$n_cohort)) %*% payoff_life_exp\n\n# Function for cycle correction (alternative Simpson's method)\nalt_simp_coef &lt;- function(i) c(17, 59, 43, 49, rep(48, i-8),\n                               49, 43, 59, 17) / 48\ncycle_adj     &lt;- function(x) sum(alt_simp_coef(length(x)) * x)\n\ntotal_life_exp = cycle_adj(life_exp_cycle)\n\nNote that we divide by 100000 to normalize the results to a single individual for life expectancy calculations."
  },
  {
    "objectID": "slides/01_mortality.html#life-expectancy-4",
    "href": "slides/01_mortality.html#life-expectancy-4",
    "title": "1. Coping with Mortality",
    "section": "Life Expectancy",
    "text": "Life Expectancy\n\n\nDefine a function for cycle adjustment.1\n\n\n\n# Define the payoff for life expectancy\npayoff_life_exp = c(\"Alive\" = 1, \"Dead\" = 0)\n\n# Calculate alive years in each cycle\nlife_exp_cycle = (trace[[1]] * (1 / params$n_cohort)) %*% payoff_life_exp\n\n# Function for cycle correction (alternative Simpson's method)\nalt_simp_coef &lt;- function(i) c(17, 59, 43, 49, rep(48, i-8),\n                               49, 43, 59, 17) / 48\ncycle_adj     &lt;- function(x) sum(alt_simp_coef(length(x)) * x)\n\ntotal_life_exp = cycle_adj(life_exp_cycle)\n\nWe use the alternative Simpson’s method here for higher accuracy. The half-cycle correction is Newton’s trapezoid method. See: Elbasha, Chhatwal, 2016 MDM."
  },
  {
    "objectID": "slides/01_mortality.html#life-expectancy-5",
    "href": "slides/01_mortality.html#life-expectancy-5",
    "title": "1. Coping with Mortality",
    "section": "Life Expectancy",
    "text": "Life Expectancy\n\n\nSum of values (with cycle adjustment applied) is total life expectancy.\n\n\n\n# Define the payoff for life expectancy\npayoff_life_exp = c(\"Alive\" = 1, \"Dead\" = 0)\n\n# Calculate alive years in each cycle\nlife_exp_cycle = (trace[[1]] * (1 / params$n_cohort)) %*% payoff_life_exp\n\n# Function for cycle correction (alternative Simpson's method)\nalt_simp_coef &lt;- function(i) c(17, 59, 43, 49, rep(48, i-8),\n                               49, 43, 59, 17) / 48\ncycle_adj     &lt;- function(x) sum(alt_simp_coef(length(x)) * x)\n\ntotal_life_exp = cycle_adj(life_exp_cycle)"
  },
  {
    "objectID": "slides/01_mortality.html#life-expectancy-6",
    "href": "slides/01_mortality.html#life-expectancy-6",
    "title": "1. Coping with Mortality",
    "section": "Life Expectancy",
    "text": "Life Expectancy\n\n\n\n\n\nAge\nLife Expectancy (Life Table data)\nLife Expectancy (Markov-Life Table)\n\n\n\n\n0\n78.963\n78.924\n\n\n\n\n\n\n\n\nWe can repeat this exercise for different cohort starting ages and verify things line up."
  },
  {
    "objectID": "slides/01_mortality.html#life-expectancy-7",
    "href": "slides/01_mortality.html#life-expectancy-7",
    "title": "1. Coping with Mortality",
    "section": "Life Expectancy",
    "text": "Life Expectancy"
  },
  {
    "objectID": "slides/01_mortality.html#mortality-modeling-1",
    "href": "slides/01_mortality.html#mortality-modeling-1",
    "title": "1. Coping with Mortality",
    "section": "Mortality Modeling",
    "text": "Mortality Modeling\n\nDepending on context and modeling environment, you may need to model mortality.\nThe MortalityLaws package has a number of mortality models we can draw from:"
  },
  {
    "objectID": "slides/01_mortality.html#mortality-modeling-2",
    "href": "slides/01_mortality.html#mortality-modeling-2",
    "title": "1. Coping with Mortality",
    "section": "Mortality Modeling",
    "text": "Mortality Modeling\n\n\n\n\n\n\nName\n\n\nModel\n\n\nCode\n\n\n\n\n\n\nInfant mortality\n\n\n\n\nOpperman\n\n\n\\(\\mu[x] = A/\\sqrt{x} - B + C\\sqrt{x}\\)\n\n\nopperman\n\n\n\n\nWeibull\n\n\n\\(\\mu[x] = 1/\\sigma * (x/M)^{(M/\\sigma - 1)}\\)\n\n\nweibull\n\n\n\n\nAccident hump\n\n\n\n\nInverse-Gompertz\n\n\n\\(\\mu[x] = [1-\\exp((M-x)/\\sigma)]/[\\exp((M-x)/\\sigma)-1]\\)\n\n\ninvgompertz\n\n\n\n\nInverse-Weibull\n\n\n\\(\\mu[x] = 1/\\sigma * (x/M)^{[-M/\\sigma - 1]} / [\\exp((x/M)^{(-M/\\sigma)}) - 1]\\)\n\n\ninvweibull"
  },
  {
    "objectID": "slides/01_mortality.html#section",
    "href": "slides/01_mortality.html#section",
    "title": "1. Coping with Mortality",
    "section": "",
    "text": "Name\n\n\nModel\n\n\nCode\n\n\n\n\n\n\nAdult mortality\n\n\n\n\nGompertz\n\n\n\\(\\mu[x] = A \\exp[Bx]\\)\n\n\ngompertz\n\n\n\n\nGompertz\n\n\n\\(\\mu[x] = 1/\\sigma \\exp[(x-M)/\\sigma]\\)\n\n\ngompertz0\n\n\n\n\nMakeham\n\n\n\\(\\mu[x] = A \\exp[Bx] + C\\)\n\n\nmakeham\n\n\n\n\nMakeham\n\n\n\\(\\mu[x] = 1/\\sigma \\exp[(x-M)/\\sigma)] + C\\)\n\n\nmakeham0\n\n\n\n\nPerks\n\n\n\\(\\mu[x] = [A + BC^x] / [BC^{-x} + 1 + DC^x]\\)\n\n\nperks\n\n\n\n\nStrehler-Mildvan\n\n\n\\(\\mu[x] = K \\exp[-V_0 (1-Bx)/D]\\)\n\n\nstrehler_mildvan\n\n\n\n\nAdult and/or old-age mortality\n\n\n\n\nVan der Maen\n\n\n\\(\\mu[x] = A+Bx+Cx^2 + I/[N-x]\\)\n\n\nvandermaen\n\n\n\n\nBeard\n\n\n\\(\\mu[x] = \\exp(Bx)/[1+KA \\exp(Bx)]\\)\n\n\nbeard\n\n\n\n\nBeard-Makeham\n\n\n\\(\\mu[x] = A \\exp(Bx)/[1 + KA \\exp(Bx)]\\)\n\n\nbeard_makeham\n\n\n\n\nGamma-Gompertz\n\n\n\\(\\mu[x] = A \\exp(Bx)/(1+AG/B[\\exp(Bx)-1])\\)\n\n\nggompertz"
  },
  {
    "objectID": "slides/01_mortality.html#section-1",
    "href": "slides/01_mortality.html#section-1",
    "title": "1. Coping with Mortality",
    "section": "",
    "text": "Name\n\n\nModel\n\n\nCode\n\n\n\n\n\n\nOld-age mortality\n\n\n\n\nVan der Maen\n\n\n\\(\\mu[x] = A + Bx + I/[N-x]\\)\n\n\nvandermaen2\n\n\n\n\nQuadratic\n\n\n$= A + Bx + Cx^2%\n\n\nquadratic\n\n\n\n\nKannisto\n\n\n\\(\\mu[x] = A \\exp(Bx)/[1+A\\exp(Bx)]\\)\n\n\nkannisto\n\n\n\n\nKannisto-Makeham\n\n\n\\(\\mu[x] = A \\exp(Bx)/[1+A\\exp(Bx)]+C\\)\n\n\nkannisto_makeham"
  },
  {
    "objectID": "slides/01_mortality.html#section-2",
    "href": "slides/01_mortality.html#section-2",
    "title": "1. Coping with Mortality",
    "section": "",
    "text": "Name\n\n\nModel\n\n\nCode\n\n\n\n\n\n\nFull age range\n\n\n\n\nThiele\n\n\n\\(\\mu[a] = A e^{-Bx} + C e^{-\\frac{1}{2} D(x-E)^2}+F e^{Gx}\\)\n\n\nthiele\n\n\n\n\nWittstein\n\n\n\\(q[x] = (1/B) A^{-[(Bx)^N]} + A^{-[(M-x)^N]}\\)\n\n\nwittstein\n\n\n\n\nHeligman-Pollard\n\n\n\\(q[x]/p[x] = A^{[(x + B)^C]} + D e^{-E \\log(x/F)^2} + G H^x\\)\n\n\nHP\n\n\n\n\nHeligman-Pollard\n\n\n\\(q[x] = A^{[(x + B)^C]} + D e^{-E \\log(x/F)^2} + GH^x / [1 + GH^x]\\)\n\n\nHP2\n\n\n\n\nRogers-Planck\n\n\n\\(q[x] = A_0 + A_1 e^{-Ax} + A_2 e^{B(x-u)-e^{-C(x-u)}}+A_3 e^{Dx}\\)\n\n\nrogersplanck\n\n\n\n\nMartinelle\n\n\n\\(\\mu[x] = [A e^{Bx} + C]/[1+D e^{Bx}]+K e^{Bx}\\)\n\n\nmartinelle\n\n\n\n\nCarriere\n\n\n\\(l[x] = P1 l[x](weibull) + P2 l[x](invweibull) + P3 l[x](gompertz)\\)\n\n\ncarriere1\n\n\n\n\nKostaki\n\n\n\\(q[x]/p[x] = A^{[(x+B)^C]} + D \\exp[-(E_i \\log(x/F_))^2] + G H^x\\)\n\n\nkostaki"
  },
  {
    "objectID": "slides/01_mortality.html#mortality-modeling-3",
    "href": "slides/01_mortality.html#mortality-modeling-3",
    "title": "1. Coping with Mortality",
    "section": "Mortality Modeling",
    "text": "Mortality Modeling\n\nAnother nice feature of the package is that each mortality model type has its own defined function to calculate the mortality rate (or probability) given an age and model coefficients."
  },
  {
    "objectID": "slides/01_mortality.html#mortality-modeling-4",
    "href": "slides/01_mortality.html#mortality-modeling-4",
    "title": "1. Coping with Mortality",
    "section": "Mortality Modeling",
    "text": "Mortality Modeling\nGenerally speaking, we need three inputs:\n\nage: Ages for lifetable\ndx: The number of deaths between exact ages x and x+1.\nlx: Number of survivors to exact age x."
  },
  {
    "objectID": "slides/01_mortality.html#gompertz-model",
    "href": "slides/01_mortality.html#gompertz-model",
    "title": "1. Coping with Mortality",
    "section": "Gompertz Model",
    "text": "Gompertz Model\n\nBecause we want to stay general (i.e., model all over the age spectrum), our first attempt will be a Gompertz model.\nGompertz reduces mortality to two parameters."
  },
  {
    "objectID": "slides/01_mortality.html#gompertz-model-1",
    "href": "slides/01_mortality.html#gompertz-model-1",
    "title": "1. Coping with Mortality",
    "section": "Gompertz Model",
    "text": "Gompertz Model\n\nages     &lt;- lt$age[lt$age&lt;100]\ndeaths   &lt;- lt$dx[lt$age&lt;100]\nexposure &lt;- lt$lx[lt$age&lt;100]\n\ngom_fit &lt;- MortalityLaw(\n    x  = ages,      # vector with ages\n    Dx  = deaths,   # vector with death counts\n    Ex  = exposure, # vector containing exposures\n    law = \"gompertz\",\n    opt.method = \"LF2\")"
  },
  {
    "objectID": "slides/01_mortality.html#gompertz-model-2",
    "href": "slides/01_mortality.html#gompertz-model-2",
    "title": "1. Coping with Mortality",
    "section": "Gompertz Model",
    "text": "Gompertz Model\n\n# Fitted coefficients\ngom_fit$coefficients\n\n         A          B \n0.00010772 0.07534542"
  },
  {
    "objectID": "slides/01_mortality.html#gompertz-model-3",
    "href": "slides/01_mortality.html#gompertz-model-3",
    "title": "1. Coping with Mortality",
    "section": "Gompertz Model",
    "text": "Gompertz Model\n\n# Fitted coefficients\ngom_fit$coefficients\n\n         A          B \n0.00010772 0.07534542 \n\n# Hazard rate of death for a 40 year old based on Gompertz model\n# mx = A exp(Bx)\ngom_fit$coefficients[\"A\"] * exp(gom_fit$coefficients[\"B\"] * 40 )\n\n        A \n0.0021938"
  },
  {
    "objectID": "slides/01_mortality.html#gompertz-model-4",
    "href": "slides/01_mortality.html#gompertz-model-4",
    "title": "1. Coping with Mortality",
    "section": "Gompertz Model",
    "text": "Gompertz Model\n\n# Fitted coefficients\ngom_fit$coefficients\n\n         A          B \n0.00010772 0.07534542 \n\n# Hazard rate of death for a 40 year old based on Gompertz model\n# mx = A exp(Bx)\ngom_fit$coefficients[\"A\"] * exp(gom_fit$coefficients[\"B\"] * 40 )\n\n        A \n0.0021938 \n\n# Can simply use the supplied function to calcualte \nMortalityLaws::gompertz(x = 40, par = gom_fit$coefficients)\n\n$hx\n[1] 0.0021938\n\n$par\n         A          B \n0.00010772 0.07534542 \n\n$Sx\n[1] 0.97269"
  },
  {
    "objectID": "slides/01_mortality.html#gompertz-model-5",
    "href": "slides/01_mortality.html#gompertz-model-5",
    "title": "1. Coping with Mortality",
    "section": "Gompertz Model",
    "text": "Gompertz Model\n\n# Calculate death hazard rate at age 40 from fitted Gompertz model. \nmx = gom_fit$coefficients[\"A\"] * exp(gom_fit$coefficients[\"B\"] * 40 )"
  },
  {
    "objectID": "slides/01_mortality.html#gompertz-model-6",
    "href": "slides/01_mortality.html#gompertz-model-6",
    "title": "1. Coping with Mortality",
    "section": "Gompertz Model",
    "text": "Gompertz Model\n\n# Calculate death hazard rate at age 40 from fitted Gompertz model. \nmx = gom_fit$coefficients[\"A\"] * exp(gom_fit$coefficients[\"B\"] * 40 )\n\n# Convert mortality rate to probability\n-log(1-mx)\n\n        A \n0.0021962"
  },
  {
    "objectID": "slides/01_mortality.html#gompertz-model-7",
    "href": "slides/01_mortality.html#gompertz-model-7",
    "title": "1. Coping with Mortality",
    "section": "Gompertz Model",
    "text": "Gompertz Model\n\n# Calculate death hazard rate at age 40 from fitted Gompertz model. \nmx = gom_fit$coefficients[\"A\"] * exp(gom_fit$coefficients[\"B\"] * 40 )\n\n# Convert mortality rate to probability\n-log(1-mx)\n\n        A \n0.0021962 \n\n# Compare with life table probability (qx) at age 40:\nlt[41,c(\"age\",\"qx\")] \n\n# A tibble: 1 × 2\n    age      qx\n  &lt;dbl&gt;   &lt;dbl&gt;\n1    40 0.00208"
  },
  {
    "objectID": "slides/01_mortality.html#gompertz-model-8",
    "href": "slides/01_mortality.html#gompertz-model-8",
    "title": "1. Coping with Mortality",
    "section": "Gompertz Model",
    "text": "Gompertz Model\n\nGompertz doesn’t fit all age ranges well—particularly young ages.\n(This is a well-known fact in demography.)\nIf we were to focus only on adults, however, this would be a nice way to go."
  },
  {
    "objectID": "slides/01_mortality.html#gompertz-model-9",
    "href": "slides/01_mortality.html#gompertz-model-9",
    "title": "1. Coping with Mortality",
    "section": "Gompertz Model",
    "text": "Gompertz Model\n\nplot(gom_fit)"
  },
  {
    "objectID": "slides/01_mortality.html#gompertz-model-10",
    "href": "slides/01_mortality.html#gompertz-model-10",
    "title": "1. Coping with Mortality",
    "section": "Gompertz Model",
    "text": "Gompertz Model\n\n\nIf we were to focus only on adults, however, this would be a nice way to go."
  },
  {
    "objectID": "slides/01_mortality.html#gompertz-model-40-year-old-cohort",
    "href": "slides/01_mortality.html#gompertz-model-40-year-old-cohort",
    "title": "1. Coping with Mortality",
    "section": "Gompertz Model: 40 Year Old Cohort",
    "text": "Gompertz Model: 40 Year Old Cohort\n\nages     &lt;- lt$age[lt$age&gt;=40 & lt$age&lt;100]\ndeaths   &lt;- lt$dx[lt$age&gt;=40 & lt$age&lt;100]\nexposure &lt;- lt$lx[lt$age&gt;=40 & lt$age&lt;100]\n\ngom_fit40 &lt;- MortalityLaw(\n                x  = ages,      # vector with ages\n                Dx  = deaths,   # vector with death counts\n                Ex  = exposure, # vector containing exposures\n                law = \"gompertz\",\n                opt.method = \"LF2\")"
  },
  {
    "objectID": "slides/01_mortality.html#gompertz-model-40-year-old-cohort-1",
    "href": "slides/01_mortality.html#gompertz-model-40-year-old-cohort-1",
    "title": "1. Coping with Mortality",
    "section": "Gompertz Model: 40 Year Old Cohort",
    "text": "Gompertz Model: 40 Year Old Cohort\n\nplot(gom_fit40)"
  },
  {
    "objectID": "slides/01_mortality.html#heligman-pollard",
    "href": "slides/01_mortality.html#heligman-pollard",
    "title": "1. Coping with Mortality",
    "section": "Heligman-Pollard",
    "text": "Heligman-Pollard\n\nWhile you could draw from any of the aforementioned mortality models, the Heligman-Pollard model tends to fit the entire age distribution reasonably well.\nEasy to use: just use HP in lieu of gompertz!"
  },
  {
    "objectID": "slides/01_mortality.html#heligman-pollard-1",
    "href": "slides/01_mortality.html#heligman-pollard-1",
    "title": "1. Coping with Mortality",
    "section": "Heligman-Pollard",
    "text": "Heligman-Pollard\n\n\nWhile you could draw from any of the aforementioned mortality models, the Heligman-Pollard model tends to fit the entire age distribution reasonably well.\nEasy to use: just use HP in lieu of gompertz!\n\n\n\nages     &lt;- lt$age[lt$age&lt;100]\ndeaths   &lt;- lt$dx[lt$age&lt;100]\nexposure &lt;- lt$lx[lt$age&lt;100]\n\nhp_fit &lt;- MortalityLaw(\n                x  = ages,      # vector with ages\n                Dx  = deaths,   # vector with death counts\n                Ex  = exposure, # vector containing exposures\n                law = \"HP\",\n                opt.method = \"LF2\")"
  },
  {
    "objectID": "slides/01_mortality.html#heligman-pollard-2",
    "href": "slides/01_mortality.html#heligman-pollard-2",
    "title": "1. Coping with Mortality",
    "section": "Heligman-Pollard",
    "text": "Heligman-Pollard\n\nplot(hp_fit)"
  },
  {
    "objectID": "slides/01_mortality.html#heligman-pollard-3",
    "href": "slides/01_mortality.html#heligman-pollard-3",
    "title": "1. Coping with Mortality",
    "section": "Heligman-Pollard",
    "text": "Heligman-Pollard\nMortality rate for a 40 year old:\n\nHP(x = 40, par = hp_fit$coefficients)\n\n$hx\n[1] 0.0020409\n\n$par\n           A            B            C            D            E           F_ \n 0.000386408  0.021271772  0.107422357  0.001025285  2.871760263 33.201213579 \n           G            H \n 0.000022277  1.102611045 \n\n\n\nx   = 40\nmu1 = A^((x + B)^C) + G * H^x)\nmu2 = D * exp(-E * (log(x/F_))^2))\neta = ifelse(x == 0, mu1, mu1 + mu2)\nhx  = eta/(1 + eta)"
  },
  {
    "objectID": "slides/01_mortality.html#death-hazard-at-age-40-gompertz-vs.-hp",
    "href": "slides/01_mortality.html#death-hazard-at-age-40-gompertz-vs.-hp",
    "title": "1. Coping with Mortality",
    "section": "Death Hazard at Age 40: Gompertz vs. HP",
    "text": "Death Hazard at Age 40: Gompertz vs. HP\n\ngompertz(x = 40, par = gom_fit$coefficients)$hx\n\n[1] 0.0021938\n\nHP(x = 40, par = hp_fit$coefficients)$hx\n\n[1] 0.0020409"
  },
  {
    "objectID": "slides/01_mortality.html#well-approach-this-from-two-angles",
    "href": "slides/01_mortality.html#well-approach-this-from-two-angles",
    "title": "1. Coping with Mortality",
    "section": "We’ll Approach This From Two Angles",
    "text": "We’ll Approach This From Two Angles\n\nDiscrete Event Simulation: Sample a background mortality time.\nDiscrete Time Markov: Use parameterized mortality in Alive-Dead model."
  },
  {
    "objectID": "slides/01_mortality.html#sampling-death-dates-des",
    "href": "slides/01_mortality.html#sampling-death-dates-des",
    "title": "1. Coping with Mortality",
    "section": "1. Sampling Death Dates (DES)",
    "text": "1. Sampling Death Dates (DES)\n\nDifficult to sample death times from life tables due to coarseness of data (e.g., five-year age bins).\nSolution:\n\nFit a parametric mortality model (e.g., Heligman-Pollard)\nConstruct a survival function from modeled hazards.\nSample a death time from the survival function."
  },
  {
    "objectID": "slides/01_mortality.html#sampling-death-rates-des",
    "href": "slides/01_mortality.html#sampling-death-rates-des",
    "title": "1. Coping with Mortality",
    "section": "1. Sampling Death Rates (DES)",
    "text": "1. Sampling Death Rates (DES)\n\nIntuition is easier if we start with a defined quantile (e.g., 25th percentile of survival)"
  },
  {
    "objectID": "slides/01_mortality.html#sampling-death-rates-des-1",
    "href": "slides/01_mortality.html#sampling-death-rates-des-1",
    "title": "1. Coping with Mortality",
    "section": "1. Sampling Death Rates (DES)",
    "text": "1. Sampling Death Rates (DES)\n\n\nIntuition is easier if we start with a defined quantile (e.g., 25th percentile of survival)\n\n\n\nu = 0.25"
  },
  {
    "objectID": "slides/01_mortality.html#sampling-death-rates-des-2",
    "href": "slides/01_mortality.html#sampling-death-rates-des-2",
    "title": "1. Coping with Mortality",
    "section": "1. Sampling Death Rates (DES)",
    "text": "1. Sampling Death Rates (DES)\n\n\nWe can feed the quantile (0.25) and coefficients into an inverse quantile function.\nStraightforward to do for Gompertz model\n\n\n\nu = 0.25\nqgompertz(p = u, shape = gom_fit$coefficients[\"B\"], rate = gom_fit$coefficients[\"A\"])\n\n[1] 70.467"
  },
  {
    "objectID": "slides/01_mortality.html#sampling-death-rates-des-3",
    "href": "slides/01_mortality.html#sampling-death-rates-des-3",
    "title": "1. Coping with Mortality",
    "section": "1. Sampling Death Rates (DES)",
    "text": "1. Sampling Death Rates (DES)\n\n\nLet’s verify this gets us close to what we see in the life table data.\n\n\n\nu = 0.25\nqgompertz(p = u, shape = gom_fit$coefficients[\"B\"], rate = gom_fit$coefficients[\"A\"])\n\n[1] 70.467\n\n\n\n\n\n\n\nage\nmx\nSx\n\n\n\n\n70\n0.01827\n0.76590\n\n\n71\n0.01995\n0.75077\n\n\n72\n0.02162\n0.73472"
  },
  {
    "objectID": "slides/01_mortality.html#sampling-death-rates-des-4",
    "href": "slides/01_mortality.html#sampling-death-rates-des-4",
    "title": "1. Coping with Mortality",
    "section": "1. Sampling Death Rates (DES)",
    "text": "1. Sampling Death Rates (DES)\n\nThere is no inverse quantile function for Heligman-Pollard, but we can create one!"
  },
  {
    "objectID": "slides/01_mortality.html#sampling-death-rates-des-5",
    "href": "slides/01_mortality.html#sampling-death-rates-des-5",
    "title": "1. Coping with Mortality",
    "section": "1. Sampling Death Rates (DES)",
    "text": "1. Sampling Death Rates (DES)\n\n\nThere is no inverse quantile function for Heligman-Pollard, but we can create one!\nApproxfun returns a function that provides a value of y for a given value of x.\n\n\n\nqHP &lt;- \n  approxfun(y = 0:115,\n            x = 1 - exp(-cumsum(HP(x = 0:115, par = hp_fit$coefficients)$hx)))"
  },
  {
    "objectID": "slides/01_mortality.html#sampling-death-rates-des-6",
    "href": "slides/01_mortality.html#sampling-death-rates-des-6",
    "title": "1. Coping with Mortality",
    "section": "1. Sampling Death Rates (DES)",
    "text": "1. Sampling Death Rates (DES)\n\nFor approxfun():\n\nx is quantile in CDF for survival, i.e., 1 - Survival1\ny is the age.\n\nSo qHP(0.5) would return median survival age in the modeled data.\n\nRecall that survival is \\(\\exp(-H)\\), where \\(H\\) is the cumulative hazard"
  },
  {
    "objectID": "slides/01_mortality.html#sampling-death-rates-des-7",
    "href": "slides/01_mortality.html#sampling-death-rates-des-7",
    "title": "1. Coping with Mortality",
    "section": "1. Sampling Death Rates (DES)",
    "text": "1. Sampling Death Rates (DES)\n\nqHP &lt;- \n  approxfun(y = 0:115,\n            x = 1 - exp(-cumsum(HP(x = 0:115, par = hp_fit$coefficients)$hx)))\nqHP(0.25)\n\n[1] 71.069\n\n\nSurvival in life table:\n\n\n\n\n\nage\nmx\nSx\n\n\n\n\n70\n0.01827\n0.76590\n\n\n71\n0.01995\n0.75077\n\n\n72\n0.02162\n0.73472"
  },
  {
    "objectID": "slides/01_mortality.html#sampling-death-rates-des-8",
    "href": "slides/01_mortality.html#sampling-death-rates-des-8",
    "title": "1. Coping with Mortality",
    "section": "1. Sampling Death Rates (DES)",
    "text": "1. Sampling Death Rates (DES)\n\nWe now have the tools we need to sample death times that closely match underlying mortality data!\nFor a given simulated patient, sample a uniform (0,1) and feed this number into the inverse quantile function."
  },
  {
    "objectID": "slides/01_mortality.html#sampling-death-rates-des-9",
    "href": "slides/01_mortality.html#sampling-death-rates-des-9",
    "title": "1. Coping with Mortality",
    "section": "1. Sampling Death Rates (DES)",
    "text": "1. Sampling Death Rates (DES)\n\n\nWe now have the tools we need to sample death times that closely match underlying mortality data!\nFor a given simulated patient, sample a uniform (0,1) and feed this number into the inverse quantile function.\n\n\n\n# Sample death times for 10 individuals\nu &lt;- runif(10, min = 0, max = 1)\nqHP &lt;- \n  approxfun(y = 0:115,\n  x = 1 - exp(-cumsum(HP(x = 0:115, par = hp_fit$coefficients)$hx)))\nqHP(u)\n\n [1] 84.613 77.082 87.010 78.662 86.211 92.977 68.957 89.789 64.050 86.566"
  },
  {
    "objectID": "slides/01_mortality.html#modeled-mortality-markov",
    "href": "slides/01_mortality.html#modeled-mortality-markov",
    "title": "1. Coping with Mortality",
    "section": "2. Modeled Mortality (Markov)",
    "text": "2. Modeled Mortality (Markov)\n\nLet’s now incorporate modeled mortality parameters into our Alive-Dead model.\nRather than draw a probability of death from the life table data, we’ll calculate the probability of death at a given age using the model coefficients."
  },
  {
    "objectID": "slides/01_mortality.html#parameterize-the-model-4",
    "href": "slides/01_mortality.html#parameterize-the-model-4",
    "title": "1. Coping with Mortality",
    "section": "Parameterize the model",
    "text": "Parameterize the model\n\nparams = \n  list(\n    t_names = c(\"lifetable\",          # Strategy names\n                \"heligman-pollard\",\n                \"gompertz\"),          \n    n_treatments = 3,                 # Number of treatments\n    s_names  = c(\"Alive\", \"Dead\"),    # State names\n    n_states = 2,                     # Number of states\n    n_cohort = 100000,                # Cohort size\n    initial_age = 40,                 # Cohort starting age    \n    n_cycles = 110,                   # Number of cycles in model.  \n    cycle = 1,                        # Cycle length\n    life_table = lt,                  # Processed HMD life table data (2019, USA)\n    gom_fit = gom_fit,                # Fitted Gompertz model object\n    hp_fit = hp_fit                   # Fitted Heligman-Pollard model object\n  )"
  },
  {
    "objectID": "slides/01_mortality.html#age-dependent-transition-matrices",
    "href": "slides/01_mortality.html#age-dependent-transition-matrices",
    "title": "1. Coping with Mortality",
    "section": "Age-Dependent Transition Matrices",
    "text": "Age-Dependent Transition Matrices\n\nfn_mPt &lt;- function(t, params) {\n  with(params, {\n    h = cycle # Time step\n    lapply(t, function(tt){\n       # Life table method\n        current_age_lt = pmin(initial_age  + (tt)*h - 1,max(lt$age))\n        p_death &lt;- lt[lt$age==current_age_lt,\"qx\"]\n        # parametric mortality methods\n        current_age = initial_age  + (tt)*h - 1\n        r_death_gompertz &lt;- gompertz(current_age,params$gom_fit$coefficients)$hx\n        p_death_gompertz &lt;- 1 - exp(-r_death_gompertz)\n        r_death_hp &lt;- HP(current_age, params$hp_fit$coefficients)$hx\n        p_death_hp &lt;- 1 - exp(-r_death_hp)\n        \n        array(data = c(1 - p_death, 0, \n                 p_death,1,\n                 \n                 1 - p_death_hp, 0, \n                 p_death_hp,1,\n                 \n                1 - p_death_gompertz, 0, \n                 p_death_gompertz,1),\n              \n              dim = c(n_states, n_states, n_treatments),\n              dimnames = list(from = s_names,\n                              to = s_names,\n                              t_names)) \n    })\n  })\n}"
  },
  {
    "objectID": "slides/01_mortality.html#construct-a-markov-trace",
    "href": "slides/01_mortality.html#construct-a-markov-trace",
    "title": "1. Coping with Mortality",
    "section": "Construct a Markov Trace",
    "text": "Construct a Markov Trace\n\n# Add transition matrices into params.\nparams$mP &lt;- \n  fn_mPt(1:params$n_cycles, params)\n\n# Construct the Markov trace. \ntrace &lt;- \n  sim_cohort(params)"
  },
  {
    "objectID": "slides/01_mortality.html#construct-a-markov-trace-1",
    "href": "slides/01_mortality.html#construct-a-markov-trace-1",
    "title": "1. Coping with Mortality",
    "section": "Construct a Markov Trace",
    "text": "Construct a Markov Trace\n\n\n\ntrace[[\"lifetable\"]][1:10,]\n\n   Alive    Dead\n0 100000    0.00\n1  99792  207.68\n2  99584  416.43\n3  99365  634.88\n4  99138  861.67\n5  98899 1101.19\n6  98639 1361.45\n7  98358 1641.68\n8  98054 1945.62\n9  97728 2271.99\n\n\n\n\ntrace[[\"gompertz\"]][1:10,]\n\n   Alive    Dead\n0 100000    0.00\n1  99781  219.14\n2  99545  454.89\n3  99292  708.46\n4  99019  981.15\n5  98726 1274.35\n6  98410 1589.51\n7  98072 1928.21\n8  97708 2292.12\n9  97317 2682.98\n\n\n\n\ntrace[[\"heligman-pollard\"]][1:10,]\n\n   Alive    Dead\n0 100000    0.00\n1  99796  203.88\n2  99584  416.04\n3  99363  637.42\n4  99131  869.10\n5  98888 1112.31\n6  98632 1368.43\n7  98361 1639.00\n8  98074 1925.75\n9  97769 2230.56"
  },
  {
    "objectID": "slides/01_mortality.html#calculate-life-expectancy",
    "href": "slides/01_mortality.html#calculate-life-expectancy",
    "title": "1. Coping with Mortality",
    "section": "Calculate Life Expectancy",
    "text": "Calculate Life Expectancy\n\n# Define the payoff for life expectancy\npayoff_life_exp = c(\"Alive\" = 1, \"Dead\" = 0)\n\n# Calculate alive years in each cycle\nlife_exp_cycle = lapply(trace, function(tr) (tr * (1 / params$n_cohort)) %*% payoff_life_exp)\n\n# Function for cycle correction (alternative Simpson's method)\nalt_simp_coef &lt;- function(i) c(17, 59, 43, 49, rep(48, i-8),\n                               49, 43, 59, 17) / 48\ncycle_adj     &lt;- function(x) sum(alt_simp_coef(length(x)) * x)\n\ntotal_life_exp = lapply(life_exp_cycle,cycle_adj)"
  },
  {
    "objectID": "slides/01_mortality.html#life-expectancy-alive-dead-model",
    "href": "slides/01_mortality.html#life-expectancy-alive-dead-model",
    "title": "1. Coping with Mortality",
    "section": "Life Expectancy: Alive-Dead Model",
    "text": "Life Expectancy: Alive-Dead Model\n\ntotal_life_exp\n\n$lifetable\n[1] 40.959\n\n$`heligman-pollard`\n[1] 41.008\n\n$gompertz\n[1] 41.29"
  },
  {
    "objectID": "slides/01_mortality.html#motivation",
    "href": "slides/01_mortality.html#motivation",
    "title": "1. Coping with Mortality",
    "section": "Motivation",
    "text": "Motivation\n\nOften, background mortality is drawn directly from life table data.\nModels also frequently include cause-specific death as a separate tracked event or health state."
  },
  {
    "objectID": "slides/01_mortality.html#motivation-1",
    "href": "slides/01_mortality.html#motivation-1",
    "title": "1. Coping with Mortality",
    "section": "Motivation",
    "text": "Motivation\n\nThis approach “double-counts” death because cause-specific death is also reflected in the life table estimates!\nOK if cause-specific death is a small contributor to overall death rates.\nBut what if modeled disease is a frequent cause of death (e.g., cardiovascular disease, cancer)?"
  },
  {
    "objectID": "slides/01_mortality.html#solution",
    "href": "slides/01_mortality.html#solution",
    "title": "1. Coping with Mortality",
    "section": "Solution",
    "text": "Solution\n\nWe can construct an alternative life table that “nets out” cause-specific deaths.\nNot foolproof: need to make an assumption that we can parse out deaths as indepdendent contributors to overall mortality."
  },
  {
    "objectID": "slides/01_mortality.html#cvd-natural-history-model-1",
    "href": "slides/01_mortality.html#cvd-natural-history-model-1",
    "title": "1. Coping with Mortality",
    "section": "CVD Natural History Model",
    "text": "CVD Natural History Model\n\nNext set of slides will walk through the process of constructing a natural history model for cardiovascular disease.\nWe’ll construct a model with non-CVD background mortality, and CVD mortality.\nFirst step is constructing a cause-deleted life table.\n\nNeeded because at older ages, CVD is a substantial contributor (~50%) of overall mortality."
  },
  {
    "objectID": "slides/01_mortality.html#cvd-deleted-life-table",
    "href": "slides/01_mortality.html#cvd-deleted-life-table",
    "title": "1. Coping with Mortality",
    "section": "CVD-Deleted Life Table",
    "text": "CVD-Deleted Life Table\nConstructing the cause-deleted life table requires two necessary inputs:\n\nOverall mortality by age.\nCause-specific mortality by age (ideally as a % of all deaths at a given age).\n\n\nThese are obtainable for many countries from the Global Burden of Disease and Human Cause of Death Database websites."
  },
  {
    "objectID": "slides/01_mortality.html#cvd-deleted-life-table-1",
    "href": "slides/01_mortality.html#cvd-deleted-life-table-1",
    "title": "1. Coping with Mortality",
    "section": "CVD-Deleted Life Table",
    "text": "CVD-Deleted Life Table\n\n\nOur estimates of CVD death by age will be drawn from the Global Burden of Disease website.\n\n\n\n\n\nScreenshot of Global Burden of Disease Data"
  },
  {
    "objectID": "slides/01_mortality.html#section-3",
    "href": "slides/01_mortality.html#section-3",
    "title": "1. Coping with Mortality",
    "section": "",
    "text": "We extract the percentage of overall deaths that are from CVD by age bin:\n\nihme_cvd &lt;- \n  tibble::tribble(\n        ~age_name,        ~val,\n               1, 0.038771524,\n               5, 0.038546046,\n              10, 0.044403585,\n              15, 0.033781126,\n              20, 0.035856165,\n              25, 0.053077797,\n              30, 0.086001439,\n              35, 0.130326551,\n              40, 0.184310334,\n              45,  0.21839762,\n              50, 0.243705394,\n              55, 0.256334637,\n              60,  0.26828001,\n              65, 0.272698709,\n              70,  0.28529754,\n              75, 0.310642009,\n               0, 0.016750489,\n              80, 0.353518012,\n              85, 0.399856716,\n              90, 0.447817792,\n              95, 0.495305502\n        ) %&gt;% \n    mutate(age_ihme = cut(age_name,unique(c(0,1,seq(0,95,5),105)),right=FALSE))  %&gt;% \n    select(age_ihme,  pct_cvd = val)"
  },
  {
    "objectID": "slides/01_mortality.html#section-4",
    "href": "slides/01_mortality.html#section-4",
    "title": "1. Coping with Mortality",
    "section": "",
    "text": "Merge these percentages into the underlying life table data and use them to calculate the total number of CVD deaths by age:\n\n\n\n\n\nage\nage_ihme\npct_cvd\ndx\ndx_i\n\n\n\n\n0\n[0,1)\n0.01675\n553.221\n9\n\n\n10\n[10,15)\n0.04440\n11.518\n1\n\n\n25\n[25,30)\n0.05308\n103.706\n6\n\n\n50\n[50,55)\n0.24371\n365.721\n89\n\n\n75\n[75,80)\n0.31064\n1997.766\n621\n\n\n98\n[95,105)\n0.49531\n1262.593\n625"
  },
  {
    "objectID": "slides/01_mortality.html#section-5",
    "href": "slides/01_mortality.html#section-5",
    "title": "1. Coping with Mortality",
    "section": "",
    "text": "We next calculate the cause-deleted probability of death (qd) and death rate (md), as well as the cause-specific probability of death (qi) and death rate (mi):"
  },
  {
    "objectID": "slides/01_mortality.html#steps",
    "href": "slides/01_mortality.html#steps",
    "title": "1. Coping with Mortality",
    "section": "Steps",
    "text": "Steps\n\nCause-specific probability of death (qi): \\(q \\cdot dx_i / dx\\)\nCacluate cause-specific rates by dividing deaths of a given cause into person-years of exposure.\n\n\nThis is equivalent to multiplying the overall rate by the ratio of deaths of a given cause to the total."
  },
  {
    "objectID": "slides/01_mortality.html#steps-1",
    "href": "slides/01_mortality.html#steps-1",
    "title": "1. Coping with Mortality",
    "section": "Steps",
    "text": "Steps\n\n\nCause-specific probability of death (qi): \\(q \\cdot dx_i / dx\\)\nCacluate cause-specific rates by dividing deaths of a given cause into person-years of exposure.\n\nThis is equivalent to multiplying the overall rate by the ratio of deaths of a given cause to the total.\n\n\n\n\nlt_ &lt;- \n  lt_ %&gt;% \n    # Cause specific probability of death. \n    mutate(qi = q * dx_i / dx) %&gt;% \n    mutate(Rd = (dx - dx_i) / dx) %&gt;% \n    mutate(md = m * Rd) %&gt;% \n    mutate(mi = m - md) %&gt;% \n    mutate(dxd = dx - dx_i)"
  },
  {
    "objectID": "slides/01_mortality.html#section-6",
    "href": "slides/01_mortality.html#section-6",
    "title": "1. Coping with Mortality",
    "section": "",
    "text": "age\ndx\ndxd\ndx_i\nq\nqi\nmd\nmi\n\n\n\n\n0\n553.221\n544.221\n9\n0.00553\n0.00009\n0.00546\n0.00009\n\n\n1\n38.180\n37.180\n1\n0.00038\n0.00001\n0.00037\n0.00001\n\n\n2\n23.160\n22.160\n1\n0.00023\n0.00001\n0.00022\n0.00001\n\n\n3\n17.689\n16.689\n1\n0.00018\n0.00001\n0.00017\n0.00001\n\n\n4\n14.209\n13.209\n1\n0.00014\n0.00001\n0.00013\n0.00001\n\n\n5\n13.213\n12.213\n1\n0.00013\n0.00001\n0.00012\n0.00001"
  },
  {
    "objectID": "slides/01_mortality.html#modeling-cvd-deleted-mortality",
    "href": "slides/01_mortality.html#modeling-cvd-deleted-mortality",
    "title": "1. Coping with Mortality",
    "section": "Modeling CVD-Deleted Mortality",
    "text": "Modeling CVD-Deleted Mortality\n\nWe can also apply the methods covered earlier to the cause-deleted life table data!\n\n\nages_     &lt;- lt_$age[lt_$age&lt;100 & lt_$age&gt;=25]\ndeaths_   &lt;- lt_$dxd[lt_$age&lt;100 & lt_$age&gt;=25] \nexposure_  &lt;- lt_$lx[lt_$age&lt;100 & lt_$age&gt;=25]\n\nmort_fit_CVDdeleted &lt;- MortalityLaw(\n    x  = ages_,\n    Dx  = deaths_,   # vector with death counts\n    Ex  = exposure_, # vector containing exposures\n    law = \"HP2\",\n    opt.method = \"LF2\")"
  },
  {
    "objectID": "slides/01_mortality.html#basic-cvd-model",
    "href": "slides/01_mortality.html#basic-cvd-model",
    "title": "1. Coping with Mortality",
    "section": "Basic CVD Model",
    "text": "Basic CVD Model\n\n\n\n\n\n\n\nG\n\n  \n\nHealthy\n\n Healthy   \n\nHealthy-&gt;Healthy\n\n    \n\nCVD\n\n CVD   \n\nHealthy-&gt;CVD\n\n  r_HS   \n\nDead\n\n Dead   \n\nHealthy-&gt;Dead\n\n  r_HD(t)   \n\nCVD-&gt;CVD\n\n    \n\nDead(CVD)\n\n Dead (CVD)   \n\nCVD-&gt;Dead(CVD)\n\n      r_DCVD(t)           \n\nCVD-&gt;Dead\n\n    r_HD(t)   \n\nDead(CVD)-&gt;Dead(CVD)\n\n    \n\nDead-&gt;Dead"
  },
  {
    "objectID": "slides/01_mortality.html#basic-cvd-model-1",
    "href": "slides/01_mortality.html#basic-cvd-model-1",
    "title": "1. Coping with Mortality",
    "section": "Basic CVD Model",
    "text": "Basic CVD Model\n\n\nHealthy  Death based on modeled (Heligman-Pollard) cause-deleted mortality.\n\n\n\n\n\n\n\n\n\nG\n\n  \n\nHealthy\n\n Healthy   \n\nHealthy-&gt;Healthy\n\n    \n\nCVD\n\n CVD   \n\nHealthy-&gt;CVD\n\n  r_HS   \n\nDead\n\n Dead   \n\nHealthy-&gt;Dead\n\n  r_HD(t)   \n\nCVD-&gt;CVD\n\n    \n\nDead(CVD)\n\n Dead (CVD)   \n\nCVD-&gt;Dead(CVD)\n\n      r_DCVD(t)           \n\nCVD-&gt;Dead\n\n    r_HD(t)   \n\nDead(CVD)-&gt;Dead(CVD)\n\n    \n\nDead-&gt;Dead"
  },
  {
    "objectID": "slides/01_mortality.html#basic-cvd-model-2",
    "href": "slides/01_mortality.html#basic-cvd-model-2",
    "title": "1. Coping with Mortality",
    "section": "Basic CVD Model",
    "text": "Basic CVD Model\n\n\nCVD  Death based on age- and cause-specific death rates from cause-deleted life table.\n\n\n\n\n\n\n\n\n\nG\n\n  \n\nHealthy\n\n Healthy   \n\nHealthy-&gt;Healthy\n\n    \n\nCVD\n\n CVD   \n\nHealthy-&gt;CVD\n\n  r_HS   \n\nDead\n\n Dead   \n\nHealthy-&gt;Dead\n\n  r_HD(t)   \n\nCVD-&gt;CVD\n\n    \n\nDead(CVD)\n\n Dead (CVD)   \n\nCVD-&gt;Dead(CVD)\n\n      r_DCVD(t)           \n\nCVD-&gt;Dead\n\n    r_HD(t)   \n\nDead(CVD)-&gt;Dead(CVD)\n\n    \n\nDead-&gt;Dead"
  },
  {
    "objectID": "slides/01_mortality.html#basic-cvd-model-3",
    "href": "slides/01_mortality.html#basic-cvd-model-3",
    "title": "1. Coping with Mortality",
    "section": "Basic CVD Model",
    "text": "Basic CVD Model\n\n\nWe also allow for a CVD  Death transition based on non-CVD causes.\n\n\n\n\n\n\n\n\n\nG\n\n  \n\nHealthy\n\n Healthy   \n\nHealthy-&gt;Healthy\n\n    \n\nCVD\n\n CVD   \n\nHealthy-&gt;CVD\n\n  r_HS   \n\nDead\n\n Dead   \n\nHealthy-&gt;Dead\n\n  r_HD(t)   \n\nCVD-&gt;CVD\n\n    \n\nDead(CVD)\n\n Dead (CVD)   \n\nCVD-&gt;Dead(CVD)\n\n      r_DCVD(t)           \n\nCVD-&gt;Dead\n\n    r_HD(t)   \n\nDead(CVD)-&gt;Dead(CVD)\n\n    \n\nDead-&gt;Dead"
  },
  {
    "objectID": "slides/01_mortality.html#age-dependent-transition-matrices-1",
    "href": "slides/01_mortality.html#age-dependent-transition-matrices-1",
    "title": "1. Coping with Mortality",
    "section": "Age-Dependent Transition Matrices",
    "text": "Age-Dependent Transition Matrices"
  },
  {
    "objectID": "slides/01_mortality.html#construct-a-markov-trace-2",
    "href": "slides/01_mortality.html#construct-a-markov-trace-2",
    "title": "1. Coping with Mortality",
    "section": "Construct a Markov Trace",
    "text": "Construct a Markov Trace\n\ntrace &lt;- \n  sim_cohort(params)\ntrace[[\"natural_history\"]][1:10,]\n\n  Healthy     CVD CVDDeath    Dead\n0  100000     0.0   0.0000    0.00\n1   90391  9506.2   0.2945  103.00\n2   81702 18088.0   1.1404  208.58\n3   73847 25833.6   2.4853  316.88\n4   66745 32822.6   4.2817  428.11\n5   60324 39126.6   6.8544  542.45\n6   54519 44809.4  11.5751  660.14\n7   49270 49930.7  17.3944  781.42\n8   44526 54544.1  23.8195  906.57\n9   40236 58697.0  31.3741 1035.87"
  },
  {
    "objectID": "slides/01_mortality.html#good-news",
    "href": "slides/01_mortality.html#good-news",
    "title": "1. Coping with Mortality",
    "section": "Good News",
    "text": "Good News\n\nModeled CVD and non-CVD mortality closely matches the cause-deleted life table data!"
  },
  {
    "objectID": "slides/02_competing-events.html#learning-objectives",
    "href": "slides/02_competing-events.html#learning-objectives",
    "title": "Competing Risks",
    "section": "Learning Objectives",
    "text": "Learning Objectives\n\nPitfalls of traditional transition probability conversion formulas.\nDiscuss compound transitions and how to account for them.\nDemonstrate how to properly embed a transition probability matrix into a timestep.\n\n\n\n\n\n\n\n\nCode\nsource(\"./manifest.r\")\n\n# # Better accuracy that \"life-table\" aka trapezoidal method\n# alt_simp_coef &lt;- function(i) c(17, 59, 43, 49, rep(48, i-8), 49, 43, 59, 17) / 48\n# alt_simp      &lt;- function(x,h) h*sum(alt_simp_coef(length(x)) * x)\n# \n# r_H_CVD &lt;- 0.15\n# r_HD &lt;- .006\n# hr_S &lt;- 10\n# r_SD &lt;- hr_S*r_HD\n# cycle &lt;- 1\n# \n# # 1-exp(-r_H_CVD*cycle)\n# # 1-exp(-r_HD*cycle)\n# \n# get_P &lt;- function(r_H_CVD,r_HD,r_SD,cycle) {\n#   P_st &lt;- \n#   matrix(\n#   c(exp(-r_H_CVD*cycle) + exp(-r_HD*cycle) -1 ,  (1-exp(-r_H_CVD*cycle)) ,  1-exp(-r_HD*cycle), \n#   0, exp(-r_SD*cycle), 1-exp(-r_SD*cycle),\n#   0,0,1),\n#   nrow = 3, \n#   ncol = 3,\n#   byrow=TRUE,\n#   dimnames = list(c(\"Healthy\",\"Sick\",\"Dead\"), c(\"Healthy\",\"Sick\",\"Dead\"))\n#   ) %&gt;% \n#     data.frame() %&gt;% \n#     rownames_to_column(var = \"from\") %&gt;% \n#     mutate(name = \"P_st\")\n# \n#   P_eQ &lt;- matrix(\n#     c(-(r_H_CVD*cycle+r_HD*cycle),r_H_CVD*cycle,r_HD*cycle,\n#       0,-r_SD*cycle,r_SD*cycle,\n#       0,0,0),\n#       nrow=3,\n#       ncol=3,\n#       byrow=TRUE,\n#     dimnames = list(c(\"Healthy\",\"Sick\",\"Dead\"), c(\"Healthy\",\"Sick\",\"Dead\"))\n#   ) %&gt;% expm() %&gt;% as.matrix() %&gt;% \n#     data.frame() %&gt;% \n#     rownames_to_column(var = \"from\") %&gt;% \n#     mutate(name = \"P_eQ\")\n# \n# \n#   P_cr &lt;- \n#     matrix(\n#     c(exp(-(r_H_CVD+r_HD)*cycle) , (r_H_CVD/(r_H_CVD+r_HD)) * (1-exp(-(r_H_CVD+r_HD)*cycle))   ,(r_HD/(r_H_CVD+r_HD)) * (1-exp(-(r_H_CVD+r_HD)*cycle))   , \n#     0, exp(-r_SD*cycle), 1-exp(-r_SD*cycle),\n#     0,0,1),\n#     nrow = 3, \n#     ncol = 3,\n#     byrow=TRUE,\n#     dimnames = list(c(\"Healthy\",\"Sick\",\"Dead\"), c(\"Healthy\",\"Sick\",\"Dead\"))\n#   ) %&gt;% \n#     data.frame() %&gt;% \n#     rownames_to_column(var = \"from\") %&gt;% mutate(name = \"P_cr\")\n#   \n#   \n#   \n#   out &lt;- bind_rows( P_st, P_cr , P_eQ)\n#   return(out)\n# }"
  },
  {
    "objectID": "slides/02_competing-events.html#section",
    "href": "slides/02_competing-events.html#section",
    "title": "Competing Risks",
    "section": "",
    "text": "We will first construct a very simple CVD model with only two states: Healthy and CVD.\nTransitions are goverened by a single rate from Healthy  CVD"
  },
  {
    "objectID": "slides/02_competing-events.html#section-1",
    "href": "slides/02_competing-events.html#section-1",
    "title": "Competing Risks",
    "section": "",
    "text": "We will first construct a very simple CVD model with only two states: Healthy and CVD.\nTransitions are goverened by a single rate from Healthy  CVD\n\n\n\n\n\n\n\n\n\nG\n\n  \n\nHealthy\n\n Healthy   \n\nHealthy-&gt;Healthy\n\n    \n\nCVD\n\n CVD   \n\nHealthy-&gt;CVD\n\n  r_H_CVD = 0.15   \n\nDead\n\n Dead   \n\nHealthy-&gt;Dead\n\n  r_HD=0.006   \n\nCVD-&gt;CVD\n\n    \n\nCVD-&gt;Dead\n\n  hr_S * r_HD hr_S=10   \n\nDead-&gt;Dead"
  },
  {
    "objectID": "slides/02_competing-events.html#parameterize-the-model",
    "href": "slides/02_competing-events.html#parameterize-the-model",
    "title": "Competing Risks",
    "section": "Parameterize the model",
    "text": "Parameterize the model\n\nparams = \n  list(\n    t_names = c(\"natural_history\"),   # Strategy names. \n    n_treatments = 1,                 # Number of treatments\n    s_names  = c(\"Healthy\", \"CVD\"),   # State names\n    n_states = 2,                     # Number of states\n    n_cohort = 1,                     # Cohort size\n    n_cycles = 100,                   # Number of cycles in model.  \n    cycle = 1,                        # Cycle length\n    initial_age = 55,                 # Cohort starting age\n    r_H_CVD = 0.15                    # Rate of healthy -&gt; CVD\n  )"
  },
  {
    "objectID": "slides/02_competing-events.html#transition-probability-matrix",
    "href": "slides/02_competing-events.html#transition-probability-matrix",
    "title": "Competing Risks",
    "section": "Transition Probability Matrix",
    "text": "Transition Probability Matrix\nWe’ll next construct a transition probability matrix using the standard rate-to-probability conversion formula:\n\\[\np = 1 - \\exp(-rt)\n\\] where \\(r\\) is the rate, \\(t\\) is the time-step (e.g., 1 for annual, 1/12 for monthly, etc.)."
  },
  {
    "objectID": "slides/02_competing-events.html#transition-probability-matrix-1",
    "href": "slides/02_competing-events.html#transition-probability-matrix-1",
    "title": "Competing Risks",
    "section": "Transition Probability Matrix",
    "text": "Transition Probability Matrix\n\nparams$mP &lt;- \n  with(params,{\n    tp_H_CVD = 1 - exp(-r_H_CVD * cycle) \n    array(data = c(1 - tp_H_CVD, 0, \n                 tp_H_CVD,1),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n  })"
  },
  {
    "objectID": "slides/02_competing-events.html#transition-probability-matrix-2",
    "href": "slides/02_competing-events.html#transition-probability-matrix-2",
    "title": "Competing Risks",
    "section": "Transition Probability Matrix",
    "text": "Transition Probability Matrix\n\nparams$mP &lt;- \n  with(params,{\n    tp_H_CVD = 1 - exp(-r_H_CVD * cycle) \n    array(data = c(1 - tp_H_CVD, 0, \n                 tp_H_CVD,1),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n  })\n\n\n\nNext, place these probabilities within the transition probability matrix array.\n\n\n\nOuter array dimensions goverened by the number of strategies under consideration."
  },
  {
    "objectID": "slides/02_competing-events.html#transition-probability-matrix-3",
    "href": "slides/02_competing-events.html#transition-probability-matrix-3",
    "title": "Competing Risks",
    "section": "Transition Probability Matrix",
    "text": "Transition Probability Matrix\n\nparams$mP &lt;- \n  with(params,{\n    tp_H_CVD = 1 - exp(-r_H_CVD * cycle) \n    array(data = c(1 - tp_H_CVD, 0, \n                 tp_H_CVD,1),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n  })\n\n\n\nRemaining code simply names the various dimensions of the array."
  },
  {
    "objectID": "slides/02_competing-events.html#transition-probability-matrix-4",
    "href": "slides/02_competing-events.html#transition-probability-matrix-4",
    "title": "Competing Risks",
    "section": "Transition Probability Matrix",
    "text": "Transition Probability Matrix\n\n\n$natural_history\n         to\nfrom      Healthy     CVD\n  Healthy 0.86071 0.13929\n  CVD     0.00000 1.00000"
  },
  {
    "objectID": "slides/02_competing-events.html#construct-the-markov-trace",
    "href": "slides/02_competing-events.html#construct-the-markov-trace",
    "title": "Competing Risks",
    "section": "Construct the Markov Trace",
    "text": "Construct the Markov Trace\n\nsim_cohort &lt;- function(params) {\n  tr_ &lt;- t(c(\"Healthy\" = params$n_cohort, \"CVD\" = 0)) \n  trace &lt;- \n    0:params$n_cycles %&gt;% map_df(~({ \n        apply(params$mP,3, simplify=FALSE, function(tp) {  \n          (tr_ %*% (tp %^% .x)) %&gt;% data.frame()\n        })\n    })) %&gt;% \n    as.matrix() \n}\n\n\n\nsim_cohort(params) is a function that constructs a Markov trace from the supplied parameters."
  },
  {
    "objectID": "slides/02_competing-events.html#construct-the-markov-trace-1",
    "href": "slides/02_competing-events.html#construct-the-markov-trace-1",
    "title": "Competing Risks",
    "section": "Construct the Markov Trace",
    "text": "Construct the Markov Trace\n\nsim_cohort &lt;- function(params) {\n  tr_ &lt;- t(c(\"Healthy\" = params$n_cohort, \"CVD\" = 0)) \n  trace &lt;- \n    0:params$n_cycles %&gt;% map_df(~({  \n        apply(params$mP,3, simplify=FALSE, function(tp) {  \n          (tr_ %*% (tp %^% .x)) %&gt;% data.frame()\n        })\n    })) %&gt;% \n    as.matrix() \n}\n\n\n\nSpecify the initial state occupancy."
  },
  {
    "objectID": "slides/02_competing-events.html#construct-the-markov-trace-2",
    "href": "slides/02_competing-events.html#construct-the-markov-trace-2",
    "title": "Competing Risks",
    "section": "Construct the Markov Trace",
    "text": "Construct the Markov Trace\n\nsim_cohort &lt;- function(params) {\n  tr_ &lt;- t(c(\"Healthy\" = params$n_cohort, \"CVD\" = 0)) \n  trace &lt;- \n    0:params$n_cycles %&gt;% map_df(~({  \n        apply(params$mP,3, simplify=FALSE, function(tp) {  \n          (tr_ %*% (tp %^% .x)) %&gt;% data.frame()\n        })\n    })) %&gt;% \n    as.matrix() \n}\n\n\n\nIterate over the cycles in the model."
  },
  {
    "objectID": "slides/02_competing-events.html#construct-the-markov-trace-3",
    "href": "slides/02_competing-events.html#construct-the-markov-trace-3",
    "title": "Competing Risks",
    "section": "Construct the Markov Trace",
    "text": "Construct the Markov Trace\n\nsim_cohort &lt;- function(params) {\n  tr_ &lt;- t(c(\"Healthy\" = params$n_cohort, \"CVD\" = 0)) \n  trace &lt;- \n    0:params$n_cycles %&gt;% map_df(~({  \n        apply(params$mP,3, simplify=FALSE, function(tp) {  \n          (tr_ %*% (tp %^% .x)) %&gt;% data.frame()\n        })\n    })) %&gt;% \n    as.matrix() \n}\n\n\n\nWithin a cycle, iterate over the strategies under consideration."
  },
  {
    "objectID": "slides/02_competing-events.html#construct-the-markov-trace-4",
    "href": "slides/02_competing-events.html#construct-the-markov-trace-4",
    "title": "Competing Risks",
    "section": "Construct the Markov Trace",
    "text": "Construct the Markov Trace\nThe markov trace tells us the fraction of the population in each state in any cycle:\n\ntrace &lt;- sim_cohort(params)\ntrace[1:5,]\n\n     natural_history.Healthy natural_history.CVD\n[1,]                 1.00000             0.00000\n[2,]                 0.86071             0.13929\n[3,]                 0.74082             0.25918\n[4,]                 0.63763             0.36237\n[5,]                 0.54881             0.45119"
  },
  {
    "objectID": "slides/02_competing-events.html#cvd-state-occupancy-at-two-years",
    "href": "slides/02_competing-events.html#cvd-state-occupancy-at-two-years",
    "title": "Competing Risks",
    "section": "1. CVD State Occupancy at Two Years",
    "text": "1. CVD State Occupancy at Two Years\n\nSuppose we start off with a cohort of 1000 healthy individuals.\nHow many are in the CVD health state at year 2?"
  },
  {
    "objectID": "slides/02_competing-events.html#cvd-state-occupancy-at-two-years-1",
    "href": "slides/02_competing-events.html#cvd-state-occupancy-at-two-years-1",
    "title": "Competing Risks",
    "section": "1. CVD State Occupancy at Two Years",
    "text": "1. CVD State Occupancy at Two Years\n\n\nSuppose we start off with a cohort of 1000 healthy individuals.\nHow many are in the CVD health state at year 2?\n\n\n\nPin this number to your brain for a few minutes!\n\n\n(1000*trace[3,]) %&gt;% t() %&gt;% \n  data.frame() %&gt;% \n  kable(col.names = c(\"Healthy\",\"CVD\")) %&gt;% \n  kable_styling()\n\n\n\n\nHealthy\nCVD\n\n\n\n\n740.82\n259.18"
  },
  {
    "objectID": "slides/02_competing-events.html#life-expectancy",
    "href": "slides/02_competing-events.html#life-expectancy",
    "title": "Competing Risks",
    "section": "2. Life Expectancy",
    "text": "2. Life Expectancy\n\nWe have a model with 100 annual cycles and no death.\nLet’s verify that life expectancy is 100."
  },
  {
    "objectID": "slides/02_competing-events.html#life-expectancy-1",
    "href": "slides/02_competing-events.html#life-expectancy-1",
    "title": "Competing Risks",
    "section": "2. Life Expectancy",
    "text": "2. Life Expectancy\n\n\nWe have a model with 100 annual cycles and no death.\nLet’s verify that life expectancy is 100\n\n\n\n1payoff_life_exp = c(\"Healthy\" = 1, \"CVD\" = 1)\n2life_exp_cycle = trace[-1,] %*% payoff_life_exp\n3total_life_exp = sum(life_exp_cycle)\n\n\n1\n\nLife expectancy payoff is 1 for every state where someone remains alive.\n\n2\n\nTotal life-years alive in each state is the markov trace multiplied by the payoff vector.\n\n3\n\nTotal life expectancy is the sum of cycle values."
  },
  {
    "objectID": "slides/02_competing-events.html#life-expectancy-2",
    "href": "slides/02_competing-events.html#life-expectancy-2",
    "title": "Competing Risks",
    "section": "2. Life Expectancy",
    "text": "2. Life Expectancy\n\n\nWe have a model with 100 annual cycles and no death.\nLet’s verify that life expectancy is 100\n\n\n\npayoff_life_exp = c(\"Healthy\" = 1, \"CVD\" = 1)\nlife_exp_cycle = trace[-1,] %*% payoff_life_exp\ntotal_life_exp = sum(life_exp_cycle)\ntotal_life_exp * params$cycle\n\n[1] 100"
  },
  {
    "objectID": "slides/02_competing-events.html#daily-cycle-length",
    "href": "slides/02_competing-events.html#daily-cycle-length",
    "title": "Competing Risks",
    "section": "3. Daily Cycle Length",
    "text": "3. Daily Cycle Length\n\nWe will next switch to a daily cycle length and verify that we can recapitulate these numbers."
  },
  {
    "objectID": "slides/02_competing-events.html#daily-cycle-length-1",
    "href": "slides/02_competing-events.html#daily-cycle-length-1",
    "title": "Competing Risks",
    "section": "3. Daily Cycle Length",
    "text": "3. Daily Cycle Length\n\n\nWe will next switch to a daily cycle length and verify that we can recapitulate these numbers.\n\n\n\nparams_daily &lt;- modifyList(params,list(\n  cycle = 1/365,\n  n_cycles = params$n_cycles * 365))"
  },
  {
    "objectID": "slides/02_competing-events.html#daily-cycle-length-2",
    "href": "slides/02_competing-events.html#daily-cycle-length-2",
    "title": "Competing Risks",
    "section": "3. Daily Cycle Length",
    "text": "3. Daily Cycle Length\n\nparams_daily$mP &lt;- \n  with(params_daily,{\n    tp_H_CVD = 1 - exp(-r_H_CVD * cycle) \n    array(data = c(1 - tp_H_CVD, 0, \n                 tp_H_CVD,1),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n  }) \n\n\napply(params_daily$mP,3,function(x) x, simplify=FALSE)\n\n$natural_history\n         to\nfrom      Healthy        CVD\n  Healthy 0.99959 0.00041087\n  CVD     0.00000 1.00000000"
  },
  {
    "objectID": "slides/02_competing-events.html#daily-cycle-length-3",
    "href": "slides/02_competing-events.html#daily-cycle-length-3",
    "title": "Competing Risks",
    "section": "3. Daily Cycle Length",
    "text": "3. Daily Cycle Length\n\n# Markov Trace (Daily Cycle)\ntrace_daily &lt;- \n  sim_cohort(params_daily)\n\n# State Occupancy at 2 Years\n1000 * trace_daily[365 * 2 + 1,]\n\n\ntrace_daily &lt;- \n  sim_cohort(params_daily)\n(1000 * trace_daily[365 * 2 + 1,]) %&gt;% t() %&gt;% \ndata.frame() %&gt;% \n  kable(col.names = c(\"Healthy\",\"CVD\")) %&gt;% \n  kable_styling()\n\n\n\n\nHealthy\nCVD\n\n\n\n\n740.82\n259.18"
  },
  {
    "objectID": "slides/02_competing-events.html#daily-cycle-length-4",
    "href": "slides/02_competing-events.html#daily-cycle-length-4",
    "title": "Competing Risks",
    "section": "3. Daily Cycle Length",
    "text": "3. Daily Cycle Length\n\n# Life Expectancy\npayoff_life_exp = c(\"Healthy\" = 1, \"CVD\" = 1) \nlife_exp_cycle_daily = trace_daily[-1,] %*% payoff_life_exp  \ntotal_life_exp_daily = sum(life_exp_cycle_daily) \ntotal_life_exp_daily * params_daily$cycle\n\n[1] 100"
  },
  {
    "objectID": "slides/02_competing-events.html#summary",
    "href": "slides/02_competing-events.html#summary",
    "title": "Competing Risks",
    "section": "Summary",
    "text": "Summary\n\nAfter 2 years, 259 individuals are in the CVD health state.\nBecause there is no death, after 100 cycles life expectancy is 100 years.\nWe verified that the above results hold exactly when we convert to a daily cycle length."
  },
  {
    "objectID": "slides/02_competing-events.html#section-2",
    "href": "slides/02_competing-events.html#section-2",
    "title": "Competing Risks",
    "section": "",
    "text": "We next include a background mortality rate that is increased by a hazard ratio (10.0) among people with CVD."
  },
  {
    "objectID": "slides/02_competing-events.html#section-3",
    "href": "slides/02_competing-events.html#section-3",
    "title": "Competing Risks",
    "section": "",
    "text": "We next include a background mortality rate that is increased by a hazard ratio (10.0) among people with CVD.\n\n\n\n\n\n\n\n\n\nG\n\n  \n\nHealthy\n\n Healthy   \n\nHealthy-&gt;Healthy\n\n    \n\nCVD\n\n CVD   \n\nHealthy-&gt;CVD\n\n  r_H_CVD = 0.15   \n\nDead\n\n Dead   \n\nHealthy-&gt;Dead\n\n  r_HD=0.01   \n\nCVD-&gt;CVD\n\n    \n\nCVD-&gt;Dead\n\n   hr_CVD * r_HD hr_CVD=10   \n\nDead-&gt;Dead"
  },
  {
    "objectID": "slides/02_competing-events.html#parameterize-the-model-1",
    "href": "slides/02_competing-events.html#parameterize-the-model-1",
    "title": "Competing Risks",
    "section": "Parameterize the model",
    "text": "Parameterize the model\n\nparams_mort = \n  list(\n    t_names = c(\"natural_history\"),           # Strategy names. \n    n_treatments = 1,                         # Number of treatments\n    s_names  = c(\"Healthy\", \"CVD\", \"Dead\"),   # State names\n    n_states = 3,                             # Number of states\n    n_cohort = 1,                             # Cohort size\n    n_cycles = 100,                           # Number of cycles in model.  \n    cycle = 1,                                # Cycle length\n    initial_age = 55,                         # Cohort starting age\n    r_H_CVD = 0.15,                           # Rate of healthy -&gt; CVD\n    hr_CVD = 10,                              # Hazard Ratio: CVD Death\n    r_H_D = 0.01                              # Rate of healthy -&gt; dead\n  )"
  },
  {
    "objectID": "slides/02_competing-events.html#transition-probability-matrix-5",
    "href": "slides/02_competing-events.html#transition-probability-matrix-5",
    "title": "Competing Risks",
    "section": "Transition Probability Matrix",
    "text": "Transition Probability Matrix\n\nparams_mort$mP &lt;- \n  with(params_mort,{\n    \n    tp_H_CVD = 1 - exp(-r_H_CVD * cycle) \n    tp_H_D = 1 - exp(-r_H_D * cycle)\n    tp_CVD_D &lt;- 1 - exp(-(hr_CVD * r_H_D) * cycle)\n    \n    array(data = c(1 - tp_H_CVD - tp_H_D, 0, 0, \n                 tp_H_CVD,1-tp_CVD_D, 0,\n                 tp_H_D, tp_CVD_D, 1),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n  })"
  },
  {
    "objectID": "slides/02_competing-events.html#transition-probability-matrix-6",
    "href": "slides/02_competing-events.html#transition-probability-matrix-6",
    "title": "Competing Risks",
    "section": "Transition Probability Matrix",
    "text": "Transition Probability Matrix\n\n\n$natural_history\n         to\nfrom      Healthy     CVD      Dead\n  Healthy 0.85076 0.13929 0.0099502\n  CVD     0.00000 0.90484 0.0951626\n  Dead    0.00000 0.00000 1.0000000"
  },
  {
    "objectID": "slides/02_competing-events.html#construct-the-markov-trace-5",
    "href": "slides/02_competing-events.html#construct-the-markov-trace-5",
    "title": "Competing Risks",
    "section": "Construct the Markov Trace",
    "text": "Construct the Markov Trace\n\nsim_cohort &lt;- function(params) {\n  tr_ &lt;- c(1,rep(0,params$n_states-1))\n  trace &lt;- \n    0:params$n_cycles %&gt;% map_df(~({ \n        apply(params$mP,3, simplify=FALSE, function(tp) {  \n          (tr_ %*% (tp %^% .x)) %&gt;% data.frame()\n        })\n    })) %&gt;% \n    as.matrix() \n}\n\ntrace_mort &lt;- \n  sim_cohort(params_mort)"
  },
  {
    "objectID": "slides/02_competing-events.html#construct-the-markov-trace-6",
    "href": "slides/02_competing-events.html#construct-the-markov-trace-6",
    "title": "Competing Risks",
    "section": "Construct the Markov Trace",
    "text": "Construct the Markov Trace\n\ntrace_mort[1:5,]\n\n     natural_history.Healthy natural_history.CVD natural_history.Dead\n[1,]                 1.00000             0.00000            0.0000000\n[2,]                 0.85076             0.13929            0.0099502\n[3,]                 0.72379             0.24454            0.0316707\n[4,]                 0.61577             0.32209            0.0621437\n[5,]                 0.52387             0.37721            0.0989213"
  },
  {
    "objectID": "slides/02_competing-events.html#cvd-state-occupancy-at-2-years",
    "href": "slides/02_competing-events.html#cvd-state-occupancy-at-2-years",
    "title": "Competing Risks",
    "section": "1. CVD State Occupancy at 2 Years",
    "text": "1. CVD State Occupancy at 2 Years\n\n(1000*trace_mort[3,]) %&gt;% t() %&gt;% \n  data.frame() %&gt;% \n  kable(digits = 1,col.names = c(\"Healthy\",\"CVD\",\"Dead\")) %&gt;% \n  kable_styling()\n\n\n\n\nHealthy\nCVD\nDead\n\n\n\n\n723.8\n244.5\n31.7"
  },
  {
    "objectID": "slides/02_competing-events.html#life-expectancy-3",
    "href": "slides/02_competing-events.html#life-expectancy-3",
    "title": "Competing Risks",
    "section": "2. Life Expectancy",
    "text": "2. Life Expectancy\n\npayoff_life_exp_mort = c(\"Healthy\" = 1, \"CVD\" = 1, \"Dead\" = 0) \nlife_exp_cycle_mort = trace_mort[-1,] %*% payoff_life_exp_mort \ntotal_life_exp_mort = sum(life_exp_cycle_mort)\ntotal_life_exp_mort\n\n[1] 15.507"
  },
  {
    "objectID": "slides/02_competing-events.html#daily-cycle-length-5",
    "href": "slides/02_competing-events.html#daily-cycle-length-5",
    "title": "Competing Risks",
    "section": "3. Daily Cycle Length",
    "text": "3. Daily Cycle Length\n\nparams_mort_daily &lt;- modifyList(params_mort,list(\n  cycle = 1/365,\n  n_cycles = params$n_cycles * 365))"
  },
  {
    "objectID": "slides/02_competing-events.html#daily-cycle-length-6",
    "href": "slides/02_competing-events.html#daily-cycle-length-6",
    "title": "Competing Risks",
    "section": "3. Daily Cycle Length",
    "text": "3. Daily Cycle Length\n\nparams_mort_daily$mP &lt;- \n  with(params_mort_daily,{\n    tp_H_CVD = 1 - exp(-r_H_CVD * cycle) \n    tp_H_D = 1 - exp(-r_H_D * cycle)\n    tp_CVD_D &lt;- 1 - exp(-(hr_CVD * r_H_D) * cycle)\n    \n    array(data = c(1 - tp_H_CVD - tp_H_D, 0, 0, \n                 tp_H_CVD,1-tp_CVD_D, 0,\n                 tp_H_D, tp_CVD_D, 1),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n  })"
  },
  {
    "objectID": "slides/02_competing-events.html#daily-cycle-length-7",
    "href": "slides/02_competing-events.html#daily-cycle-length-7",
    "title": "Competing Risks",
    "section": "3. Daily Cycle Length",
    "text": "3. Daily Cycle Length\n\napply(params_mort_daily$mP,3,function(x) x, simplify = FALSE)\n\n$natural_history\n         to\nfrom      Healthy        CVD        Dead\n  Healthy 0.99956 0.00041087 0.000027397\n  CVD     0.00000 0.99972606 0.000273935\n  Dead    0.00000 0.00000000 1.000000000"
  },
  {
    "objectID": "slides/02_competing-events.html#daily-cycle-length-8",
    "href": "slides/02_competing-events.html#daily-cycle-length-8",
    "title": "Competing Risks",
    "section": "3. Daily Cycle Length",
    "text": "3. Daily Cycle Length\n\n# Markov Trace (Daily Cycle)\ntrace_mort_daily &lt;- sim_cohort(params_mort_daily)\n\n\n\n\n\n\nHealthy\nCVD\nDead\n\n\n\n\n726.1\n231.5\n42.4"
  },
  {
    "objectID": "slides/02_competing-events.html#daily-cycle-length-9",
    "href": "slides/02_competing-events.html#daily-cycle-length-9",
    "title": "Competing Risks",
    "section": "3. Daily Cycle Length",
    "text": "3. Daily Cycle Length\n\n# Life Expectancy\npayoff_mort_life_exp = c(\"Healthy\" = 1, \"CVD\" = 1, \"Death\" = 0) \nlife_exp_mort_daily = trace_mort_daily[-1,] %*% payoff_mort_life_exp  \ntotal_life_exp_mort_daily = sum(life_exp_mort_daily) \ntotal_life_exp_mort_daily * params_mort_daily$cycle\n\n[1] 15.624"
  },
  {
    "objectID": "slides/02_competing-events.html#signs-of-trouble",
    "href": "slides/02_competing-events.html#signs-of-trouble",
    "title": "Competing Risks",
    "section": "Signs of Trouble",
    "text": "Signs of Trouble\n\n\n\n\n\n\nIn the presence of competing events (mortality), we obtain different results for different cycle lengths!"
  },
  {
    "objectID": "slides/02_competing-events.html#signs-of-trouble-1",
    "href": "slides/02_competing-events.html#signs-of-trouble-1",
    "title": "Competing Risks",
    "section": "Signs of Trouble",
    "text": "Signs of Trouble\n\n\n\n\n\n\nIn the presence of competing events (mortality), we obtain different results for different cycle lengths!\n\n\n\ncvd2_ann &lt;- unname((1000*trace[3,2]))\ncvd2_day &lt;- unname((1000*trace_daily[365*2+1,2]))\ncvd2_ann_mort &lt;- 1000*trace_mort[3,2]\ncvd2_day_mort &lt;- 1000*trace_mort_daily[365*2+1,2]\n\nle_ann &lt;- total_life_exp * params$cycle\nle_day &lt;- total_life_exp_daily * params_daily$cycle\nle_mort_ann &lt;- total_life_exp_mort * params_mort$cycle\nle_mort_day &lt;- total_life_exp_mort_daily * params_mort_daily$cycle \n\ntibble(measure = c(\"1. CVD State Occupancy at Two Years\", \"2. Life Expectancy\"), \n       annual = c(cvd2_ann, le_ann),\n       daily = c(cvd2_day, le_day),\n       annual_mort= c(cvd2_ann_mort,le_mort_ann),\n       daily_mort = c(cvd2_day_mort, le_mort_day)) %&gt;% \n  gt()  %&gt;% \n  gt::data_color(\n    method = \"numeric\",\n    palette = \"ggsci::red_material\",\n    domain = c(15.5,15.65),\n    columns = c(annual_mort, daily_mort),\n    rows = measure == \"2. Life Expectancy\"\n  ) %&gt;% \n  gt::data_color(\n    method = \"numeric\",\n    palette = \"ggsci::red_material\",\n    domain = c(230,245),\n    columns = c(annual_mort, daily_mort),\n    rows = measure == \"1. CVD State Occupancy at Two Years\"\n  ) %&gt;% \n  tab_spanner(label = \"Model With\\nNo Mortality\", columns = c(annual,daily)) %&gt;% \n  tab_spanner(label = \"Model With Mortality\", columns = c(annual_mort, daily_mort)) %&gt;% \n  cols_label(\n    annual = \"Yearly Cycle\",\n    daily = \"Daily Cycle\",\n    annual_mort = \"Yearly Cycle\", \n    daily_mort = \"Daily Cycle\",\n    measure = \"\"\n  ) %&gt;% \n\n  rm_stubhead() %&gt;% \n  tab_options(\n    table.font.size = pct(90)\n    ) %&gt;% \n   as_raw_html()\n\n\n\n  \n  \n  \n    \n    \n      \n      \n        Model With\nNo Mortality\n      \n      \n        Model With Mortality\n      \n    \n    \n      Yearly Cycle\n      Daily Cycle\n      Yearly Cycle\n      Daily Cycle\n    \n  \n  \n    1. CVD State Occupancy at Two Years\n259.18\n259.18\n244.540\n231.488\n    2. Life Expectancy\n100.00\n100.00\n15.507\n15.624"
  },
  {
    "objectID": "slides/02_competing-events.html#signs-of-trouble-2",
    "href": "slides/02_competing-events.html#signs-of-trouble-2",
    "title": "Competing Risks",
    "section": "Signs of Trouble",
    "text": "Signs of Trouble\n\n\n\n\n\n\nIn the presence of competing events (mortality), we obtain different results for different cycle lengths! Notice how the state occupancy in CVD differs in the right panel of the figure below.\n\n\n\n\ndf_res &lt;- \n    data.frame(trace) %&gt;% \n        mutate(cycle = (row_number()-1)) %&gt;% \n        mutate(strategy = \"Model With\\nNo Mortality\") %&gt;% \n        mutate(cycle = cycle * params$cycle) %&gt;% \n        mutate(cycle_length = paste0(params$cycle)) %&gt;% \n    bind_rows(\n        data.frame(trace_daily) %&gt;% \n        mutate(cycle = (row_number()-1)) %&gt;% \n        mutate(strategy = \"Model With\\nNo Mortality\") %&gt;% \n        mutate(cycle = cycle * params_daily$cycle) %&gt;% \n        mutate(cycle_length = paste0(params_daily$cycle))\n    ) %&gt;% \n    bind_rows(\n        data.frame(trace_mort) %&gt;% \n        mutate(cycle = (row_number()-1)) %&gt;% \n        mutate(strategy = \"Model With Mortality\") %&gt;% \n        mutate(cycle = cycle * params_mort$cycle) %&gt;% \n        mutate(cycle_length = paste0(params_mort$cycle))\n    ) %&gt;%  \n    bind_rows(\n        data.frame(trace_mort_daily) %&gt;% \n        mutate(cycle = (row_number()-1)) %&gt;% \n        mutate(strategy = \"Model With Mortality\") %&gt;% \n        mutate(cycle = cycle * params_mort_daily$cycle) %&gt;% \n        mutate(cycle_length = paste0(params_mort_daily$cycle))\n    ) %&gt;%  \n    mutate(cycle_length = factor(round(as.numeric(paste0(cycle_length)),2), labels = c(\"Day\",\"Year\"))) %&gt;% \n    gather(state,value,-strategy,-cycle,-cycle_length)  %&gt;% \n    mutate(state = gsub(\"natural_history.\",\"\",state)) %&gt;% \n   mutate(strategy = factor(strategy, levels = c(\"Model With\\nNo Mortality\",\"Model With Mortality\")))\n\ndf_res %&gt;% \n    ggplot(aes(x = cycle, y = value, colour = state ,lty=cycle_length)) + \n    geom_line() +\n    facet_grid(~strategy) +\n    hrbrthemes::theme_ipsum(base_family = \"Arial\") + \n    ggsci::scale_color_aaas(name=\"\") + \n    theme(legend.position = \"top\") +\n  # TK ADD BACK IN\n    geom_dl(method = list(\"last.bumpup\",hjust=1,vjust=-1),aes(label = state)) +\n    geom_dl(method = list(\"first.bumpup\",hjust=0,vjust=-1),aes(label = state)) + \n    guides(color = \"none\") + \n  scale_linetype_discrete(name=\"Cycle Length\")\n\nWarning: Removed 36602 rows containing missing values (`geom_line()`).\n\n\nWarning: Removed 36602 rows containing missing values (`geom_dl()`).\nRemoved 36602 rows containing missing values (`geom_dl()`)."
  },
  {
    "objectID": "slides/02_competing-events.html#what-went-wrong-1",
    "href": "slides/02_competing-events.html#what-went-wrong-1",
    "title": "Competing Risks",
    "section": "What Went Wrong?",
    "text": "What Went Wrong?\n\n\nTo gain intuition for what is going on, let’s split out death for those with vs. without CVD:"
  },
  {
    "objectID": "slides/02_competing-events.html#what-went-wrong-2",
    "href": "slides/02_competing-events.html#what-went-wrong-2",
    "title": "Competing Risks",
    "section": "What Went Wrong?",
    "text": "What Went Wrong?\n\n\n\n\n\n\n\nG\n\n  \n\nHealthy\n\n Healthy   \n\nHealthy-&gt;Healthy\n\n    \n\nCVD\n\n CVD   \n\nHealthy-&gt;CVD\n\n  r_H_CVD = 0.15   \n\nDead\n\n Dead   \n\nHealthy-&gt;Dead\n\n  r_HD=0.01   \n\nCVD-&gt;CVD\n\n    \n\nCVDDeath\n\n CVDDeath   \n\nCVD-&gt;CVDDeath\n\n    hr_CVD * r_HD hr_CVD=10   \n\nDead-&gt;Dead\n\n    \n\nCVDDeath-&gt;CVDDeath"
  },
  {
    "objectID": "slides/02_competing-events.html#parameterize-the-model-2",
    "href": "slides/02_competing-events.html#parameterize-the-model-2",
    "title": "Competing Risks",
    "section": "Parameterize the model",
    "text": "Parameterize the model\n\nparams_mort2 = \n  list(\n    t_names = c(\"natural_history\"),                       \n    n_treatments = 1,                                     \n    s_names  = c(\"Healthy\", \"CVD\", \"CVDDeath\", \"Dead\"),   \n    n_states = 4,                                         \n    n_cohort = 1,                                         \n    n_cycles = 100,                                        \n    cycle = 1,                                            \n    initial_age = 55,                                     \n    r_H_CVD = 0.15,                                       \n    hr_CVD = 10,                                          \n    r_H_D = 0.01                                          \n  )"
  },
  {
    "objectID": "slides/02_competing-events.html#section-4",
    "href": "slides/02_competing-events.html#section-4",
    "title": "Competing Risks",
    "section": "",
    "text": "params_mort2$mP &lt;- \n  with(params_mort2,{\n    \n    tp_H_CVD = 1 - exp(-r_H_CVD * cycle) \n    tp_H_D = 1 - exp(-r_H_D * cycle)\n    tp_CVD_D &lt;- 1 - exp(-(hr_CVD * r_H_D) * cycle)\n    \n    array(data = c(1 - tp_H_CVD - tp_H_D, 0, 0,0,  \n                 tp_H_CVD,1-tp_CVD_D, 0,0,\n                 0,tp_CVD_D,1,0,\n                 tp_H_D, 0,0, 1),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n  })"
  },
  {
    "objectID": "slides/02_competing-events.html#spot-the-problem-1yr-cycle",
    "href": "slides/02_competing-events.html#spot-the-problem-1yr-cycle",
    "title": "Competing Risks",
    "section": "Spot the Problem (1yr Cycle)",
    "text": "Spot the Problem (1yr Cycle)\n\napply(params_mort2$mP,3,function(x) x, simplify=FALSE)\n\n$natural_history\n          to\nfrom       Healthy     CVD CVDDeath      Dead\n  Healthy  0.85076 0.13929 0.000000 0.0099502\n  CVD      0.00000 0.90484 0.095163 0.0000000\n  CVDDeath 0.00000 0.00000 1.000000 0.0000000\n  Dead     0.00000 0.00000 0.000000 1.0000000"
  },
  {
    "objectID": "slides/02_competing-events.html#spot-the-problem-1yr-cycle-1",
    "href": "slides/02_competing-events.html#spot-the-problem-1yr-cycle-1",
    "title": "Competing Risks",
    "section": "Spot the Problem (1yr Cycle)",
    "text": "Spot the Problem (1yr Cycle)\n\napply(params_mort2$mP,3,function(x) x, simplify=FALSE)\n\n$natural_history\n          to\nfrom       Healthy     CVD CVDDeath      Dead\n  Healthy  0.85076 0.13929 0.000000 0.0099502\n  CVD      0.00000 0.90484 0.095163 0.0000000\n  CVDDeath 0.00000 0.00000 1.000000 0.0000000\n  Dead     0.00000 0.00000 0.000000 1.0000000\n\n\n\n\n\n\n\n\nRecall that in this model, CVD has a very high death rate—meaning that many people who develop CVD will die very soon after."
  },
  {
    "objectID": "slides/02_competing-events.html#spot-the-problem-1yr-cycle-2",
    "href": "slides/02_competing-events.html#spot-the-problem-1yr-cycle-2",
    "title": "Competing Risks",
    "section": "Spot the Problem (1yr Cycle)",
    "text": "Spot the Problem (1yr Cycle)\n\napply(params_mort2$mP,3,function(x) x, simplify=FALSE)\n\n$natural_history\n          to\nfrom       Healthy     CVD CVDDeath      Dead\n  Healthy  0.85076 0.13929 0.000000 0.0099502\n  CVD      0.00000 0.90484 0.095163 0.0000000\n  CVDDeath 0.00000 0.00000 1.000000 0.0000000\n  Dead     0.00000 0.00000 0.000000 1.0000000\n\n\n\n\n\n\n\n\nRecall that in this model, CVD has a very high death rate—meaning that many people who develop CVD will die very soon after.\n\n\n\n\n\n\n\n\n\nWith this knowledge in mind, can you spot something wrong with the above (annual) transition matrix?"
  },
  {
    "objectID": "slides/02_competing-events.html#spot-the-problem-10yr-cycle",
    "href": "slides/02_competing-events.html#spot-the-problem-10yr-cycle",
    "title": "Competing Risks",
    "section": "Spot the Problem (10yr Cycle)",
    "text": "Spot the Problem (10yr Cycle)\n\nparams_mort_10y = \n  list(\n    t_names = c(\"natural_history\"),           # Strategy names. \n    n_treatments = 1,                         # Number of treatments\n    s_names  = c(\"Healthy\", \"CVD\", \"Dead\"),   # State names\n    n_states = 3,                             # Number of states\n    n_cohort = 1,                             # Cohort size\n    n_cycles = 10,                           # Number of cycles in model.  \n    cycle = 10,                                # Cycle length\n    initial_age = 55,                         # Cohort starting age\n    r_H_CVD = 0.15,                           # Rate of healthy -&gt; CVD\n    hr_CVD = 10,                              # Hazard Ratio: CVD Death\n    r_H_D = 0.01                              # Rate of healthy -&gt; dead\n  )\n\nparams_mort_10y$mP &lt;- \n  with(params_mort_10y,{\n    \n    tp_H_CVD = 1 - exp(-r_H_CVD * cycle) \n    tp_H_D = 1 - exp(-r_H_D * cycle)\n    tp_CVD_D &lt;- 1 - exp(-(hr_CVD * r_H_D) * cycle)\n    \n    array(data = c(1 - tp_H_CVD - tp_H_D, 0, 0, \n                 tp_H_CVD,1-tp_CVD_D, 0,\n                 tp_H_D, tp_CVD_D, 1),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n  })\n\n\nparams_mort2_10y = \n  list(\n    t_names = c(\"natural_history\"),                       # Strategy names. \n    n_treatments = 1,                                     # Number of treatments\n    s_names  = c(\"Healthy\", \"CVD\", \"CVDDeath\", \"Dead\"),   # State names\n    n_states = 4,                                         # Number of states\n    n_cohort = 1,                                         # Cohort size\n    n_cycles = 10,                                       # Number of cycles in model.  \n    cycle = 10,                                            # Cycle length\n    initial_age = 55,                                     # Cohort starting age\n    r_H_CVD = 0.15,                                       # Rate of healthy -&gt; CVD\n    hr_CVD = 10,                                          # Hazard Ratio: CVD Death\n    r_H_D = 0.01                                          # Rate of healthy -&gt; dead\n  )\n\nparams_mort2_10y$mP &lt;- \n  with(params_mort2_10y,{\n    \n    tp_H_CVD = 1 - exp(-r_H_CVD * cycle) \n    tp_H_D = 1 - exp(-r_H_D * cycle)\n    tp_CVD_D &lt;- 1 - exp(-(hr_CVD * r_H_D) * cycle)\n    \n    array(data = c(1 - tp_H_CVD - tp_H_D, 0, 0,0,  \n                 tp_H_CVD,1-tp_CVD_D, 0,0,\n                 0,tp_CVD_D,1,0,\n                 tp_H_D, 0,0, 1),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n  })\napply(params_mort2_10y$mP,3,function(x) x, simplify = FALSE)\n\n$natural_history\n          to\nfrom       Healthy     CVD CVDDeath     Dead\n  Healthy  0.12797 0.77687  0.00000 0.095163\n  CVD      0.00000 0.36788  0.63212 0.000000\n  CVDDeath 0.00000 0.00000  1.00000 0.000000\n  Dead     0.00000 0.00000  0.00000 1.000000\n\n\n\n\n\n\n\n\nRecall that in this model, CVD has a very high death rate—meaning that many people who develop CVD will die very soon after.\n\n\n\n\n\n\n\n\n\nWith this knowledge in mind, can you spot something wrong with the above (annual) transition matrix?"
  },
  {
    "objectID": "slides/02_competing-events.html#discretizing-a-continuous-process",
    "href": "slides/02_competing-events.html#discretizing-a-continuous-process",
    "title": "Competing Risks",
    "section": "Discretizing a Continuous Process",
    "text": "Discretizing a Continuous Process\n\nOur constructed model rules out compound transitions within a cycle.\nCompound transition: Healthy  CVD  CVD Death in a single cycle.\n\n\napply(params_mort2_10y$mP,3,function(x) x, simplify = FALSE)\n\n$natural_history\n          to\nfrom       Healthy     CVD CVDDeath     Dead\n  Healthy  0.12797 0.77687  0.00000 0.095163\n  CVD      0.00000 0.36788  0.63212 0.000000\n  CVDDeath 0.00000 0.00000  1.00000 0.000000\n  Dead     0.00000 0.00000  0.00000 1.000000"
  },
  {
    "objectID": "slides/02_competing-events.html#discretizing-a-continuous-process-1",
    "href": "slides/02_competing-events.html#discretizing-a-continuous-process-1",
    "title": "Competing Risks",
    "section": "Discretizing a Continuous Process",
    "text": "Discretizing a Continuous Process\n\nTo accurately capture the underlying continuous time process, there should be a transition probability defined for a seemingly impossible transition: Healthy  CVD Death.\n\n\napply(params_mort2_10y$mP,3,function(x) x, simplify = FALSE)\n\n$natural_history\n          to\nfrom       Healthy     CVD CVDDeath     Dead\n  Healthy  0.12797 0.77687  0.00000 0.095163\n  CVD      0.00000 0.36788  0.63212 0.000000\n  CVDDeath 0.00000 0.00000  1.00000 0.000000\n  Dead     0.00000 0.00000  0.00000 1.000000"
  },
  {
    "objectID": "slides/02_competing-events.html#discretizing-a-continuous-process-2",
    "href": "slides/02_competing-events.html#discretizing-a-continuous-process-2",
    "title": "Competing Risks",
    "section": "Discretizing a Continuous Process",
    "text": "Discretizing a Continuous Process\n\n\n\n\n\n\n\nG\n\n  \n\nHealthy\n\n Healthy   \n\nHealthy-&gt;Healthy\n\n    \n\nCVD\n\n CVD   \n\nHealthy-&gt;CVD\n\n  r_H_CVD = 0.15   \n\nDead\n\n Dead   \n\nHealthy-&gt;Dead\n\n  r_HD=0.01   \n\nTest\n\n   \n\nHealthy-&gt;Test\n\n   \n\nCVD-&gt;CVD\n\n    \n\nCVDDeath\n\n CVDDeath   \n\nCVD-&gt;CVDDeath\n\n    hr_CVD * r_HD hr_CVD=10   \n\nDead-&gt;Dead\n\n    \n\nCVDDeath-&gt;CVDDeath\n\n    \n\nTest-&gt;CVDDeath\n\n    \n\nTest2"
  },
  {
    "objectID": "slides/02_competing-events.html#discretizing-a-continuous-process-3",
    "href": "slides/02_competing-events.html#discretizing-a-continuous-process-3",
    "title": "Competing Risks",
    "section": "Discretizing a Continuous Process",
    "text": "Discretizing a Continuous Process\n\n\n\n\n\n\n\nG\n\n  \n\nHealthy\n\n Healthy   \n\nHealthy-&gt;Healthy\n\n    \n\nCVD\n\n CVD   \n\nHealthy-&gt;CVD\n\n  r_H_CVD = 0.15   \n\nDead\n\n Dead   \n\nHealthy-&gt;Dead\n\n  r_HD=0.01   \n\nCVDDeath\n\n CVDDeath   \n\nHealthy-&gt;CVDDeath\n\n    \n\nCVD-&gt;CVD\n\n    \n\nCVD-&gt;CVDDeath\n\n    hr_CVD * r_HD hr_CVD=10   \n\nDead-&gt;Dead\n\n    \n\nCVDDeath-&gt;CVDDeath"
  },
  {
    "objectID": "slides/02_competing-events.html#why-dont-the-conversion-formulas-work",
    "href": "slides/02_competing-events.html#why-dont-the-conversion-formulas-work",
    "title": "Competing Risks",
    "section": "Why Don’t the Conversion Formulas Work?",
    "text": "Why Don’t the Conversion Formulas Work?\n\nWhen we use the standard rate-to-probability conversion formula (i.e., \\(p_{H,CVD}= 1 - \\exp(-r_{H,CVD} t)\\) ) we obtain the marginal transition probability.\nThis marginal probability reflects the union of all possible transitions that start Healthy and then transition to and from the CVD state in the cycle."
  },
  {
    "objectID": "slides/02_competing-events.html#why-dont-the-conversion-formulas-work-1",
    "href": "slides/02_competing-events.html#why-dont-the-conversion-formulas-work-1",
    "title": "Competing Risks",
    "section": "Why Don’t the Conversion Formulas Work?",
    "text": "Why Don’t the Conversion Formulas Work?\nThat is, \\(p_{H,CVD}= 1 - \\exp(-r_{H,CVD} t)\\) captures the probability of following scenarios occurring in a cycle:\n\nIndividual transitions from healthy to CVD.\nIndividual transitions from healthy to CVD to CVD Death.\nIndividual dies from background causes before they would have developed CVD in the same cycle."
  },
  {
    "objectID": "slides/02_competing-events.html#year-cycle",
    "href": "slides/02_competing-events.html#year-cycle",
    "title": "Competing Risks",
    "section": "10 Year Cycle",
    "text": "10 Year Cycle\n\napply(params_mort2_10y$mP,3,function(x) x, simplify = FALSE)\n\n$natural_history\n          to\nfrom       Healthy     CVD CVDDeath     Dead\n  Healthy  0.12797 0.77687  0.00000 0.095163\n  CVD      0.00000 0.36788  0.63212 0.000000\n  CVDDeath 0.00000 0.00000  1.00000 0.000000\n  Dead     0.00000 0.00000  0.00000 1.000000\n\n\n\nThis matrix “captures” all transitions from Healthy  CVD in a single transition probability (0.7769)."
  },
  {
    "objectID": "slides/02_competing-events.html#year-cycle-1",
    "href": "slides/02_competing-events.html#year-cycle-1",
    "title": "Competing Risks",
    "section": "10 Year Cycle",
    "text": "10 Year Cycle\n\napply(params_mort2_10y$mP,3,function(x) x, simplify = FALSE)\n\n$natural_history\n          to\nfrom       Healthy     CVD CVDDeath     Dead\n  Healthy  0.12797 0.77687  0.00000 0.095163\n  CVD      0.00000 0.36788  0.63212 0.000000\n  CVDDeath 0.00000 0.00000  1.00000 0.000000\n  Dead     0.00000 0.00000  0.00000 1.000000\n\n\n\nBut we actually need to distribute out the marginal probability so that we’re left only with the probability that someone transitions to CVD and remains there at the end of the cycle.\nAs constructed, we have ruled out the possibility of compound transitions (Healthy  CVD  CVDDeath) in a single cycle."
  },
  {
    "objectID": "slides/02_competing-events.html#year-cycle-2",
    "href": "slides/02_competing-events.html#year-cycle-2",
    "title": "Competing Risks",
    "section": "10 Year Cycle",
    "text": "10 Year Cycle\n\napply(params_mort_10y$mP,3,function(x) x, simplify = FALSE)\n\n$natural_history\n         to\nfrom      Healthy     CVD     Dead\n  Healthy 0.12797 0.77687 0.095163\n  CVD     0.00000 0.36788 0.632121\n  Dead    0.00000 0.00000 1.000000\n\n\n\nThis problem isn’t fixed in the version of the model where death is a single health state.\nThe problem persists, but is “hidden” from view!"
  },
  {
    "objectID": "slides/02_competing-events.html#year-cycle-3",
    "href": "slides/02_competing-events.html#year-cycle-3",
    "title": "Competing Risks",
    "section": "10 Year Cycle",
    "text": "10 Year Cycle\n\napply(params_mort2_10y$mP,3,function(x) x, simplify = FALSE)\n\n$natural_history\n          to\nfrom       Healthy     CVD CVDDeath     Dead\n  Healthy  0.12797 0.77687  0.00000 0.095163\n  CVD      0.00000 0.36788  0.63212 0.000000\n  CVDDeath 0.00000 0.00000  1.00000 0.000000\n  Dead     0.00000 0.00000  0.00000 1.000000\n\n\n\nThis results in overcounting CVD state occupancy in some cases (people who develop CVD and die soon after) and undercounting CVD state occupancy in others (people who die of background causes before they would have developed CVD in the same cycle)."
  },
  {
    "objectID": "slides/02_competing-events.html#discretizing-a-continuous-process-4",
    "href": "slides/02_competing-events.html#discretizing-a-continuous-process-4",
    "title": "Competing Risks",
    "section": "Discretizing a Continuous Process",
    "text": "Discretizing a Continuous Process\n\n\n\n\n\n\nChanging to shorter cycle does not get us out of this problem."
  },
  {
    "objectID": "slides/02_competing-events.html#quantified-absolute-error",
    "href": "slides/02_competing-events.html#quantified-absolute-error",
    "title": "Competing Risks",
    "section": "Quantified Absolute Error",
    "text": "Quantified Absolute Error\n\n\nError after one cycle\n\n\n\ntruth &lt;- Vectorize(function(r1, r2, t)\n{\n  # Embed properly\n  x &lt;- matrix(c(-r1-r2, r1, r2, rep(0, 6)), nrow=3, ncol=3, byrow=TRUE)\n  (c(1, 0, 0) %*% expm(x*t))[,2:3]\n})\n\nmisspecify &lt;- Vectorize(function(r1, r2, t)\n{\n  # Common Advice\n  # RL Fleurence, Christopher S. Hollenbeak. Rates and Probabilities in Economics, Pharmacoeconomics 2007; 25 (1) 3-6\n  tp1 &lt;- 1-exp(-r1*t)\n  tp2 &lt;- 1-exp(-r2*t)\n \n  # THIS CONVERSION CAN RESULT IN IMPOSSIBLE VALUES!\n  if(tp1 + tp2 &gt; 1) return(NA)\n  \n  # Mispecify\n  x &lt;- matrix(c(1-tp1-tp2, tp1, tp2, 0, 1, 0, 0, 0, 1), nrow=3, ncol=3, byrow=TRUE)\n  (c(1, 0, 0) %*% x)[,2:3]\n})\n\npar(mfrow=c(1,1))\nabs.error &lt;- Vectorize(function(r1, r2, t=1)\n{\n  misspecify(r1, r2, t) - truth(r1, r2, t)\n})\n\nx &lt;- seq(0.01, 0.7, by = 0.01)\ny &lt;- x\nz &lt;- outer(x, y, FUN=function(x, y) {abs.error(x, y)[1,]})\ncontour(x,y,z, xlab=\"Rate 1 A -&gt; B\", ylab=\"Rate 2 A -&gt; C\",\n        main=\"Misspecified Competing Rates\",\n        sub=\"Absolute Error Contour State B, t=1\")"
  },
  {
    "objectID": "slides/02_competing-events.html#quantified-relative-error",
    "href": "slides/02_competing-events.html#quantified-relative-error",
    "title": "Competing Risks",
    "section": "Quantified Relative Error",
    "text": "Quantified Relative Error\n\nrel.error &lt;- Vectorize(function(r1, r2, t=1)\n{\n    x &lt;- truth(r1, r2, t)\n    100*(misspecify(r1, r2, t) - x)/x\n})\n\npar(mfrow=c(1,2))\nz &lt;- outer(x, y, FUN=function(x, y) {rel.error(x, y)[1,]})\ncontour(x,y,z, xlab=\"Rate 1 A -&gt; B\", ylab=\"Rate 2 A -&gt; C\",\n        main=\"\",\n        sub=\"Relative Error Contour (%) State B, t=1\")\n\nz &lt;- outer(x, y, FUN=function(x, y) {rel.error(x, y)[2,]})\ncontour(x,y,z, xlab=\"Rate 1 A -&gt; B\", ylab=\"Rate 2 A -&gt; C\",\n        main=\"\",\n        sub=\"Relative Error Contour (%) State C, t=1\")\npar(mfrow=c(1,1))\ntitle(main=\"Misspecified Competing Rates\")\n\n\n\nFor rates &lt; 0.1 of the chosen time step the error is &lt;5%.\nThis error will accumulate over each timestep."
  },
  {
    "objectID": "slides/02_competing-events.html#comparisons-across-strategies-bail-you-out",
    "href": "slides/02_competing-events.html#comparisons-across-strategies-bail-you-out",
    "title": "Competing Risks",
    "section": "Comparisons Across Strategies Bail You Out",
    "text": "Comparisons Across Strategies Bail You Out\n\nCommon CEA approaches compare strategies, i.e., \\(f(\\theta_A) - f(\\theta_{B})\\)\n\nNet monetary benefit.\nNet health benefit.\nIncremental cost effectiveness ratio.\n\nWith error it becomes:"
  },
  {
    "objectID": "slides/02_competing-events.html#comparisons-across-strategies-bail-you-out-1",
    "href": "slides/02_competing-events.html#comparisons-across-strategies-bail-you-out-1",
    "title": "Competing Risks",
    "section": "Comparisons Across Strategies Bail You Out",
    "text": "Comparisons Across Strategies Bail You Out\n\n\nCommon CEA approaches compare strategies, i.e., \\(f(\\theta_A) - f(\\theta_{B})\\)\n\nNet monetary benefit.\nNet health benefit.\nIncremental cost effectiveness ratio.\n\nWith error it becomes:\n\n\n\\[f(\\theta_A) + \\epsilon_A - (f(\\theta_{B}) + \\epsilon_{B})\\]"
  },
  {
    "objectID": "slides/02_competing-events.html#specification-error",
    "href": "slides/02_competing-events.html#specification-error",
    "title": "Competing Risks",
    "section": "Specification Error",
    "text": "Specification Error\nIf \\(\\epsilon_A - \\epsilon_{B} \\sim 0\\) the impact to the decision threshold is minimal.\n\nThese decision thresholds are semi-robust against this misspecification.\nRestated: Single model runs are biased under misspecification, but comparison across strategies helps cancel this out."
  },
  {
    "objectID": "slides/02_competing-events.html#rate-misspecification-conclusions",
    "href": "slides/02_competing-events.html#rate-misspecification-conclusions",
    "title": "Competing Risks",
    "section": "Rate Misspecification Conclusions",
    "text": "Rate Misspecification Conclusions\n\n\n\n\n\n\nIn the presence of competing events (mortality), using standard conversion formulas will yield incorrect transition probability matrices."
  },
  {
    "objectID": "slides/02_competing-events.html#why-does-this-matter",
    "href": "slides/02_competing-events.html#why-does-this-matter",
    "title": "Competing Risks",
    "section": "Why Does This Matter?",
    "text": "Why Does This Matter?\n\nWithout properly embedding, you are no longer modeling a continuous time process.\nSo your model results will differ compared to a continuous time model (e.g., discrete event simulation)\nMicrosimulation suffers the same problem because the patient-level transition probability matrix is embedded in a time step and requires Markov Rate conversion."
  },
  {
    "objectID": "slides/02_competing-events.html#rate-misspecification-conclusions-1",
    "href": "slides/02_competing-events.html#rate-misspecification-conclusions-1",
    "title": "Competing Risks",
    "section": "Rate Misspecification Conclusions",
    "text": "Rate Misspecification Conclusions\n\nExisting publication’s decision thresholds are generally okay if they misspecified rates.\nCheck the maximum rate of an event as a rough estimate of potential bias.\nRule of thumb, on the error plot use the estimated rate for full time scale of simulation, i.e. one step is entire simulation."
  },
  {
    "objectID": "slides/02_competing-events.html#rate-misspecification-error-decision-threshold",
    "href": "slides/02_competing-events.html#rate-misspecification-error-decision-threshold",
    "title": "Competing Risks",
    "section": "Rate Misspecification Error Decision Threshold",
    "text": "Rate Misspecification Error Decision Threshold\n\nThe amount of error for a decision threshold is the difference in contour. In this example: \\(0.07 - 0.02 = 0.05\\).\n\n\ntruth &lt;- Vectorize(function(r1, r2, t)\n{\n  # Embed properly\n  x &lt;- matrix(c(-r1-r2, r1, r2, rep(0, 6)), nrow=3, ncol=3, byrow=TRUE)\n  (c(1, 0, 0) %*% expm(x*t))[,2:3]\n})\n\nmisspecify &lt;- Vectorize(function(r1, r2, t)\n{\n  # Common Advice\n  # RL Fleurence, Christopher S. Hollenbeak. Rates and Probabilities in Economics, Pharmacoeconomics 2007; 25 (1) 3-6\n  tp1 &lt;- 1-exp(-r1*t)\n  tp2 &lt;- 1-exp(-r2*t)\n \n  # THIS CONVERSION CAN RESULT IN IMPOSSIBLE VALUES!\n  if(tp1 + tp2 &gt; 1) return(NA)\n  \n  # Mispecify\n  x &lt;- matrix(c(1-tp1-tp2, tp1, tp2, 0, 1, 0, 0, 0, 1), nrow=3, ncol=3, byrow=TRUE)\n  (c(1, 0, 0) %*% x)[,2:3]\n})\n\npar(mfrow=c(1,1))\nabs.error &lt;- Vectorize(function(r1, r2, t=1)\n{\n  misspecify(r1, r2, t) - truth(r1, r2, t)\n})\n\nx &lt;- seq(0.01, 0.7, by = 0.01)\ny &lt;- x\nz &lt;- outer(x, y, FUN=function(x, y) {abs.error(x, y)[1,]})\ncontour(x,y,z, xlab=\"Rate 1 A -&gt; B\", ylab=\"Rate 2 A -&gt; C\",\n        main=\"Misspecified Competing Rates\",\n        sub=\"Absolute Error Contour State B, t=1\")\n\npoints(x[8], y[63], col='red', lwd=4, cex=2)\npoints(x[63], y[37], col='red', lwd=4, cex=2)\n\nlines(c(x[63], x[63]), c(y[37], y[9]), lty=2, lwd=2)"
  },
  {
    "objectID": "slides/02_competing-events.html#additional-notes",
    "href": "slides/02_competing-events.html#additional-notes",
    "title": "Competing Risks",
    "section": "Additional Notes",
    "text": "Additional Notes\n\nDiscrete Event Simulation automatically handles competing events.\nMicrosimulation misspecification error interacts with the discrete time step truncation and increases this error!\nPublished rates from clinical studies are usually adjusted for competing events (the purpose of survival studies)."
  },
  {
    "objectID": "slides/02_competing-events.html#section-5",
    "href": "slides/02_competing-events.html#section-5",
    "title": "Competing Risks",
    "section": "",
    "text": "Rather than use the conversion formulas, we need to properly “embed” the transition probability matrix.\nThe correct transition probability matrix includes a seemingly impossible transition: Healthy  CVDDeath"
  },
  {
    "objectID": "slides/02_competing-events.html#section-6",
    "href": "slides/02_competing-events.html#section-6",
    "title": "Competing Risks",
    "section": "",
    "text": "Rather than use the conversion formulas, we need to properly “embed” the transition probability matrix.\nThe correct transition probability matrix includes a seemingly impossible transition: Healthy  CVDDeath\n\n\n\nparams_mort2_10y_emb &lt;- params_mort2_10y\n\nparams_mort2_10y_emb$mR &lt;- \n  with(params_mort2_10y,{\n\n    r_CVD_D &lt;- hr_CVD * r_H_D\n    \n    R_ &lt;- \n      array(data = c(0, 0, 0,0,  \n                 r_H_CVD,0, 0,0,\n                 0,r_CVD_D,0,0,\n                 r_H_D, 0,0, 0),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n    R &lt;- apply(R_,3, simplify=FALSE,function(x) {\n      diag(x) = -rowSums(x)\n      x * cycle\n    })\n  R    \n  })\nparams_mort2_10y_emb$mP &lt;- lapply(params_mort2_10y_emb$mR,expm)\n\nround(params_mort2_10y_emb$mP[[1]],3)\n\n         Healthy   CVD CVDDeath Dead\nHealthy    0.202 0.415    0.333 0.05\nCVD        0.000 0.368    0.632 0.00\nCVDDeath   0.000 0.000    1.000 0.00\nDead       0.000 0.000    0.000 1.00\n\n\n\nparams_mort2_emb &lt;- params_mort2\n\nparams_mort2_emb$mR &lt;- \n  with(params_mort2_emb,{\n\n    r_CVD_D &lt;- hr_CVD * r_H_D\n    \n    R_ &lt;- \n      array(data = c(0, 0, 0,0,  \n                 r_H_CVD,0, 0,0,\n                 0,r_CVD_D,0,0,\n                 r_H_D, 0,0, 0),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n    R &lt;- apply(R_,3, simplify=FALSE,function(x) {\n      diag(x) = -rowSums(x)\n      x * cycle\n    })\n  R    \n  })\nparams_mort2_emb$mP &lt;- lapply(params_mort2_emb$mR,expm)\n\n\nsim_cohort_tmp &lt;- function(params) {\n  tr_ &lt;- c(1,rep(0,params$n_states-1))\n  trace &lt;- \n    0:params$n_cycles %&gt;% map_df(~({ \n        lapply(params$mP,function(tp) {  \n          (tr_ %*% (tp %^% .x)) %&gt;% data.frame()\n        })\n    })) %&gt;% \n    as.matrix() \n  trace\n}\n\ntrace_mort_emb &lt;- \n  sim_cohort_tmp(params_mort2_emb)\n\ntrace_mort2 &lt;- \n  sim_cohort(params_mort2)\n\n# sum(trace_mort_emb[-1,] %*% c(1,1,0,0)) * params_mort2_emb$cycle\n# sum(trace_mort2[-1,] %*% c(1,1,0,0)) * params_mort2$cycle"
  },
  {
    "objectID": "slides/02_competing-events.html#what-is-commonly-taught",
    "href": "slides/02_competing-events.html#what-is-commonly-taught",
    "title": "Competing Risks",
    "section": "What Is Commonly Taught",
    "text": "What Is Commonly Taught\n\nConvert each rate to a probability for the time step using \\(p = 1-\\exp(-rt)\\).\nPlace the probabilities within a transition matrix \\(\\mathbf{P}\\).\nDiagonal elements of \\(\\mathbf{P}\\): 1 - (row sum of nondiagonal elements)."
  },
  {
    "objectID": "slides/02_competing-events.html#what-well-teach-you",
    "href": "slides/02_competing-events.html#what-well-teach-you",
    "title": "Competing Risks",
    "section": "What We’ll Teach You",
    "text": "What We’ll Teach You\n\nPlace each rate in a rate matrix \\(\\mathbf{R}\\).\nDiagonal elements of \\(\\mathbf{R}\\): -1 * (row sum of nondiagonal elements).\nEmbed the transition probability matrix using matrix exponentiation \\(\\mathbf{P} = \\exp{(\\mathbf{R}t)}\\)."
  },
  {
    "objectID": "slides/02_competing-events.html#what-well-teach-you-1",
    "href": "slides/02_competing-events.html#what-well-teach-you-1",
    "title": "Competing Risks",
    "section": "What We’ll Teach You",
    "text": "What We’ll Teach You\n\n\nPlace each rate in a rate matrix \\(\\mathbf{R}\\).\nDiagonal elements of \\(\\mathbf{R}\\): -1 * (row sum of nondiagonal elements).\nEmbed the transition probability matrix using matrix exponentiation \\(\\mathbf{P} = \\exp{(\\mathbf{R}t})\\).\n\n\n\n\n\n\n\n\nThis process will ensure that the matrix captures “jumpover” states for compound transitions!"
  },
  {
    "objectID": "slides/02_competing-events.html#what-well-teach-you-2",
    "href": "slides/02_competing-events.html#what-well-teach-you-2",
    "title": "Competing Risks",
    "section": "What We’ll Teach You",
    "text": "What We’ll Teach You\n\n\nPlace each rate in a rate matrix \\(\\mathbf{R}\\).\nDiagonal elements of \\(\\mathbf{R}\\): -1 * (row sum of nondiagonal elements).\nEmbed the transition probability matrix using matrix exponentiation \\(\\mathbf{P} = \\exp{(\\mathbf{R}t})\\).\n\n\n\n\n\n\n\n\nThis process will ensure that the matrix captures “jumpover” states for compound transitions!\n\n\n\n\n\n\n\n\n\nIt also ensures that changing cycle lengths will not change your answers!"
  },
  {
    "objectID": "slides/02_competing-events.html#parameterize-the-model-3",
    "href": "slides/02_competing-events.html#parameterize-the-model-3",
    "title": "Competing Risks",
    "section": "Parameterize the model",
    "text": "Parameterize the model\n\nparams_mort_embedded = \n  list(\n    t_names = c(\"natural_history\"),                       \n    n_treatments = 1,                                     \n    s_names  = c(\"Healthy\", \"CVD\", \"CVDDeath\", \"Dead\"),   \n    n_states = 4,                                         \n    n_cohort = 1,                                         \n    n_cycles = 100,                                        \n    cycle = 1,                                            \n    initial_age = 55,                                     \n    r_H_CVD = 0.15,                                       \n    hr_CVD = 10,                                          \n    r_H_D = 0.01                                          \n  )\n\n\nNote: this is the same parameter list as earlier!"
  },
  {
    "objectID": "slides/02_competing-events.html#transition-rate-matrix",
    "href": "slides/02_competing-events.html#transition-rate-matrix",
    "title": "Competing Risks",
    "section": "Transition Rate Matrix",
    "text": "Transition Rate Matrix\n\nparams_mort_embedded$mR &lt;- \n  with(params_mort2_emb,{\n\n    r_CVD_D &lt;- hr_CVD * r_H_D\n    \n    R_ &lt;- \n      array(data = c(0, 0, 0,0,  \n                 r_H_CVD,0, 0,0,\n                 0,r_CVD_D,0,0,\n                 r_H_D, 0,0, 0),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n    R &lt;- apply(R_,3, simplify=FALSE,function(x) {\n      diag(x) = -rowSums(x)\n      x * cycle\n    })\n  R    \n  })"
  },
  {
    "objectID": "slides/02_competing-events.html#transition-rate-matrix-1",
    "href": "slides/02_competing-events.html#transition-rate-matrix-1",
    "title": "Competing Risks",
    "section": "Transition Rate Matrix",
    "text": "Transition Rate Matrix\n\nparams_mort_embedded$mR &lt;- \n  with(params_mort2_emb,{\n\n    r_CVD_D &lt;- hr_CVD * r_H_D\n    \n    R_ &lt;- \n      array(data = c(0, 0, 0,0,  \n                 r_H_CVD,0, 0,0,\n                 0,r_CVD_D,0,0,\n                 r_H_D, 0,0, 0),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n    R &lt;- apply(R_,3, simplify=FALSE,function(x) {\n      diag(x) = -rowSums(x)\n      x * cycle\n    })\n  R    \n  })\n\n\n\nCalculate the CVD  Dead rate"
  },
  {
    "objectID": "slides/02_competing-events.html#transition-rate-matrix-2",
    "href": "slides/02_competing-events.html#transition-rate-matrix-2",
    "title": "Competing Risks",
    "section": "Transition Rate Matrix",
    "text": "Transition Rate Matrix\n\nparams_mort_embedded$mR &lt;- \n  with(params_mort2_emb,{\n\n    r_CVD_D &lt;- hr_CVD * r_H_D\n    \n    R_ &lt;- \n      array(data = c(0, 0, 0,0,  \n                 r_H_CVD,0, 0,0,\n                 0,r_CVD_D,0,0,\n                 r_H_D, 0,0, 0),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n    R &lt;- apply(R_,3, simplify=FALSE,function(x) {\n      diag(x) = -rowSums(x)\n      x * cycle\n    })\n  R    \n  })\n\n\n\nPlace the rates within the matrix. We’ll get the diagonal elements in a second to ensure things balance out."
  },
  {
    "objectID": "slides/02_competing-events.html#transition-rate-matrix-3",
    "href": "slides/02_competing-events.html#transition-rate-matrix-3",
    "title": "Competing Risks",
    "section": "Transition Rate Matrix",
    "text": "Transition Rate Matrix\n\nparams_mort_embedded$mR &lt;- \n  with(params_mort2_emb,{\n    r_CVD_D &lt;- hr_CVD * r_H_D\n    R_ &lt;- \n      array(data = c(0, 0, 0,0,  \n                 r_H_CVD,0, 0,0,\n                 0,r_CVD_D,0,0,\n                 r_H_D, 0,0, 0),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n    R &lt;- apply(R_,3, simplify=FALSE,function(x) {\n      diag(x) = -rowSums(x)\n      x * cycle \n    })\n  R    \n  })\n\n\n\nDiagonal elements are the negative row sum (i.e., each row of \\(\\mathbf{R}\\) sums to 0)"
  },
  {
    "objectID": "slides/02_competing-events.html#transition-rate-matrix-4",
    "href": "slides/02_competing-events.html#transition-rate-matrix-4",
    "title": "Competing Risks",
    "section": "Transition Rate Matrix",
    "text": "Transition Rate Matrix\n\nparams_mort_embedded$mR &lt;- \n  with(params_mort2_emb,{\n    r_CVD_D &lt;- hr_CVD * r_H_D\n    R_ &lt;- \n      array(data = c(0, 0, 0,0,  \n                 r_H_CVD,0, 0,0,\n                 0,r_CVD_D,0,0,\n                 r_H_D, 0,0, 0),\n          dim = c(n_states, n_states, n_treatments),\n                  dimnames = list(from = s_names,\n                                  to = s_names,\n                                  t_names))\n    R &lt;- apply(R_,3, simplify=FALSE,function(x) {\n      diag(x) = -rowSums(x) \n      x * cycle\n    })\n  R    \n  })\n\n\n\nConvert \\(\\mathbf{R}\\) to the model cycle length (e.g., 1 year, 1 day, 1 month, etc.)."
  },
  {
    "objectID": "slides/02_competing-events.html#transition-rate-matrix-5",
    "href": "slides/02_competing-events.html#transition-rate-matrix-5",
    "title": "Competing Risks",
    "section": "Transition Rate Matrix",
    "text": "Transition Rate Matrix\n\nparams_mort_embedded$mR\n\n$natural_history\n          to\nfrom       Healthy   CVD CVDDeath Dead\n  Healthy    -0.16  0.15      0.0 0.01\n  CVD         0.00 -0.10      0.1 0.00\n  CVDDeath    0.00  0.00      0.0 0.00\n  Dead        0.00  0.00      0.0 0.00"
  },
  {
    "objectID": "slides/02_competing-events.html#transition-probability-matrix-7",
    "href": "slides/02_competing-events.html#transition-probability-matrix-7",
    "title": "Competing Risks",
    "section": "Transition Probability Matrix",
    "text": "Transition Probability Matrix\n\nexpm(params_mort_embedded$mR[[\"natural_history\"]])\n\n         Healthy     CVD  CVDDeath     Dead\nHealthy  0.85214 0.13173 0.0068811 0.009241\nCVD      0.00000 0.90484 0.0951626 0.000000\nCVDDeath 0.00000 0.00000 1.0000000 0.000000\nDead     0.00000 0.00000 0.0000000 1.000000\n\n\n\nNotice how the embedded matrix now has a transition probability from Healthy  CVD Death!"
  },
  {
    "objectID": "slides/02_competing-events.html#section-7",
    "href": "slides/02_competing-events.html#section-7",
    "title": "Competing Risks",
    "section": "",
    "text": "Using Conversion Formulas:\n\nround(apply(params_mort2$mP,3,function(x) x, simplify = FALSE)[[1]],3)\n\n          to\nfrom       Healthy   CVD CVDDeath Dead\n  Healthy    0.851 0.139    0.000 0.01\n  CVD        0.000 0.905    0.095 0.00\n  CVDDeath   0.000 0.000    1.000 0.00\n  Dead       0.000 0.000    0.000 1.00\n\n\n\n\n\nUsing Rate Matrix Eponentiation:\n\nround(expm(params_mort_embedded$mR[[\"natural_history\"]]),3)\n\n         Healthy   CVD CVDDeath  Dead\nHealthy    0.852 0.132    0.007 0.009\nCVD        0.000 0.905    0.095 0.000\nCVDDeath   0.000 0.000    1.000 0.000\nDead       0.000 0.000    0.000 1.000"
  },
  {
    "objectID": "slides/02_competing-events.html#case-study",
    "href": "slides/02_competing-events.html#case-study",
    "title": "Competing Risks",
    "section": "Case Study",
    "text": "Case Study"
  },
  {
    "objectID": "slides/02_competing-events.html#learning-objectives-1",
    "href": "slides/02_competing-events.html#learning-objectives-1",
    "title": "Competing Risks",
    "section": "Learning Objectives",
    "text": "Learning Objectives\n\nConstruct a natural history model for CVD.\nBackground mortality based on cause-deleted life table data.\nCVD mortality based on cause-specific mortality.\nMarkov model is properly embedded.\nMarkov model results will closely match cause-deleted and cause-specific mortality in the US population.\n\n\n\nBack to Website"
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "About this site\n\n1 + 1\n\n[1] 2"
  },
  {
    "objectID": "roster.html",
    "href": "roster.html",
    "title": "Instructors, Facilitators and Participants",
    "section": "",
    "text": "Instructors\n\nShawn Garbett (Vanderbilt University Medical Center)\n\n\n\n\n\nShawn Garbett, MS is faculty at Vanderbilt University Medical Center, where he holds an appointment in the Department of Biostatistics. Mr. Garbett is the director for informatics software development.\nGarbett has a diverse career background starting as an engineer for the Tennessee Valley Authority doing load grid optimization and data collection and modeling of the reservoir system. He worked as a consultant for many years, designing high confidence medical and nuclear software systems. He designed the first FDA approved closed loop medical device for Walter Reed with installations in Air Force One.\nHis research career began when he joined Vanderbilt in 2009. He began working with the department of Health Policy at Vanderbilt in 2016 and has participated in research on two publications which got listed in the top 10 papers in genomics. He has coauthored a book chapter on pharmacogenomics.\n\n\nJohn Graves (Vanderbilt University)\n\n\n\n\n\nJohn Graves, Ph.D. is Associate Professor at Vanderbilt University School of Medicine, where he holds appointments in the Department of Health Policy and the Department of Medicine. Dr. Graves directs the Center for Health Economic Modeling at Vanderbilt University Medical Center, and is a faculty affiliate of the Vanderbilt Institute for Global Health (VIGH) and the Vanderbilt Ingram Cancer Center.\nGraves’ career spans nearly 20 years conducting interdisciplinary research at the intersection of health economics and health care policy. The focus of his work is on the use of econometric and decision analytic methodologies to inform the development, implementation and evaluation of health care reforms at the state and federal level. His research contributions include modeling efforts that informed both the 2006 Massachusetts health reform legislation and the 2010 Affordable Care Act, for which he served as lead modeler for the White House Office of Health Reform.\nSince joining Vanderbilt in 2011, Graves has led and published research projects on novel methods for identifying provider shortages, on the returns to hospital spending and quality, and on the value of genetic screening in diverse health system populations. He currently leads two large federally-funded research grants on the health effects of insurance coverage expansion among safety net patients in the South, and on the implications of provider network design for access and competition in health insurance markets.\nGraves earned his BA in Economics and English from The University of the South in Sewanee, Tennessee. He holds a Ph.D. in Health Policy from Harvard University and is the recipient of fellowships and awards from the Agency for Health Care Research and Quality, the National Institute on Aging, the National Bureau of Economic Research, the American Statistical Association, and the National Academy of Social Insurance. He has taught and consulted for the Master’s in Public Administration in International Development at the Harvard Kennedy School, and is an affiliate of the Abdul Latif Jameel Poverty Action Lab at MIT.\n\n\n\nCourse Development\n\nJinyi Zhu (Vanderbilt University)\n\n\n\n\n\nJinyi Zhu is an Assistant Professor in the Department of Health Policy. Her research focuses on applications and methods to inform decision-making for resource allocation in public health and health care. Specifically, her research falls into three main areas: 1) resource prioritization for the prevention and treatment of cardiovascular disease, 2) applied model-based cost-effectiveness analysis in other clinical areas including TB and HIV, and 3) methodological advances in disease simulation modeling (e.g., model calibration and validation).\nDr. Zhu received a Ph.D. in Health Policy from Harvard University. She also holds an MPH from Yale University and a BS in Biology and BA in economics from Peking University.\n\n\nHanxuan Yu (Vanderbilt University Medical Center)\n\n\n\n\n\nHanxuan (Astrid) Yu is a Health Policy Data Analyst in the Department of Health Policy at Vanderbilt University. Working with Dr. Ashley Leech, Prof. John Graves, and Dr. Jinyi Zhu, she applies a range of analytical methods, including discrete event simulation, microsimulation, and Markov model, to address practical questions and support decision-making in the public health field. She also focuses on methodological advances to enhance the accuracy, speed and quality of decision analysis. Her ongoing projects include: 1) applying model-based cost-effectiveness analysis in the healthcare for pregnant women with opioid use disorder and global health questions like childhood epilepsy patients in Nigeria, 2) evaluating the clinical value and application method of polygenic risk scores for atherosclerotic cardiovascular disease based on cost-effectiveness techniques, 3) developing methodology implementations like common random numbers in specific disease simulation models.\n\n\nAshley Leech (Vanderbilt University)\n\n\n\n\n\nAshley Leech is an Assistant Professor in the Department of Health Policy at the Vanderbilt University School of Medicine. Dr. Leech’s research combines health services research and health economic methods to answer questions related to healthcare access, delivery, resource allocation, and use, and outcomes for reproductive-age women and their children. She is the Principal Investigator of an NIH/NIDA-funded career development award on Advancing Treatment Outcomes for Pregnant Women with Opioid Use Disorder where she is using decision science methodology to promote the coverage and adoption of high-value healthcare for pregnant women with opioid use disorder, a population that disproportionately faces major impediments to care.\nDr. Leech completed her post-doctoral training in Health Economics at the Center for the Evaluation of Value and Risk in Health (CEVR) at Tufts University School of Medicine where she focused on decision science methodology and received her Ph.D. in Health Services Research at Boston University School of Public Health."
  }
]