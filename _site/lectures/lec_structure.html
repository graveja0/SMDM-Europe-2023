<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.272">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>SMDM Europe 2023: Health Economics Modeling Workshop - 5. Structuring the Markov Model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../lectures/lec_welcome.html">Slides</a></li><li class="breadcrumb-item"><a href="../lectures/lec_structure.html">5. Structuring the Markov Model</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">SMDM Europe 2023: Health Economics Modeling Workshop</a> 
    </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">What They Didn’t Teach You About Decision Modeling</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../blog/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Workshop Blog</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Slides</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lec_welcome.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome and Introductions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lec_structure.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">5. Structuring the Markov Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/exercise_structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Group Exercise - Populating a Markov Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/exercise_ANS_structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Group Exercise Answer - Populating a Markov Model</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Case Studies</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Tools and Applications</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://mhorta.shinyapps.io/shinycea3/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Workshop CEA Shiny Application</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://mhorta.shinyapps.io/gomp/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gompertz Mortality Parameters Fit to UN Life Table Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://dare.shinyapps.io/tree/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Decision Tree Drawing Tool</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://mermaid.live/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mermaid Live Editor (Facilitates easy model diagram drawing)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="http://magjac.com/graphviz-visual-editor//" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Graphviz Visual Editor</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://www.youtube.com/playlist?list=PLIT7NqYN7YT0TypPdKdN4qTomBp2aqt_C" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Markov Modeling in R (YouTube Video Series)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://darth-git.github.io/darthpack/articles/darthpack.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Markov Modeling in R</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../roster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Instructors</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#learning-objectives-and-outline" id="toc-learning-objectives-and-outline" class="nav-link active" data-scroll-target="#learning-objectives-and-outline">Learning Objectives and Outline</a>
  <ul class="collapse">
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  </ul></li>
  <li><a href="#outline" id="toc-outline" class="nav-link" data-scroll-target="#outline">Outline</a>
  <ul class="collapse">
  <li><a href="#goal" id="toc-goal" class="nav-link" data-scroll-target="#goal">Goal</a></li>
  <li><a href="#what-never-happens" id="toc-what-never-happens" class="nav-link" data-scroll-target="#what-never-happens">What <em>Never</em> Happens</a></li>
  <li><a href="#problem" id="toc-problem" class="nav-link" data-scroll-target="#problem">Problem</a></li>
  </ul></li>
  <li><a href="#how-can-we-deal-with-this" id="toc-how-can-we-deal-with-this" class="nav-link" data-scroll-target="#how-can-we-deal-with-this">How can we deal with this?</a>
  <ul class="collapse">
  <li><a href="#solution" id="toc-solution" class="nav-link" data-scroll-target="#solution">Solution</a></li>
  <li><a href="#solution-1" id="toc-solution-1" class="nav-link" data-scroll-target="#solution-1">Solution</a></li>
  <li><a href="#solution-2" id="toc-solution-2" class="nav-link" data-scroll-target="#solution-2">Solution</a></li>
  <li><a href="#solution-3" id="toc-solution-3" class="nav-link" data-scroll-target="#solution-3">Solution</a></li>
  <li><a href="#solution-4" id="toc-solution-4" class="nav-link" data-scroll-target="#solution-4">Solution</a></li>
  <li><a href="#transition-rate-matrix" id="toc-transition-rate-matrix" class="nav-link" data-scroll-target="#transition-rate-matrix">Transition Rate Matrix</a></li>
  <li><a href="#four-step-process" id="toc-four-step-process" class="nav-link" data-scroll-target="#four-step-process">Four-Step Process</a></li>
  </ul></li>
  <li><a href="#what-is-the-difference-between-a-rate-and-a-probability" id="toc-what-is-the-difference-between-a-rate-and-a-probability" class="nav-link" data-scroll-target="#what-is-the-difference-between-a-rate-and-a-probability">What is the difference between a rate and a probability?</a>
  <ul class="collapse">
  <li><a href="#rates-vs.-probabilities" id="toc-rates-vs.-probabilities" class="nav-link" data-scroll-target="#rates-vs.-probabilities">Rates vs.&nbsp;Probabilities</a></li>
  <li><a href="#rates-vs.-probabilities-1" id="toc-rates-vs.-probabilities-1" class="nav-link" data-scroll-target="#rates-vs.-probabilities-1">Rates vs.&nbsp;Probabilities</a></li>
  <li><a href="#rates" id="toc-rates" class="nav-link" data-scroll-target="#rates">Rates</a></li>
  <li><a href="#rates-1" id="toc-rates-1" class="nav-link" data-scroll-target="#rates-1">Rates</a></li>
  <li><a href="#probabilities" id="toc-probabilities" class="nav-link" data-scroll-target="#probabilities">Probabilities</a></li>
  <li><a href="#rates-vs.-probabilities-example" id="toc-rates-vs.-probabilities-example" class="nav-link" data-scroll-target="#rates-vs.-probabilities-example">Rates vs.&nbsp;Probabilities: Example</a></li>
  <li><a href="#common-advice-on-conversion" id="toc-common-advice-on-conversion" class="nav-link" data-scroll-target="#common-advice-on-conversion">Common Advice on Conversion</a></li>
  <li><a href="#competing-rates" id="toc-competing-rates" class="nav-link" data-scroll-target="#competing-rates">Competing Rates</a></li>
  <li><a href="#resulting-error" id="toc-resulting-error" class="nav-link" data-scroll-target="#resulting-error">Resulting Error</a></li>
  <li><a href="#quantified-absolute-error" id="toc-quantified-absolute-error" class="nav-link" data-scroll-target="#quantified-absolute-error">Quantified Absolute Error</a></li>
  <li><a href="#quantified-relative-error" id="toc-quantified-relative-error" class="nav-link" data-scroll-target="#quantified-relative-error">Quantified Relative Error</a></li>
  <li><a href="#comparison" id="toc-comparison" class="nav-link" data-scroll-target="#comparison">Comparison</a></li>
  <li><a href="#rate-misspecification-conclusions" id="toc-rate-misspecification-conclusions" class="nav-link" data-scroll-target="#rate-misspecification-conclusions">Rate Misspecification Conclusions</a></li>
  <li><a href="#rates-vs.-probabilities-example-1" id="toc-rates-vs.-probabilities-example-1" class="nav-link" data-scroll-target="#rates-vs.-probabilities-example-1">Rates vs.&nbsp;Probabilities: Example</a></li>
  <li><a href="#rates-vs.-probabilities-example-2" id="toc-rates-vs.-probabilities-example-2" class="nav-link" data-scroll-target="#rates-vs.-probabilities-example-2">Rates vs.&nbsp;Probabilities: Example</a></li>
  <li><a href="#summary-rates-vs.-probabilities" id="toc-summary-rates-vs.-probabilities" class="nav-link" data-scroll-target="#summary-rates-vs.-probabilities">Summary: Rates vs.&nbsp;Probabilities</a></li>
  <li><a href="#place-rates-in-a-rate-matrix-mathbfr." id="toc-place-rates-in-a-rate-matrix-mathbfr." class="nav-link" data-scroll-target="#place-rates-in-a-rate-matrix-mathbfr.">1. Place rates in a rate matrix <span class="math inline">\(\mathbf{R}\)</span>.</a></li>
  <li><a href="#place-rates-in-a-rate-matrix-mathbfr.-1" id="toc-place-rates-in-a-rate-matrix-mathbfr.-1" class="nav-link" data-scroll-target="#place-rates-in-a-rate-matrix-mathbfr.-1">1. Place rates in a rate matrix <span class="math inline">\(\mathbf{R}\)</span>.</a></li>
  <li><a href="#place-rates-in-a-rate-matrix-mathbfr.-2" id="toc-place-rates-in-a-rate-matrix-mathbfr.-2" class="nav-link" data-scroll-target="#place-rates-in-a-rate-matrix-mathbfr.-2">1. Place rates in a rate matrix <span class="math inline">\(\mathbf{R}\)</span>.</a></li>
  <li><a href="#place-rates-in-a-rate-matrix-mathbfr.-3" id="toc-place-rates-in-a-rate-matrix-mathbfr.-3" class="nav-link" data-scroll-target="#place-rates-in-a-rate-matrix-mathbfr.-3">1. Place rates in a rate matrix <span class="math inline">\(\mathbf{R}\)</span>.</a></li>
  <li><a href="#place-rates-in-a-rate-matrix-mathbfr.-4" id="toc-place-rates-in-a-rate-matrix-mathbfr.-4" class="nav-link" data-scroll-target="#place-rates-in-a-rate-matrix-mathbfr.-4">1. Place rates in a rate matrix <span class="math inline">\(\mathbf{R}\)</span>.</a></li>
  <li><a href="#make-adjustments-to-mathbfr-as-needed." id="toc-make-adjustments-to-mathbfr-as-needed." class="nav-link" data-scroll-target="#make-adjustments-to-mathbfr-as-needed.">2. Make adjustments to <span class="math inline">\(\mathbf{R}\)</span> as needed.</a></li>
  <li><a href="#make-adjustments-to-mathbfr-as-needed.-1" id="toc-make-adjustments-to-mathbfr-as-needed.-1" class="nav-link" data-scroll-target="#make-adjustments-to-mathbfr-as-needed.-1">2. Make adjustments to <span class="math inline">\(\mathbf{R}\)</span> as needed.</a></li>
  <li><a href="#make-adjustments-to-mathbfr-as-needed.-2" id="toc-make-adjustments-to-mathbfr-as-needed.-2" class="nav-link" data-scroll-target="#make-adjustments-to-mathbfr-as-needed.-2">2. Make adjustments to <span class="math inline">\(\mathbf{R}\)</span> as needed.</a></li>
  <li><a href="#make-adjustments-to-mathbfr-as-needed.-3" id="toc-make-adjustments-to-mathbfr-as-needed.-3" class="nav-link" data-scroll-target="#make-adjustments-to-mathbfr-as-needed.-3">2. Make adjustments to <span class="math inline">\(\mathbf{R}\)</span> as needed.</a></li>
  <li><a href="#make-adjustments-to-mathbfr-as-needed.-4" id="toc-make-adjustments-to-mathbfr-as-needed.-4" class="nav-link" data-scroll-target="#make-adjustments-to-mathbfr-as-needed.-4">2. Make adjustments to <span class="math inline">\(\mathbf{R}\)</span> as needed.</a></li>
  <li><a href="#embed-the-transition-probability-matrix-using-the-rate-matrix" id="toc-embed-the-transition-probability-matrix-using-the-rate-matrix" class="nav-link" data-scroll-target="#embed-the-transition-probability-matrix-using-the-rate-matrix">3. “Embed” the transition probability matrix using the rate matrix</a></li>
  <li><a href="#embed-the-transition-probability-matrix-using-the-rate-matrix-1" id="toc-embed-the-transition-probability-matrix-using-the-rate-matrix-1" class="nav-link" data-scroll-target="#embed-the-transition-probability-matrix-using-the-rate-matrix-1">3. “Embed” the transition probability matrix using the rate matrix</a></li>
  <li><a href="#embed-the-transition-probability-matrix-using-the-rate-matrix-2" id="toc-embed-the-transition-probability-matrix-using-the-rate-matrix-2" class="nav-link" data-scroll-target="#embed-the-transition-probability-matrix-using-the-rate-matrix-2">3. “Embed” the transition probability matrix using the rate matrix</a></li>
  <li><a href="#embed-the-transition-probability-matrix-using-the-rate-matrix-3" id="toc-embed-the-transition-probability-matrix-using-the-rate-matrix-3" class="nav-link" data-scroll-target="#embed-the-transition-probability-matrix-using-the-rate-matrix-3">3. “Embed” the transition probability matrix using the rate matrix</a></li>
  <li><a href="#embed-the-transition-probability-matrix-using-the-rate-matrix-4" id="toc-embed-the-transition-probability-matrix-using-the-rate-matrix-4" class="nav-link" data-scroll-target="#embed-the-transition-probability-matrix-using-the-rate-matrix-4">3. “Embed” the transition probability matrix using the rate matrix</a></li>
  <li><a href="#embed-the-transition-probability-matrix-using-the-rate-matrix-5" id="toc-embed-the-transition-probability-matrix-using-the-rate-matrix-5" class="nav-link" data-scroll-target="#embed-the-transition-probability-matrix-using-the-rate-matrix-5">3. “Embed” the transition probability matrix using the rate matrix</a></li>
  <li><a href="#a.-rate-to-probability-conversion" id="toc-a.-rate-to-probability-conversion" class="nav-link" data-scroll-target="#a.-rate-to-probability-conversion">3a. Rate-to-probability conversion</a></li>
  <li><a href="#a.-rate-to-probability-conversion-1" id="toc-a.-rate-to-probability-conversion-1" class="nav-link" data-scroll-target="#a.-rate-to-probability-conversion-1">3a. Rate-to-probability conversion</a></li>
  <li><a href="#a.-rate-to-probability-conversion-2" id="toc-a.-rate-to-probability-conversion-2" class="nav-link" data-scroll-target="#a.-rate-to-probability-conversion-2">3a. Rate-to-probability conversion</a></li>
  <li><a href="#a.-rate-to-probability-conversion-3" id="toc-a.-rate-to-probability-conversion-3" class="nav-link" data-scroll-target="#a.-rate-to-probability-conversion-3">3a. Rate-to-probability conversion</a></li>
  <li><a href="#a.-rate-to-probability-conversion-4" id="toc-a.-rate-to-probability-conversion-4" class="nav-link" data-scroll-target="#a.-rate-to-probability-conversion-4">3a. Rate-to-probability conversion</a></li>
  <li><a href="#a.-rate-to-probability-conversion-5" id="toc-a.-rate-to-probability-conversion-5" class="nav-link" data-scroll-target="#a.-rate-to-probability-conversion-5">3a. Rate-to-probability conversion</a></li>
  <li><a href="#a.-rate-to-probability-conversion-6" id="toc-a.-rate-to-probability-conversion-6" class="nav-link" data-scroll-target="#a.-rate-to-probability-conversion-6">3a. Rate-to-probability conversion</a></li>
  <li><a href="#a.-rate-to-probability-conversion-7" id="toc-a.-rate-to-probability-conversion-7" class="nav-link" data-scroll-target="#a.-rate-to-probability-conversion-7">3a. Rate-to-probability conversion</a></li>
  <li><a href="#a.-rate-to-probability-conversion-8" id="toc-a.-rate-to-probability-conversion-8" class="nav-link" data-scroll-target="#a.-rate-to-probability-conversion-8">3a. Rate-to-probability conversion</a></li>
  <li><a href="#b.-exponentiate-the-transition-rate-matrix" id="toc-b.-exponentiate-the-transition-rate-matrix" class="nav-link" data-scroll-target="#b.-exponentiate-the-transition-rate-matrix">3b. Exponentiate the transition rate matrix</a></li>
  <li><a href="#b.-exponentiate-the-transition-rate-matrix-1" id="toc-b.-exponentiate-the-transition-rate-matrix-1" class="nav-link" data-scroll-target="#b.-exponentiate-the-transition-rate-matrix-1">3b. Exponentiate the transition rate matrix</a></li>
  <li><a href="#b.-exponentiate-the-transition-rate-matrix-2" id="toc-b.-exponentiate-the-transition-rate-matrix-2" class="nav-link" data-scroll-target="#b.-exponentiate-the-transition-rate-matrix-2">3b. Exponentiate the transition rate matrix</a></li>
  <li><a href="#b.-exponentiate-the-transition-rate-matrix-3" id="toc-b.-exponentiate-the-transition-rate-matrix-3" class="nav-link" data-scroll-target="#b.-exponentiate-the-transition-rate-matrix-3">3b. Exponentiate the transition rate matrix</a></li>
  <li><a href="#b.-exponentiate-the-transition-rate-matrix-4" id="toc-b.-exponentiate-the-transition-rate-matrix-4" class="nav-link" data-scroll-target="#b.-exponentiate-the-transition-rate-matrix-4">3b. Exponentiate the transition rate matrix</a></li>
  <li><a href="#b.-exponentiate-the-transition-rate-matrix-5" id="toc-b.-exponentiate-the-transition-rate-matrix-5" class="nav-link" data-scroll-target="#b.-exponentiate-the-transition-rate-matrix-5">3b. Exponentiate the transition rate matrix</a></li>
  <li><a href="#b.-exponentiate-the-transition-rate-matrix-6" id="toc-b.-exponentiate-the-transition-rate-matrix-6" class="nav-link" data-scroll-target="#b.-exponentiate-the-transition-rate-matrix-6">3b. Exponentiate the transition rate matrix</a></li>
  <li><a href="#so-where-are-we-now" id="toc-so-where-are-we-now" class="nav-link" data-scroll-target="#so-where-are-we-now">So Where Are We Now?</a></li>
  <li><a href="#so-where-are-we-now-1" id="toc-so-where-are-we-now-1" class="nav-link" data-scroll-target="#so-where-are-we-now-1">So Where Are We Now?</a></li>
  <li><a href="#so-where-are-we-now-2" id="toc-so-where-are-we-now-2" class="nav-link" data-scroll-target="#so-where-are-we-now-2">So Where Are We Now?</a></li>
  <li><a href="#chf-example-continued" id="toc-chf-example-continued" class="nav-link" data-scroll-target="#chf-example-continued">CHF Example, Continued</a></li>
  <li><a href="#chf-example-continued-1" id="toc-chf-example-continued-1" class="nav-link" data-scroll-target="#chf-example-continued-1">CHF Example, Continued</a></li>
  <li><a href="#chf-example-continued-2" id="toc-chf-example-continued-2" class="nav-link" data-scroll-target="#chf-example-continued-2">CHF Example, Continued</a></li>
  <li><a href="#chf-example-continued-3" id="toc-chf-example-continued-3" class="nav-link" data-scroll-target="#chf-example-continued-3">CHF Example, Continued</a></li>
  <li><a href="#chf-example-continued-4" id="toc-chf-example-continued-4" class="nav-link" data-scroll-target="#chf-example-continued-4">CHF Example, Continued</a></li>
  <li><a href="#make-adjustments-to-mathbfp-as-needed." id="toc-make-adjustments-to-mathbfp-as-needed." class="nav-link" data-scroll-target="#make-adjustments-to-mathbfp-as-needed.">4. Make adjustments to <span class="math inline">\(\mathbf{P}\)</span> as needed.</a></li>
  <li><a href="#make-adjustments-to-mathbfp-as-needed.-1" id="toc-make-adjustments-to-mathbfp-as-needed.-1" class="nav-link" data-scroll-target="#make-adjustments-to-mathbfp-as-needed.-1">4. Make adjustments to <span class="math inline">\(\mathbf{P}\)</span> as needed.</a></li>
  <li><a href="#make-adjustments-to-mathbfp-as-needed.-2" id="toc-make-adjustments-to-mathbfp-as-needed.-2" class="nav-link" data-scroll-target="#make-adjustments-to-mathbfp-as-needed.-2">4. Make adjustments to <span class="math inline">\(\mathbf{P}\)</span> as needed.</a></li>
  <li><a href="#make-adjustments-to-mathbfp_s-as-needed." id="toc-make-adjustments-to-mathbfp_s-as-needed." class="nav-link" data-scroll-target="#make-adjustments-to-mathbfp_s-as-needed.">4. Make adjustments to <span class="math inline">\(\mathbf{P_s}\)</span> as needed.</a></li>
  <li><a href="#chf-example-continued-5" id="toc-chf-example-continued-5" class="nav-link" data-scroll-target="#chf-example-continued-5">CHF Example, Continued</a></li>
  <li><a href="#chf-example-continued-6" id="toc-chf-example-continued-6" class="nav-link" data-scroll-target="#chf-example-continued-6">CHF Example, Continued</a></li>
  <li><a href="#chf-example-continued-7" id="toc-chf-example-continued-7" class="nav-link" data-scroll-target="#chf-example-continued-7">CHF Example, Continued</a></li>
  <li><a href="#chf-example-continued-8" id="toc-chf-example-continued-8" class="nav-link" data-scroll-target="#chf-example-continued-8">CHF Example, Continued</a></li>
  <li><a href="#chf-example-continued-9" id="toc-chf-example-continued-9" class="nav-link" data-scroll-target="#chf-example-continued-9">CHF Example, Continued</a></li>
  <li><a href="#full-process" id="toc-full-process" class="nav-link" data-scroll-target="#full-process">Full Process</a></li>
  </ul></li>
  <li><a href="#transition-dynamics" id="toc-transition-dynamics" class="nav-link" data-scroll-target="#transition-dynamics">Transition Dynamics</a>
  <ul class="collapse">
  <li><a href="#transition-dynamics-1" id="toc-transition-dynamics-1" class="nav-link" data-scroll-target="#transition-dynamics-1">Transition Dynamics</a></li>
  <li><a href="#transition-dynamics-2" id="toc-transition-dynamics-2" class="nav-link" data-scroll-target="#transition-dynamics-2">Transition Dynamics</a></li>
  <li><a href="#age-varying-background-mortality" id="toc-age-varying-background-mortality" class="nav-link" data-scroll-target="#age-varying-background-mortality">Age-Varying Background Mortality</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  <li><a href="#background-mortality" id="toc-background-mortality" class="nav-link" data-scroll-target="#background-mortality">Background Mortality</a></li>
  <li><a href="#background-mortality-1" id="toc-background-mortality-1" class="nav-link" data-scroll-target="#background-mortality-1">Background Mortality</a></li>
  <li><a href="#background-mortality-2" id="toc-background-mortality-2" class="nav-link" data-scroll-target="#background-mortality-2">Background Mortality</a></li>
  <li><a href="#background-mortality-3" id="toc-background-mortality-3" class="nav-link" data-scroll-target="#background-mortality-3">Background Mortality</a></li>
  <li><a href="#background-mortality-4" id="toc-background-mortality-4" class="nav-link" data-scroll-target="#background-mortality-4">Background Mortality</a></li>
  <li><a href="#background-mortality-5" id="toc-background-mortality-5" class="nav-link" data-scroll-target="#background-mortality-5">Background Mortality</a></li>
  <li><a href="#background-mortality-6" id="toc-background-mortality-6" class="nav-link" data-scroll-target="#background-mortality-6">Background Mortality</a></li>
  <li><a href="#background-mortality-7" id="toc-background-mortality-7" class="nav-link" data-scroll-target="#background-mortality-7">Background Mortality</a></li>
  <li><a href="#background-mortality-8" id="toc-background-mortality-8" class="nav-link" data-scroll-target="#background-mortality-8">Background Mortality</a></li>
  <li><a href="#background-mortality-9" id="toc-background-mortality-9" class="nav-link" data-scroll-target="#background-mortality-9">Background Mortality</a></li>
  <li><a href="#verifying-accuracy" id="toc-verifying-accuracy" class="nav-link" data-scroll-target="#verifying-accuracy">Verifying Accuracy</a></li>
  <li><a href="#background-mortality-10" id="toc-background-mortality-10" class="nav-link" data-scroll-target="#background-mortality-10">Background Mortality</a></li>
  <li><a href="#background-mortality-11" id="toc-background-mortality-11" class="nav-link" data-scroll-target="#background-mortality-11">Background Mortality</a></li>
  <li><a href="#background-mortality-12" id="toc-background-mortality-12" class="nav-link" data-scroll-target="#background-mortality-12">Background Mortality</a></li>
  <li><a href="#nonstationary-rates" id="toc-nonstationary-rates" class="nav-link" data-scroll-target="#nonstationary-rates">Nonstationary Rates</a></li>
  <li><a href="#nonstationary-rates-1" id="toc-nonstationary-rates-1" class="nav-link" data-scroll-target="#nonstationary-rates-1">Nonstationary Rates</a></li>
  <li><a href="#nonstationary-rates-2" id="toc-nonstationary-rates-2" class="nav-link" data-scroll-target="#nonstationary-rates-2">Nonstationary Rates</a></li>
  <li><a href="#nonstationary-rates-3" id="toc-nonstationary-rates-3" class="nav-link" data-scroll-target="#nonstationary-rates-3">Nonstationary Rates</a></li>
  <li><a href="#other-transition-dynamics" id="toc-other-transition-dynamics" class="nav-link" data-scroll-target="#other-transition-dynamics">Other Transition Dynamics</a></li>
  <li><a href="#other-transition-dynamics-1" id="toc-other-transition-dynamics-1" class="nav-link" data-scroll-target="#other-transition-dynamics-1">Other Transition Dynamics</a></li>
  <li><a href="#other-transition-dynamics-2" id="toc-other-transition-dynamics-2" class="nav-link" data-scroll-target="#other-transition-dynamics-2">Other Transition Dynamics</a></li>
  <li><a href="#tunnel-states-healthy-sick-dead" id="toc-tunnel-states-healthy-sick-dead" class="nav-link" data-scroll-target="#tunnel-states-healthy-sick-dead">Tunnel States: Healthy, Sick, Dead</a></li>
  <li><a href="#tunnel-states-healthy-sick-dead-1" id="toc-tunnel-states-healthy-sick-dead-1" class="nav-link" data-scroll-target="#tunnel-states-healthy-sick-dead-1">Tunnel States: Healthy, Sick, Dead</a></li>
  <li><a href="#tunnel-states-healthy-sick-dead-2" id="toc-tunnel-states-healthy-sick-dead-2" class="nav-link" data-scroll-target="#tunnel-states-healthy-sick-dead-2">Tunnel States: Healthy, Sick, Dead</a></li>
  <li><a href="#tunnel-states-healthy-sick-dead-3" id="toc-tunnel-states-healthy-sick-dead-3" class="nav-link" data-scroll-target="#tunnel-states-healthy-sick-dead-3">Tunnel States: Healthy, Sick, Dead</a></li>
  <li><a href="#tunnel-states-healthy-sick-dead-4" id="toc-tunnel-states-healthy-sick-dead-4" class="nav-link" data-scroll-target="#tunnel-states-healthy-sick-dead-4">Tunnel States: Healthy, Sick, Dead</a></li>
  <li><a href="#tunnel-states-healthy-sick-dead-5" id="toc-tunnel-states-healthy-sick-dead-5" class="nav-link" data-scroll-target="#tunnel-states-healthy-sick-dead-5">Tunnel States: Healthy, Sick, Dead</a></li>
  </ul></li>
  <li><a href="#working-backwards" id="toc-working-backwards" class="nav-link" data-scroll-target="#working-backwards">Working Backwards</a>
  <ul class="collapse">
  <li><a href="#working-backwards-1" id="toc-working-backwards-1" class="nav-link" data-scroll-target="#working-backwards-1">Working Backwards</a></li>
  <li><a href="#working-backwards-2" id="toc-working-backwards-2" class="nav-link" data-scroll-target="#working-backwards-2">Working Backwards</a></li>
  <li><a href="#working-backwards-3" id="toc-working-backwards-3" class="nav-link" data-scroll-target="#working-backwards-3">Working Backwards</a></li>
  <li><a href="#working-backwards-4" id="toc-working-backwards-4" class="nav-link" data-scroll-target="#working-backwards-4">Working Backwards</a></li>
  <li><a href="#working-backwards-5" id="toc-working-backwards-5" class="nav-link" data-scroll-target="#working-backwards-5">Working Backwards</a></li>
  <li><a href="#working-backwards-6" id="toc-working-backwards-6" class="nav-link" data-scroll-target="#working-backwards-6">Working Backwards</a></li>
  <li><a href="#working-backwards-7" id="toc-working-backwards-7" class="nav-link" data-scroll-target="#working-backwards-7">Working Backwards</a></li>
  <li><a href="#working-backwards-8" id="toc-working-backwards-8" class="nav-link" data-scroll-target="#working-backwards-8">Working Backwards</a></li>
  <li><a href="#working-backwards-9" id="toc-working-backwards-9" class="nav-link" data-scroll-target="#working-backwards-9">Working Backwards</a></li>
  </ul></li>
  <li><a href="#now-you-try-it" id="toc-now-you-try-it" class="nav-link" data-scroll-target="#now-you-try-it">Now You Try It!</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="lec_structure.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    <div class="quarto-margin-footer"><div class="margin-footer-item">
<p><img src="CHEMlogo_white.png" class="img-fluid"></p>
</div></div></div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">5. Structuring the Markov Model</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<style>
.nobullet li {
  list-style-type: none;
}
</style>
<section id="learning-objectives-and-outline" class="level1">
<h1>Learning Objectives and Outline</h1>
<!-- Rates: The instantaneous potential for the occurrence of an event, expressed per number of patients at risk. Rates can be added and subtracted. -->
<!-- Probabilities: A number ranging between 0 and 1. Represents the likelihood of an event happening over a specific period of time. -->
<!-- https://www.hsrd.research.va.gov/for_researchers/cyber_seminars/archives/2401-notes.pdf -->
<!-- https://link.springer.com/article/10.1007/s40273-020-00937-z -->
<!-- https://www.valueinhealthjournal.com/article/S1098-3015(12)01654-3/fulltext?_returnURL=https%3A%2F%2Flinkinghub.elsevier.com%2Fretrieve%2Fpii%2FS1098301512016543%3Fshowall%3Dtrue -->
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──
✔ ggplot2 3.4.1     ✔ purrr   1.0.1
✔ tibble  3.2.1     ✔ dplyr   1.1.1
✔ tidyr   1.3.0     ✔ stringr 1.5.0
✔ readr   2.1.4     ✔ forcats 0.5.2
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter()     masks stats::filter()
✖ dplyr::group_rows() masks kableExtra::group_rows()
✖ dplyr::lag()        masks stats::lag()</code></pre>
</div>
</div>
<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<div class="incremental">
<ul class="incremental">
<li>Understand differences between rates and probabilities, hazard rates, relative risks, and other relevant model inputs.</li>
<li>Understand rate-to-probability conversion formulas and competing rates.</li>
<li>Embedding a continuous transition rate matrix into a discrete timestep resulting in a transition probability matrix.</li>
<li>Embedding of non-stationary rates as a function of time.</li>
<li>Understand additional non-Markovian components: accumulators, tunnel states.</li>
</ul>
</div>
</section>
</section>
<section id="outline" class="level1 smaller">
<h1 class="smaller">Outline</h1>
<div class="incremental">
<ol class="incremental" type="1">
<li>Rates, probabilities, and other model inputs.</li>
<li>Constructing the transition probability matrix.</li>
<li>Model dynamics</li>
</ol>
<ul class="incremental">
<li>Non-stationary rates: mortality and other time/age-varying parameters.</li>
<li>Tunnel states and other disease-specific transition dynamics</li>
</ul>
<ol class="incremental" start="4" type="1">
<li>Working backwards: adapting an existing model to your country/region.</li>
</ol>
</div>
<section id="goal" class="level2">
<h2 class="anchored" data-anchor-id="goal">Goal</h2>
<p><img src="images/paste-DE23E852.png" class="quarto-discovered-preview-image img-fluid"></p>
</section>
<section id="what-never-happens" class="level2">
<h2 class="anchored" data-anchor-id="what-never-happens">What <em>Never</em> Happens</h2>
<p><img src="images/paste-35C55E40.png" class="img-fluid"></p>
</section>
<section id="problem" class="level2">
<h2 class="anchored" data-anchor-id="problem">Problem</h2>
<ul>
<li>Need transition probabilities but literature-based parameters are reported as:</li>
</ul>
<div class="incremental">
<ol class="incremental" type="1">
<li>Rates</li>
<li>Hazard ratios</li>
<li>Odds ratios</li>
<li>Relative risks</li>
<li>Transition probabilities (rare!)</li>
</ol>
</div>
</section>
</section>
<section id="how-can-we-deal-with-this" class="level1" data-background="#c2f0c2">
<h1 data-background="#c2f0c2">How can we deal with this?</h1>
<section id="solution" class="level2">
<h2 class="anchored" data-anchor-id="solution">Solution</h2>
<div class="incremental">
<ul class="incremental">
<li>Need “common ground” where we can combine and transform different model inputs.</li>
<li>This “common ground” is often found in a <strong>transition rate matrix.</strong></li>
</ul>
</div>
</section>
<section id="solution-1" class="level2">
<h2 class="anchored" data-anchor-id="solution-1">Solution</h2>
<p><img src="images/paste-23D41BA7.png" class="img-fluid"></p>
</section>
<section id="solution-2" class="level2">
<h2 class="anchored" data-anchor-id="solution-2">Solution</h2>
<p><img src="images/paste-7BE7C6AF.png" class="img-fluid"></p>
</section>
<section id="solution-3" class="level2">
<h2 class="anchored" data-anchor-id="solution-3">Solution</h2>
<p><img src="images/paste-EFB5816C.png" class="img-fluid"></p>
</section>
<section id="solution-4" class="level2">
<h2 class="anchored" data-anchor-id="solution-4">Solution</h2>
<p><img src="images/paste-500FB9B7.png" class="img-fluid"></p>
</section>
<section id="transition-rate-matrix" class="level2" data-background-image="images/paste-7BE7C6AF.png" data-background-size="contain" data-background-opacity="0.2">
<h2 data-background-image="images/paste-7BE7C6AF.png" data-background-size="contain" data-background-opacity="0.2" class="anchored" data-anchor-id="transition-rate-matrix">Transition Rate Matrix</h2>
<div class="incremental">
<ul class="incremental">
<li>The central “hub” of a Markov model.</li>
<li>Straightforward to convert rate matrix into a transition probability matrix.</li>
<li>Can be used to change the cycle length.</li>
<li>Facilitates modeling using alternative techniques:
<ul class="incremental">
<li>Continuous time Markov</li>
<li>Discrete event simulation</li>
<li>Microsimulation</li>
</ul></li>
</ul>
</div>
</section>
<section id="four-step-process" class="level2">
<h2 class="anchored" data-anchor-id="four-step-process">Four-Step Process</h2>
<div class="incremental">
<ol class="incremental" type="1">
<li>Use data inputs/published literature to define a rate matrix <span class="math inline">\(\mathbf{R}\)</span>.</li>
<li>Make strategy-specific adjustments to <span class="math inline">\(\mathbf{R}\)</span> as needed.</li>
<li>“Embed” the transition probability matrix using the rate matrix</li>
<li>Make further overall or strategy-specific adjustments to <span class="math inline">\(\mathbf{P}\)</span> as needed.</li>
</ol>
</div>
</section>
</section>
<section id="what-is-the-difference-between-a-rate-and-a-probability" class="level1" data-background="#c2f0c2">
<h1 data-background="#c2f0c2">What is the difference between a rate and a probability?</h1>
<section id="rates-vs.-probabilities" class="level2">
<h2 class="anchored" data-anchor-id="rates-vs.-probabilities">Rates vs.&nbsp;Probabilities</h2>
<div class="incremental">
<ul class="incremental">
<li><strong>Rate</strong>: number of occurrences of an event per unit of time. These are additive and subtractive–i.e.&nbsp;simple algebra for manipulation.</li>
<li><strong>Probability</strong>: Likelihood that an event will occur for an in individual over a defined time period.</li>
<li>Major difference is in denominator: rates take into account <strong>time at risk</strong> while probabilities do not.</li>
</ul>
</div>
</section>
<section id="rates-vs.-probabilities-1" class="level2">
<h2 class="anchored" data-anchor-id="rates-vs.-probabilities-1">Rates vs.&nbsp;Probabilities</h2>
<p><img src="images/paste-83525383.png" class="img-fluid"></p>
</section>
<section id="rates" class="level2">
<h2 class="anchored" data-anchor-id="rates">Rates</h2>
<div class="incremental">
<ul class="incremental">
<li>Number of events divided by the total time at risk experienced by all people followed.</li>
<li>Ranges from 0 to <span class="math inline">\(\infty\)</span>.</li>
<li><span class="math inline">\(\frac{\# \text{events in time period}}{\text{Total time period experienced by all subjects followed}}\)</span></li>
</ul>
</div>
</section>
<section id="rates-1" class="level2">
<h2 class="anchored" data-anchor-id="rates-1">Rates</h2>
<p><img src="images/paste-8191B0E3.png" class="img-fluid"></p>
</section>
<section id="probabilities" class="level2">
<h2 class="anchored" data-anchor-id="probabilities">Probabilities</h2>
<p><img src="images/paste-62FF1911.png" class="img-fluid"></p>
<!-- ## Rates vs. Probabilities: Example[^1] -->
<!-- [^1]: Source: @gidwaniEstimatingTransitionProbabilities2020 -->
<!-- ::: incremental -->
<!-- -   Suppose a study followed 100 people with congestive heart failure for 4 years. -->
<!-- -   At the end of 4 years, 40 had died. -->
<!-- -   The probability of death over 4 years is $40/100=0.40$. -->
<!-- ::: -->
<!-- ## Rates vs. Probabilities: Example[^2] -->
<!-- [^2]: Source: @gidwaniEstimatingTransitionProbabilities2020 -->
<!-- ::: incremental -->
<!-- -   A rate takes into account the time each person was at risk. -->
<!-- -   The 60 who survived were at risk the entire 4 years and contributed $60 \times 4 = 240$ years at risk. -->
<!-- -   Once a person dies, he/she is no longer at risk. -->
<!-- ::: -->
<!-- ## Rates vs. Probabilities: Example[^3] -->
<!-- [^3]: Source: @gidwaniEstimatingTransitionProbabilities2020 -->
<!-- ::: incremental -->
<!-- -   When a study does not report time at risk, the conventional assumption is that the events were spread evenly over the time period. -->
<!-- -   Using this assumption, the average time at risk for the 40 who died was 2 years, adding 40 × 2 = 80 years at risk. -->
<!-- ::: -->
<!-- ## Rates vs. Probabilities: Example[^4] -->
<!-- [^4]: Source: @gidwaniEstimatingTransitionProbabilities2020 -->
<!-- ::: incremental -->
<!-- -   Total time at risk for the cohort of 100 people is 320 person-years (240+80). -->
<!-- -   Thus, the rate of death from CHF is 40/320 = 0.125 deaths per person-year. -->
<!-- -   Let's now construct a rate matrix with three states: CHF, Death from CHF, and Death from other causes. -->
<!-- ::: -->
<!-- ## Rates vs. Probabilities: Example -->
<!-- ```{r} -->
<!-- m_P <- matrix(0,nrow=3,ncol=3,dimnames=list(c("CHF","D_CHF","D_OTH"),c("CHF","D_CHF","D_OTH"))) -->
<!-- #m_P[1,2] <- 0.125 -->
<!-- #m_P[1,3] <- 0.006 -->
<!-- m_P %>% kable() -->
<!-- ``` -->
</section>
<section id="rates-vs.-probabilities-example" class="level2">
<h2 class="anchored" data-anchor-id="rates-vs.-probabilities-example">Rates vs.&nbsp;Probabilities: Example</h2>
<div class="incremental">
<ul class="incremental">
<li>0.125 per person year is the <strong>rate</strong> we’d enter into our rate matrix.</li>
<li>We could also think of a separate death rate from background causes (e.g., 0.006 per person-year).<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li>
</ul>
</div>
</section>
<section id="common-advice-on-conversion" class="level2">
<h2 class="anchored" data-anchor-id="common-advice-on-conversion">Common Advice on Conversion</h2>
<p><span class="math inline">\(\pi_{A \rightarrow B} = 1 - e^{-r_{A \rightarrow B} t}\)</span> to convert a rate, <span class="math inline">\(r\)</span> to a probability, <span class="math inline">\(\pi\)</span>.</p>
<p><span class="math inline">\(r_{A \rightarrow B} = -\log(1 - (\pi_{A \rightarrow B} - 1) / t\)</span> to convert a probability, <span class="math inline">\(\pi\)</span>, to a rate, <span class="math inline">\(r\)</span>.</p>
<p>Which is technically correct for a model with one rate.</p>
<p><img src="images/a_to_b.png" class="img-fluid"></p>
</section>
<section id="competing-rates" class="level2">
<h2 class="anchored" data-anchor-id="competing-rates">Competing Rates</h2>
<p>When 2 rates compete for a transition these formulas are mathematically wrong.</p>
<p>What is correct is <em>embedding</em> the rate matrix, <span class="math inline">\(X\)</span> into a time step, <span class="math inline">\(Y = Y_0 e^{Xt}\)</span>.</p>
<p><img src="images/a_to_bc.png" class="img-fluid"></p>
</section>
<section id="resulting-error" class="level2">
<h2 class="anchored" data-anchor-id="resulting-error">Resulting Error</h2>
<p><img src="images/dont_panic.png" class="img-fluid"></p>
<p>If one has misapplied this in a publication, it’s okay.</p>
</section>
<section id="quantified-absolute-error" class="level2">
<h2 class="anchored" data-anchor-id="quantified-absolute-error">Quantified Absolute Error</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(expm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Matrix'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:tidyr':

    expand, pack, unpack</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'expm'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:Matrix':

    expm</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>truth <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(r1, r2, t)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Embed properly</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="sc">-</span>r1<span class="sc">-</span>r2, r1, r2, <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">6</span>)), <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">ncol=</span><span class="dv">3</span>, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>) <span class="sc">%*%</span> <span class="fu">expm</span>(x<span class="sc">*</span>t))[,<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>misspecify <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(r1, r2, t)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Common Advice</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RL Fleurence, Christopher S. Hollenbeak. Rates and Probabilities in Economics, Pharmacoeconomics 2007; 25 (1) 3-6</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  tp1 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r1<span class="sc">*</span>t)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  tp2 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r2<span class="sc">*</span>t)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># THIS CONVERSION CAN RESULT IN IMPOSSIBLE VALUES!</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(tp1 <span class="sc">+</span> tp2 <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mispecify</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">-</span>tp1<span class="sc">-</span>tp2, tp1, tp2, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">ncol=</span><span class="dv">3</span>, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>) <span class="sc">%*%</span> x)[,<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>abs.error <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(r1, r2, <span class="at">t=</span><span class="dv">1</span>)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">misspecify</span>(r1, r2, t) <span class="sc">-</span> <span class="fu">truth</span>(r1, r2, t)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.01</span>, <span class="fl">0.7</span>, <span class="at">by =</span> <span class="fl">0.01</span>)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> x</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">outer</span>(x, y, <span class="at">FUN=</span><span class="cf">function</span>(x, y) {<span class="fu">abs.error</span>(x, y)[<span class="dv">1</span>,]})</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(x,y,z, <span class="at">xlab=</span><span class="st">"Rate 1 A -&gt; B"</span>, <span class="at">ylab=</span><span class="st">"Rate 2 A -&gt; C"</span>,</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">main=</span><span class="st">"Misspecified Competing Rates"</span>,</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">sub=</span><span class="st">"Absolute Error Contour State B, t=1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="lec_structure_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="quantified-relative-error" class="level2">
<h2 class="anchored" data-anchor-id="quantified-relative-error">Quantified Relative Error</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>rel.error <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(r1, r2, <span class="at">t=</span><span class="dv">1</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">truth</span>(r1, r2, t)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">100</span><span class="sc">*</span>(<span class="fu">misspecify</span>(r1, r2, t) <span class="sc">-</span> x)<span class="sc">/</span>x</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">outer</span>(x, y, <span class="at">FUN=</span><span class="cf">function</span>(x, y) {<span class="fu">rel.error</span>(x, y)[<span class="dv">1</span>,]})</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(x,y,z, <span class="at">xlab=</span><span class="st">"Rate 1 A -&gt; B"</span>, <span class="at">ylab=</span><span class="st">"Rate 2 A -&gt; C"</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">main=</span><span class="st">""</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">sub=</span><span class="st">"Relative Error Contour (%) State B, t=1"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">outer</span>(x, y, <span class="at">FUN=</span><span class="cf">function</span>(x, y) {<span class="fu">rel.error</span>(x, y)[<span class="dv">2</span>,]})</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(x,y,z, <span class="at">xlab=</span><span class="st">"Rate 1 A -&gt; B"</span>, <span class="at">ylab=</span><span class="st">"Rate 2 A -&gt; C"</span>,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">main=</span><span class="st">""</span>,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">sub=</span><span class="st">"Relative Error Contour (%) State C, t=1"</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main=</span><span class="st">"Misspecified Competing Rates"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="lec_structure_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>For rates &lt; 0.1 of the chosen time step the error is &lt;5%.</li>
</ul>
</section>
<section id="comparison" class="level2">
<h2 class="anchored" data-anchor-id="comparison">Comparison</h2>
<ul>
<li>Common Economic Statistics are relative to a base or reference case.
<ul>
<li>Net monetary benefit.</li>
<li>Net health benefit.</li>
<li>Incremental cost effectiveness ratio.</li>
</ul></li>
<li>The bias introduced is generally of the same order of magnitude and cancels. Similar to the “difference in difference” method in statistics.</li>
<li>These decision thresholds are <em>robust</em> against this misspecification.</li>
<li>Absolute values in a single scenario will be biased relative to rates.</li>
</ul>
</section>
<section id="rate-misspecification-conclusions" class="level2">
<h2 class="anchored" data-anchor-id="rate-misspecification-conclusions">Rate Misspecification Conclusions</h2>
<ul>
<li>Existing publications are generally okay if they misspecified rates via these formulas. Check the maximum rate of an event as a rough estimate of effect.</li>
<li>Published rates from clinical studies are usually adjusted for competing events.</li>
</ul>
</section>
<section id="rates-vs.-probabilities-example-1" class="level2">
<h2 class="anchored" data-anchor-id="rates-vs.-probabilities-example-1">Rates vs.&nbsp;Probabilities: Example</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>m_P <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span><span class="dv">3</span>,<span class="at">ncol=</span><span class="dv">3</span>,<span class="at">dimnames=</span><span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"CHF"</span>,<span class="st">"D_CHF"</span>,<span class="st">"D_OTH"</span>),<span class="fu">c</span>(<span class="st">"CHF"</span>,<span class="st">"D_CHF"</span>,<span class="st">"D_OTH"</span>)))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>m_P[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fl">0.125</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>m_P[<span class="dv">1</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fl">0.006</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>m_P <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_OTH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.125</td>
<td style="text-align: right;">0.006</td>
</tr>
<tr class="even">
<td style="text-align: left;">D_CHF</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D_OTH</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="rates-vs.-probabilities-example-2" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="rates-vs.-probabilities-example-2">Rates vs.&nbsp;Probabilities: Example</h2>
<div class="columns">
<div class="column">
<div class="incremental">
<ul class="incremental">
<li>The diagonal elements in a rate matrix are just the negative sum of the off-diagonal elements. (Markovian)</li>
<li>In this example, the diagonal value for the 1st row would be -0.131 = -(0.125+0.006)</li>
<li>We can leave all other rate matrix values at 0 because the rate of progression from death to other states is zero.</li>
</ul>
</div>
</div><div class="column">
<div style="padding-top: 125px; font-size: 0.8em">
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>m_P <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span><span class="dv">3</span>,<span class="at">ncol=</span><span class="dv">3</span>,<span class="at">dimnames=</span><span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"CHF"</span>,<span class="st">"Death_CHF"</span>,<span class="st">"Death_Other"</span>),<span class="fu">c</span>(<span class="st">"CHF"</span>,<span class="st">"Death_CHF"</span>,<span class="st">"Death_Other"</span>)))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>m_P[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fl">0.125</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>m_P[<span class="dv">1</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fl">0.006</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>m_P[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">c</span>(.<span class="dv">125</span><span class="fl">+.006</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>m_P <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">CHF =</span> <span class="fu">cell_spec</span>(CHF, </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">color =</span> <span class="fu">ifelse</span>(CHF<span class="sc">&lt;</span><span class="dv">0</span>,<span class="st">"white"</span>,<span class="st">"black"</span>),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">background=</span> <span class="fu">ifelse</span>(CHF<span class="sc">&lt;</span><span class="dv">0</span>,<span class="st">"red"</span>,<span class="st">"white"</span>),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">bold =</span> <span class="fu">ifelse</span>(Death_CHF<span class="sc">&lt;</span><span class="dv">0</span>,T,F)))  <span class="sc">%&gt;%</span> </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">'html'</span>, <span class="at">booktabs =</span><span class="cn">TRUE</span>, <span class="at">escape =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Death_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Death_Other</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: left;"><span style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: red !important;">-0.131</span></td>
<td style="text-align: right;">0.125</td>
<td style="text-align: right;">0.006</td>
</tr>
<tr class="even">
<td style="text-align: left;">Death_CHF</td>
<td style="text-align: left;"><span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Death_Other</td>
<td style="text-align: left;"><span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
</div>
</section>
<section id="summary-rates-vs.-probabilities" class="level2">
<h2 class="anchored" data-anchor-id="summary-rates-vs.-probabilities">Summary: Rates vs.&nbsp;Probabilities</h2>
<div style="font-size: 0.6em">
<table class="table">
<colgroup>
<col style="width: 24%">
<col style="width: 27%">
<col style="width: 24%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th>Statistic</th>
<th>Evaluates</th>
<th>Range</th>
<th>Applicable Domain</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Rate</td>
<td><span class="math inline">\(\frac{\# \text{events in time period}}{\text{Total time period experienced by all subjects followed}}\)</span></td>
<td>0 to <span class="math inline">\(\infty\)</span></td>
<td>Rate matrix</td>
</tr>
<tr class="even">
<td>Probability/risk</td>
<td><span class="math inline">\(\frac{\# \text{events in time period}}{\# \text{people followed for time period}}\)</span></td>
<td>0-1</td>
<td>Probability matrix</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="place-rates-in-a-rate-matrix-mathbfr." class="level2">
<h2 class="anchored" data-anchor-id="place-rates-in-a-rate-matrix-mathbfr.">1. Place rates in a rate matrix <span class="math inline">\(\mathbf{R}\)</span>.</h2>
<p><img src="images/paste-01DABA0F.png" class="img-fluid"></p>
</section>
<section id="place-rates-in-a-rate-matrix-mathbfr.-1" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="place-rates-in-a-rate-matrix-mathbfr.-1">1. Place rates in a rate matrix <span class="math inline">\(\mathbf{R}\)</span>.</h2>
<div class="columns">
<div class="column">
<div class="incremental">
<ul class="incremental">
<li>Country/region-specific background mortality rate (0.006)</li>
<li>Disease mortality rates from existing population-based epidemiological study. (e.g., 0.125 = 40 cases per 320 person-years)</li>
<li>Diagonal value that is the negative sum of the off-diagonal values in each row (-0.131).</li>
</ul>
</div>
</div><div class="column">
<div style="padding-top: 125px; font-size: 0.8em">
<p>“Natural History” (i.e., “do nothing”) rate matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>m_P <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Death_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Death_Other</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">-0.131</td>
<td style="text-align: right;">0.125</td>
<td style="text-align: right;">0.006</td>
</tr>
<tr class="even">
<td style="text-align: left;">Death_CHF</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Death_Other</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
</div>
</section>
<section id="place-rates-in-a-rate-matrix-mathbfr.-2" class="level2">
<h2 class="anchored" data-anchor-id="place-rates-in-a-rate-matrix-mathbfr.-2">1. Place rates in a rate matrix <span class="math inline">\(\mathbf{R}\)</span>.</h2>
<div class="incremental">
<ul class="incremental">
<li>What we have just done is contruct a rate matrix for a “natural history” model of the disease (CHF).</li>
<li>This is a version of the model in which we allow the disease process to play out naturally, with no further intervention.</li>
<li>Sometimes called a “do nothing” strategy.</li>
</ul>
</div>
</section>
<section id="place-rates-in-a-rate-matrix-mathbfr.-3" class="level2">
<h2 class="anchored" data-anchor-id="place-rates-in-a-rate-matrix-mathbfr.-3">1. Place rates in a rate matrix <span class="math inline">\(\mathbf{R}\)</span>.</h2>
<div class="incremental">
<ul class="incremental">
<li>The “natural history” model is useful because it can help us verify that the model matches what we see in the “real world.”</li>
<li>The “natural history” model also can be used to calibrate transition rates to different countries/contexts.</li>
<li>For example, we could recalibrate the model so the CHF mortality transition rate matches our country-specific data.</li>
</ul>
</div>
</section>
<section id="place-rates-in-a-rate-matrix-mathbfr.-4" class="level2">
<h2 class="anchored" data-anchor-id="place-rates-in-a-rate-matrix-mathbfr.-4">1. Place rates in a rate matrix <span class="math inline">\(\mathbf{R}\)</span>.</h2>
<div class="incremental">
<ul class="incremental">
<li>Alternatively, suppose we “borrow” a model developed in another country/context.</li>
<li>That model will be based on underlying rates specific to that context.</li>
<li>The underlying rate matrix can be used to “swap in” transition rates that apply to our country/context.
<ul class="incremental">
<li>Example: change the background mortality rate to match you country’s.</li>
</ul></li>
</ul>
</div>
</section>
<section id="make-adjustments-to-mathbfr-as-needed." class="level2">
<h2 class="anchored" data-anchor-id="make-adjustments-to-mathbfr-as-needed.">2. Make adjustments to <span class="math inline">\(\mathbf{R}\)</span> as needed.</h2>
<p><img src="images/paste-20350F55.png" class="img-fluid"></p>
</section>
<section id="make-adjustments-to-mathbfr-as-needed.-1" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="make-adjustments-to-mathbfr-as-needed.-1">2. Make adjustments to <span class="math inline">\(\mathbf{R}\)</span> as needed.</h2>
<div class="columns">
<div class="column">
<div class="incremental">
<ul class="incremental">
<li>Suppose that a new strategy can reduces the risk of CHF mortality by 20% (i.e., hazard ratio = 0.8).</li>
<li>We can simply apply this hazard ratio directly to construct a rate matrix for strategy A.</li>
<li>For the Strategy A rate matrix, the rate of CHF death is <span class="math inline">\(0.8 * 0.125 = 0.1\)</span></li>
<li>Make sure that the diagonal element is adjusted to account for this change!</li>
</ul>
</div>
</div><div class="column">
<div style="font-size: 0.8em">
<p>“Natural History” rate matrix</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>m_P <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Death_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Death_Other</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">-0.131</td>
<td style="text-align: right;">0.125</td>
<td style="text-align: right;">0.006</td>
</tr>
<tr class="even">
<td style="text-align: left;">Death_CHF</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Death_Other</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
</div>
</section>
<section id="make-adjustments-to-mathbfr-as-needed.-2" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="make-adjustments-to-mathbfr-as-needed.-2">2. Make adjustments to <span class="math inline">\(\mathbf{R}\)</span> as needed.</h2>
<div class="columns">
<div class="column">
<div style="font-size: 1.0em">
<ul>
<li>Suppose that a new strategy can reduces the risk of CHF mortality by 20% (i.e., hazard ratio = 0.8).</li>
<li>We can simply apply this hazard ratio directly to construct a rate matrix for strategy A.</li>
<li>For the Strategy A rate matrix, the rate of CHF death is <span class="math inline">\(0.8 * 0.125 = 0.1\)</span></li>
<li>Make sure that the diagonal element is adjusted to account for this change!</li>
</ul>
</div>
</div><div class="column">
<div style="font-size: 0.8em">
<p>“Natural History” rate matrix</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>m_P <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Death_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Death_Other</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">-0.131</td>
<td style="text-align: right;">0.125</td>
<td style="text-align: right;">0.006</td>
</tr>
<tr class="even">
<td style="text-align: left;">Death_CHF</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Death_Other</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>“Strategy A” rate matrix</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>m_P_A <span class="ot">&lt;-</span> m_P</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>m_P_A[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">=</span> <span class="fl">0.8</span> <span class="sc">*</span> m_P[<span class="dv">1</span>,<span class="dv">2</span>]</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>m_P_A[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">=</span> <span class="sc">-</span> (m_P_A[<span class="dv">1</span>,<span class="dv">2</span>] <span class="sc">+</span> m_P_A[<span class="dv">1</span>,<span class="dv">3</span>])</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>m_P_A <span class="sc">%&gt;%</span> </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Death_CHF =</span> <span class="fu">cell_spec</span>(Death_CHF, </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">color =</span> <span class="fu">ifelse</span>(Death_CHF<span class="sc">&gt;</span><span class="dv">0</span>,<span class="st">"white"</span>,<span class="st">"black"</span>),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">background=</span> <span class="fu">ifelse</span>(Death_CHF<span class="sc">&gt;</span><span class="dv">0</span>,<span class="st">"red"</span>,<span class="st">"white"</span>),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">bold =</span> <span class="fu">ifelse</span>(Death_CHF<span class="sc">&gt;</span><span class="dv">0</span>,T,F))) <span class="sc">%&gt;%</span> </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">CHF =</span> <span class="fu">cell_spec</span>(CHF, </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                               <span class="at">color =</span> <span class="fu">ifelse</span>(CHF<span class="sc">&lt;</span><span class="dv">0</span>,<span class="st">"white"</span>,<span class="st">"black"</span>),</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                               <span class="at">background=</span> <span class="fu">ifelse</span>(CHF<span class="sc">&lt;</span><span class="dv">0</span>,<span class="st">"red"</span>,<span class="st">"white"</span>),</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                               <span class="at">bold =</span> <span class="fu">ifelse</span>(Death_CHF<span class="sc">&lt;</span><span class="dv">0</span>,T,F))) <span class="sc">%&gt;%</span> </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">'html'</span>, <span class="at">booktabs =</span><span class="cn">TRUE</span>, <span class="at">escape =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Death_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Death_Other</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: left;"><span style=" font-weight: bold;    color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: red !important;">-0.106</span></td>
<td style="text-align: left;"><span style=" font-weight: bold;    color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: red !important;">0.1</span></td>
<td style="text-align: right;">0.006</td>
</tr>
<tr class="even">
<td style="text-align: left;">Death_CHF</td>
<td style="text-align: left;"><span style=" font-weight: bold;    color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
<td style="text-align: left;"><span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Death_Other</td>
<td style="text-align: left;"><span style=" font-weight: bold;    color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
<td style="text-align: left;"><span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
<td style="text-align: right;">0.000</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
</div>
</section>
<section id="make-adjustments-to-mathbfr-as-needed.-3" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="make-adjustments-to-mathbfr-as-needed.-3">2. Make adjustments to <span class="math inline">\(\mathbf{R}\)</span> as needed.</h2>
<div class="columns">
<div class="column">
<div class="incremental">
<ul class="incremental">
<li>Another adjustment we could make at this stage is the time cycle length.</li>
<li>Suppose our rate matrix is defined in terms of a one-year time cycle, but we want to convert to a monthly cycle.</li>
<li>In that event, we’d simply divide each rate in the matrix by 12, and the resulting matrix would be for a monthly timestep.</li>
</ul>
</div>
</div><div class="column">
<div style="font-size: 0.8em">
<p>“Natural History” rate matrix (one-year timestep)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>m_P <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Death_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Death_Other</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">-0.131</td>
<td style="text-align: right;">0.125</td>
<td style="text-align: right;">0.006</td>
</tr>
<tr class="even">
<td style="text-align: left;">Death_CHF</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Death_Other</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
</div>
</section>
<section id="make-adjustments-to-mathbfr-as-needed.-4" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="make-adjustments-to-mathbfr-as-needed.-4">2. Make adjustments to <span class="math inline">\(\mathbf{R}\)</span> as needed.</h2>
<div class="columns">
<div class="column">
<ul>
<li>Another adjustment we could make at this stage is the time cycle length.</li>
<li>Suppose our rate matrix is defined in terms of a one-year time cycle, but we want to convert to a monthly cycle.</li>
<li>In that event, we’d simply divide each rate in the matrix by 12, and the resulting matrix would be for a monthly timestep.</li>
</ul>
</div><div class="column">
<div style="font-size: 0.8em">
<p>“Natural History” rate matrix (one-year timestep)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>m_P <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Death_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Death_Other</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">-0.131</td>
<td style="text-align: right;">0.125</td>
<td style="text-align: right;">0.006</td>
</tr>
<tr class="even">
<td style="text-align: left;">Death_CHF</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Death_Other</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>“Natural History” rate matrix (one-month timestep)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>(m_P<span class="sc">/</span><span class="dv">12</span>) <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate_if</span>(is.numeric, <span class="fu">funs</span>(<span class="fu">as.character</span>(<span class="fu">signif</span>(., <span class="dv">3</span>)))) <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable</span>(.)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `funs()` was deprecated in dplyr 0.8.0.
ℹ Please use a list of either functions or lambdas:

# Simple named list: list(mean = mean, median = median)

# Auto named with `tibble::lst()`: tibble::lst(mean, median)

# Using lambdas list(~ mean(., trim = .2), ~ median(., na.rm = TRUE))</code></pre>
</div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Death_CHF</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Death_Other</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: left;">-0.0109</td>
<td style="text-align: left;">0.0104</td>
<td style="text-align: left;">5e-04</td>
</tr>
<tr class="even">
<td style="text-align: left;">Death_CHF</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Death_Other</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">0</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
</div>
</section>
<section id="embed-the-transition-probability-matrix-using-the-rate-matrix" class="level2">
<h2 class="anchored" data-anchor-id="embed-the-transition-probability-matrix-using-the-rate-matrix">3. “Embed” the transition probability matrix using the rate matrix</h2>
<p><img src="images/paste-CC9FEF98.png" class="img-fluid"></p>
</section>
<section id="embed-the-transition-probability-matrix-using-the-rate-matrix-1" class="level2">
<h2 class="anchored" data-anchor-id="embed-the-transition-probability-matrix-using-the-rate-matrix-1">3. “Embed” the transition probability matrix using the rate matrix</h2>
<div class="incremental">
<ul class="incremental">
<li>Our next step is to convert the transition rate matrix into a transition probability matrix.</li>
<li>Common practice is to use rate-to-probability conversion formulas</li>
</ul>
</div>
</section>
<section id="embed-the-transition-probability-matrix-using-the-rate-matrix-2" class="level2">
<h2 class="anchored" data-anchor-id="embed-the-transition-probability-matrix-using-the-rate-matrix-2">3. “Embed” the transition probability matrix using the rate matrix</h2>
<ul>
<li>Our next step is to convert the transition rate matrix into a transition probability matrix.</li>
<li>Common practice is to use rate-to-probability conversion formulas</li>
</ul>
<p><span class="math display">\[
p = 1 - \exp(-rt)
\]</span> where <span class="math inline">\(r\)</span> is the rate and <span class="math inline">\(t\)</span> is the time-step.</p>
</section>
<section id="embed-the-transition-probability-matrix-using-the-rate-matrix-3" class="level2">
<h2 class="anchored" data-anchor-id="embed-the-transition-probability-matrix-using-the-rate-matrix-3">3. “Embed” the transition probability matrix using the rate matrix</h2>
<div class="incremental">
<ul class="incremental">
<li>This formula works fine when there is only one possible state an individual can transition to.</li>
<li>The formula <strong>will not</strong> calculate the correct transition probability if there are two or more states someone can transition to.</li>
<li>See the <a href="../blog/posts/embedding-a-transition-probability-matrix.html">workshop blog posting</a> for more.</li>
</ul>
</div>
</section>
<section id="embed-the-transition-probability-matrix-using-the-rate-matrix-4" class="level2">
<h2 class="anchored" data-anchor-id="embed-the-transition-probability-matrix-using-the-rate-matrix-4">3. “Embed” the transition probability matrix using the rate matrix</h2>
<div class="incremental">
<ul class="incremental">
<li>We will cover <strong>two</strong> approaches for constructing a transition probability matrix.</li>
<li>The first is technically incorrect, but is widely used and easier to implement because it ignores compound transitions (i.e., multiple transitions within a cycle).</li>
</ul>
</div>
</section>
<section id="embed-the-transition-probability-matrix-using-the-rate-matrix-5" class="level2">
<h2 class="anchored" data-anchor-id="embed-the-transition-probability-matrix-using-the-rate-matrix-5">3. “Embed” the transition probability matrix using the rate matrix</h2>
<p>The two approaches</p>
<div class="nobullet">
<div class="incremental">
<ul class="incremental">
<li>3a. Construct a transition probability matrix using rate-to-probability conversion formulas.</li>
<li>3b. Embed the transition probability matrix using the rate matrix exponential (i.e., <span class="math inline">\(\mathbf{P}=e^{\mathbf{R}}\)</span>).</li>
</ul>
</div>
</div>
</section>
<section id="a.-rate-to-probability-conversion" class="level2">
<h2 class="anchored" data-anchor-id="a.-rate-to-probability-conversion">3a. Rate-to-probability conversion</h2>
<p>The probability of transitioning from health state <span class="math inline">\(A\)</span> to health state <span class="math inline">\(B\)</span> is:</p>
<p><span class="math display">\[
p_{AB}= \frac{r_{AB}}{\sum_S r_{AS}}\big ( 1 - e^{-(\sum_S r_{AS}) t}\big )
\]</span> where <span class="math inline">\(S\)</span> captures all the health states (i.e., columns) in the transition rate matrix, and <span class="math inline">\(t\)</span> is the time-step (e.g., <span class="math inline">\(t=1\)</span> if 1 year, <span class="math inline">\(t=1/12\)</span> if one month, etc.).</p>
</section>
<section id="a.-rate-to-probability-conversion-1" class="level2">
<h2 class="anchored" data-anchor-id="a.-rate-to-probability-conversion-1">3a. Rate-to-probability conversion</h2>
<p>Let’s build on our chronic heart failure example from earlier. Here is the transition rate matrix we constructed:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(m_P) <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"CHF"</span>,<span class="st">"D_CHF"</span>,<span class="st">"D_OTH"</span>),<span class="fu">c</span>(<span class="st">"CHF"</span>,<span class="st">"D_CHF"</span>,<span class="st">"D_OTH"</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>m_P <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_OTH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">-0.131</td>
<td style="text-align: right;">0.125</td>
<td style="text-align: right;">0.006</td>
</tr>
<tr class="even">
<td style="text-align: left;">D_CHF</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D_OTH</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="a.-rate-to-probability-conversion-2" class="level2">
<h2 class="anchored" data-anchor-id="a.-rate-to-probability-conversion-2">3a. Rate-to-probability conversion</h2>
<p>Let’s now calculate the probability of transitioning from the <strong>CHF</strong> state to <strong>D_CHF</strong> (death from heart failure).</p>
</section>
<section id="a.-rate-to-probability-conversion-3" class="level2">
<h2 class="anchored" data-anchor-id="a.-rate-to-probability-conversion-3">3a. Rate-to-probability conversion</h2>
<p>Annual probability of transitioning from CHF to death from CHF:</p>
<p><span class="math display">\[
p_{\text{CHF,D_CHF}}= \frac{r_{\text{CHF,D_CHF}}}{r_{\text{CHF,D_CHF}} + r_{\text{CHF,D_OTH}}}\big ( 1 - e^{-(r_{\text{CHF,D_CHF}} + r_{\text{CHF,D_OTH}}) \times 1}\big )
\]</span></p>
<p>We can find each of these rates in our transition rate matrix…</p>
</section>
<section id="a.-rate-to-probability-conversion-4" class="level2">
<h2 class="anchored" data-anchor-id="a.-rate-to-probability-conversion-4">3a. Rate-to-probability conversion</h2>
<p>Annual probability of transitioning from CHF to death from CHF:</p>
<p><span class="math display">\[
p_{\text{CHF,D_CHF}}= \frac{\color{red}{0.125}}{\color{red}{0.125}+\color{green}{0.006}}\big ( 1 - e^{-(\color{red}{0.125}+\color{green}{0.006}) \times 1}\big ) = 0.1172
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>m_P <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">D_CHF =</span> <span class="fu">cell_spec</span>(D_CHF, </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">color =</span> <span class="fu">ifelse</span>(D_CHF<span class="sc">&gt;</span><span class="dv">0</span>,<span class="st">"white"</span>,<span class="st">"black"</span>),</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">background=</span> <span class="fu">ifelse</span>(D_CHF<span class="sc">&gt;</span><span class="dv">0</span>,<span class="st">"red"</span>,<span class="st">"white"</span>),</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">bold =</span> <span class="fu">ifelse</span>(D_CHF<span class="sc">&gt;</span><span class="dv">0</span>,T,F))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">D_OTH =</span> <span class="fu">cell_spec</span>(D_OTH, </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">color =</span> <span class="fu">ifelse</span>(D_OTH<span class="sc">&gt;</span><span class="dv">0</span>,<span class="st">"white"</span>,<span class="st">"black"</span>),</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">background=</span> <span class="fu">ifelse</span>(D_OTH<span class="sc">&gt;</span><span class="dv">0</span>,<span class="st">"green"</span>,<span class="st">"white"</span>),</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">bold =</span> <span class="fu">ifelse</span>(D_OTH<span class="sc">&gt;</span><span class="dv">0</span>,T,F))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">'html'</span>, <span class="at">booktabs =</span><span class="cn">TRUE</span>, <span class="at">escape =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">D_CHF</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">D_OTH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">-0.131</td>
<td style="text-align: left;"><span style=" font-weight: bold;    color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: red !important;">0.125</span></td>
<td style="text-align: left;"><span style=" font-weight: bold;    color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: green !important;">0.006</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">D_CHF</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: left;"><span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
<td style="text-align: left;"><span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">D_OTH</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: left;"><span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
<td style="text-align: left;"><span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="a.-rate-to-probability-conversion-5" class="level2">
<h2 class="anchored" data-anchor-id="a.-rate-to-probability-conversion-5">3a. Rate-to-probability conversion</h2>
<p>Let’s now calculate the probability of transitioning from the <strong>CHF</strong> state to <strong>D_OTH</strong> (death from other causes).</p>
</section>
<section id="a.-rate-to-probability-conversion-6" class="level2">
<h2 class="anchored" data-anchor-id="a.-rate-to-probability-conversion-6">3a. Rate-to-probability conversion</h2>
<p>Annual probability of transitioning from CHF to death from <strong>other causes</strong>:</p>
<p><span class="math display">\[
p_{\text{CHF,D_CHF}}= \frac{\color{green}{0.006}}{\color{red}{0.125}+\color{green}{0.006}}\big ( 1 - e^{-(\color{red}{0.125}+\color{green}{0.006}) \times 1}\big ) = 0.00562
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>m_P <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">D_CHF =</span> <span class="fu">cell_spec</span>(D_CHF, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">color =</span> <span class="fu">ifelse</span>(D_CHF<span class="sc">&gt;</span><span class="dv">0</span>,<span class="st">"white"</span>,<span class="st">"black"</span>),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">background=</span> <span class="fu">ifelse</span>(D_CHF<span class="sc">&gt;</span><span class="dv">0</span>,<span class="st">"red"</span>,<span class="st">"white"</span>),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">bold =</span> <span class="fu">ifelse</span>(D_CHF<span class="sc">&gt;</span><span class="dv">0</span>,T,F))) <span class="sc">%&gt;%</span> </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">D_OTH =</span> <span class="fu">cell_spec</span>(D_OTH, </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">color =</span> <span class="fu">ifelse</span>(D_OTH<span class="sc">&gt;</span><span class="dv">0</span>,<span class="st">"white"</span>,<span class="st">"black"</span>),</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">background=</span> <span class="fu">ifelse</span>(D_OTH<span class="sc">&gt;</span><span class="dv">0</span>,<span class="st">"green"</span>,<span class="st">"white"</span>),</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">bold =</span> <span class="fu">ifelse</span>(D_OTH<span class="sc">&gt;</span><span class="dv">0</span>,T,F))) <span class="sc">%&gt;%</span> </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">'html'</span>, <span class="at">booktabs =</span><span class="cn">TRUE</span>, <span class="at">escape =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">D_CHF</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">D_OTH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">-0.131</td>
<td style="text-align: left;"><span style=" font-weight: bold;    color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: red !important;">0.125</span></td>
<td style="text-align: left;"><span style=" font-weight: bold;    color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: green !important;">0.006</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">D_CHF</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: left;"><span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
<td style="text-align: left;"><span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">D_OTH</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: left;"><span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
<td style="text-align: left;"><span style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0</span></td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="a.-rate-to-probability-conversion-7" class="level2">
<h2 class="anchored" data-anchor-id="a.-rate-to-probability-conversion-7">3a. Rate-to-probability conversion</h2>
<div class="incremental">
<ul class="incremental">
<li><p>We now have the quantities needed to complete the first row of our transition rate matrix.</p></li>
<li><p>Recall that the diagonal elements of the transition probability matrix are just 1 minus the other transition probabilities.</p></li>
</ul>
</div>
</section>
<section id="a.-rate-to-probability-conversion-8" class="level2">
<h2 class="anchored" data-anchor-id="a.-rate-to-probability-conversion-8">3a. Rate-to-probability conversion</h2>
<p>Calculated transition probability matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>m_P2 <span class="ot">&lt;-</span> m_P</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>m_P2[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> (m_P[<span class="dv">1</span>,<span class="dv">2</span>]<span class="sc">/</span>(m_P[<span class="dv">1</span>,<span class="dv">2</span>]<span class="sc">+</span>m_P[<span class="dv">1</span>,<span class="dv">3</span>]))<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>((m_P[<span class="dv">1</span>,<span class="dv">2</span>]<span class="sc">+</span>m_P[<span class="dv">1</span>,<span class="dv">3</span>]))))</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>m_P2[<span class="dv">1</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> (m_P[<span class="dv">1</span>,<span class="dv">3</span>]<span class="sc">/</span>(m_P[<span class="dv">1</span>,<span class="dv">2</span>]<span class="sc">+</span>m_P[<span class="dv">1</span>,<span class="dv">3</span>]))<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>((m_P[<span class="dv">1</span>,<span class="dv">2</span>]<span class="sc">+</span>m_P[<span class="dv">1</span>,<span class="dv">3</span>]))))</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>m_P2[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> m_P2[<span class="dv">1</span>,<span class="dv">2</span>] <span class="sc">-</span> m_P2[<span class="dv">1</span>,<span class="dv">3</span>]</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>m_P2[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>m_P2[<span class="dv">3</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>m_P2 <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span><span class="dv">4</span>) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_OTH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">0.8772</td>
<td style="text-align: right;">0.1172</td>
<td style="text-align: right;">0.0056</td>
</tr>
<tr class="even">
<td style="text-align: left;">D_CHF</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D_OTH</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="b.-exponentiate-the-transition-rate-matrix" class="level2">
<h2 class="anchored" data-anchor-id="b.-exponentiate-the-transition-rate-matrix">3b. Exponentiate the transition rate matrix</h2>
<div class="incremental">
<ul class="incremental">
<li><p>The most technically correct approach for “embedding” a transition probability matrix is using the rate matrix exponential.</p></li>
<li><p>This is a matrix analogue to the cellwise rate-to-probability matrix process we just went through.</p></li>
</ul>
</div>
</section>
<section id="b.-exponentiate-the-transition-rate-matrix-1" class="level2">
<h2 class="anchored" data-anchor-id="b.-exponentiate-the-transition-rate-matrix-1">3b. Exponentiate the transition rate matrix</h2>
<p><span class="math display">\[
\mathbf{P} = e^{\mathbf{R}}
\]</span></p>
</section>
<section id="b.-exponentiate-the-transition-rate-matrix-2" class="level2">
<h2 class="anchored" data-anchor-id="b.-exponentiate-the-transition-rate-matrix-2">3b. Exponentiate the transition rate matrix</h2>
<p>Pros:</p>
<div class="incremental">
<ul class="incremental">
<li><p>Embedding the transition probability matrix in this way ensures that the correct transition probabilities are calculated.</p></li>
<li><p>Without going into too many details, this approach ensures that some compound transitions are not “hidden” in the Markov cycle.</p></li>
<li><p>This ensures that our discrete time Markov model accurately represents the underlying continuous time process.</p></li>
</ul>
</div>
</section>
<section id="b.-exponentiate-the-transition-rate-matrix-3" class="level2">
<h2 class="anchored" data-anchor-id="b.-exponentiate-the-transition-rate-matrix-3">3b. Exponentiate the transition rate matrix</h2>
<p>Cons:</p>
<div class="incremental">
<ul class="incremental">
<li><p>A major drawback is that this approach can create some “jumpover” states that are seemingly inconsistent with the underlying model (see blog for more).</p></li>
<li><p>Accounting for “hidden” transitions and jumpover states requires augmenting the transition probability matrix (again, see blog for details).</p></li>
</ul>
</div>
</section>
<section id="b.-exponentiate-the-transition-rate-matrix-4" class="level2">
<h2 class="anchored" data-anchor-id="b.-exponentiate-the-transition-rate-matrix-4">3b. Exponentiate the transition rate matrix</h2>
<p>Cons, cont’d:</p>
<div class="incremental">
<ul class="incremental">
<li><p>Excel does not easily do matrix exponentiation, however you can use an approximation (we’ll do this in a case study).</p></li>
<li><p>Modern (free) statistical software can easily exponentiate a matrix:</p></li>
</ul>
</div>
</section>
<section id="b.-exponentiate-the-transition-rate-matrix-5" class="level2">
<h2 class="anchored" data-anchor-id="b.-exponentiate-the-transition-rate-matrix-5">3b. Exponentiate the transition rate matrix</h2>
<p>Cons, cont’d:</p>
<ul>
<li><p>Excel does not easily do matrix exponentiation, however you can use an approximation (we’ll do this in a case study).</p></li>
<li><p>Modern (free) statistical software can easily exponentiate a matrix:</p></li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(expm)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>m_P <span class="ot">=</span> <span class="fu">expm</span>(m_R)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="b.-exponentiate-the-transition-rate-matrix-6" class="level2">
<h2 class="anchored" data-anchor-id="b.-exponentiate-the-transition-rate-matrix-6">3b. Exponentiate the transition rate matrix</h2>
<p>For our chronic heart failure example, the exponentiated matrix yields a very similar answer to the first approach:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(expm)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>m_P <span class="sc">%&gt;%</span> <span class="fu">expm</span>() <span class="sc">%&gt;%</span> <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_OTH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">0.8772</td>
<td style="text-align: right;">0.1172</td>
<td style="text-align: right;">0.0056</td>
</tr>
<tr class="even">
<td style="text-align: left;">D_CHF</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D_OTH</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="so-where-are-we-now" class="level2">
<h2 class="anchored" data-anchor-id="so-where-are-we-now">So Where Are We Now?</h2>
<p><img src="images/paste-EFB5816C.png" class="img-fluid"></p>
</section>
<section id="so-where-are-we-now-1" class="level2">
<h2 class="anchored" data-anchor-id="so-where-are-we-now-1">So Where Are We Now?</h2>
<div class="incremental">
<ul class="incremental">
<li><p>By constructing our model using the “roots” of a transition rate matrix, we can incorporate disparate sources of information.</p></li>
<li><p>Facilitates country/region-specific background mortality.</p></li>
<li><p>Facilitates standardizing inputs measured at different time intervals.</p></li>
</ul>
</div>
</section>
<section id="so-where-are-we-now-2" class="level2">
<h2 class="anchored" data-anchor-id="so-where-are-we-now-2">So Where Are We Now?</h2>
<div class="incremental">
<ul class="incremental">
<li><p>Not all literature-based parameters operate on transition rates.</p></li>
<li><p>You will often find that the strategies you want to model have inputs based on odds ratios, relative risks, risk differences, etc.</p></li>
</ul>
</div>
</section>
<section id="chf-example-continued" class="level2">
<h2 class="anchored" data-anchor-id="chf-example-continued">CHF Example, Continued</h2>
<div class="incremental">
<ul class="incremental">
<li><p>Recall from earlier that we constructed two transition rate matrices:</p>
<ol class="incremental" type="1">
<li>“Natural History” rate matrix</li>
<li>Strategy A (“New Drug”) rate matrix based on a hazard ratio (for CHF mortality) of 0.8.</li>
</ol></li>
</ul>
</div>
</section>
<section id="chf-example-continued-1" class="level2">
<h2 class="anchored" data-anchor-id="chf-example-continued-1">CHF Example, Continued</h2>
<p>These two rate matrices can be used to construct the following transition probability matrices:</p>
<div style="font-size: 0.7em">
<div class="columns">
<div class="column">
<p>m_P_NH =</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">expm</span>(m_P) <span class="sc">%&gt;%</span> <span class="fu">kable</span>(<span class="at">digits=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_OTH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">0.8772</td>
<td style="text-align: right;">0.1172</td>
<td style="text-align: right;">0.0056</td>
</tr>
<tr class="even">
<td style="text-align: left;">D_CHF</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D_OTH</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
</tr>
</tbody>
</table>


</div>
</div>
</div><div class="column">
<p>m_P_A =</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(m_P_A) <span class="ot">=</span> <span class="fu">dimnames</span>(m_P)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expm</span>(m_P_A) <span class="sc">%&gt;%</span> <span class="fu">kable</span>(<span class="at">digits=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_OTH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">0.8994</td>
<td style="text-align: right;">0.0949</td>
<td style="text-align: right;">0.0057</td>
</tr>
<tr class="even">
<td style="text-align: left;">D_CHF</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D_OTH</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
</div>
</section>
<section id="chf-example-continued-2" class="level2">
<h2 class="anchored" data-anchor-id="chf-example-continued-2">CHF Example, Continued</h2>
<div class="incremental">
<ul class="incremental">
<li>Now suppose we wanted to model a second strategy (“B”) based on a randomized trial of another drug.</li>
<li>That trial reports an odds ratio (OR) of CHF death of 0.75.</li>
<li>The probability of CHF death in the placebo (control) arm in that trial was 0.15.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></li>
</ul>
</div>
</section>
<section id="chf-example-continued-3" class="level2">
<h2 class="anchored" data-anchor-id="chf-example-continued-3">CHF Example, Continued</h2>
<div class="incremental">
<ul class="incremental">
<li>An odds ratio is based on the odds of an outcome happening, which is directly related to the probability.</li>
<li>Odds = <span class="math inline">\(\frac{\text{Probability of Outcome}}{1 - \text{Probability of Outcome}}\)</span></li>
<li>Odds Ratio = <span class="math inline">\(\frac{\text{Odds of outcome in exposed}}{\text{Odds of outcome in unexposed}}\)</span></li>
</ul>
</div>
</section>
<section id="chf-example-continued-4" class="level2">
<h2 class="anchored" data-anchor-id="chf-example-continued-4">CHF Example, Continued</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Not all literature-based parameters operate on the rate scale. Some operate on the probability scale!</p>
</div>
</div>
</section>
<section id="make-adjustments-to-mathbfp-as-needed." class="level2">
<h2 class="anchored" data-anchor-id="make-adjustments-to-mathbfp-as-needed.">4. Make adjustments to <span class="math inline">\(\mathbf{P}\)</span> as needed.</h2>
<p><img src="images/paste-369710A3.png" class="img-fluid"></p>
</section>
<section id="make-adjustments-to-mathbfp-as-needed.-1" class="level2">
<h2 class="anchored" data-anchor-id="make-adjustments-to-mathbfp-as-needed.-1">4. Make adjustments to <span class="math inline">\(\mathbf{P}\)</span> as needed.</h2>
<div class="incremental">
<ul class="incremental">
<li>Constructing our final transition probability matrix—for natural history or more specifically for for a stratgey under consideration–may require further adjustment.</li>
<li>We must be careful about the <em>scale</em> on which these parameters apply.</li>
<li>Odds ratios, relative risks, and risk differences all operate on the <em>probability</em> scale.</li>
</ul>
</div>
</section>
<section id="make-adjustments-to-mathbfp-as-needed.-2" class="level2">
<h2 class="anchored" data-anchor-id="make-adjustments-to-mathbfp-as-needed.-2">4. Make adjustments to <span class="math inline">\(\mathbf{P}\)</span> as needed.</h2>
<div style="font-size: 0.5em">
<table class="table">
<colgroup>
<col style="width: 23%">
<col style="width: 28%">
<col style="width: 23%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th>Statistic</th>
<th>Evaluates</th>
<th>Range</th>
<th>Applicable Domain</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Rate</td>
<td><span class="math inline">\(\frac{\# \text{events in time period}}{\text{Total time period experienced by all subjects followed}}\)</span></td>
<td>0 to <span class="math inline">\(\infty\)</span></td>
<td>Rate matrix</td>
</tr>
<tr class="even">
<td>Hazard Ratio</td>
<td><span class="math inline">\(\frac{\text{Hazard rate of outcome in exposed}}{\text{Hazard rate of outcome in unexposed}}\)</span></td>
<td>0 to <span class="math inline">\(\infty\)</span></td>
<td>Rate matrix</td>
</tr>
<tr class="odd">
<td>Probability/risk</td>
<td><span class="math inline">\(\frac{\# \text{events in time period}}{\# \text{people followed for time period}}\)</span></td>
<td>0-1</td>
<td>Probability matrix</td>
</tr>
<tr class="even">
<td>Odds</td>
<td><span class="math inline">\(\frac{\text{Probability of Outcome}}{1 - \text{Probability of Outcome}}\)</span></td>
<td>0 to <span class="math inline">\(\infty\)</span></td>
<td>Probability matrix</td>
</tr>
<tr class="odd">
<td>Odds Ratio</td>
<td><span class="math inline">\(\frac{\text{Odds of outcome in exposed}}{\text{Odds of outcome in unexposed}}\)</span></td>
<td>0 to <span class="math inline">\(\infty\)</span></td>
<td>Probability matrix</td>
</tr>
<tr class="even">
<td>Relative Risk</td>
<td><span class="math inline">\(\frac{\text{Probability of outcome in exposed}}{\text{Probablity of outcome in unexposed}}\)</span></td>
<td>0 to <span class="math inline">\(\infty\)</span></td>
<td>Probability matrix</td>
</tr>
<tr class="odd">
<td>Risk Difference</td>
<td><span class="math inline">\(\text{Probability of outcome in exposed}-\text{Probablity of outcome in unexposed}\)</span></td>
<td>-1 to 1</td>
<td>Probability matrix</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="make-adjustments-to-mathbfp_s-as-needed." class="level2">
<h2 class="anchored" data-anchor-id="make-adjustments-to-mathbfp_s-as-needed.">4. Make adjustments to <span class="math inline">\(\mathbf{P_s}\)</span> as needed.</h2>
<p><img src="images/paste-369710A3.png" class="img-fluid"></p>
</section>
<section id="chf-example-continued-5" class="level2">
<h2 class="anchored" data-anchor-id="chf-example-continued-5">CHF Example, Continued</h2>
<p>Let’s turn back to our CHF example.</p>
<div class="incremental">
<ul class="incremental">
<li>Suppose we wanted to model a second strategy (“B”) based on a randomized trial of another drug.</li>
<li>That trial reports an odds ratio (OR) of CHF death of 0.75.</li>
<li>The probability of CHF death in the placebo (control) arm in that trial was 0.15.</li>
</ul>
</div>
</section>
<section id="chf-example-continued-6" class="level2">
<h2 class="anchored" data-anchor-id="chf-example-continued-6">CHF Example, Continued</h2>
<div class="incremental">
<ul class="incremental">
<li>We can convert an odds ratio to a relative risk (i.e., ratio of probabilities) if we know the baseline (unexposed) probability of the outcome, <span class="math inline">\(p_0\)</span>.</li>
<li>In this case we were able to find <span class="math inline">\(p_0=0.15\)</span> in the underlying clinical trial.</li>
<li>If we didn’t have this information, we might <strong>assume</strong> its the same (0.1172) as in our underlying natural history probability matrix<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></li>
</ul>
</div>
</section>
<section id="chf-example-continued-7" class="level2">
<h2 class="anchored" data-anchor-id="chf-example-continued-7">CHF Example, Continued</h2>
<div class="incremental">
<ul class="incremental">
<li>We can convert an odds ratio to a <strong>relative risk</strong> (RR).<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></li>
<li><span class="math inline">\(RR = \frac{\text{Probability of outcome in exposed}}{\text{Probablity of outcome in unexposed}} = \frac{p_1}{p_0} = \frac{OR}{(1-p_0+(p_0 \times OR))}\)</span></li>
<li>A relative risk is the ratio of the probability of the outcome in the exposed group to the probability of the outcome in the unexposed group.</li>
</ul>
</div>
</section>
<section id="chf-example-continued-8" class="level2">
<h2 class="anchored" data-anchor-id="chf-example-continued-8">CHF Example, Continued</h2>
<div class="incremental">
<ul class="incremental">
<li><span class="math inline">\(RR = \frac{p_1}{p_0}\)</span></li>
<li><span class="math inline">\(p_1 = RR \times p_0\)</span></li>
<li><span class="math inline">\(p_{D_{CHF}} = 0.75 \times .15 = 0.1125\)</span></li>
</ul>
</div>
</section>
<section id="chf-example-continued-9" class="level2">
<h2 class="anchored" data-anchor-id="chf-example-continued-9">CHF Example, Continued</h2>
<div id="fig-elephants" class="quarto-layout-panel" style="font-size: 0.7em">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">expm</span>(m_P) <span class="sc">%&gt;%</span> <span class="fu">kable</span>(<span class="at">digits=</span><span class="dv">4</span>,<span class="at">caption =</span> <span class="st">"m_P ="</span>) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-elephants-1">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>m_P =</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_OTH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">0.8772</td>
<td style="text-align: right;">0.1172</td>
<td style="text-align: right;">0.0056</td>
</tr>
<tr class="even">
<td style="text-align: left;">D_CHF</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D_OTH</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<div class="cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(m_P_A) <span class="ot">=</span> <span class="fu">dimnames</span>(m_P)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expm</span>(m_P_A) <span class="sc">%&gt;%</span> <span class="fu">kable</span>(<span class="at">digits=</span><span class="dv">4</span>,<span class="at">caption =</span> <span class="st">"m_P_A ="</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-elephants-2">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>m_P_A =</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_OTH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">0.8994</td>
<td style="text-align: right;">0.0949</td>
<td style="text-align: right;">0.0057</td>
</tr>
<tr class="even">
<td style="text-align: left;">D_CHF</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D_OTH</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>m_P_B <span class="ot">=</span> <span class="fu">expm</span>(m_P) </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>m_P_B[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">=</span> <span class="fl">0.75</span> <span class="sc">*</span> .<span class="dv">15</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>m_P_B[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> m_P_B[<span class="dv">1</span>,<span class="dv">2</span>] <span class="sc">-</span> m_P_B[<span class="dv">1</span>,<span class="dv">3</span>]</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>m_P_B <span class="sc">%&gt;%</span> <span class="fu">kable</span>(<span class="at">digits=</span><span class="dv">4</span>,<span class="at">caption =</span> <span class="st">"m_P_B ="</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-elephants-3">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>m_P_B =</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_CHF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D_OTH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHF</td>
<td style="text-align: right;">0.8819</td>
<td style="text-align: right;">0.1125</td>
<td style="text-align: right;">0.0056</td>
</tr>
<tr class="even">
<td style="text-align: left;">D_CHF</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
<td style="text-align: right;">0.0000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D_OTH</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">1.0000</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: Transition probability matrices (NH = Natural History; A = Strategy A; B = Strategy B)</figcaption><p></p>
</figure>
</div>
</section>
<section id="full-process" class="level2">
<h2 class="anchored" data-anchor-id="full-process">Full Process</h2>
<p><img src="images/paste-E2EB7E3D.png" class="img-fluid"></p>
</section>
</section>
<section id="transition-dynamics" class="level1">
<h1>Transition Dynamics</h1>
<section id="transition-dynamics-1" class="level2">
<h2 class="anchored" data-anchor-id="transition-dynamics-1">Transition Dynamics</h2>
<div class="incremental">
<ul class="incremental">
<li>We have focused on “static” transition rate/probability matrices.</li>
<li>Often, transitions vary as a function of time.</li>
</ul>
</div>
</section>
<section id="transition-dynamics-2" class="level2">
<h2 class="anchored" data-anchor-id="transition-dynamics-2">Transition Dynamics</h2>
<div class="incremental">
<ul class="incremental">
<li>Nonstationary rates: background mortality rate rises with age.</li>
<li>Nonstationary rates: transition to disease status may vary over different ages.</li>
<li>Time-dependent event transitions: rate of adverse events after disease onset is higher in first cycle, lower in subsequent cycles.</li>
</ul>
</div>
</section>
<section id="age-varying-background-mortality" class="level2">
<h2 class="anchored" data-anchor-id="age-varying-background-mortality">Age-Varying Background Mortality</h2>
<div class="incremental">
<ul class="incremental">
<li>Useful data source is life table data.</li>
<li>May be available from vital statistics division in your country.</li>
<li>Also available (by region) <a href="https://www.un.org/development/desa/pd/data/model-life-tables">from the UN</a> and other organizations.</li>
</ul>
</div>
</section>
<section id="section" class="level2" data-background-image="media/life-table-un.png" data-background-size="contain">
<h2 data-background-image="media/life-table-un.png" data-background-size="contain" class="anchored" data-anchor-id="section"></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2); <span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(flexsurv) <span class="co"># For pgompertz</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: survival</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival) <span class="co"># For fitting</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'janitor'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    chisq.test, fisher.test</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in Raw Lifetable Data</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>deaths.male <span class="ot">&lt;-</span> <span class="fu">read.table</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"gompertz-mortality/data/mltper_1x1.txt"</span>),<span class="at">skip=</span><span class="dv">2</span>,<span class="at">header=</span>T,<span class="at">as.is=</span><span class="cn">TRUE</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>deaths.female <span class="ot">&lt;-</span> <span class="fu">read.table</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"gompertz-mortality/data/fltper_1x1.txt"</span>),<span class="at">skip=</span><span class="dv">2</span>,<span class="at">header=</span>T,<span class="at">as.is=</span><span class="cn">TRUE</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Make Some Edits</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>deaths.male[<span class="fu">which</span>(deaths.male<span class="sc">$</span>Age<span class="sc">==</span><span class="st">"110+"</span>),]<span class="sc">$</span>Age <span class="ot">&lt;-</span> <span class="dv">110</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>deaths.female[<span class="fu">which</span>(deaths.female<span class="sc">$</span>Age<span class="sc">==</span><span class="st">"110+"</span>),]<span class="sc">$</span>Age <span class="ot">&lt;-</span> <span class="dv">110</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>deaths.male<span class="sc">$</span>Age <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(deaths.male<span class="sc">$</span>Age)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>deaths.female<span class="sc">$</span>Age <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(deaths.female<span class="sc">$</span>Age)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Isolate each file to 2010 deaths only</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>deaths.male<span class="fl">.2010</span> <span class="ot">&lt;-</span> <span class="fu">subset</span>(deaths.male,Year<span class="sc">==</span><span class="dv">2010</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>deaths.female<span class="fl">.2010</span> <span class="ot">&lt;-</span> <span class="fu">subset</span>(deaths.female,Year<span class="sc">==</span><span class="dv">2010</span>)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the CDF ## CDF == 1-Survival = 1 - lx/10)</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>deaths.male<span class="fl">.2010</span><span class="sc">$</span>cdf <span class="ot">&lt;-</span> <span class="fu">with</span>(deaths.male<span class="fl">.2010</span>,<span class="dv">1</span><span class="sc">-</span>lx<span class="sc">/</span><span class="dv">100000</span>)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>deaths.female<span class="fl">.2010</span><span class="sc">$</span>cdf <span class="ot">&lt;-</span> <span class="fu">with</span>(deaths.female<span class="fl">.2010</span>,<span class="dv">1</span><span class="sc">-</span>lx<span class="sc">/</span><span class="dv">100000</span>)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Expand to full data frame</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>deaths.male.long <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Age=</span><span class="fu">rep</span>(deaths.male<span class="fl">.2010</span><span class="sc">$</span>Age, deaths.male<span class="fl">.2010</span><span class="sc">$</span>dx))</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>deaths.male.long<span class="sc">$</span>Death <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>deaths.female.long <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Age=</span><span class="fu">rep</span>(deaths.female<span class="fl">.2010</span><span class="sc">$</span>Age, deaths.female<span class="fl">.2010</span><span class="sc">$</span>dx))</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>deaths.female.long<span class="sc">$</span>Death <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">Age =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">110</span>,</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">male.shape=</span><span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">111</span>),</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">male.rate=</span><span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">111</span>),</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">female.shape=</span><span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">111</span>),</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">female.rate=</span><span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">111</span>)</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"lectures/media/gompertz-mortality.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="background-mortality" class="level2">
<h2 class="anchored" data-anchor-id="background-mortality">Background Mortality</h2>
<div class="incremental">
<ul class="incremental">
<li>You can fit a Gompertz survival model to each age’s life table data.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></li>
<li>The Gompertz model will estimate two parameters: a <strong>shape (a)</strong> and a <strong>rate (b)</strong> parameter.</li>
<li>Gompertz parameters (by gender) are shown in the table.</li>
</ul>
</div>
</section>
<section id="background-mortality-1" class="level2">
<h2 class="anchored" data-anchor-id="background-mortality-1">Background Mortality</h2>
<ul>
<li>You can fit a Gompertz survival model to each age’s life table data.</li>
<li>The Gompertz model will estimate two parameters: a <strong>shape (a)</strong> and a <strong>rate (b)</strong> parameter.</li>
<li>Gompertz parameters (by gender) are shown in the table on next slide.</li>
</ul>
</section>
<section id="background-mortality-2" class="level2">
<h2 class="anchored" data-anchor-id="background-mortality-2">Background Mortality</h2>
<div style="font-size: 1.0em">
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>parameters <span class="sc">%&gt;%</span>  <span class="fu">select</span>(Age,<span class="at">a_shape =</span> male.shape, <span class="at">b_rate =</span> male.rate) <span class="sc">%&gt;%</span> <span class="fu">head</span>() <span class="sc">%&gt;%</span> <span class="fu">kable</span>(<span class="at">digits=</span><span class="dv">5</span>) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">Age</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">a_shape</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">b_rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.08386</td>
<td style="text-align: right;">8e-05</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.08630</td>
<td style="text-align: right;">7e-05</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.08644</td>
<td style="text-align: right;">8e-05</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.08653</td>
<td style="text-align: right;">8e-05</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: right;">0.08658</td>
<td style="text-align: right;">9e-05</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.08661</td>
<td style="text-align: right;">1e-04</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</section>
<section id="background-mortality-3" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="background-mortality-3">Background Mortality</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for(age in 0:109)</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># {</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   print(age)</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   surv.data &lt;- with(deaths.male.long[deaths.male.long$Age &gt;= age,], Surv(Age, Death, origin=age))</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   surv.model &lt;- flexsurvreg(surv.data ~ 1, dist="gompertz")</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters$male.shape[age+1] &lt;- surv.model$coefficients[1]</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters$male.rate[age+1] &lt;- exp(surv.model$coefficients[2])</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   surv.data &lt;- with(deaths.female.long[deaths.female.long$Age &gt;= age,], Surv(Age, Death, origin=age))</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   surv.model &lt;- flexsurvreg(surv.data ~ 1, dist="gompertz")</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters$female.shape[age+1] &lt;- surv.model$coefficients[1]</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters$female.rate[age+1] &lt;- exp(surv.model$coefficients[2])</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="co"># parameters &lt;- parameters[1:110,]</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="co"># write.csv(parameters, here::here("lectures/media/gompertz-mortality.csv"), row.names=FALSE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Gompertz fit to mortality data for two selected ages (40- and 90-year old U.S. males)</li>
</ul>
<div id="fig-gompertz" class="quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  Let's check the post 40 fit.</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>surv.data <span class="ot">&lt;-</span> deaths.male.long[deaths.male.long<span class="sc">$</span>Age <span class="sc">&gt;=</span> <span class="dv">40</span>,]</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(surv.data<span class="sc">$</span>Age, <span class="at">freq=</span><span class="cn">FALSE</span>, <span class="at">main=</span><span class="st">"Census Data from 2010"</span>, <span class="at">xlab=</span><span class="st">"Male Deaths Starting at 40"</span>, <span class="at">breaks=</span><span class="dv">20</span>)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(<span class="fu">dgompertz</span>(x<span class="dv">-40</span>, parameters<span class="sc">$</span>male.shape[<span class="dv">41</span>], parameters<span class="sc">$</span>male.rate[<span class="dv">41</span>]) , <span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-forty" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="lec_structure_files/figure-html/fig-forty-1.png" class="img-fluid figure-img" data-ref-parent="fig-gompertz" width="672"></p>
<p></p><figcaption class="figure-caption">(a) 40-Year Old Men</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  Let's check the post 90 fit.</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>surv.data <span class="ot">&lt;-</span> deaths.male.long[deaths.male.long<span class="sc">$</span>Age <span class="sc">&gt;=</span> <span class="dv">90</span>,]</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(surv.data<span class="sc">$</span>Age, <span class="at">freq=</span><span class="cn">FALSE</span>, <span class="at">main=</span><span class="st">"Census Data from 2010"</span>, <span class="at">xlab=</span><span class="st">"Male Deaths Starting at 90"</span>, <span class="at">breaks=</span><span class="dv">20</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(<span class="fu">dgompertz</span>(x<span class="dv">-90</span>, parameters<span class="sc">$</span>male.shape[<span class="dv">91</span>], parameters<span class="sc">$</span>male.rate[<span class="dv">91</span>]) , <span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ninety" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="lec_structure_files/figure-html/fig-ninety-1.png" class="img-fluid figure-img" data-ref-parent="fig-gompertz" width="672"></p>
<p></p><figcaption class="figure-caption">(b) 90-Year Old Men</figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;2: Distribution of observed deaths (grey bars) and fitted Gompertz model (red) for two ages.</figcaption><p></p>
</figure>
</div>
</section>
<section id="background-mortality-4" class="level2">
<h2 class="anchored" data-anchor-id="background-mortality-4">Background Mortality</h2>
<div class="incremental">
<ul class="incremental">
<li>Suppose we have a model of males starting at age 40.</li>
<li>Each age has its own estimated shape (a) and rate (b) parameter.</li>
<li>We can find the values of <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> for our 40 year old male cohort:</li>
</ul>
</div>
</section>
<section id="background-mortality-5" class="level2">
<h2 class="anchored" data-anchor-id="background-mortality-5">Background Mortality</h2>
<ul>
<li>Suppose we have a model of males starting at age 40.</li>
<li>Each age has its own estimated shape (a) and rate (b) parameter.</li>
<li>We can find the values of <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> for our 40 year old male cohort:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>parameters <span class="sc">%&gt;%</span> <span class="fu">select</span>(Age,<span class="at">a_shape =</span> male.shape, <span class="at">b_rate =</span> male.rate) <span class="sc">%&gt;%</span>  <span class="fu">filter</span>(Age<span class="sc">==</span><span class="dv">40</span>) <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">Age</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">a_shape</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">b_rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">40</td>
<td style="text-align: right;">0.0908323</td>
<td style="text-align: right;">0.0017132</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="background-mortality-6" class="level2">
<h2 class="anchored" data-anchor-id="background-mortality-6">Background Mortality</h2>
<div class="incremental">
<ul class="incremental">
<li>These shape and rate values are now fixed for our model</li>
<li>That is, we only need these two values, as they allow us to model the remaining life expectancy of our 40-year-old male cohort as it ages through our model!</li>
</ul>
</div>
</section>
<section id="background-mortality-7" class="level2">
<h2 class="anchored" data-anchor-id="background-mortality-7">Background Mortality</h2>
<div class="incremental">
<ul class="incremental">
<li><p>As our cohort ages through the model (40, 41, 42, …), the background death rate at each subsequent age can be calculated using a simple formula.</p></li>
<li><p>Given the <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> values for a 40-year-old males, we can calcualte the death rate at any subsequent age as <span class="math display">\[r_{e} =  \frac{b}{a} (e^{at_2} - e^{at_1})\]</span></p></li>
</ul>
</div>
</section>
<section id="background-mortality-8" class="level2">
<h2 class="anchored" data-anchor-id="background-mortality-8">Background Mortality</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>tmp_ <span class="ot">&lt;-</span> parameters <span class="sc">%&gt;%</span> <span class="fu">select</span>(Age,<span class="at">a_shape =</span> male.shape, <span class="at">b_rate =</span> male.rate) <span class="sc">%&gt;%</span>  <span class="fu">filter</span>(Age<span class="sc">==</span><span class="dv">40</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> tmp_<span class="sc">$</span>a_shape[<span class="dv">1</span>] </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> tmp_<span class="sc">$</span>b_rate[<span class="dv">1</span>] </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>t <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> (b<span class="sc">/</span>a) <span class="sc">*</span> (<span class="fu">exp</span>(a<span class="sc">*</span>(t<span class="sc">+</span><span class="dv">1</span>)) <span class="sc">-</span> <span class="fu">exp</span>(a<span class="sc">*</span>((t))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>The Gompertz parameters for 40-year old males (US life table data) are:
<ul>
<li>a = 0.0908</li>
<li>b = 0.0017</li>
</ul></li>
</ul>
</section>
<section id="background-mortality-9" class="level2">
<h2 class="anchored" data-anchor-id="background-mortality-9">Background Mortality</h2>
<div class="incremental">
<ul class="incremental">
<li>At t=0 (i.e., age 40), the mortality rate for the cohort over the next year is:</li>
</ul>
<div class="nobullet">
<ul class="incremental">
<li><span class="math display">\[r_{t=0} = 0.0017934 =  \frac{0.0017132}{0.0908323} (e^{0.0908323 \cdot 1} - e^{0.0908323 \cdot (0))})\]</span></li>
</ul>
</div>
<ul class="incremental">
<li>Using a rate-to-probability conversion formula, this corresponds to a probability of death in the next year of <span class="math display">\[p = 1-exp(-r) = 1-exp(-0.0017934) = 0.0017918\]</span></li>
</ul>
</div>
</section>
<section id="verifying-accuracy" class="level2">
<h2 class="anchored" data-anchor-id="verifying-accuracy">Verifying Accuracy</h2>
<div class="incremental">
<ul class="incremental">
<li>Using this mortality rate, we can (randomly) draw death times (years from age 40) for 1 million 40 year old males.</li>
<li>The average life expectancy is the mean of this value.</li>
<li>In this example, the life expectancy is 38.3 years.</li>
</ul>
</div>
</section>
<section id="background-mortality-10" class="level2">
<h2 class="anchored" data-anchor-id="background-mortality-10">Background Mortality</h2>
<ul>
<li>This life expectancy closely matches other published data</li>
</ul>
<p><img src="images/paste-B67603F4.png" class="img-fluid"></p>
<p><img src="images/paste-47FEC4F5.png" class="img-fluid"></p>
</section>
<section id="background-mortality-11" class="level2">
<h2 class="anchored" data-anchor-id="background-mortality-11">Background Mortality</h2>
<div class="incremental">
<ul class="incremental">
<li>We can now repeat this exercise for every cycle in our model.</li>
<li>This gives us a different background mortality rate for every cycle.</li>
</ul>
</div>
<div style="font-size: 0.8em">
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">cycle =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">age =</span> <span class="dv">40</span><span class="sc">:</span><span class="dv">45</span>, <span class="at">a_shape =</span> a, <span class="at">b_rate =</span> b) <span class="sc">%&gt;%</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">r_mort =</span> (b_rate <span class="sc">/</span> a_shape) <span class="sc">*</span> (<span class="fu">exp</span>(a_shape<span class="sc">*</span>(cycle<span class="sc">+</span><span class="dv">1</span>)) <span class="sc">-</span> <span class="fu">exp</span>(a_shape <span class="sc">*</span> cycle))) <span class="sc">%&gt;%</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_death =</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r_mort)) <span class="sc">%&gt;%</span> </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits=</span><span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">cycle</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">age</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">a_shape</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">b_rate</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">r_mort</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p_death</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">0.0908</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">0.0018</td>
<td style="text-align: right;">0.0018</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">0.0908</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">0.0020</td>
<td style="text-align: right;">0.0020</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">0.0908</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">0.0022</td>
<td style="text-align: right;">0.0021</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">0.0908</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">0.0024</td>
<td style="text-align: right;">0.0024</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">0.0908</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">0.0026</td>
<td style="text-align: right;">0.0026</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">0.0908</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">0.0028</td>
<td style="text-align: right;">0.0028</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</section>
<section id="background-mortality-12" class="level2">
<h2 class="anchored" data-anchor-id="background-mortality-12">Background Mortality</h2>
<ul>
<li>We can now repeat this exercise for every cycle in our model.</li>
<li>This gives us a different background mortality rate for every cycle.</li>
</ul>
<div style="font-size: 0.8em">
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">cycle =</span> <span class="dv">50</span><span class="sc">:</span><span class="dv">55</span>, <span class="at">age =</span> <span class="dv">50</span><span class="sc">+</span><span class="dv">40</span><span class="sc">:</span><span class="dv">45</span>, <span class="at">a_shape =</span> a, <span class="at">b_rate =</span> b) <span class="sc">%&gt;%</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">r_mort =</span> (b_rate <span class="sc">/</span> a_shape) <span class="sc">*</span> (<span class="fu">exp</span>(a_shape<span class="sc">*</span>(cycle<span class="sc">+</span><span class="dv">1</span>)) <span class="sc">-</span> <span class="fu">exp</span>(a_shape <span class="sc">*</span> cycle))) <span class="sc">%&gt;%</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_death =</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r_mort)) <span class="sc">%&gt;%</span> </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits=</span><span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">cycle</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">age</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">a_shape</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">b_rate</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">r_mort</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p_death</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">50</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">0.0908</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">0.1683</td>
<td style="text-align: right;">0.1549</td>
</tr>
<tr class="even">
<td style="text-align: right;">51</td>
<td style="text-align: right;">91</td>
<td style="text-align: right;">0.0908</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">0.1843</td>
<td style="text-align: right;">0.1683</td>
</tr>
<tr class="odd">
<td style="text-align: right;">52</td>
<td style="text-align: right;">92</td>
<td style="text-align: right;">0.0908</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">0.2018</td>
<td style="text-align: right;">0.1828</td>
</tr>
<tr class="even">
<td style="text-align: right;">53</td>
<td style="text-align: right;">93</td>
<td style="text-align: right;">0.0908</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">0.2210</td>
<td style="text-align: right;">0.1983</td>
</tr>
<tr class="odd">
<td style="text-align: right;">54</td>
<td style="text-align: right;">94</td>
<td style="text-align: right;">0.0908</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">0.2420</td>
<td style="text-align: right;">0.2150</td>
</tr>
<tr class="even">
<td style="text-align: right;">55</td>
<td style="text-align: right;">95</td>
<td style="text-align: right;">0.0908</td>
<td style="text-align: right;">0.0017</td>
<td style="text-align: right;">0.2650</td>
<td style="text-align: right;">0.2328</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</section>
<section id="nonstationary-rates" class="level2">
<h2 class="anchored" data-anchor-id="nonstationary-rates">Nonstationary Rates</h2>
<ul>
<li>You may have other parameters that vary by age.
<ul>
<li>Disease specific mortality rate:</li>
</ul></li>
</ul>
<p><img src="images/paste-EA4566AA.png" class="img-fluid"></p>
<p>Source: <span class="citation" data-cites="russellWhatPertussisMortality2016">Russell et al. (<a href="#ref-russellWhatPertussisMortality2016" role="doc-biblioref">2016</a>)</span></p>
</section>
<section id="nonstationary-rates-1" class="level2">
<h2 class="anchored" data-anchor-id="nonstationary-rates-1">Nonstationary Rates</h2>
<ul>
<li>You may have other parameters that vary by age.
<ul>
<li>Disease specific mortality rate:</li>
<li>Age-specific intervention rates/probabilities</li>
</ul></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/paste-0AB76A08.png" height="300" class="figure-img"></p>
</figure>
</div>
<p>Source: <span class="citation" data-cites="russellWhatPertussisMortality2016">Russell et al. (<a href="#ref-russellWhatPertussisMortality2016" role="doc-biblioref">2016</a>)</span></p>
</section>
<section id="nonstationary-rates-2" class="level2">
<h2 class="anchored" data-anchor-id="nonstationary-rates-2">Nonstationary Rates</h2>
<div class="incremental">
<ul class="incremental">
<li>It is straightforward to incorporate these dynamics into a Markov model.</li>
<li>Essentially, you recalculate the transition probability matrix in each cycle.</li>
<li>This works long as the underlying rates/probabilities change by age.</li>
</ul>
</div>
</section>
<section id="nonstationary-rates-3" class="level2">
<h2 class="anchored" data-anchor-id="nonstationary-rates-3">Nonstationary Rates</h2>
<div class="incremental">
<ul class="incremental">
<li>This makes the Excel a bit more complicated, because you have to incorporate visual basic code to recalculate.</li>
<li>We have constructed an optional case study that draws on age-specific background mortality rates – see the workshop website for more!</li>
</ul>
</div>
</section>
<section id="other-transition-dynamics" class="level2">
<h2 class="anchored" data-anchor-id="other-transition-dynamics">Other Transition Dynamics</h2>
<div class="incremental">
<ul class="incremental">
<li>Suppose, instead, that event/transition rates, costs, quality of life vary over the course of a disease or other process in our model.</li>
<li>Example: cost, quality of life weight, or risk of adverse event (e.g., death) is different in first year after disease onset, and changes thereafter.</li>
<li>These types of dynamics are more challenging to implement – but you can often do it!</li>
</ul>
</div>
</section>
<section id="other-transition-dynamics-1" class="level2">
<h2 class="anchored" data-anchor-id="other-transition-dynamics-1">Other Transition Dynamics</h2>
<div class="incremental">
<ul class="incremental">
<li><p>One option is to simply build a decision tree around events that occur at higher rates shortly after disease onset, surgery, drug initiation, etc.</p></li>
<li><p>The decision tree can follow people until they reach a “steady state” — then the Markov model can pick up from there.</p></li>
</ul>
</div>
</section>
<section id="other-transition-dynamics-2" class="level2">
<h2 class="anchored" data-anchor-id="other-transition-dynamics-2">Other Transition Dynamics</h2>
<div class="incremental">
<ul class="incremental">
<li><p>Another option is “tunnel states” — simply expand the health state to follow people over the first few cycles of onset.</p></li>
<li><p>Tunnel states are “non-markovian,” so they need to be added once you have the transition probability matrix defined.</p></li>
</ul>
</div>
</section>
<section id="tunnel-states-healthy-sick-dead" class="level2">
<h2 class="anchored" data-anchor-id="tunnel-states-healthy-sick-dead">Tunnel States: Healthy, Sick, Dead</h2>
<div class="incremental">
<ul class="incremental">
<li>Let’s take a simple healthy, sick, dead model.</li>
<li>Illness onset rate = 0.0314</li>
<li>Background mortality rate = 0.0094</li>
<li>Illness increases the risk of death by a hazard ratio of 5.45.</li>
</ul>
</div>
</section>
<section id="tunnel-states-healthy-sick-dead-1" class="level2">
<h2 class="anchored" data-anchor-id="tunnel-states-healthy-sick-dead-1">Tunnel States: Healthy, Sick, Dead</h2>
<p>Transition rate matrix: <span class="math inline">\(\mathbf{R}\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>m_P_ <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.96</span>,<span class="fl">0.03</span>,<span class="fl">0.01</span>,<span class="dv">0</span>,<span class="fl">0.95</span>,<span class="fl">0.05</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>),<span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">nrow=</span><span class="dv">3</span>,<span class="at">ncol=</span><span class="dv">3</span>,<span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"H"</span>,<span class="st">"S"</span>,<span class="st">"D"</span>),<span class="fu">c</span>(<span class="st">"H"</span>,<span class="st">"S"</span>,<span class="st">"D"</span>)))</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>V  <span class="ot">&lt;-</span> <span class="fu">eigen</span>(m_P_)<span class="sc">$</span>vectors</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>iV <span class="ot">&lt;-</span> <span class="fu">solve</span>(V)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>Ap <span class="ot">&lt;-</span> iV <span class="sc">%*%</span> m_P_ <span class="sc">%*%</span> V</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>lAp <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">log</span>(<span class="fu">diag</span>(Ap)), <span class="fu">nrow</span>(Ap), <span class="fu">ncol</span>(Ap))</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>m_R  <span class="ot">&lt;-</span> V <span class="sc">%*%</span> lAp <span class="sc">%*%</span> iV</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(m_R) <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"H"</span>,<span class="st">"S"</span>,<span class="st">"D"</span>),<span class="fu">c</span>(<span class="st">"H"</span>,<span class="st">"S"</span>,<span class="st">"D"</span>))</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="co"># m_R &lt;- matrix(0, nrow=3, ncol=3, dimnames = list(c("H","S","D"),c("H","S","D")))</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="co"># m_R[1,2] &lt;- .1</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="co"># m_R[1,3] &lt;- 0.006</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="co"># m_R[2,3] &lt;- 0.006 * 5</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="co"># diag(m_R) = -rowSums(m_R)</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>m_R <span class="sc">%&gt;%</span> <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">H</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">H</td>
<td style="text-align: right;">-0.0408</td>
<td style="text-align: right;">0.0314</td>
<td style="text-align: right;">0.0094</td>
</tr>
<tr class="even">
<td style="text-align: left;">S</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">-0.0513</td>
<td style="text-align: right;">0.0513</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="tunnel-states-healthy-sick-dead-2" class="level2">
<h2 class="anchored" data-anchor-id="tunnel-states-healthy-sick-dead-2">Tunnel States: Healthy, Sick, Dead</h2>
<p>Transition probability matrix: <span class="math inline">\(\exp(\mathbf{R})\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(expm)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>m_P <span class="ot">&lt;-</span> <span class="fu">expm</span>(m_R) </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>m_P <span class="sc">%&gt;%</span> <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">H</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">H</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">0.01</td>
</tr>
<tr class="even">
<td style="text-align: left;">S</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">0.05</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="tunnel-states-healthy-sick-dead-3" class="level2">
<h2 class="anchored" data-anchor-id="tunnel-states-healthy-sick-dead-3">Tunnel States: Healthy, Sick, Dead</h2>
<div class="incremental">
<ul class="incremental">
<li><p>Now suppose that the probability of death from disease varies by time since disease onset.</p>
<ul class="incremental">
<li>0.08 in first year</li>
<li>0.06 in second year</li>
<li>0.04 in third year onwards</li>
</ul></li>
<li><p>We can add tunnel states to our transition probability matrix to accomodate this.</p></li>
</ul>
</div>
</section>
<section id="tunnel-states-healthy-sick-dead-4" class="level2">
<h2 class="anchored" data-anchor-id="tunnel-states-healthy-sick-dead-4">Tunnel States: Healthy, Sick, Dead</h2>
<ul>
<li>Here is the new transition probability matrix.</li>
<li>Notice how the tunnel states “force” people to transition either to the next disease state if they do not die of the disease in the cycle.</li>
</ul>
<div style="font-size: 0.8em">
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>m_Pt <span class="ot">&lt;-</span> <span class="fu">cbind</span>(m_P,<span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span><span class="fu">nrow</span>(m_P),<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">dimnames=</span><span class="fu">list</span>(<span class="fu">rownames</span>(m_P),<span class="fu">c</span>(<span class="st">"S1"</span>,<span class="st">"S2"</span>))))</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>m_Pt <span class="ot">&lt;-</span> m_Pt[,<span class="fu">c</span>(<span class="st">"H"</span>,<span class="st">"S1"</span>,<span class="st">"S2"</span>,<span class="st">"S"</span>,<span class="st">"D"</span>)]</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>m_Pt <span class="ot">&lt;-</span> <span class="fu">rbind</span>(m_Pt,<span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span><span class="dv">2</span>,<span class="at">ncol=</span><span class="fu">ncol</span>(m_Pt),<span class="at">dimnames=</span><span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"S1"</span>,<span class="st">"S2"</span>),<span class="fu">colnames</span>(m_Pt))))</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>m_Pt <span class="ot">&lt;-</span> m_Pt[<span class="fu">c</span>(<span class="st">"H"</span>,<span class="st">"S1"</span>,<span class="st">"S2"</span>,<span class="st">"S"</span>,<span class="st">"D"</span>),]</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>m_Pt[<span class="st">"S1"</span>,<span class="st">"D"</span>] <span class="ot">&lt;-</span> <span class="fl">0.08</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>m_Pt[<span class="st">"S2"</span>,<span class="st">"D"</span>] <span class="ot">&lt;-</span> <span class="fl">0.06</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>m_Pt[<span class="st">"S"</span>,<span class="st">"D"</span>] <span class="ot">&lt;-</span> <span class="fl">0.04</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(m_Pt) <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">nrow</span>(m_Pt))</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(m_Pt) <span class="ot">=</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">rowSums</span>(m_Pt)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>m_Pt[<span class="st">"S1"</span>,<span class="st">"S2"</span>] <span class="ot">=</span> m_Pt[<span class="st">"S1"</span>,<span class="st">"S1"</span>]</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>m_Pt[<span class="st">"S2"</span>,<span class="st">"S"</span>] <span class="ot">=</span> m_Pt[<span class="st">"S2"</span>,<span class="st">"S2"</span>]</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>m_Pt[<span class="st">"H"</span>,<span class="st">"S1"</span>] <span class="ot">=</span> m_Pt[<span class="st">"H"</span>,<span class="st">"S"</span>]</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>m_Pt[<span class="st">"H"</span>,<span class="st">"S"</span>] <span class="ot">=</span><span class="dv">0</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(m_Pt) <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">nrow</span>(m_Pt))</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(m_Pt) <span class="ot">=</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">rowSums</span>(m_Pt)</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>m_Pt <span class="sc">%&gt;%</span> </span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">H</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S2</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">H</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.01</td>
</tr>
<tr class="even">
<td style="text-align: left;">S1</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.92</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.08</td>
</tr>
<tr class="odd">
<td style="text-align: left;">S2</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.94</td>
<td style="text-align: right;">0.06</td>
</tr>
<tr class="even">
<td style="text-align: left;">S</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">0.04</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</section>
<section id="tunnel-states-healthy-sick-dead-5" class="level2">
<h2 class="anchored" data-anchor-id="tunnel-states-healthy-sick-dead-5">Tunnel States: Healthy, Sick, Dead</h2>
<ul>
<li>If we run out the Markov trace for five cycles, here are the results.</li>
</ul>
<div class="incremental">
<ul class="incremental">
<li>You can find a nice discussion of how to incorporate tunnel states into an Excel model <a href="https://www.youtube.com/watch?v=FkYFRNw5EAw">here</a>.</li>
</ul>
</div>
<div style="font-size: 0.75em">
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span><span class="sc">:</span><span class="dv">5</span> <span class="sc">%&gt;%</span> <span class="fu">map_df</span>(<span class="sc">~</span>({</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="dv">1000</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>) <span class="sc">%*%</span> (m_Pt <span class="sc">%^%</span> .x) <span class="sc">%&gt;%</span> </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    {<span class="fu">round</span>(.,<span class="dv">0</span>)} <span class="sc">%&gt;%</span> </span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>()</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>})) <span class="sc">%&gt;%</span> </span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cycle =</span> <span class="fu">row_number</span>()<span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">S_total =</span> S1 <span class="sc">+</span> S2 <span class="sc">+</span> S) <span class="sc">%&gt;%</span> </span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(cycle,H,S1,S2,S,S_total,D) <span class="sc">%&gt;%</span> </span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">cycle</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">H</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S2</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S_total</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1000</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">960</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">922</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">57</td>
<td style="text-align: right;">22</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: right;">885</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">80</td>
<td style="text-align: right;">35</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: right;">849</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">102</td>
<td style="text-align: right;">49</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">815</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">121</td>
<td style="text-align: right;">63</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</section>
</section>
<section id="working-backwards" class="level1">
<h1>Working Backwards</h1>
<section id="working-backwards-1" class="level2">
<h2 class="anchored" data-anchor-id="working-backwards-1">Working Backwards</h2>
<div class="incremental">
<ul class="incremental">
<li>Suppose someone has already constructed a detailed Markov model for the decision problem you are working on.</li>
<li>However, this model was constructed for another country/region/context.</li>
<li>Rather than start from “scratch” with your own model, you might be able to adapt it!</li>
</ul>
</div>
</section>
<section id="working-backwards-2" class="level2">
<h2 class="anchored" data-anchor-id="working-backwards-2">Working Backwards</h2>
<p>Essentially, this means working backwards!</p>
<p><img src="images/paste-72736A50.png" class="img-fluid"></p>
</section>
<section id="working-backwards-3" class="level2">
<h2 class="anchored" data-anchor-id="working-backwards-3">Working Backwards</h2>
<p>Essentially, this means working backwards!</p>
<p><img src="images/paste-B58E8E75.png" class="img-fluid"></p>
</section>
<section id="working-backwards-4" class="level2">
<h2 class="anchored" data-anchor-id="working-backwards-4">Working Backwards</h2>
<div class="incremental">
<ul class="incremental">
<li>We won’t go into the (very mathematical) details, but we will show you how to do this!</li>
<li>Essentially, we will “solve” for what is called the <strong>generator matrix</strong> for the (existing) transition probability matrix.</li>
<li>This is done through a process known as “eigenvalue decomposition.”</li>
<li>Note that this is not always possible, depending on the matrix!</li>
</ul>
</div>
</section>
<section id="working-backwards-5" class="level2">
<h2 class="anchored" data-anchor-id="working-backwards-5">Working Backwards</h2>
<p>Let’s start with the example transition probability matrix from earlier:</p>
<p><code>m_P</code> =</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>m_P <span class="sc">%&gt;%</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">H</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">H</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">0.01</td>
</tr>
<tr class="even">
<td style="text-align: left;">S</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">0.05</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="working-backwards-6" class="level2">
<h2 class="anchored" data-anchor-id="working-backwards-6">Working Backwards</h2>
<p>To obtain the rate matrix (<code>m_R</code>) from an existing transition probability matrix (<code>m_P</code>):</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>V  <span class="ot">&lt;-</span> <span class="fu">eigen</span>(m_P)<span class="sc">$</span>vectors</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>iV <span class="ot">&lt;-</span> <span class="fu">solve</span>(V)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>Ap <span class="ot">&lt;-</span> iV <span class="sc">%*%</span> m_P <span class="sc">%*%</span> V</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>lAp <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">log</span>(<span class="fu">diag</span>(Ap)), <span class="fu">nrow</span>(Ap), <span class="fu">ncol</span>(Ap))</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>m_R  <span class="ot">&lt;-</span> V <span class="sc">%*%</span> lAp <span class="sc">%*%</span> iV</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="working-backwards-7" class="level2">
<h2 class="anchored" data-anchor-id="working-backwards-7">Working Backwards</h2>
<p>To obtain the rate matrix (<code>m_R</code>) from an existing transition probability matrix (<code>m_P</code>):</p>
<p><code>m_R</code> =</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>m_R <span class="sc">%&gt;%</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">H</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">D</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">H</td>
<td style="text-align: right;">-0.040822</td>
<td style="text-align: right;">0.0314139</td>
<td style="text-align: right;">0.0094081</td>
</tr>
<tr class="even">
<td style="text-align: left;">S</td>
<td style="text-align: right;">0.000000</td>
<td style="text-align: right;">-0.0512933</td>
<td style="text-align: right;">0.0512933</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: right;">0.000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="working-backwards-8" class="level2">
<h2 class="anchored" data-anchor-id="working-backwards-8">Working Backwards</h2>
<div class="incremental">
<ul class="incremental">
<li>We now have the rate matrix that is the “hub” or “root” of the underlying Markov model!</li>
<li>From here, we could adapt rates using country-specific parameters.</li>
<li>For example, we could adapt the rate of background mortality to match our country’s/region’s mortality rate.</li>
<li>We could also add additional states, or make other changes as needed.</li>
</ul>
</div>
</section>
<section id="working-backwards-9" class="level2">
<h2 class="anchored" data-anchor-id="working-backwards-9">Working Backwards</h2>
<div class="incremental">
<ul class="incremental">
<li>Once we make the changes we need, we just go back to our usual process.</li>
<li>“Embed” the new transition probability matrix using rate-to-probability conversion formulas, or using exponentiation.</li>
</ul>
</div>
</section>
</section>
<section id="now-you-try-it" class="level1">
<h1>Now You Try It!</h1>
<!-- ## Relative Risk (RR) -->
<!-- -   Also known as a **risk ratio** -->
<!-- -   Ratio of the probability of an outcome between two groups. -->
<!-- -   RR = 1 : Probability of outcome identical -->
<!-- -   RR \< 1 : Probability of outcome is lower compared to reference group. -->
<!-- -   RR \> 1 : Probability of outocme is higher compare to referance group. -->
<!-- ## Relative Risk vs. Odds Ratio -->
<!-- -   RR is different from the odds ratio (OR). -->
<!-- -   OR \$\approx \$ RR for outcomes with small probabilities. -->
<!-- ##  -->
<!-- | Quantity     | Where Does it Apply?                         | -->
<!-- |--------------|----------------------------------------------| -->
<!-- | rate         | Transition rate matrix ($\mathbf{R}$)        | -->
<!-- | Hazard Ratio | Transition rate matrix ($\mathbf{R}$)        | -->
<!-- | probability  | Transition probability matrix ($\mathbf{P}$) | -->
<!-- | probability  | Transition probability matrix ($\mathbf{P}$) | -->
<!-- | probability  | Transition probability matrix ($\mathbf{P}$) | -->
<!-- ## Transition Rate Matrix -->
<!-- For strategy $s$ -->
<!-- $\mathbf{R}$ = -->
<!-- ::: {style="font-size: 0.6em"} -->
<!-- |     | H                                                    | S                                                                                                                                                                      | D                                                                                                                                                                      | -->
<!-- |------------|------------|------------------------|------------------------| -->
<!-- | H   | [$-(r_{HS,s}+r_{HD,s})$]{style="background:#f3c7a0"} | [$r_{HS,s}\cdot \Delta t$]{style="background:#bee0ec"}=</span>[$HR_{HS,s}$]{style="background:#9ee9b2"} $\cdot$ [$r_{HS,0}\cdot \Delta t$]{style="background:#bee0ec"} | [$r_{HD,s}\cdot \Delta t$]{style="background:#bee0ec"}=</span>[$HR_{HD,s}$]{style="background:#9ee9b2"} $\cdot$ [$r_{HD,0}\cdot \Delta t$]{style="background:#bee0ec"} | -->
<!-- | S   | 0                                                    | [$-r_{SD,s}\cdot \Delta t$]{style="background:#f3c7a0"}                                                                                                                | [$r_{SD,s}\cdot \Delta t$]{style="background:#bee0ec"}=</span>[$HR_{SD,s}$]{style="background:#9ee9b2"} $\cdot$ [$r_{SD,0}\cdot \Delta t$]{style="background:#bee0ec"} | -->
<!-- | D   | 0                                                    | 0                                                                                                                                                                      | 0                                                                                                                                                                      | -->
<!-- ::: -->
<!-- ::: {style="font-size: 0.6em"} -->
<!-- | Key                                                                                                       | -->
<!-- |------------------------------------------------------------------------| -->
<!-- | </span>[Rate adjusted for timestep $\Delta t$]{style="background:#bee0ec"}                                | -->
<!-- | </span>[$r_0\cdot \Delta t=$ Baseline Rate adjusted for time step $\Delta t$]{style="background:#bee0ec"} | -->
<!-- | </span>[Hazard Ratio $\frac{r_s\cdot \Delta t}{r_0\cdot \Delta t}$]{style="background:#9ee9b2"}           | -->
<!-- | </span>[Constructed from other cells]{style="background:#f3c7a0"}                                         | -->
<!-- ::: -->
<!-- ## Relative Risks and Odds Ratios -->
<!-- ::: incremental -->
<!-- -   Where do relative risks and odds ratios plug in? -->
<!-- -   These must be applied to the transition probability matrix. -->
<!-- -   Therefore, we first convert the transition rate matrix to the transition probability matrix. -->
<!-- ::: -->
<!-- ## Rate Matrix to Probability Matrix {.smaller} -->
<!-- -   *Preferred Method*: $\mathbf{P} = \exp(\mathbf{R})$[^4] -->
<!-- -   Can also use the rate-to-probability conversion formulas. -->
<!-- [^4]: Can use statistical software or Taylor series expansion; see case study for worked example. -->
<!-- ## Transition Probability Matrix -->
<!-- For strategy $s$ -->
<!-- ::: {style="font-size: 0.8em"} -->
<!-- |     | H                                               | S                                                                                                                                          | D                                                                                                                                          | -->
<!-- |-------------|-------------|------------------------|------------------------| -->
<!-- | H   | [$1-p_{HS}-p_{HD}$]{style="background:#f3c7a0"} | [$p_{HS}^s$]{style="background:#f2c9ec"}=</span>[$RR_{HS}^s$]{style="background:#f8f5aa"} $\cdot$ [$p_{HS}^0$]{style="background:#f2c9ec"} | [$p_{HD}^s$]{style="background:#f2c9ec"}=</span>[$RR_{HD}^s$]{style="background:#f8f5aa"} $\cdot$ [$p_{HD}^0$]{style="background:#f2c9ec"} | -->
<!-- | S   | 0                                               | [$1-p_{SD}^s$]{style="background:#f3c7a0"}                                                                                                 | [$p_{SD}^s$]{style="background:#f2c9ec"}=</span>[$RR_{SD}^s$]{style="background:#f8f5aa"} $\cdot$ [$p_{SD}^0$]{style="background:#f2c9ec"} | -->
<!-- | D   | 0                                               | 0                                                                                                                                          | 0                                                                                                                                          | -->
<!-- ::: -->
<!-- ::: {style="font-size: 0.8em"} -->
<!-- | Key                                                                                                              | -->
<!-- |------------------------------------------------------------------------| -->
<!-- | </span>[Probability]{style="background:#f2c9ec"}                                                                 | -->
<!-- | </span>[$p^0=$ Probability Rate]{style="background:#f2c9ec"}                                                     | -->
<!-- | </span>[Relative Risk $RR = \frac{p^s}{p^0} = \frac{OR^s}{(1-p^0+(p^0 \times OR))}$]{style="background:#f8f5aa"} | -->
<!-- | </span>[Constructed from other cells]{style="background:#f3c7a0"}                                                | -->
<!-- ::: -->
<!-- ## Transition Probability Matrix with Odds Ratios -->
<!-- For strategy $s$ -->
<!-- ::: {style="font-size: 0.8em"} -->
<!-- |     | H                                               | S                                                                                                                                          | D                                                                                                                                          | -->
<!-- |-------------|-------------|------------------------|------------------------| -->
<!-- | H   | [$1-p_{HS}-p_{HD}$]{style="background:#f3c7a0"} | [$p_{HS}^s$]{style="background:#f2c9ec"}=</span>[$RR_{HS}^s$]{style="background:#f8f5aa"} $\cdot$ [$p_{HS}^0$]{style="background:#f2c9ec"} | [$p_{HD}^s$]{style="background:#f2c9ec"}=</span>[$RR_{HD}^s$]{style="background:#f8f5aa"} $\cdot$ [$p_{HD}^0$]{style="background:#f2c9ec"} | -->
<!-- | S   | 0                                               | [$1-p_{SD}^s$]{style="background:#f3c7a0"}                                                                                                 | [$p_{SD}^s$]{style="background:#f2c9ec"}=</span>[$RR_{SD}^s$]{style="background:#f8f5aa"} $\cdot$ [$p_{SD}^0$]{style="background:#f2c9ec"} | -->
<!-- | D   | 0                                               | 0                                                                                                                                          | 0                                                                                                                                          | -->
<!-- ::: -->
<!-- ::: {style="font-size: 0.8em"} -->
<!-- | Key                                                                                  | -->
<!-- |------------------------------------------------------------------------| -->
<!-- | </span>[Probability]{style="background:#f2c9ec"}                                     | -->
<!-- | </span>[$p^0=$ Probability Rate]{style="background:#f2c9ec"}                         | -->
<!-- | </span>[Odds Ratio $\frac{OR^s}{1-p^0+(p^0 \times OR)}$]{style="background:#f8f5aa"} | -->
<!-- | </span>[Constructed from other cells]{style="background:#f3c7a0"}                    | -->
<!-- ::: -->
<!-- ## Test -->
<!-- ![](images/paste-23DDF3EF.png) -->
<!-- Source: @gidwaniEstimatingTransitionProbabilities2020 -->
</section>
<section id="references" class="level1">
<h1>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-russellWhatPertussisMortality2016" class="csl-entry" role="listitem">
Russell, Louise B., Sri Ram Pentakota, Cristiana Maria Toscano, Ben Cosgriff, and Anushua Sinha. 2016. <span>“What Pertussis Mortality Rates Make Maternal Acellular Pertussis Immunization Cost-Effective in Low-and Middle-Income Countries? A Decision Analysis.”</span> <em>Clinical Infectious Diseases</em> 63 (suppl_4): S227–35.
</div>
<div id="ref-zhangWhatRelativeRisk1998" class="csl-entry" role="listitem">
Zhang, Jun, and Kai F. Yu. 1998. <span>“What’s the <span>Relative Risk</span>?<span>A Method</span> of <span>Correcting</span> the <span>Odds Ratio</span> in <span>Cohort Studies</span> of <span>Common Outcomes</span>.”</span> <em>JAMA</em> 280 (19): 1690–91. <a href="https://doi.org/10.1001/jama.280.19.1690">https://doi.org/10.1001/jama.280.19.1690</a>.
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This often comes from separate vital statistics / life-table data sources.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Note this is slightly higher than the corresponding probability in our natural history transition probability matrix (0.1172), reflecting the fact that randomized trial participants are not necessarily representative of the entire population!<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Though note this is an assumption, so we should incorporate a lot of uncertainty around it in our model!<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>If the incidence of the outcome is fairly rare (<span class="math inline">\(p_0&lt;0.10\)</span>), you will often see people simply use the OR as a RR. Source for conversion formula: <span class="citation" data-cites="zhangWhatRelativeRisk1998">Zhang and Yu (<a href="#ref-zhangWhatRelativeRisk1998" role="doc-biblioref">1998</a>)</span><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>See the <a href="../blog/posts/gompertz-mortality.html">workshop blog posting</a> for R code!<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>